# Clear existing rules to prevent duplicates
-D

# === Process Execution (High Performance) ===
-a always,exit -F arch=b64 -S execve,execveat -k process_exec
-a always,exit -F arch=b32 -S execve,execveat -k process_exec

# === Network Connections ===
# Split lines to handle "Unknown Syscall" errors gracefully per-distro
-a always,exit -F arch=b64 -S connect,bind,accept4 -F success=1 -k network_connect
-a always,exit -F arch=b32 -S connect,bind,socketcall -F success=1 -k network_connect
# Optional: some older RHEL/Debian kernels specifically need 'accept' on its own
-a always,exit -F arch=b64 -S accept -F success=1 -k network_connect

# === Process Tree & Masquerading (Replaced -w with -a) ===
# This replaces the "Old style watch" on /proc with a faster syscall filter
-a always,exit -F arch=b64 -F dir=/proc -F perm=wa -k proc_monitor
-a always,exit -F arch=b32 -F dir=/proc -F perm=wa -k proc_monitor

# === Fileless Execution ===
-a always,exit -F arch=b64 -S memfd_create -k fileless_exec
-a always,exit -F arch=b32 -S memfd_create -k fileless_exec

# === Suspicious Directory Execution (Modern Syscall Style) ===
# Using -a with -F arch eliminates the "perm used without arch is slower" warning
-a always,exit -F arch=b64 -F dir=/tmp -F perm=x -k suspicious_exec
-a always,exit -F arch=b32 -F dir=/tmp -F perm=x -k suspicious_exec

-a always,exit -F arch=b64 -F dir=/dev/shm -F perm=x -k suspicious_exec
-a always,exit -F arch=b32 -F dir=/dev/shm -F perm=x -k suspicious_exec

-a always,exit -F arch=b64 -F dir=/run -F perm=x -k suspicious_exec
-a always,exit -F arch=b32 -F dir=/run -F perm=x -k suspicious_exec

# =============================================================================
# Load with: sudo auditctl -R /etc/audit/rules.d/c2_beacon.rules
# =============================================================================