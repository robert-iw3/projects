apiVersion: v1
kind: Namespace
metadata:
  name: malware-sandbox
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: malware-sandbox-sa
  namespace: malware-sandbox
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: malware-sandbox-role
  namespace: malware-sandbox
rules:
- apiGroups: [""]
  resources: ["pods", "pods/log"]
  verbs: ["get", "list", "watch", "create", "update", "delete"]
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "create", "update", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: malware-sandbox-rolebinding
  namespace: malware-sandbox
subjects:
- kind: ServiceAccount
  name: malware-sandbox-sa
  namespace: malware-sandbox
roleRef:
  kind: Role
  name: malware-sandbox-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: malware-sandbox
  namespace: malware-sandbox
  labels:
    app: malware-sandbox
spec:
  replicas: 1
  selector:
    matchLabels:
      app: malware-sandbox
  template:
    metadata:
      labels:
        app: malware-sandbox
      namespace: malware-sandbox
    spec:
      serviceAccountName: malware-sandbox-sa
      containers:
      - name: malware-sandbox
        image: malware-sandbox:latest
        command: ["python", "malware_sandbox.py", "--malws-path", "/Malware", "--collection-dir", "/Collections", "--parallel", "4", "--volatility-plugins", "windows.pslist,windows.netscan", "--simulate-network", "--evidence-tool", "magnet"]
        env:
        - name: EVIDENCE_TOOL
          value: "magnet"
        - name: CUCKOO_URL
          value: "http://192.168.56.10:8090"
        livenessProbe:
          exec:
            command: ["powershell", "-Command", "Test-Path -Path /Collections/*summary.json"]
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          exec:
            command: ["powershell", "-Command", "Select-String -Path /Logs/malware_sandbox.log -Pattern 'Malware Sandbox initialized'"]
          initialDelaySeconds: 30
          periodSeconds: 10
        volumeMounts:
        - mountPath: /Malware
          name: malware-volume
        - mountPath: /Collections
          name: collections-volume
        - mountPath: /Logs
          name: logs-volume
      - name: prometheus-exporter
        image: prom/prometheus:latest
        args: ["--config.file=/etc/prometheus/prometheus.yml"]
        ports:
        - containerPort: 9090
        volumeMounts:
        - mountPath: /etc/prometheus
          name: prometheus-config
        - mountPath: /Logs
          name: logs-volume
      volumes:
      - name: malware-volume
        hostPath:
          path: C:/Malware
      - name: collections-volume
        hostPath:
          path: C:/Collections
      - name: logs-volume
        hostPath:
          path: C:/Logs
      - name: prometheus-config
        configMap:
          name: prometheus-config
      nodeSelector:
        kubernetes.io/os: windows
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: malware-sandbox
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
    - job_name: 'malware-sandbox'
      static_configs:
      - targets: ['localhost:9090']
---
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: malware-sandbox-psp
  namespace: malware-sandbox
spec:
  privileged: false
  seLinux:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  runAsUser:
    rule: RunAsAny
  fsGroup:
    rule: RunAsAny
  volumes:
  - 'hostPath'
  - 'configMap'
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: malware-sandbox-hpa
  namespace: malware-sandbox
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: malware-sandbox
  minReplicas: 1
  maxReplicas: 4
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80