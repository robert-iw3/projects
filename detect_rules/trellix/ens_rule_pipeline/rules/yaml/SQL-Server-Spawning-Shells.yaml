- type: expert
  name: Detect SQL Server (sqlservr.exe) Spawning Suspicious Shells
  content: |-
    Rule {
       Reaction SCAN ACTOR_PROCESS ScanAction REPORT
       Process {
          Include OBJECT_NAME { -v "sqlservr.exe" }
          Exclude OBJECT_NAME { -v "C:\\Program Files\\Microsoft SQL Server\\**\\sqlservr.exe" -v "C:\\Program Files (x86)\\Microsoft SQL Server\\**\\sqlservr.exe" }
       }
       Target {
          Match PROCESS {
             Include OBJECT_NAME { -v "cmd.exe" -v "powershell.exe" -v "pwsh.exe" }
             Include -access "CREATE"
          }
       }
    }
  action: Report
  severity: High
  enabled: true
  description: "Detects the SQL Server process (sqlservr.exe) spawning command shells (cmd.exe, powershell.exe, pwsh.exe) from non-standard installation paths. Classic indicator of malicious activity: xp_cmdshell abuse, malicious CLR assemblies (e.g., CLR SqlShell, evilclr.dll), or direct code execution in compromised MSSQL servers (ransomware like Mallox/Trigona, cryptominers, PRC APT campaigns 2024-2026). Very high-fidelity; low false positives with path exclusion. Tune further if custom SQL tools are used outside Program Files."
- type: expert
  name: Detect Suspicious Child Processes from sqlservr.exe (Broadened)
  content: |-
    Rule {
       Reaction SCAN ACTOR_PROCESS ScanAction REPORT
       Process {
          Include OBJECT_NAME { -v "sqlservr.exe" }
          Exclude OBJECT_NAME { -v "C:\\Program Files\\Microsoft SQL Server\\**" -v "C:\\Program Files (x86)\\Microsoft SQL Server\\**" }
       }
       Target {
          Match PROCESS {
             Include OBJECT_NAME { -v "cmd.exe" -v "powershell.exe" -v "pwsh.exe" -v "bitsadmin.exe" -v "certutil.exe" -v "net.exe" }
             Include -access "CREATE"
          }
       }
    }
  action: Report
  severity: High
  enabled: true
  description: "Broader variant: Detects sqlservr.exe spawning common attacker utilities (cmd/powershell, bitsadmin, certutil, net) from non-standard paths. Covers additional post-exploitation TTPs (payload download, recon) seen in MSSQL-targeted attacks (ransomware, APT, CLR abuse). High value for chaining with other indicators (e.g., CLR enablement) (e.g., unusual sqlservr.exe parents). Tune exclusions for legitimate SQL agent/monitoring tools."