// Rule Title: Firmware Vulnerability Exploitation Attempt
// Author: RW
// Date: 2025-08-10
// Description: Detects preparatory actions for firmware vulnerability exploitation, such as those seen with BlackLotus
//              (CVE-2022-21894) and LogoFAIL. This includes suspicious modification of boot configuration data (BCD)
//              and the creation of unusual executable or image files in the EFI System Partition (ESP).
// MITRE TTPs: T1542.001, T1542.003

(union isfuzzy=true
    (
        // Part 1: Detects suspicious modification of boot configuration, a technique used by BlackLotus.
        DeviceProcessEvents
        | where ProcessFileName =~ "bcdedit.exe"
        | where ProcessCommandLine has_all ("/set", "path")
        // Extract the new boot path being set.
        | extend NewPath = extract(@"(?i)\spath\s+([\\\w\.\\]+)", 1, ProcessCommandLine)
        // FP Tuning: Legitimate recovery tools or dual-boot configurations might use different paths.
        // Add any known legitimate paths for your environment to this exclusion list.
        | where isnotempty(NewPath) and not (
            NewPath matches regex @"(?i)\\Windows\\system32\\winload\.(efi|exe)"
            or NewPath matches regex @"(?i)\\EFI\\Microsoft\\Boot\\bootmgfw\.efi"
            )
        | extend
            RuleName = "Suspicious Boot Configuration Modification (BlackLotus)",
            SuspiciousEntity = NewPath,
            EntityType = "File"
        | project-reorder TimeGenerated, DeviceName, RuleName, SuspiciousEntity, EntityType, InitiatingProcessFileName, ProcessCommandLine
    ),
    (
        // Part 2: Detects suspicious file creation in the EFI System Partition (ESP).
        DeviceFileEvents
        | where ActionType == "FileCreated"
        | where FolderPath has @"\EFI\"
        | where FileName matches regex @"(?i)\.(efi|bmp|jpg|jpeg|gif|png)$"
        // FP Tuning: Legitimate processes from OS updates, installers, or OEM tools may write to the ESP.
        // This exclusion list may need to be expanded based on your environment.
        | where not(InitiatingProcessFileName in~ (
            "bcdboot.exe", "TiWorker.exe", "TrustedInstaller.exe", "svchost.exe",
            "setup.exe", "dism.exe", "wuauclt.exe", "msiexec.exe", "bootim.exe",
            "fwupd.exe", "DellCommandUpdate.exe", "LenovoVantage.exe", "HPImageAssistant.exe"
            )
        )
        | extend
            RuleName = case(
                FileName endswith ".efi", "Suspicious EFI File Creation (Bootkit)",
                FileName matches regex @"(?i)\.(bmp|jpg|jpeg|gif|png)$", "Suspicious Image File Creation in EFI Partition (LogoFAIL)",
                "Suspicious File Creation in EFI Partition"
            ),
            SuspiciousEntity = FileName,
            EntityType = "File"
        | project-reorder TimeGenerated, DeviceName, RuleName, SuspiciousEntity, EntityType, InitiatingProcessFileName, InitiatingProcessCommandLine, FolderPath
    )
)
