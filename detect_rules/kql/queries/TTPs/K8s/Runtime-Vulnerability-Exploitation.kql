// Name: Kubernetes - Potential Container Runtime File Overwrite
// Author: RW
// Date: 2025-08-11
// Description: Detects attempts to modify or overwrite critical container runtime binaries on a host, such as 'runc'.
//              This is a key indicator of a container escape attempt, notably associated with vulnerabilities like CVE-2019-5736.
//              Legitimate updates to these files should only be performed by system package managers (e.g., yum, apt).
//              Any other process modifying these files is highly suspicious.
// False Positive Sensitivity: Medium. Custom update scripts or configuration management tools might perform legitimate modifications.
// Exclude known legitimate processes or parent processes if they cause noise in your environment.
// MITRE TTPs: T1611 (Escape to Host), T1068 (Exploitation for Privilege Escalation)

// Define sensitive container runtime binary paths.
let sensitive_binaries = dynamic([
    "/usr/bin/runc",
    "/usr/sbin/runc",
    "/bin/runc",
    "/sbin/runc",
    "/var/lib/docker/runc",
    "/usr/bin/containerd-shim",
    "/usr/bin/containerd-shim-runc-v1",
    "/usr/bin/containerd-shim-runc-v2"
]);
// Define legitimate processes that are allowed to modify these binaries.
let legitimate_updaters = dynamic([
    "yum",
    "dnf",
    "apt",
    "apt-get",
    "dpkg",
    "unattended-upgr",
    "rpm"
]);
// This detection requires an EDR agent like Defender for Endpoint or Sysmon on the Kubernetes nodes.
// Using DeviceFileEvents as an example table from Defender for Endpoint.
DeviceFileEvents
// Look for file creation or rename events which indicate a write/overwrite.
| where ActionType in ("FileCreated", "FileRenamed")
// Focus on modifications to the specified sensitive runtime binaries.
| where FolderPath in (sensitive_binaries)
// Exclude modifications performed by known, legitimate package managers.
| where not(InitiatingProcessFileName in (legitimate_updaters))
| project
    TimeGenerated,
    DeviceName,
    ActionType,
    ModifiedFile = FolderPath,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    InitiatingProcessParentFileName,
    InitiatingProcessId,
    InitiatingProcessMD5,
    InitiatingProcessSHA1
| extend
    HostName = tostring(split(DeviceName, ".")[0]),
    HostOS = "Linux"
