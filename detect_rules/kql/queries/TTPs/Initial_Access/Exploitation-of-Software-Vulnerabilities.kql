// Name: Suspicious Process Activity from Public-Facing Application
// Author: RW
// Date: 2025-08-20
// Description: Detects when a common public-facing application (like a web server or Java application) either spawns a suspicious
// child process (e.g., a shell) or contains command-line arguments indicative of an exploit attempt, such as those used in the
// Log4j vulnerability. This can indicate a successful exploitation (T1190).
// Tactic: Initial Access
// Technique: T1190 - Exploit Public-Facing Application
// False Positive Sensitivity: Medium

// Define a list of common public-facing application processes.
// This list should be customized for your environment.
let public_facing_apps = dynamic([
    "w3wp.exe", // IIS
    "httpd.exe", // Apache
    "nginx.exe", // NGINX
    "java.exe",
    "javaw.exe",
    "tomcat.exe",
    "tomcat6.exe",
    "tomcat7.exe",
    "tomcat8.exe",
    "tomcat9.exe",
    "node.exe",
    "php-cgi.exe"
]);

// Define suspicious child processes often used for post-exploitation.
let suspicious_child_processes = dynamic([
    "powershell.exe",
    "pwsh.exe",
    "cmd.exe",
    "sh",
    "bash",
    "rundll32.exe",
    "certutil.exe",
    "bitsadmin.exe",
    "whoami.exe",
    "hostname.exe",
    "ipconfig.exe",
    "net.exe",
    "netstat.exe",
    "curl.exe",
    "wget.exe"
]);

// Define command-line patterns indicative of exploits (e.g., Log4Shell).
let exploit_strings = dynamic([
    "jndi:ldap",
    "jndi:rmi",
    "jndi:dns"
]);

// Detect a public-facing app spawning a suspicious child process.
DeviceProcessEvents
| where ActionType == "ProcessCreated"
| where InitiatingProcessFileName in~ (public_facing_apps)
| where FileName in~ (suspicious_child_processes)
// Potential for False Positives: Some applications may legitimately spawn shells for administrative tasks or plugins.
// These should be identified and excluded.
// For example: | where not (InitiatingProcessFileName == "java.exe" and ProcessCommandLine contains "run_backup.bat")
| project
    Timestamp,
    DeviceName,
    ActionType,
    DetectionMethod = "Suspicious Child Process",
    ParentProcessName = InitiatingProcessFileName,
    ParentProcessCommandLine = InitiatingProcessCommandLine,
    ChildProcessName = FileName,
    ChildProcessCommandLine = ProcessCommandLine,
    AccountName,
    ReportId,
    DeviceId
| union (
    // Detect exploit strings in the command line of a public-facing app.
    DeviceProcessEvents
    | where ActionType == "ProcessCreated"
    | where FileName in~ (public_facing_apps)
    | where ProcessCommandLine has_any (exploit_strings)
    | project
        Timestamp,
        DeviceName,
        ActionType,
        DetectionMethod = "Exploit String in Command Line",
        ParentProcessName = InitiatingProcessFileName,
        ParentProcessCommandLine = InitiatingProcessCommandLine,
        ChildProcessName = FileName,
        ChildProcessCommandLine = ProcessCommandLine,
        AccountName,
        ReportId,
        DeviceId
)
