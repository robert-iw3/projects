// Name: AD CS ESC8 Exploitation via NTLM Relay
// Author: RW
// Date: 2025-08-07
// Tactic: Privilege Escalation, Credential Access
// Technique: T1558.004
// False Positive Sensitivity: Medium
// - This detection relies on the correlation of an NTLM authentication and a certificate request.
// - Legitimate certificate auto-enrollment processes might trigger this, although NTLM usage for this is less common and often indicates a misconfiguration.
// !!! It is critical to populate the 'adcs_hosts' list with your Active Directory Certificate Services hosts for this rule to be effective.
//
// Detection Comment Level: Medium

let timeframe = 1h;
let time_window = 2m; // Time window to correlate the NTLM auth and certificate request events.

// !!! This list must be populated with the hostnames of your AD CS servers, especially those with HTTP-based enrollment endpoints.
let adcs_hosts = dynamic([
    "adcs-server-01.corp.local", // Placeholder for an AD CS server
    "ca01.corp.local"            // Placeholder for an AD CS server
]);

// Find successful NTLM authentication events targeting AD CS servers, focusing on machine accounts often used in coercion attacks.
let ntlm_to_adcs = SecurityEvent
| where TimeGenerated > ago(timeframe)
| where Computer in (adcs_hosts)
| where EventID == 4776 // A credential validation event was logged.
| parse-kv EventData as (TargetUserName:string, WorkstationName:string, Status:string, SourceNetworkAddress:string, AuthenticationPackageName:string)
| where AuthenticationPackageName == "NTLM"
| where Status == "0x0" // Successful authentication.
| where TargetUserName endswith "$" // Focus on machine accounts, the typical target of coercion for relay to AD CS.
| project
    AuthTime = TimeGenerated,
    ADCSServer = Computer,
    RelayedAccount = TargetUserName,
    AttackerIP = SourceNetworkAddress,
    VictimWorkstation = WorkstationName;

// Find certificate requests made on the AD CS servers.
let cert_requests = SecurityEvent
| where TimeGenerated > ago(timeframe)
| where Computer in (adcs_hosts)
| where EventID == 4886 // The certificate service received a certificate request.
| parse-kv EventData as (SubjectUserName:string, RequesterName:string, TemplateName:string)
| project
    RequestTime = TimeGenerated,
    ADCSServer = Computer,
    RequestedForAccount = SubjectUserName,
    Requester = RequesterName,
    CertificateTemplate = TemplateName;

// Join the NTLM authentications with the certificate requests to find a relay pattern.
ntlm_to_adcs
| join kind=inner (
    cert_requests
) on $left.ADCSServer == $right.ADCSServer and $left.RelayedAccount == $right.RequestedForAccount
// The core of the detection: the certificate request must happen immediately after the relayed NTLM authentication.
| where RequestTime between (AuthTime .. (AuthTime + time_window))
| project
    timestamp = AuthTime,
    ADCSServer,
    RelayedAccount,
    AttackerIP,
    VictimWorkstation,
    CertificateTemplate,
    Requester,
    RequestTime
| extend
    Description = strcat("Potential AD CS ESC8 NTLM Relay attack detected. Account '", RelayedAccount, "' was authenticated via NTLM from IP '", AttackerIP, "' (likely coerced from '", VictimWorkstation, "') and was immediately used to request certificate '", CertificateTemplate, "' on AD CS server '", ADCSServer, "'. This is indicative of an ESC8 attack leveraging a coerced authentication over an insecure (HTTP) enrollment endpoint."),
    AccountCustomEntity = RelayedAccount,
    HostCustomEntity = ADCSServer,
    IPCustomEntity = AttackerIP
