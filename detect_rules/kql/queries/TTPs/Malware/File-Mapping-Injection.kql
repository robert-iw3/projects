//
// Name: File Mapping Injection via Multiple API Calls
// Author: RW
// Date: 2025-08-02
//
// Description:
// This detection identifies a process performing file mapping injection by calling a specific sequence of Windows APIs (`CreateFileMapping`, `MapViewOfFile`, and `MapViewOfFileNuma2`) within a short timeframe.
// This is a less common process injection technique used by malware, including samples written in Rust, to evade defenses by allocating memory using lesser-known APIs.
//
// MITRE ATT&CK:
// - Tactic: TA0005 - Defense Evasion
// - Technique: T1055.002 - Process Injection: Portable Executable Injection
//
// False Positive Sensitivity: Medium
//
// Note: This query assumes an event source that logs API calls. The field names (e.g., ActionType, AdditionalFields.ApiName)
// may need to be adjusted based on your specific data schema.
//
// Define the time window for correlating the API calls.
let timeWindow = 5m;
// Define the set of normalized APIs that constitute the suspicious behavior.
let targetApis = dynamic(["CreateFileMapping", "MapViewOfFile", "MapViewOfFileNuma2"]);
// To increase fidelity, consider adding the execution API call, e.g., "CreateRemoteThread".
// let targetApis = dynamic(["CreateFileMapping", "MapViewOfFile", "MapViewOfFileNuma2", "CreateRemoteThread"]);
//
// Define a list of known legitimate processes that perform this behavior.
// FP Tuning: This list is a critical tuning point. Add legitimate software from your environment
// that performs similar actions to this list to reduce noise.
let legitimateProcesses = dynamic([
    "example_legit_process.exe"
]);
DeviceEvents
| where TimeGenerated > ago(1d)
// Filter for API call events initiated by a process.
| where ActionType == "ApiCall" and isnotempty(InitiatingProcessId)
// The field containing the API name may vary. Adjust 'tostring(AdditionalFields.ApiName)' as needed.
| extend ApiName = tostring(AdditionalFields.ApiName)
// Normalize API names to catch both ANSI and Unicode versions of CreateFileMapping.
| extend NormalizedApiName = case(
    ApiName in ("CreateFileMappingA", "CreateFileMappingW"), "CreateFileMapping",
    ApiName
  )
| where NormalizedApiName in (targetApis)
// Group API calls by the initiating process within the specified time window.
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    CalledApis = make_set(NormalizedApiName),
    ReportId = any(ReportId),
    InitiatingProcessCommandLine = any(InitiatingProcessCommandLine),
    InitiatingProcessParentFileName = any(InitiatingProcessParentFileName)
    by DeviceId, DeviceName, InitiatingProcessId, InitiatingProcessFileName, bin(TimeGenerated, timeWindow)
// The core detection logic: ensure the process called all the target APIs.
| where array_length(CalledApis) == array_length(targetApis)
// Exclude known legitimate processes to reduce false positives.
| where InitiatingProcessFileName !in (legitimateProcesses)
| project
    StartTime,
    EndTime,
    DeviceName,
    DeviceId,
    InitiatingProcessId,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    InitiatingProcessParentFileName,
    CalledApis,
    ReportId
