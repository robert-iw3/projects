//
// Name: Remote Thread Creation in Common Processes
// Author: RW
// Date: 2025-08-02
//
// Description:
// This detection identifies when a process creates a remote thread in another, commonly targeted process.
// This is a classic process injection technique (T1055.001) used by malware to execute code in the address space of a legitimate process to evade defenses.
// The rule focuses on injection into common Windows or user applications from unexpected source processes.
//
// MITRE ATT&CK:
// - Tactic: TA0005 - Defense Evasion
// - Technique: T1055.001 - Process Injection: Dynamic-link Library Injection
//
// False Positive Sensitivity: Medium
//
// Note: This query uses the 'CreateRemoteThreadApiCall' ActionType from DeviceProcessEvents, which is a high-fidelity signal.
//
// Define the time window for the query.
let timeWindow = 1d;
// Define a list of common processes that are frequently targeted for process injection.
// FP Tuning: You may add or remove processes based on your environment's software.
let suspiciousTargets = dynamic([
    "notepad.exe",
    "explorer.exe",
    "svchost.exe",
    "lsass.exe",
    "winlogon.exe",
    "services.exe",
    "spoolsv.exe",
    "msedge.exe",
    "chrome.exe",
    "firefox.exe",
    "powershell.exe",
    "cmd.exe",
    "rundll32.exe",
    "regsvr32.exe",
    "mspaint.exe",
    "calc.exe"
]);
// Define a list of processes that are known to legitimately create remote threads.
// FP Tuning: This allowlist is the most critical part of tuning. Add your organization's
// security, management, or debugging tools to this list.
let legitimateInitiators = dynamic([
    "csrss.exe",
    "wininit.exe",
    "services.exe",
    "svchost.exe",
    "lsass.exe",
    "MsMpEng.exe",
    "SenseCncProxy.exe",
    "System",
    "smss.exe",
    "conhost.exe",
    "msvsmon.exe",
    "devenv.exe",
    "windbg.exe"
]);
DeviceProcessEvents
| where TimeGenerated > ago(timeWindow)
// Filter for remote thread creation events.
| where ActionType == "CreateRemoteThreadApiCall"
// Ensure the thread is created in a different process, not the process itself.
| where InitiatingProcessId != ProcessId
// FP Tuning: Exclude known legitimate processes that create remote threads.
| where InitiatingProcessFileName !in (legitimateInitiators)
// Focus on injection into common, high-value target processes.
| where FileName in (suspiciousTargets)
// FP Tuning: Exclude specific known-good initiator/target pairs.
// For example, explorer.exe may create threads in svchost.exe for shell extensions.
| where not (InitiatingProcessFileName == "explorer.exe" and FileName == "svchost.exe")
| project
    TimeGenerated,
    DeviceName,
    DeviceId,
    TargetProcessName = FileName,
    TargetProcessId = ProcessId,
    TargetProcessCommandLine = ProcessCommandLine,
    InitiatingProcessFileName,
    InitiatingProcessId,
    InitiatingProcessCommandLine,
    InitiatingProcessParentFileName,
    ReportId
