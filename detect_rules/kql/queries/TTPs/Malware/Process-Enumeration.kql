//
// Name: Suspicious Process Enumeration via Multiple API Calls
// Author: RW
// Date: 2025-08-02
//
// Description:
// This detection identifies a process that enumerates other running processes by calling a specific combination of Windows APIs (`EnumProcesses`, `OpenProcess`, and `GetModuleBaseNameW`) within a short timeframe.
// This behavior is indicative of discovery activity, often preceding process injection or other malicious actions.
// The technique is highlighted in research as being used by malware developed in Rust to identify potential target processes.
//
// MITRE ATT&CK:
// - Tactic: TA0007 - Discovery
//
// False Positive Sensitivity: Medium
//
// Note: This query assumes an event source that logs API calls. The field names (e.g., ActionType, AdditionalFields.ApiName)
// may need to be adjusted based on your specific data schema.
//
// Define the time window for correlating the API calls.
let timeWindow = 5m;
// Define the set of APIs that constitute the suspicious behavior.
let targetApis = dynamic(["EnumProcesses", "OpenProcess", "GetModuleBaseNameW"]);
// Define a list of known legitimate processes that perform process enumeration.
// FP Tuning: This list is a critical tuning point. Add legitimate software from your environment
// that performs process monitoring or management to this list to reduce noise.
let legitimateProcesses = dynamic([
    "taskmgr.exe",
    "procexp.exe",
    "procexp64.exe",
    "perfmon.exe",
    "svchost.exe",
    "MsMpEng.exe",
    "SenseCncProxy.exe",
    "powershell.exe",
    "wmiprvse.exe",
    "explorer.exe"
]);
DeviceEvents
| where TimeGenerated > ago(1d)
// Filter for API call events initiated by a process.
| where ActionType == "ApiCall" and isnotempty(InitiatingProcessId)
// The field containing the API name may vary. Adjust 'tostring(AdditionalFields.ApiName)' as needed.
| extend ApiName = tostring(AdditionalFields.ApiName)
| where ApiName in (targetApis)
// Group API calls by the initiating process within the specified time window.
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    CalledApis = make_set(ApiName),
    ReportId = any(ReportId),
    InitiatingProcessCommandLine = any(InitiatingProcessCommandLine),
    InitiatingProcessParentFileName = any(InitiatingProcessParentFileName)
    by DeviceId, DeviceName, InitiatingProcessId, InitiatingProcessFileName, bin(TimeGenerated, timeWindow)
// The core detection logic: ensure the process called all the target APIs.
| where array_length(CalledApis) == array_length(targetApis)
// Exclude known legitimate processes to reduce false positives.
| where InitiatingProcessFileName !in (legitimateProcesses)
| project
    StartTime,
    EndTime,
    DeviceName,
    DeviceId,
    InitiatingProcessId,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    InitiatingProcessParentFileName,
    CalledApis,
    ReportId
