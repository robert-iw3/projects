// Name: Suspicious File Execution Following Delivery via Trusted Channel
// Description: Detects the execution of a potentially malicious file (e.g., .iso, .zip, .exe) shortly after it was created by a
// browser or email client. This pattern is common in attacks leveraging phishing attachments (T1566.001) or drive-by compromises
// from legitimate but compromised websites (T1189).
// Author: RW
// Date: 2025-08-18
// MITRE TTPs: T1566.001, T1189

// Define suspicious file extensions often used in phishing or drive-by attacks.
let suspicious_extensions = dynamic([".iso", ".img", ".cab", ".zip", ".rar", ".lnk", ".js", ".vbs", ".hta", ".exe", ".scr", ".msi"]);

// Define common delivery applications (browsers and email clients).
let delivery_apps = dynamic(["msedge.exe", "chrome.exe", "firefox.exe", "iexplore.exe", "opera.exe", "brave.exe", "outlook.exe", "thunderbird.exe"]);

// Find suspicious files created by delivery applications.
let suspicious_files_created =
DeviceFileEvents
| where TimeGenerated > ago(1d)
| where ActionType == "FileCreated"
| where InitiatingProcessFileName in (delivery_apps)
// Focus on common drop locations to reduce noise.
| where FolderPath has_any ("Downloads", "AppData\\Local\\Temp", "Outlook\\Content.Outlook")
| where has_any_suffix(FileName, suspicious_extensions)
| where isnotempty(SHA256)
| project FileCreationTime = TimeGenerated, DeviceId, DeviceName, FileName, FolderPath, SHA256, DeliveryApplication = InitiatingProcessFileName;

// Correlate file creation with subsequent execution.
suspicious_files_created
| join kind=inner (
    DeviceProcessEvents
    | where TimeGenerated > ago(1d)
    | where isnotempty(SHA256)
    // FP Filtering: Exclude executables signed by highly trusted publishers. This list may need tuning for your environment.
    | where not(Signer has_any ("Microsoft Corporation", "Google LLC", "Mozilla Corporation") and IsTrusted)
    | project ProcessCreationTime = TimeGenerated, DeviceId, SHA256, ExecutedProcess = FileName, ProcessCommandLine
) on DeviceId, SHA256
// Key correlation: Ensure the process was created shortly after the file was written.
| where ProcessCreationTime >= FileCreationTime and ProcessCreationTime - FileCreationTime < 5m
// Summarize to create a single alert per malicious file.
| summarize
    StartTime = min(ProcessCreationTime),
    EndTime = max(ProcessCreationTime),
    DeliveryApplications = make_set(DeliveryApplication),
    FileNames = make_set(FileName),
    FilePaths = make_set(FolderPath),
    ExecutedProcesses = make_set(ExecutedProcess),
    ProcessCommandLines = make_set(ProcessCommandLine)
    by DeviceName, SHA256
| project
    StartTime,
    EndTime,
    DeviceName,
    SHA256,
    DeliveryApplications,
    FileNames,
    FilePaths,
    ExecutedProcesses,
    ProcessCommandLines
