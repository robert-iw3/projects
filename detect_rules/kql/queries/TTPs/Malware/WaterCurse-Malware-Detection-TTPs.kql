let start_time = ago(1d);
let end_time = now();
// -- Water Curse IOCs --
// Reference: https://www.trendmicro.com/en_us/research/25/f/water-curse.html
let suspiciousDomains = dynamic(["store-eu-par-2.gofile.io", "api.telegram.org", "popcorn-soft.glitch.me", "pastejustit.com", "pastesio.com"]);
let c2IPs = dynamic(["46.101.236.176"]);
let suspiciousFileNames = dynamic(["SearchFilter.exe", "antiDebug.ps1", "disabledefender.ps1"]);
// -- TTP Detections --
// TTP 1: Initial execution via malicious Visual Studio project file (.csproj)
// This stage looks for MSBuild spawning cmd.exe to execute a temporary batch file, which in turn runs a VBScript via cscript.exe.
let TTP_InitialExec =
    DeviceProcessEvents
    | where Timestamp between (start_time..end_time)
    | where InitiatingProcessFileName =~ "MSBuild.exe"
      and FileName =~ "cmd.exe"
      and ProcessCommandLine has_all ("/c", ".exec.cmd")
      and ProcessCommandLine contains "Temp\\MSBuildTemp";
// TTP 2: Defense Evasion via PowerShell to disable Windows Defender and System Restore
let TTP_DefenseEvasion =
    DeviceProcessEvents
    | where Timestamp between (start_time..end_time)
    | where FileName =~ "powershell.exe"
    | where
      // Disabling Defender for the entire C: drive is highly suspicious.
      ProcessCommandLine has_all ("Set-MpPreference", "-ExclusionPath", "'C:\\'")
      // Deleting all volume shadow copies to prevent recovery.
      or ProcessCommandLine has_all ("vssadmin", "delete", "shadows", "/all")
      // Disabling System Restore via registry modification.
      or ProcessCommandLine has_all ("Set-ItemProperty", "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows NT\\SystemRestore", "DisableSR");
// TTP 3: UAC Bypass via ms-settings protocol handler hijack
let TTP_UACBypass =
    DeviceRegistryEvents
    | where Timestamp between (start_time..end_time)
    // This is a known UAC bypass technique that hijacks a registry key to execute code with elevated privileges.
    | where RegistryKey has @"HKCU\Software\Classes\ms-settings\shell\open\command" and (RegistryValueName == "(Default)" or RegistryValueName == "DelegateExecute");
// TTP 4: Persistence via unusually configured Scheduled Task
let TTP_Persistence =
    DeviceProcessEvents
    | where Timestamp between (start_time..end_time)
    | where FileName =~ "schtasks.exe" and ProcessCommandLine has "/create"
    // The actor uses an extremely long duration parameter (9999 hours) or specific task names.
    // Tuning: Legitimate software may create tasks. Filter by the specific command line arguments seen in the campaign.
    | where ProcessCommandLine has "/du 9999:59" or (ProcessCommandLine has "BitLocker Encrypt All Drives" and ProcessCommandLine has @"\OneDriveCloud\taskhostw.exe");
// TTP 5: Data Staging and Reconnaissance
let TTP_StagingAndRecon =
    DeviceProcessEvents
    | where Timestamp between (start_time..end_time)
    | where
      // Looks for 7-Zip running from a non-standard ProgramData path to extract password-protected files.
      (FileName =~ "7z.exe" and FolderPath has @"C:\ProgramData\sevenZip" and ProcessCommandLine has "-p") or
      // Looks for a masqueraded NVIDIA Control Panel executable running from a suspicious path and performing recon.
      (InitiatingProcessFileName =~ "NVIDIA Control Panel.exe" and InitiatingProcessFolderPath has @"\Microsoft\Vault\UserRoamingTiles\NVIDIAContainer" and FileName in~ ("curl.exe", "wmic.exe", "tasklist.exe"));
// TTP 6: Malicious File Artifacts Creation
let TTP_FileArtifacts =
    DeviceFileEvents
    | where Timestamp between (start_time..end_time)
    // Looks for the creation of files specific to this campaign in their respective paths.
    | where (FolderPath has @"\.vs-script\" and FileName in~ (suspiciousFileNames))
      or (FolderPath contains @"\AppData\Local\Temp\" and FileName =~ "SearchFilter.exe")
      or (FolderPath has @"\Microsoft\Vault\UserRoamingTiles\NVIDIAContainer" and FileName =~ "NVIDIA Control Panel.exe");
// TTP 7: C2 and Exfiltration Network Activity
let TTP_Network =
    DeviceNetworkEvents
    | where Timestamp between (start_time..end_time)
    // Looks for connections to known malicious domains/IPs.
    | where RemoteUrl in (suspiciousDomains) or RemoteIP in (c2IPs)
    // RegAsm.exe making network connections is highly anomalous and was observed in this campaign.
    | extend InitiatingProcessFileName = iff(InitiatingProcessFileName =~ "RegAsm.exe", "RegAsm.exe (Suspicious C2)", InitiatingProcessFileName);
// Union all detection logic
union isfuzzy=true
    (TTP_InitialExec | extend Activity="WaterCurse: Initial Execution via MSBuild", Tactic="Execution", Technique="T1129"),
    (TTP_DefenseEvasion | extend Activity="WaterCurse: Defense Evasion via PowerShell", Tactic="Defense Evasion", Technique="T1562.001"),
    (TTP_UACBypass | extend Activity="WaterCurse: UAC Bypass via ms-settings Hijack", Tactic="Privilege Escalation", Technique="T1548.002"),
    (TTP_Persistence | extend Activity="WaterCurse: Persistence via Scheduled Task", Tactic="Persistence", Technique="T1053.005"),
    (TTP_StagingAndRecon | extend Activity="WaterCurse: Staging and Reconnaissance", Tactic="Collection", Technique="T1560"),
    (TTP_FileArtifacts | extend Activity="WaterCurse: Malicious File Artifact Creation", Tactic="Initial Access", Technique="T1195.002"),
    (TTP_Network | extend Activity="WaterCurse: C2/Exfiltration Network Connection", Tactic="Command and Control", Technique="T1071")
| project Timestamp, DeviceName, Activity, Tactic, Technique, InitiatingProcessFileName, InitiatingProcessCommandLine, FileName, ProcessCommandLine, FolderPath, RegistryKey, RemoteUrl, RemoteIP
