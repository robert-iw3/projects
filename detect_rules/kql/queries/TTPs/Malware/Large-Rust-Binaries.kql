//
// Name: Suspicious Large Unsigned Executable Created
// Author: RW
// Date: 2025-08-02
//
// Description:
// This rule detects the creation of an unusually large executable file that is not digitally signed.
// Malware developed in languages like Rust or Go often results in large, statically-linked binaries.
// While file size alone is a weak indicator, combining it with other heuristics like the absence of a digital signature
// and creation in a non-standard location can indicate a potentially malicious or evasive tool.
//
// MITRE ATT&CK:
// - Tactic: TA0005 - Defense Evasion
//
// False Positive Sensitivity: Medium
//
// Note: The file size threshold and suspicious paths are critical tuning points.
// Legitimate software installers or updaters can sometimes trigger this rule.
//
// Define the minimum file size in bytes to be considered "large".
let fileSizeThreshold = 15000000; // 15 MB
// Define a list of paths where executables are not typically placed by legitimate installers.
let suspiciousPaths = dynamic([
    "C:\\Users\\",
    "C:\\ProgramData\\",
    "C:\\Windows\\Temp\\",
    "C:\\Temp\\",
    "C:\\Perflogs\\"
]);
// FP Tuning: Add legitimate but large and unsigned applications to this allowlist.
let processAllowlist = dynamic([
    "setup.exe" // Example, add specific installer names if needed.
]);
DeviceFileEvents
| where TimeGenerated > ago(1d)
// Filter for the creation of executable files.
| where ActionType == "FileCreated" and FileName endswith ".exe"
// Core detection logic: File is larger than the defined threshold.
| where FileSize > fileSizeThreshold
// Increase fidelity by focusing on unsigned executables.
| where IsSigned == false
// Further increase fidelity by checking for creation in suspicious/non-standard paths.
| where FolderPath has_any (suspiciousPaths) and not (FolderPath matches regex @'C:\\Users\\[^\\]+\\Downloads')
// Exclude common legitimate but large/unsigned files like installers.
| where FileName !in (processAllowlist)
// Summarize by the file hash to understand its prevalence.
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    DeviceCount = dcount(DeviceId),
    DeviceNames = make_set(DeviceName),
    FilePaths = make_set(FolderPath),
    InitiatingProcesses = make_set(InitiatingProcessFileName)
    by SHA1, FileName, FileSize
// Alert on files with low prevalence in the environment.
| where DeviceCount < 5 // FP Tuning: Adjust this prevalence threshold based on your organization's size.
| project
    StartTime,
    EndTime,
    FileName,
    SHA1,
    FileSize,
    DeviceCount,
    DeviceNames,
    FilePaths,
    InitiatingProcesses
