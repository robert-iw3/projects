// Name: Credential Access Followed by Potential Data Exfiltration
// Author: RW
// Date: 2025-08-24
// Description: Detects when a host that recently had sensitive credential hives (SAM, SECURITY) accessed is subsequently observed sending a
// significant amount of data to a public IP address. This pattern can indicate the exfiltration stage of an attack following credential harvesting.
// MITRE ATT&CK: T1041
// False Positive Sensitivity: Medium

let timeWindow = 15m;
let minExfilDataSize = 500000; // 500 KB - Tune this threshold based on environment norms.

// Define sensitive registry hives targeted for credential access.
let sensitiveHives = dynamic([
    "HKEY_LOCAL_MACHINE\\SAM\\",
    "HKEY_LOCAL_MACHINE\\SECURITY\\"
]);

// FP Mitigation: Processes that are expected to upload large amounts of data.
// Add legitimate corporate backup, file sync, or other high-volume upload tools here.
let exfilToolAllowlist = dynamic([
    "outlook.exe",
    "teams.exe",
    "onedrive.exe",
    "msedge.exe",
    "chrome.exe",
    "firefox.exe",
    "gdrive.exe",
    "dropbox.exe"
]);

// Step 1: Identify devices where sensitive credential hives were accessed by non-SYSTEM accounts.
let credentialAccessEvents = DeviceRegistryEvents
| where RegistryKey has_any (sensitiveHives)
| where InitiatingProcessAccountSid != "S-1-5-18" // Exclude SYSTEM account activity
| summarize AccessTime = min(TimeGenerated), AccessingProcesses = make_set(InitiatingProcessFileName) by DeviceId, DeviceName;

// Step 2: Identify significant outbound data transfers to public IPs.
let exfilEvents = DeviceNetworkEvents
| where ActionType == "ConnectionSuccess"
| where RemoteIPType == "Public"
| where TotalBytesSent > minExfilDataSize
| where InitiatingProcessFileName !in (exfilToolAllowlist)
| project NetworkEventTime = TimeGenerated, DeviceId, InitiatingProcessFileName, InitiatingProcessCommandLine, RemoteIP, RemotePort, TotalBytesSent;

// Step 3: Correlate the credential access with subsequent data exfiltration from the same device.
credentialAccessEvents
| join kind=inner (
    exfilEvents
) on DeviceId
// Ensure the network event happened shortly after the registry access.
| where exfilEvents.NetworkEventTime between (credentialAccessEvents.AccessTime .. (credentialAccessEvents.AccessTime + timeWindow))
| summarize
    StartTime = min(AccessTime),
    EndTime = max(NetworkEventTime),
    TotalDataExfiltratedMB = round(sum(TotalBytesSent) / 1048576.0, 2),
    RemoteIPs = make_set(RemoteIP, 10),
    RemotePorts = make_set(RemotePort, 10)
    by DeviceId,
       DeviceName,
       ExfiltratingProcess = InitiatingProcessFileName,
       ExfiltratingProcessCommandLine = InitiatingProcessCommandLine,
       CredentialAccessProcesses = AccessingProcesses
// FP Mitigation: Review the ExfiltratingProcess. If it's a legitimate admin tool, consider adding it to an allowlist or tuning the minExfilDataSize threshold.
| extend HostName = DeviceName, ProcessName = ExfiltratingProcess, ProcessCommandLine = ExfiltratingProcessCommandLine
