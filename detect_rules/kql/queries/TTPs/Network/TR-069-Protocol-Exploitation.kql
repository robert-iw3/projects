let timeframe = 1d;
// Define the standard port for TR-069 (CPE WAN Management Protocol).
let tr069_port = 7547;
// Define keywords associated with potentially malicious TR-069 commands, such as forcing a firmware update or installing an application.
// The Viasat attack reportedly involved a malicious firmware update.
let suspicious_keywords = dynamic([
    "download",
    "upgrade",
    "install",
    "reboot",
    "factoryreset",
    ".bin",
    ".img"
]);
// Placeholder for known legitimate Auto Configuration Server (ACS) IPs. Traffic from these is expected.
let known_acs_ips = dynamic(["1.2.3.4", "5.6.7.8"]); // Replace with your actual ACS IPs

(union isfuzzy=true
    (
        // Detect suspicious commands or unencrypted traffic from network events logs.
        DeviceNetworkEvents
        | where TimeGenerated >= ago(timeframe)
        | where RemotePort == tr069_port
        | where RemoteIP !in (known_acs_ips)
        | where RemoteUrl has_any (suspicious_keywords) or (isnotempty(RemoteUrl) and RemoteUrl startswith "http://")
        | extend
            Reason = case(
                RemoteUrl has_any (suspicious_keywords), "Suspicious TR-069 Command Keyword",
                RemoteUrl startswith "http://", "Unencrypted TR-069 Traffic Detected",
                "Unknown"
            ),
            Account = InitiatingProcessAccountName,
            Host = DeviceName,
            RequestURL = RemoteUrl,
            Process = InitiatingProcessFileName
    ),
    (
        // Detect suspicious commands or unencrypted traffic from firewall/proxy logs.
        CommonSecurityLog
        | where TimeGenerated >= ago(timeframe)
        | where DestinationPort == tr069_port
        | where SourceIP !in (known_acs_ips)
        | where RequestURL has_any (suspicious_keywords) or (isnotempty(RequestURL) and RequestURL startswith "http://")
        | extend
            Reason = case(
                RequestURL has_any (suspicious_keywords), "Suspicious TR-069 Command Keyword",
                RequestURL startswith "http://", "Unencrypted TR-069 Traffic Detected",
                "Unknown"
            ),
            Account = SourceUserID,
            Host = SourceHostName,
            IP = SourceIP
    )
)
// False Positive Tuning: Legitimate device management uses this protocol.
// The query already attempts to filter out traffic from known management servers (ACS).
// You may need to tune the 'suspicious_keywords' list based on your environment's legitimate management scripts.
| project
    TimeGenerated,
    Host,
    Account,
    Process,
    IP,
    DestinationIP,
    DestinationPort,
    RequestURL,
    Reason
