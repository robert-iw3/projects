// Name: CVE-2025-50154 LNK Abuse Activity Chain
// Author: RW
// Date: 2025-08-13
// Description: This is a consolidated query that detects multiple stages of the CVE-2025-50154 exploit chain. It looks for:
// 1) The creation of a malicious LNK file via PowerShell pointing to a remote resource.
// 2) Network connections from explorer.exe to remote SMB shares, which can indicate NTLM credential leakage or payload download.
// 3) The creation of executable files by explorer.exe in temporary directories, indicating a successfully staged payload.
// Correlating these events on a single host provides a high-confidence indicator of compromise.
// False Positive Sensitivity: Medium
// Tags: T1204.002, T1566.001, T1187, T1021.002, CVE-2025-50154

(
// Part 1: Detects PowerShell creating a .LNK file with a remote path. This is the initial setup for the exploit.
DeviceEvents
| where ActionType == "PowerShellCommand"
| where PowerShellCommand has "WScript.Shell" and PowerShellCommand has "CreateShortcut"
| where PowerShellCommand matches regex @'(\.TargetPath|\.IconLocation)\s*=\s*["\'].*?\\\\'
| extend
    DetectionMethod = "PowerShell LNK Creation with Remote Path",
    Evidence = PowerShellCommand,
    SuspiciousProcess = InitiatingProcessFileName,
    SuspiciousCommandLine = InitiatingProcessCommandLine
| project
    Timestamp, DeviceId, DeviceName, DetectionMethod, Evidence, SuspiciousProcess, SuspiciousCommandLine, AccountName, AccountDomain
)
| union kind=outer (
// Part 2: Detects Explorer.exe connecting to a remote SMB share. This indicates the LNK file was rendered, triggering NTLM auth or a file download.
DeviceNetworkEvents
| where InitiatingProcessFileName =~ "explorer.exe"
| where RemotePort == 445
// This logic detects connections to remote shares for specific file types OR connections to any external (non-private) IP address.
| where (RemoteUrl endswith ".exe" or RemoteUrl endswith ".dll" or RemoteUrl endswith ".ico") or (isnotempty(RemoteIP) and not(ipv4_is_private(RemoteIP)))
| extend
    DetectionMethod = "Explorer.exe SMB Connection for Remote File",
    Evidence = strcat("RemoteUrl: ", RemoteUrl, ", RemoteIP: ", RemoteIP),
    SuspiciousProcess = InitiatingProcessFileName,
    SuspiciousCommandLine = InitiatingProcessCommandLine
| project
    Timestamp, DeviceId, DeviceName, DetectionMethod, Evidence, SuspiciousProcess, SuspiciousCommandLine, AccountName, AccountDomain
)
| union kind=outer (
// Part 3: Detects Explorer.exe creating an executable file in a temp location. This indicates a malicious payload was successfully staged on the host.
DeviceFileEvents
| where ActionType == "FileCreated"
| where InitiatingProcessFileName =~ "explorer.exe"
| where FileName endswith ".exe" or FileName endswith ".dll"
| where FolderPath contains @"\AppData\Local\Temp\" or FolderPath contains @"\AppData\Local\Microsoft\Windows\INetCache\"
| extend
    DetectionMethod = "Explorer.exe Created Executable in Temp Directory",
    Evidence = strcat("File: ", FileName, ", Path: ", FolderPath),
    SuspiciousProcess = InitiatingProcessFileName,
    SuspiciousCommandLine = InitiatingProcessCommandLine
| project
    Timestamp, DeviceId, DeviceName, DetectionMethod, Evidence, SuspiciousProcess, SuspiciousCommandLine, AccountName, AccountDomain
)
