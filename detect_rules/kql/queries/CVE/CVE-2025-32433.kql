// Name: Erlang/OTP SSH Vulnerability Exploitation (CVE-2025-32433)
// Description: Detects potential exploitation of a fictional Erlang/OTP SSH vulnerability (CVE-2025-32433).
// The rule identifies two key patterns associated with this threat:
// 1) Erlang-related processes accepting inbound connections on non-standard SSH ports (e.g., 2222), which is a primary indicator of the exploit attempt, especially in OT networks.
// 2) Erlang-related processes spawning command shells, indicating successful post-exploitation and remote code execution.
// Author: RW
// Date: 2025-08-17
// MITRE ATT&CK:
// - T1190: Exploit Public-Facing Application
// - T1021: Remote Services
// - T1059: Command and Scripting Interpreter
// False Positive Sensitivity: Medium
// - Some legitimate applications built on Erlang/OTP may use SSH on non-standard ports for administrative purposes.
// - Spawning a shell from an Erlang process is highly suspicious but could occur in bespoke management scripts.
// - To reduce false positives, populate the 'ot_subnets' variable with your specific OT network ranges and review any findings for legitimacy.
// References:
// - https://unit42.paloaltonetworks.com/erlang-otp-cve-2025-32433/
// - https://gbhackers.com/erlang-otp-ssh-rce-vulnerability-actively-exploited/

let lookback = 1d;

// --- CONFIGURATION START ---
// Define non-standard SSH ports. Port 2222 is specifically mentioned in intelligence.
let non_standard_ssh_ports = dynamic([2222]);

// Define known Erlang/OTP process names.
let erlang_processes = dynamic(["beam.smp", "beam", "erl", "erlexec"]);

// Define common command shell processes.
let shell_processes = dynamic(["bash", "sh", "zsh", "csh", "ksh", "cmd.exe", "powershell.exe"]);

// Define OT network ranges to focus the detection, as this threat disproportionately affects OT environments.
// This is a placeholder and should be populated with your specific OT network CIDR ranges.
let ot_subnets = dynamic(["10.100.0.0/16", "192.168.50.0/24"]);
// --- CONFIGURATION END ---

union
(
    // Tactic 1: Detect Erlang process listening on a non-standard SSH port
    DeviceNetworkEvents
    | where TimeGenerated > ago(lookback)
    | where ActionType == "InboundConnectionAccepted"
    // Filter for connections to the specified non-standard ports
    | where LocalPort in (non_standard_ssh_ports)
    // Filter for connections handled by a known Erlang process
    | where InitiatingProcessFileName in (erlang_processes)
    // Focus on devices within the defined OT subnets
    | where ipv4_is_in_any_range(LocalIP, ot_subnets)
    | extend
        Activity = "Non-Standard SSH Port Connection to Erlang Process",
        ProcessName = InitiatingProcessFileName,
        ParentProcessName = tostring(InitiatingProcessParentFileName),
        CommandLine = tostring(InitiatingProcessCommandLine)
    | project-reorder
        TimeGenerated,
        Activity,
        DeviceName,
        ProcessName,
        ParentProcessName,
        CommandLine,
        LocalPort,
        RemoteIP,
        RemotePort
),
(
    // Tactic 2: Detect Erlang process spawning a command shell
    DeviceProcessEvents
    | where TimeGenerated > ago(lookback)
    // Filter for the creation of a shell process
    | where FileName in (shell_processes)
    // Filter for a known Erlang process being the parent
    | where InitiatingProcessFileName in (erlang_processes)
    // Focus on devices within the defined OT subnets
    | where ipv4_is_in_any_range(DeviceIP, ot_subnets)
    | extend
        Activity = "Shell Spawned by Erlang Process",
        ProcessName = FileName,
        ParentProcessName = InitiatingProcessFileName,
        CommandLine = ProcessCommandLine
    | project-reorder
        TimeGenerated,
        Activity,
        DeviceName,
        ProcessName,
        ParentProcessName,
        CommandLine
)
