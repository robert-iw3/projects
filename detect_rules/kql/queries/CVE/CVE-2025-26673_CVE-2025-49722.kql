// Name: Win-DoS and Win-DDoS RPC and LDAP Abuse Techniques
// Author: RW
// Date: 2025-08-13
// Tactic: Impact
// Technique: T1498.001 - Endpoint Denial of Service: OS Exhaustion Flood
// Description: This query combines multiple detections for Denial of Service (DoS) and Distributed Denial of Service (DDoS) techniques
//              that abuse Windows RPC and LDAP functionalities, as detailed by SafeBreach research. It identifies high-volume LDAP traffic
//              from DCs (Win-DDoS), excessive RPC bind requests (TorpeDoS), and specific RPC call floods associated with CVE-2025-26673 and CVE-2025-49722.
// False Positives: Legitimate administrative, monitoring, or inventory scanning tools may generate activity that resembles these attacks.
// It is crucial to baseline normal activity and tune the thresholds for each detection module.
// Consider allowlisting known-good scanners or administrative hosts/accounts where applicable.

// Module 1: Win-DDoS - High Volume Outbound LDAP from Domain Controller
let LdapDdos =
    let ConnectionThreshold = 100;
    let TimeFrame = 15m;
    DeviceNetworkEvents
    | where TimeGenerated > ago(TimeFrame)
    // Detects high volume of outbound LDAP/CLDAP from lsass.exe on a DC to a public IP.
    | where ActionType == "ConnectionSuccess" and RemotePort == 389 and InitiatingProcessFileName =~ "lsass.exe" and RemoteIPType == "Public"
    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ActivityCount = count() by TargetDevice = DeviceName, SourceIdentifier = RemoteIP
    | where ActivityCount > ConnectionThreshold
    | project StartTime, EndTime, TargetDevice, SourceIdentifier, ActivityCount, DetectionName = "Win-DDoS: High Volume Outbound LDAP", Description = strcat("Potential Win-DDoS attack participation. Device '", TargetDevice, "' made ", ActivityCount, " outbound LDAP connections to public IP '", SourceIdentifier, "'.");

// Module 2: TorpeDoS - High Volume of RPC Bind Requests
let TorpeDosBind =
    let BindThreshold = 500;
    let TimeFrame = 10m;
    DeviceNetworkEvents
    | where TimeGenerated > ago(TimeFrame)
    // Detects high volume of connections to port 135 (RPC Endpoint Mapper) from a single source.
    | where ActionType == "ConnectionSuccess" and RemotePort == 135 and Protocol == "Tcp"
    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ActivityCount = dcount(ReportId) by TargetDevice = DeviceName, SourceIdentifier = RemoteIP
    | where ActivityCount > BindThreshold
    | project StartTime, EndTime, TargetDevice, SourceIdentifier, ActivityCount, DetectionName = "TorpeDoS: High Volume RPC Bind Requests", Description = strcat("Potential TorpeDoS attack. Source '", SourceIdentifier, "' established ", ActivityCount, " connections to the RPC Endpoint Mapper on '", TargetDevice, "'.");

// Module 3: Win-DDoS - Repeated DsrGetDcNameEx2 RPC Calls
let DsrGetDcNameEx2Flood =
    let Threshold = 20;
    let TimeFrame = 30m;
    DeviceEvents
    | where TimeGenerated > ago(TimeFrame)
    // Detects high volume of DsrGetDcNameEx2 RPC calls to lsass.exe.
    | where ActionType in ("RpcCall", "RpcServerCall") and InitiatingProcessFileName =~ "lsass.exe"
    | where todynamic(AdditionalFields).InterfaceUuid == "12345678-1234-abcd-ef00-01234567cffb" and todynamic(AdditionalFields).Operation == "DsrGetDcNameEx2"
    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ActivityCount = count() by TargetDevice = DeviceName, SourceIdentifier = RemoteIP
    | where ActivityCount > Threshold
    | project StartTime, EndTime, TargetDevice, SourceIdentifier, ActivityCount, DetectionName = "Win-DDoS: DsrGetDcNameEx2 RPC Flood", Description = strcat("Potential Win-DDoS trigger. Source '", SourceIdentifier, "' made ", ActivityCount, " DsrGetDcNameEx2 RPC calls to '", TargetDevice, "'.");

// Module 4: Spike in NetrServerReqChallenge RPC Calls (CVE-2025-26673)
let NetlogonChallengeFlood =
    let Threshold = 500;
    let TimeFrame = 10m;
    DeviceEvents
    | where TimeGenerated > ago(TimeFrame)
    // Detects high volume of NetrServerReqChallenge RPC calls to lsass.exe.
    | where ActionType in ("RpcCall", "RpcServerCall") and InitiatingProcessFileName =~ "lsass.exe"
    | where todynamic(AdditionalFields).InterfaceUuid == "12345678-1234-abcd-ef00-01234567cffb" and (todynamic(AdditionalFields).Operation == "NetrServerReqChallenge" or todynamic(AdditionalFields).Opnum == 4)
    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ActivityCount = count() by TargetDevice = DeviceName, SourceIdentifier = RemoteIP
    | where ActivityCount > Threshold
    | project StartTime, EndTime, TargetDevice, SourceIdentifier, ActivityCount, DetectionName = "Netlogon DoS (CVE-2025-26673)", Description = strcat("Potential Netlogon DoS attack. Source '", SourceIdentifier, "' made ", ActivityCount, " NetrServerReqChallenge RPC calls to '", TargetDevice, "'.");

// Module 5: Excessive RpcEnumPrinters Calls (CVE-2025-49722)
let SpoolerEnumFlood =
    let Threshold = 200;
    let TimeFrame = 10m;
    DeviceEvents
    | where TimeGenerated > ago(TimeFrame)
    // Detects high volume of RpcEnumPrinters calls to spoolsv.exe.
    | where ActionType in ("RpcCall", "RpcServerCall") and InitiatingProcessFileName =~ "spoolsv.exe"
    | where todynamic(AdditionalFields).InterfaceUuid == "12345678-1234-abcd-ef00-0123456789ab" and todynamic(AdditionalFields).Operation == "RpcEnumPrinters"
    | summarize StartTime = min(TimeGenerated), EndTime = max(TimeGenerated), ActivityCount = count() by TargetDevice = DeviceName, SourceIdentifier = RemoteIP, UserName = InitiatingProcessAccountName
    | where ActivityCount > Threshold
    | project StartTime, EndTime, TargetDevice, SourceIdentifier, ActivityCount, DetectionName = "Spooler DoS (CVE-2025-49722)", Description = strcat("Potential Spooler DoS attack by user '", UserName, "' from '", SourceIdentifier, "'. Made ", ActivityCount, " RpcEnumPrinters calls to '", TargetDevice, "'.");

union LdapDdos, TorpeDosBind, DsrGetDcNameEx2Flood, NetlogonChallengeFlood, SpoolerEnumFlood
