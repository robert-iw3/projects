// Name: RomCom Activity Collection (CVE-2025-8088)
// Author: RW
// Date: 2025-08-13
// Description: This query combines multiple detection patterns associated with the RomCom threat group's exploitation of CVE-2025-8088
//              and subsequent post-exploitation activities. It looks for WinRAR path traversal, COM hijacking, anti-analysis techniques,
//              C2 communication, and suspicious WMIC execution.
// False Positive Sensitivity: Medium. This is a composite rule. The sensitivity of individual detections varies.
// Tune by excluding known legitimate processes or domains as needed.
// MITRE TTPs: T1204.002, T1566.001, T1546.015, T1059, T1497, T1071.001, T1047

// Detection 1: WinRAR Path Traversal (CVE-2025-8088)
let WinrarPathTraversal =
DeviceFileEvents
| where InitiatingProcessFileName =~ "winrar.exe"
// Focus on file creation events in the Startup folder or temporary directories.
| where (FolderPath has_all (@"\Microsoft\Windows\Start Menu\Programs\Startup", ".lnk")) or
        (FolderPath has @"\AppData\Local\" and FileName has_any (".exe", ".dll"))
| summarize
    StartTime = min(Timestamp),
    LnkInStartup = countif(FolderPath has_all (@"\Microsoft\Windows\Start Menu\Programs\Startup", ".lnk")),
    PayloadInTemp = countif(FolderPath has @"\AppData\Local\" and FileName has_any (".exe", ".dll")),
    FilePaths = make_set(strcat(FolderPath, FileName)),
    InitiatingProcessCommandLine = any(InitiatingProcessCommandLine)
    by DeviceName, DeviceId, InitiatingProcessId, bin(Timestamp, 2m)
// Correlate LNK creation in Startup with payload drop in temp location.
| where LnkInStartup > 0 and PayloadInTemp > 0
| project
    Timestamp = StartTime,
    DeviceId,
    DeviceName,
    DetectionName = "WinRAR Path Traversal (CVE-2025-8088)",
    Description = strcat("WinRAR created LNK in startup and payload in temp. Files: ", tostring(FilePaths)),
    InitiatingProcessFileName = "winrar.exe",
    InitiatingProcessCommandLine,
    FileName = tostring(FilePaths),
    ProcessCommandLine = "",
    RegistryKey = "",
    RemoteUrl = "";

// Detection 2: RomCom COM Hijacking for Persistence
let ComHijacking =
DeviceRegistryEvents
| where ActionType in ("RegistryKeyCreated", "RegistryValueSet")
// Filter for the specific CLSID associated with the PSFactoryBuffer object hijacked by RomCom.
| where RegistryKey has_all (@"CLSID\{1299CF18-C4F5-4B6A-BB0F-2299F0398E27}", "InprocServer32")
// The malicious payload is a DLL dropped into a temporary user directory.
| where RegistryValueData has @"\AppData\Local\Temp\" and RegistryValueData endswith ".dll"
| project
    Timestamp,
    DeviceId,
    DeviceName,
    DetectionName = "RomCom COM Hijacking",
    Description = strcat("COM Hijacking Detected. Key: ", RegistryKey, ", Value: ", RegistryValueData),
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileName = RegistryValueData,
    ProcessCommandLine = "",
    RegistryKey,
    RemoteUrl = "";

// Detection 3: Suspicious Execution from Temp with RecentDocs Anti-Analysis Check
let RecentDocsCheck =
DeviceProcessEvents
// Look for processes executing from temporary user directories.
| where FolderPath has_any (@"\AppData\Local\Temp\", @"\AppData\Local\") and FileName endswith ".exe"
// Correlate with registry reads of the RecentDocs key by the same process.
| join kind=inner (
    DeviceRegistryEvents
    // This key is checked by malware to see if the machine is actively used, thus not a sandbox.
    | where RegistryKey has @"\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs"
) on $left.ProcessId == $right.InitiatingProcessId and DeviceId
| where right_Timestamp between (left_Timestamp .. (left_Timestamp + 2m))
| summarize
    StartTime = min(left_Timestamp),
    RegistryKeysAccessed = make_set(RegistryKey),
    InitiatingProcessFileName = any(left_InitiatingProcessFileName),
    InitiatingProcessCommandLine = any(left_InitiatingProcessCommandLine)
    by DeviceId, DeviceName, ProcessId, FileName, FolderPath, ProcessCommandLine
| project
    Timestamp = StartTime,
    DeviceId,
    DeviceName,
    DetectionName = "Suspicious Temp Exec with RecentDocs Check",
    Description = strcat("Process ", FileName, " executed from temp and checked RecentDocs registry keys."),
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileName,
    ProcessCommandLine,
    RegistryKey = tostring(RegistryKeysAccessed),
    RemoteUrl = "";

// Detection 4: RomCom C2 Domain Activity
let C2Domains = dynamic([
    "srlaptop.com",
    "campanole.com",
    "melamorri.com",
    "gohazeldale.com"
]);
let C2Activity =
DeviceNetworkEvents
// Look for outbound connections to known RomCom C2 domains.
| where RemoteUrl has_any (C2Domains)
| project
    Timestamp,
    DeviceId,
    DeviceName,
    DetectionName = "RomCom C2 Domain Activity",
    Description = strcat("Network connection to known RomCom C2: ", RemoteUrl),
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileName = "",
    ProcessCommandLine = "",
    RegistryKey = "",
    RemoteUrl;

// Detection 5: RomCom Mythic Agent WMIC Execution
let WmicExecution =
DeviceProcessEvents
// Look for the execution of the Windows Management Instrumentation Command-line utility.
| where FileName =~ "wmic.exe"
| where isnotempty(InitiatingProcessFolderPath)
// Filter for parent processes running from common temporary or user-writable locations.
| where InitiatingProcessFolderPath has_any (
    @"\AppData\Local\Temp\",
    @"\AppData\Local\",
    @"\Users\Public\",
    @"\ProgramData\",
    @"C:\Temp\"
)
| where InitiatingProcessFileName !~ "svchost.exe"
| project
    Timestamp,
    DeviceId,
    DeviceName,
    DetectionName = "RomCom Mythic Agent WMIC Execution",
    Description = strcat("wmic.exe spawned by suspicious parent: ", InitiatingProcessFileName, " in ", InitiatingProcessFolderPath),
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileName,
    ProcessCommandLine,
    RegistryKey = "",
    RemoteUrl = "";

// Union all detection results into a single view
union
    WinrarPathTraversal,
    ComHijacking,
    RecentDocsCheck,
    C2Activity,
    WmicExecution
