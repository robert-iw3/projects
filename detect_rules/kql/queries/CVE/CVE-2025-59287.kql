// Name: Possible CVE-2025-59287 WSUS Exploitation Activity
// Author: RW
// Date: 2025-10-26
// Description: This query detects suspicious child processes and network connections originating from the Windows Server Update Services (WSUS) service process (wsusservice.exe) or the associated IIS worker process (w3wp.exe). This behavior is indicative of post-exploitation activity related to CVE-2025-59287, a remote code execution vulnerability in WSUS. The detection looks for command-line enumeration, encoded PowerShell commands, and data exfiltration to webhook sites.
// References: https://www.huntress.com/blog/exploitation-of-windows-server-update-services-remote-code-execution-vulnerability
// False Positive Sensitivity: Medium
// Tags: CVE-2025-59287, WSUS, RCE, Exfiltration, PowerShell, w3wp.exe, wsusservice.exe

let parentProcesses = dynamic(["wsusservice.exe", "w3wp.exe"]);
let suspiciousKeywords = dynamic([
    "net user /domain",
    "ipconfig /all",
    "webhook.site",
    "iwr -UseBasicParsing",
    "curl.exe"
]);

(union isfuzzy=true
    (
        // Detects suspicious child processes of WSUS/IIS processes
        DeviceProcessEvents
        | where InitiatingProcessFileName in~ (parentProcesses)
            and (
                (FileName =~ "powershell.exe" and (ProcessCommandLine has_any (suspiciousKeywords) or ProcessCommandLine has_any ("-e", "-en", "-enc", "-encodedcommand")))
                or (FileName =~ "cmd.exe" and ProcessCommandLine has_any (suspiciousKeywords))
                or (FileName =~ "curl.exe" and ProcessCommandLine has "webhook.site")
            )
        // FP Tuning: Legitimate administrative scripts might be launched by w3wp.exe or wsusservice.exe.
        // Consider filtering by specific command lines or excluding known good scripts/servers if false positives occur.
        | project
            Timestamp,
            DeviceName,
            DetectionMethod = "Suspicious Child Process",
            ParentProcess = InitiatingProcessFileName,
            ParentProcessCommandLine = InitiatingProcessCommandLine,
            ChildProcess = FileName,
            ChildProcessCommandLine = ProcessCommandLine,
            AccountName,
            AccountDomain,
            ReportId,
            InitiatingProcessId,
            ProcessId
    ),
    (
        // Detects suspicious network connections from WSUS/IIS processes
        DeviceNetworkEvents
        | where InitiatingProcessFileName in~ (parentProcesses)
            and RemoteUrl has "webhook.site"
        // FP Tuning: If your organization uses webhook.site for legitimate purposes from these servers,
        // you may need to add more specific filters or exclude known-good URLs.
        | project
            Timestamp,
            DeviceName,
            DetectionMethod = "Suspicious Network Connection",
            ParentProcess = InitiatingProcessFileName,
            ParentProcessCommandLine = InitiatingProcessCommandLine,
            ChildProcess = "N/A",
            ChildProcessCommandLine = RemoteUrl, // Using RemoteUrl to show the suspicious indicator
            AccountName,
            AccountDomain,
            ReportId,
            InitiatingProcessId,
            ProcessId = InitiatingProcessId
    )
)
