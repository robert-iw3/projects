// Name: High-Volume MongoBleed Activity
// Author: RW
// Date: 2026-01-03
// Description: This rule detects a high volume of suspicious MongoDB connections from a single source IP. A connection is deemed suspicious if it is established and terminated without sending the standard client metadata payload (event ID 51800). This combination of high frequency and missing metadata is a high-fidelity indicator of the MongoBleed (CVE-2025-14847) exploit.
// Tactic: Initial Access
// Technique: T1190, Exploit Public-Facing Application
// References: https://www.wiz.io/blog/mongobleed-cve-2025-14847-exploited-in-the-wild-mongodb
// False Positive Sensitivity: Medium. The threshold for suspicious connections may need tuning. Legitimate clients should always send metadata, so any count greater than zero is anomalous, but a high threshold is used to detect active exploitation attempts.

// Define the time window for analysis.
let timeframe = 10m;
// Define the threshold for the number of suspicious connections from a single IP to trigger an alert.
let suspicious_connection_threshold = 50;
// Define the table containing MongoDB logs. This may need to be changed to match your environment (e.g., CommonSecurityLog, custom table).
let MongoLogs = materialize (union isfuzzy=true CommonSecurityLog, DeviceNetworkEvents, VMConnection
    | where DestinationPort == 27017
    // Add any additional filters for your MongoDB logs here.
    );
MongoLogs
| where TimeGenerated > ago(timeframe)
// The following fields are placeholders. Adjust them to match your schema for connection ID and source IP.
// Example assumes a JSON log format where 'conn' is the connection ID and 'remote' is the source IP.
| extend ConnectionId = tostring(parse_json(AdditionalExtensions).conn), RemoteIp = tostring(parse_json(AdditionalExtensions).remote)
| where isnotempty(ConnectionId) and isnotempty(RemoteIp)
// Focus on the three key events: connection start, connection end, and client metadata.
| where Message has "connection accepted" or Message has "end connection" or EventID == 51800
// Summarize the events for each unique connection to check its state.
| summarize
    startTime = min(TimeGenerated),
    endTime = max(TimeGenerated),
    has_accepted = countif(Message has "connection accepted"),
    has_ended = countif(Message has "end connection"),
    has_metadata = countif(EventID == 51800)
    by ConnectionId, RemoteIp
// A connection is suspicious if it was accepted and ended, but never sent the client metadata payload.
| where has_accepted > 0 and has_ended > 0 and has_metadata == 0
// Count the number of suspicious connections from each source IP.
| summarize
    SuspiciousConnectionCount = count(),
    StartTime = min(startTime),
    EndTime = max(endTime),
    ConnectionIds = make_set(ConnectionId, 100)
    by RemoteIp
// Alert if the count of suspicious connections exceeds the defined threshold.
| where SuspiciousConnectionCount > suspicious_connection_threshold
| project
    StartTime,
    EndTime,
    RemoteIp,
    SuspiciousConnectionCount,
    ConnectionIds