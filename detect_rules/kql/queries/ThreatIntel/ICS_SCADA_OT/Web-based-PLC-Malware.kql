// Name: Web-Based PLC Malware or Exploitation Attempt
// Author: RW
// Date: 2025-08-11
// Description: Detects suspicious web requests to Programmable Logic Controllers (PLCs) that could indicate exploitation
//              of embedded web servers by malware or an attacker. The rule looks for common hacking tools in the User-Agent
//              string and patterns associated with exploits (e.g., directory traversal, command injection) in the URL.
// Tactic: Initial Access, Execution
// Technique: T1190 - Exploit Public-Facing Application
// False Positive Sensitivity: Medium
// - This rule may generate false positives from legitimate vulnerability scanning or administrative scripts.
// - It is CRITICAL to populate the 'plc_ips' list with your assets and the 'authorized_sources' list with any approved scanners or management tools to ensure high fidelity.

let timeframe = 1h;

// **CRITICAL TUNING STEP 1**: Populate this list with the IP addresses of your PLCs that have web interfaces.
// An accurate asset inventory is key to the success of this rule.
let plc_ips = dynamic(["192.168.100.10", "10.10.0.5", "x.x.x.x"]);

// **TUNING REQUIRED**: Add any IPs of authorized vulnerability scanners or management tools that interact with PLC web servers.
let authorized_sources = dynamic(["1.1.1.1", "y.y.y.y"]);

// Define suspicious User-Agent strings associated with scanning and exploitation tools.
let suspicious_user_agents = dynamic([
    "curl",
    "wget",
    "python-requests",
    "nmap",
    "sqlmap",
    "masscan",
    "Go-http-client",
    "zgrab",
    "metasploit"
]);
// Define suspicious patterns in URLs that may indicate an exploitation attempt.
let suspicious_url_patterns = dynamic([
    "../", // Directory Traversal
    "/etc/passwd",
    "win.ini",
    "cmd.exe",
    "/bin/sh",
    "powershell.exe",
    "SELECT", "UNION", "--", // Basic SQLi
    "<script>", "%3Cscript%3E", // Basic XSS
    "rce.php", "shell.php", "upload.php" // Common webshell names
]);

// This rule works best with logs from a Next-Gen Firewall (NGFW) or Web Application Firewall (WAF) forwarded to CommonSecurityLog.
// You may need to adapt field names (e.g., RequestURL -> Url, HttpUserAgent -> UserAgent) for your specific log source.
CommonSecurityLog
| where TimeGenerated > ago(timeframe)
// Filter for traffic destined for a known PLC.
| where DestinationIP in (plc_ips)
// Focus on common web ports. Add others if your PLCs use non-standard ports.
| where DestinationPort in (80, 443, 8000, 8080)
// Ensure we have web request data to analyze.
| where isnotempty(RequestURL) or isnotempty(HttpUserAgent)
// **CRITICAL TUNING STEP 2**: Exclude traffic from authorized sources.
| where not(SourceIP in (authorized_sources))
// Core detection logic: Look for suspicious patterns in the User Agent or the URL.
| where HttpUserAgent has_any (suspicious_user_agents)
    or RequestURL has_any (suspicious_url_patterns)
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    AttemptCount = count(),
    SuspiciousUserAgents = make_set_if(HttpUserAgent, HttpUserAgent has_any (suspicious_user_agents)),
    SuspiciousUrls = make_set_if(RequestURL, RequestURL has_any (suspicious_url_patterns)),
    SourceCountries = make_set(SourceGeoCountry)
    by PlcIP = DestinationIP, SourceIP, RequestMethod
| extend
    timestamp = StartTime,
    HostCustomEntity = PlcIP,
    IPCustomEntity = SourceIP
