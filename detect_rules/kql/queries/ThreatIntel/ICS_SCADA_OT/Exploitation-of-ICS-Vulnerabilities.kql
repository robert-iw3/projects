// Rule Title: Suspicious Child Process of ICS/OT Application
// Description: This rule detects when a known Industrial Control System (ICS) or Operational Technology (OT) application process spawns a suspicious child process, such as a command shell or scripting engine. This behavior is a strong indicator of post-exploitation activity, where an attacker, having exploited a vulnerability in the ICS software, is attempting to gain further control of the host.
// Author: RW
// Date: 2025-08-17
// References:
// - https://cybersecuritynews.com/cisa-releases-six-ics-advisories/
// - https://foxguardsolutions.com/blog/ics-patch-update-february-2024/
// - https://cyble.com/blog/latest-ics-vulnerabilities/
// False Positive Sensitivity: Medium
// - Legitimate administrative or automated scripts related to the ICS application could trigger this alert.
// - It is crucial to tune the 'ics_parent_processes' list to match the specific software used in your environment.
// - Consider adding exclusions for known administrative scripts or specific command lines if they are part of normal operations.
// Detection Comment Level: Medium

// Define known ICS/OT parent processes. This list should be customized for your environment.
let ics_parent_processes = dynamic([
    // Schneider Electric
    "UAGRoot.exe", "Vijeo-Designer.exe", "Citect32.exe", "StruxureWare.exe", "PowerSCADA.exe",
    // Siemens
    "s7oiehsx.exe", "CCMyAsserver.exe", "WinCCExplorer.exe", "S7tgtopx.exe",
    // mySCADA
    "mySCADA.exe", "myPRO.exe",
    // Hitachi Energy / ABB
    "AdvDsopc.exe", "AdvAeSrv.exe",
    // Rockwell / Allen-Bradley
    "RSLinx.exe", "FTView.exe", "LogixDesigner.exe"
]);
// Define suspicious child processes often used for post-exploitation.
let suspicious_child_processes = dynamic([
    "powershell.exe", "pwsh.exe", "cmd.exe", "wscript.exe", "cscript.exe",
    "bitsadmin.exe", "certutil.exe", "rundll32.exe", "sh.exe", "bash.exe"
]);
DeviceProcessEvents
| where TimeGenerated > ago(1d)
// Core Logic: An ICS process spawns a suspicious child process.
| where InitiatingProcessFileName in~ (ics_parent_processes) and FileName in~ (suspicious_child_processes)
// Optional Filter: Scope the detection to known ICS/OT assets to reduce noise from engineering workstations.
// | where DeviceName has "PLC" or DeviceName has "HMI" // Example filter
// Summarize the findings to create a concise alert.
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    SuspiciousChildProcess = make_set(FileName, 5),
    SuspiciousChildProcessCommandLine = make_set(ProcessCommandLine, 5),
    AccountName = take_any(InitiatingProcessAccountName)
    by DeviceName, InitiatingProcessFileName
| extend
    RuleTitle = "Suspicious Child Process of ICS/OT Application",
    Description = strcat(
        "A known ICS/OT process '", InitiatingProcessFileName,
        "' on host '", DeviceName,
        "' spawned a suspicious child process: ", tostring(SuspiciousChildProcess),
        ". This may indicate exploitation of a vulnerability in the ICS software."
    )
