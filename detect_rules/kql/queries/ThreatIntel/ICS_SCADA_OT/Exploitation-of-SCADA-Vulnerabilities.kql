// Name: SCADA Application DLL Hijacking Attempt
// Author: RW
// Date: 2025-08-20
// Description: Detects when a known SCADA/ICS application process loads a DLL from an unusual or user-writable directory.
// This is a strong indicator of a DLL Hijacking attack (T1574.001), often used for privilege escalation (T1068) or persistence on a critical OT asset.
// This aligns with threat patterns involving exploitation of uncontrolled search paths in SCADA software.
// False Positive Sensitivity: Medium. Legitimate but poorly written plugins or helper applications might load DLLs from non-standard paths.
//  It is critical to populate the placeholder lists accurately, especially 'SCADA_Process_List' and 'Legit_SCADA_App_Paths', to match your environment.
// Tactics: Privilege Escalation, Persistence, Defense Evasion
// Techniques: T1068, T1574.001

// --- Tuning Section ---
let timeFrame = 1d;

// Tuning: Populate this list with the hostnames of critical SCADA servers, HMIs, and engineering workstations.
let ICS_Asset_List = dynamic([
    "SCADA_SERVER_01",
    "HMI_STATION_05",
    "ENGINEERING_WS_02",
    "HISTORIAN_DB_SERVER"
]);

// Tuning: Populate this list with the process names of SCADA/ICS software used in your environment.
let SCADA_Process_List = dynamic([
    "RSLinxNG.exe",       // Rockwell
    "FTView.exe",         // Rockwell
    "LogixDesigner.exe",  // Rockwell
    "CCW.exe",            // Rockwell
    "WinCCExplorer.exe",  // Siemens
    "s7epasrvx.exe",      // Siemens
    "view.exe"            // Wonderware/AVEVA
]);

// Tuning: Define legitimate installation paths for your SCADA software to exclude legitimate DLL loads.
let Legit_SCADA_App_Paths = dynamic([
    @"C:\Program Files (x86)\Rockwell Software\",
    @"C:\Program Files\Rockwell Software\",
    @"C:\Program Files\Siemens\",
    @"C:\Program Files (x86)\Common Files\Rockwell",
    @"C:\Program Files (x86)\Wonderware\"
]);

// Define paths that are generally suspicious for a SCADA process to load a DLL from.
let Suspicious_DLL_Paths = dynamic([
    @"C:\Users\",
    @"C:\ProgramData\",
    @"C:\PerfLogs\",
    @"C:\Windows\Temp\",
    @"C:\Temp\"
]);
// --- End of Tuning Section ---

DeviceImageLoadEvents
| where TimeGenerated > ago(timeFrame)
// Filter for events on designated critical ICS assets.
| where DeviceName in~ (ICS_Asset_List)
// Filter for a known SCADA process loading the DLL.
| where InitiatingProcessFileName in~ (SCADA_Process_List)
// Core Logic: The DLL is loaded from a suspicious path AND not from a legitimate application directory or system folder.
| where
    (FolderPath has_any (Suspicious_DLL_Paths))
    or
    (
        not(FolderPath startswith_any (Legit_SCADA_App_Paths))
        and FolderPath !startswith @"C:\Windows\"
    )
// Optional but recommended: Unsigned DLLs are much more likely to be malicious. Consider enabling this for higher fidelity.
// | where IsSigned == false
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    take_any(DeviceName, AccountName, AccountUpn, InitiatingProcessFileName, InitiatingProcessCommandLine, FileName, FolderPath, SHA1),
    HijackEventCount = count()
    by bin(TimeGenerated, 30m), DeviceId, InitiatingProcessId
| extend
    // Map entities for investigation in Microsoft Sentinel.
    HostName = DeviceName,
    AccountUPN = AccountUpn,
    Process = InitiatingProcessFileName,
    CommandLine = InitiatingProcessCommandLine,
    HijackedDLL = FileName,
    HijackedDLLPath = FolderPath
| project-reorder StartTime, EndTime, HostName, AccountUPN, Process, CommandLine, HijackedDLL, HijackedDLLPath, SHA1, HijackEventCount
| extend
    HostCustomEntity = HostName,
    AccountCustomEntity = AccountUPN,
    FileCustomEntity = HijackedDLL,
    ProcessCustomEntity = Process
