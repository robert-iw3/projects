// Name: ICS-Specific Malware Activity
// Description: Detects indicators of ICS-specific malware (like Industroyer, BlackEnergy, Triton) by identifying unauthorized program
// downloads to OT assets or the use of high-risk ICS/OT commands from non-standard sources. Such activity can be a precursor to or part
// of an attempt to impair process control.
// Author: RW
// Date: 2025-08-17
//
// MITRE ATT&CK for ICS Information:
// Tactic: Impair Process Control (TA0103)
// Technique: Program Download (T0843), Unauthorized Command Message (T0861)
//
// False Positive Sensitivity: Medium
//
// Comments:
// This rule requires logs from network security devices (Firewalls, IDS/IPS, Zeek) and/or specialized OT security monitoring platforms (e.g., Dragos, Nozomi, Claroty).
// False positives can occur if the lists of known engineering workstations or OT assets are incomplete.
// Tuning Steps:
// 1. Populate 'ot_network_range' with your specific OT/ICS subnets.
// 2. Populate 'known_engineering_workstations' with the IP addresses of legitimate HMIs, engineering workstations, and servers that manage OT devices.
// 3. Populate 'suspicious_file_extensions' and 'high_risk_commands' based on your environment and known threats.

let ot_network_range = dynamic(["10.10.0.0/16", "192.168.50.0/24"]); // Placeholder: Define your OT subnets.
let known_engineering_workstations = dynamic(["10.0.1.10", "10.0.1.11"]); // Placeholder: Define trusted management hosts.

// Pattern 1: Detects suspicious file downloads to the OT network.
let suspicious_file_extensions = dynamic([".exe", ".dll", ".bin", ".s7p", ".msf", ".out", ".ps1", ".bat"]);
let suspicious_downloads =
    CommonSecurityLog // Assumes firewall or web proxy logs. Use table name for your environment.
    | where isnotempty(DestinationIP) and isnotempty(SourceIP)
    // Traffic is going into the OT network from an untrusted source (e.g., IT network or internet).
    | where ipv4_is_in_any_range(DestinationIP, ot_network_range) and not(ipv4_is_in_any_range(SourceIP, known_engineering_workstations))
    | where isnotempty(RequestURL) or isnotempty(FilePath)
    | extend file_path = iif(isnotempty(RequestURL), RequestURL, FilePath)
    | where file_path has_any (suspicious_file_extensions)
    | extend
        Activity = "Suspicious File Download to OT",
        Technique = "Program Download (T0843)",
        Protocol = column_ifexists("Protocol", "HTTP/S or SMB"),
        Command = "",
        Source = SourceIP,
        Destination = DestinationIP
    | project TimeGenerated, Source, Destination, Activity, Technique, Protocol, Command, file_path;

// Pattern 2: Detects high-risk commands sent from unauthorized systems.
let high_risk_commands = dynamic(["Write Single Coil", "Write Multiple Coils", "Write Single Register", "Write Multiple Registers", "PLC Stop", "S7 Download"]);
let unauthorized_commands =
    OTSecurityData // Assumes a table from an OT security monitoring tool. Use table name for your environment.
    | where isnotempty(SourceIp) and isnotempty(DestinationIp) and isnotempty(Command)
    // Command is sent to an OT device from an untrusted source.
    | where ipv4_is_in_any_range(DestinationIp, ot_network_range) and not(ipv4_is_in_any_range(SourceIp, known_engineering_workstations))
    | where Command in~ (high_risk_commands)
    | extend
        Activity = "Unauthorized High-Risk ICS Command",
        Technique = "Unauthorized Command Message (T0861)",
        Source = SourceIp,
        Destination = DestinationIp,
        file_path = ""
    | project TimeGenerated, Source, Destination, Activity, Technique, Protocol, Command, file_path;

// Combine results from both patterns for a unified alert.
union suspicious_downloads, unauthorized_commands
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    Techniques = make_set(Technique),
    Activities = make_set(Activity),
    Protocols = make_set(Protocol),
    Commands = make_set(Command),
    FilePaths = make_set(file_path)
    by Source, Destination
| extend
    Tactic = "Impair Process Control"
