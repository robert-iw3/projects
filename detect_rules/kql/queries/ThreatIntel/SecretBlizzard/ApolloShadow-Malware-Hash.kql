// Name: ApolloShadow Malware Hash
// Author: RW
// Date: 2025-07-31
// Description: Detects the presence of the ApolloShadow malware on an endpoint based on its known SHA256 hash.
// False Positives: Low. A match on the hash is a high-fidelity indicator of this specific malware.
// References: https://www.microsoft.com/en-us/security/blog/2025/07-31/frozen-in-transit-secret-blizzards-aitm-campaign-against-diplomats/
// MITRE ATT&CK: T1204.002
// Data Sources: Microsoft Defender for Endpoint (DeviceFileEvents, DeviceProcessEvents)

let timeframe = 1d;
let ioc_hash = "13fafb1ae2d5de024e68f2e2fc820bc79ef0690c40dbfd70246bcc394c52ea20";
union DeviceFileEvents, DeviceProcessEvents
| where Timestamp > ago(timeframe)
// Filter for the specific SHA256 hash of the ApolloShadow malware.
| where SHA256 =~ ioc_hash
| summarize
    startTime = min(Timestamp),
    endTime = max(Timestamp),
    count(),
    // Collect distinct values for key fields to provide context.
    FileName = make_set(FileName, 10),
    FilePath = make_set(FolderPath, 10),
    ParentProcess = make_set(InitiatingProcessFileName, 10)
    by
    DeviceName,
    DeviceId,
    SHA256
| project-rename
    endpoint = DeviceName,
    firstTime = startTime,
    lastTime = endTime,
    file_name = FileName,
    file_path = FilePath,
    parent_process = ParentProcess,
    sha256 = SHA256
