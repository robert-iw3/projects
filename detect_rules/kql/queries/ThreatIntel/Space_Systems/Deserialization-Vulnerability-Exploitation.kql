// Name: Potential Deserialization Exploit via Suspicious Child Process
// Author: RW
// Date: 2025-08-18
// Description: Detects when a common Java application process spawns a command shell or other suspicious utility.
// This activity is highly indicative of remote code execution, which can result from exploiting a deserialization vulnerability.
// The CYSAT demo involved exploiting a deserialization flaw in a Java application on a satellite to gain code execution.
// False Positives: Legitimate administrative scripts or application functions might spawn shells.
// It's important to baseline normal application behavior and add exclusions for known benign parent-child relationships or command lines.
// Tags: T1190, T1059, Deserialization, RCE, Java, CYSAT

// Define common Java application server process names. This list may need tuning.
let java_parent_processes = dynamic([
    "java.exe",
    "javaw.exe",
    "tomcat.exe",
    "tomcat8.exe",
    "tomcat9.exe",
    "JBossSvc.exe",
    "wrapper.exe", // Common Java service wrapper
    "prunsrv.exe"  // Procrun, used to run services like Tomcat
]);

// Define suspicious child processes that indicate command execution.
let suspicious_child_processes = dynamic([
    "cmd.exe",
    "powershell.exe",
    "pwsh.exe",
    "sh",
    "bash",
    "zsh",
    "csh",
    "ksh",
    "wget.exe",
    "curl.exe",
    "certutil.exe",
    "bitsadmin.exe",
    "rundll32.exe"
]);

DeviceProcessEvents
| where ActionType == "ProcessCreated"
// Look for a suspicious child process being created.
| where FileName in~ (suspicious_child_processes)
// Check if the parent process is a known Java application server.
| where InitiatingProcessFileName in~ (java_parent_processes)
// Exclude cases where the parent is cmd.exe itself to avoid benign chains like cmd -> java -> cmd
| where InitiatingProcessFileName !~ "cmd.exe"
| project
    TimeGenerated,
    DeviceName,
    ParentProcess = InitiatingProcessFileName,
    ParentProcessCommandLine = InitiatingProcessCommandLine,
    ChildProcess = FileName,
    ChildProcessCommandLine = ProcessCommandLine,
    AccountName,
    ParentProcessId = InitiatingProcessId,
    ChildProcessId = ProcessId
