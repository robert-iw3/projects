// Name: Memory and Resource Exploitation (SPARTA MIRE)
// Author: RW
// Date: 2025-08-15
// Description: Aligned with the SPARTA MIRE (Spacecraft Memory Integrity and Resource Exploitation) threat pattern, this rule
// detects behaviors indicative of memory manipulation or resource exhaustion attacks on endpoints. This includes memory dumping
// of sensitive processes and potential "fork bomb" activity where a process rapidly creates numerous child processes to exhaust system resources.
// Tactic: Impact, Credential Access
// Technique: T1499.003, T1003.001
// False Positive Sensitivity: Medium

let timeframe = 10m;
let fork_bomb_threshold = 100; // Number of child processes created by a single parent in a 1-minute window. Tune for your environment.

// Part 1: Detect potential fork bomb / resource exhaustion activity
let resource_exhaustion =
    DeviceProcessEvents
    | where Timestamp > ago(timeframe)
    | where isnotempty(InitiatingProcessId)
    // FP Mitigation: Exclude common software installers and updaters that can be noisy. Add environment-specific processes.
    | where not(InitiatingProcessFileName has_any ("setup.exe", "installer.exe", "update.exe", "msiexec.exe", "TiWorker.exe", "GoogleUpdate.exe"))
    | summarize ProcessCount = dcount(ProcessId) by bin(Timestamp, 1m), DeviceName, InitiatingProcessFileName, InitiatingProcessCommandLine, InitiatingProcessId, AccountName
    | where ProcessCount > fork_bomb_threshold
    | extend
        DetectionType = "Resource Exhaustion (Fork Bomb)",
        Description = strcat("Process '", InitiatingProcessFileName, "' (PID: ", InitiatingProcessId, ") created ", ProcessCount, " child processes in one minute, potentially indicating a resource exhaustion attack."),
        FileName = InitiatingProcessFileName,
        ProcessCommandLine = InitiatingProcessCommandLine
    | project Timestamp, DeviceName, AccountName, DetectionType, Description, FileName, ProcessCommandLine;

// Part 2: Detect memory dumping of sensitive processes, a proxy for unauthorized memory access
let memory_dumping =
    DeviceProcessEvents
    | where Timestamp > ago(timeframe)
    | where
        // Procdump targeting the LSASS process
        (ProcessVersionInfoOriginalFileName =~ 'procdump.exe' and ProcessCommandLine has 'lsass') or
        // Using comsvcs.dll to dump memory of LSASS
        (ProcessVersionInfoOriginalFileName =~ 'rundll32.exe' and ProcessCommandLine has 'comsvcs.dll' and ProcessCommandLine has 'MiniDump' and ProcessCommandLine contains 'lsass') or
        // PowerShell commands for memory dumping LSASS
        (FileName in~ ('powershell.exe', 'pwsh.exe') and (ProcessCommandLine has 'Out-Minidump' or (ProcessCommandLine has 'Get-Process' and ProcessCommandLine has 'lsass')))
    | extend
        DetectionType = "Memory Dumping",
        Description = strcat("Potential memory dump of a sensitive process detected via command: ", ProcessCommandLine)
    | project Timestamp, DeviceName, AccountName, DetectionType, Description, FileName, ProcessCommandLine;

// Combine the results from both detection types
union resource_exhaustion, memory_dumping
