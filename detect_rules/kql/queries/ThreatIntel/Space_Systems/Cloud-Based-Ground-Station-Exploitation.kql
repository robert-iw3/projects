// Name: Cloud-Based Ground Station Exploitation
// Author: RW
// Date: 2025-08-19
// Description: Detects when a user account designated as high-value (e.g., satellite ground crew) performs sensitive cloud
// management actions from an IP address associated with known threat activity. This could indicate a compromised account is
// being used to manipulate cloud-based ground station services for malicious purposes, such as data exfiltration or command injection.
// Tactic: Credential Access (TA0006), Command and Control (TA0011)
// Technique: T1078.004 (Valid Accounts: Cloud Accounts)
// False Positive Sensitivity: Medium
// Data Source: AzureActivity, ThreatIntelligenceIndicator

// Define the list of high-value users who manage satellite operations.
// Tuning: This list must be populated with the User Principal Names (UPNs) of your satellite operations team.
let satellite_operations_crew = dynamic([
    "alice@contoso.com",
    "bob@contoso.com"
    // Add more user UPNs here
]);
// Define a list of sensitive operations, including specific Azure Orbital actions.
// Tuning: Add or remove operations based on what is considered high-risk in your environment.
let sensitive_cloud_operations = dynamic([
    "Microsoft.Orbital/contactProfiles/write", // Create or Update Contact Profile
    "Microsoft.Orbital/spacecrafts/write",     // Create or Update Spacecraft
    "Microsoft.Orbital/contacts/write",        // Create or Update Contact
    "Microsoft.Orbital/spacecrafts/delete",    // Delete Spacecraft
    "Microsoft.Network/networkSecurityGroups/securityRules/write", // Create or Update NSG Rule
    "Microsoft.Storage/storageAccounts/listkeys/action", // List Storage Account Keys
    "Microsoft.Compute/virtualMachines/runCommand/action" // Run command on VM
]);
AzureActivity
| where TimeGenerated > ago(1d)
// Filter for actions performed by the designated high-value users.
| where Caller in~ (satellite_operations_crew)
// Filter for specific sensitive operations relevant to ground station control or data access.
| where OperationNameValue in~ (sensitive_cloud_operations)
| extend IPCustomEntity = CallerIpAddress
// Join with threat intelligence data to identify if the source IP is known to be malicious.
| join kind=inner (
    ThreatIntelligenceIndicator
    | where Active == true and isnotempty(NetworkIP)
    | extend TI_ip = NetworkIP
) on $left.CallerIpAddress == $right.TI_ip
// Summarize alerts to reduce noise from a single compromised session.
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    Operations = make_set(OperationNameValue),
    ThreatTypes = make_set(ThreatType),
    Descriptions = make_set(Description)
    by
    Caller,
    CallerIpAddress,
    ResourceId
| project
    StartTime,
    EndTime,
    UserPrincipalName = Caller,
    SuspiciousSourceIp = CallerIpAddress,
    AzureResourceId = ResourceId,
    AttemptedOperations = Operations,
    ThreatIntel_ThreatTypes = ThreatTypes,
    ThreatIntel_Descriptions = Descriptions
| extend
    timestamp = StartTime,
    AccountCustomEntity = UserPrincipalName,
    IPCustomEntity = SuspiciousSourceIp
