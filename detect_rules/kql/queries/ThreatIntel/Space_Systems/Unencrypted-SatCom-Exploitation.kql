// Name: Unencrypted Satellite Communication Traffic
// Author: RW
// Date: 2025-08-19
// Description: Detects large volumes of potentially unencrypted network traffic between known ground station assets and satellite gateways.
// This could indicate an adversary exploiting unencrypted RF links for data interception or modification.
// This detection is highly dependent on environmental context and requires careful tuning.
// Tactic: Collection (TA0009), Man-in-the-Middle (T1557)
// False Positive Sensitivity: Medium
// Data Source: CommonSecurityLog (Firewall Logs)

// Define a list of IP addresses for critical ground station assets.
// Tuning: This list must be populated with the IP addresses of your ground station control systems, data processors, and other relevant infrastructure.
let ground_station_ips = dynamic([
    "192.168.1.10",
    "10.100.50.25"
    // Add more ground station IPs here
]);
// Define a list of IP addresses for known satellite gateways or endpoints.
// Tuning: This list should contain the public-facing IPs that ground stations communicate with for satellite operations. This may require coordination with your satellite service provider.
let satellite_gateway_ips = dynamic([
    "203.0.113.100",
    "198.51.100.200"
    // Add more satellite gateway IPs here
]);
// Define a list of ports that are expected to carry encrypted traffic.
// Tuning: Add any custom ports used for encrypted command and control (C2) or telemetry to this list.
let known_encrypted_ports = dynamic([
    443, // HTTPS/TLS
    22,  // SSH/SFTP
    990, // FTPS
    500, // IKE
    4500 // IPsec NAT-T
]);
// Define the threshold for data transfer in bytes over the time window.
// Tuning: Adjust this threshold based on baseline traffic analysis to avoid alerts for normal, low-volume unencrypted traffic (e.g., DNS, NTP).
let data_transfer_threshold = 10485760; // 10 MB
CommonSecurityLog
| where TimeGenerated > ago(1d)
// Filter for traffic between the defined ground stations and satellite gateways.
| where (SourceIP in (ground_station_ips) and DestinationIP in (satellite_gateway_ips)) or (SourceIP in (satellite_gateway_ips) and DestinationIP in (ground_station_ips))
// Filter out traffic on ports known to be encrypted. This is an inference, as not all logs explicitly state encryption status.
| where DestinationPort !in (known_encrypted_ports)
// Summarize data transfer over a 1-hour window to detect significant communication.
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    TotalBytesTransferred = sum(SentBytes + ReceivedBytes),
    DestinationPorts = make_set(DestinationPort),
    SourceSystems = make_set(DeviceName)
    by SourceIP, DestinationIP, bin(TimeGenerated, 1h)
// Alert if the total data transferred over unencrypted ports exceeds the defined threshold.
| where TotalBytesTransferred > data_transfer_threshold
| project
    StartTime,
    EndTime,
    SourceIP,
    DestinationIP,
    DestinationPorts,
    TotalBytesTransferred,
    SourceSystems
| extend
    timestamp = StartTime,
    HostCustomEntity = SourceIP,
    IPCustomEntity = DestinationIP
