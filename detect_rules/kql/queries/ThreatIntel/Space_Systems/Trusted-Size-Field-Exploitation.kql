// name: Satellite Control Application Spawns Suspicious Child Process
// author: RW
// date: 2025-08-18
// description: Detects when a satellite control application spawns a suspicious child process (e.g., a shell or reconnaissance tool)
// shortly after receiving a network connection from an external, non-authorized IP address. This could indicate successful exploitation
// of a vulnerability, such as a trusted size field manipulation, to achieve telecommand (TC) alteration and execute arbitrary commands.
// references: https://www.ndss-symposium.org/wp-content/uploads/2023/02/ndss2023_s25_paper.pdf
// data_source: microsoft_defender_for_endpoint
// false_positive_sensitivity: medium

let timeframe = 1h;
let lookback = 5m; // Time window to correlate network connection and process creation

// --- Configuration ---
// This list must be populated with the process names of your satellite control applications.
let satellite_control_apps = datatable(AppName:string) [
    "tc_handler.exe",
    "sat_control_app.exe",
    "obsw_main" // On-Board Software main process
];

// This list must be populated with authorized external IP addresses (e.g., ground stations, admin networks).
let authorized_ips = datatable(ip_address:string) [
    "203.0.113.10",
    "198.51.100.55",
    "192.0.2.0/24"
];

// List of suspicious child processes that a control application should not normally spawn.
let suspicious_child_processes = datatable(ChildName:string) [
    "bash", "sh", "zsh",
    "cmd.exe", "powershell.exe",
    "whoami.exe", "hostname.exe", "ipconfig.exe", "ifconfig",
    "net.exe", "net1.exe", "netstat.exe",
    "tasklist.exe", "ps.exe",
    "curl.exe", "wget.exe",
    "nmap.exe", "ncat.exe", "nc.exe"
];
// --- End Configuration ---

// Find instances of the satellite control application spawning a suspicious child process.
let suspicious_spawns =
    DeviceProcessEvents
    | where TimeGenerated > ago(timeframe)
    | where InitiatingProcessFileName in (satellite_control_apps)
    | where FileName in (suspicious_child_processes)
    | project
        SpawnTime = TimeGenerated,
        DeviceId,
        DeviceName,
        ParentProcessId = InitiatingProcessId,
        ParentProcessName = InitiatingProcessFileName,
        ChildProcessName = FileName,
        ChildProcessCommandLine = ProcessCommandLine,
        AccountName = InitiatingProcessAccountName;

// Find network connections to the parent processes within the lookback window.
suspicious_spawns
| join kind=inner (
    DeviceNetworkEvents
    | where TimeGenerated > ago(timeframe + lookback)
    | where ActionType == "InboundConnectionAccepted"
    | where InitiatingProcessFileName in (satellite_control_apps)
    | where isnotempty(RemoteIP) and not(ipv4_is_private(RemoteIP))
    | where RemoteIP !in (authorized_ips)
    | project
        ConnectionTime = TimeGenerated,
        DeviceId,
        ParentProcessId = InitiatingProcessId,
        RemoteIP
) on DeviceId, ParentProcessId
// Correlate the timing: the spawn must happen AFTER the connection and within the lookback window.
| where SpawnTime between (ConnectionTime .. (ConnectionTime + lookback))
| summarize
    make_set(RemoteIP),
    arg_max(SpawnTime, *)
    by DeviceId, DeviceName, ParentProcessId, ParentProcessName, ChildProcessName, ChildProcessCommandLine, AccountName
| project-reorder
    SpawnTime,
    DeviceName,
    ParentProcessName,
    ChildProcessName,
    ChildProcessCommandLine,
    AccountName,
    set_RemoteIP
| rename
    SatelliteControlSystem = DeviceName,
    ControlApplication = ParentProcessName,
    SuspiciousChildProcess = ChildProcessName,
    SuspiciousCommandLine = ChildProcessCommandLine,
    User = AccountName,
    UnauthorizedSourceIPS = set_RemoteIP
// FP Mitigation: This detection relies on the accuracy of the 'satellite_control_apps' and 'authorized_ips' lists.
// Legitimate remote administration tools or scripts might spawn processes listed as suspicious.
// Baseline the normal behavior of the control applications. If a legitimate tool spawns 'cmd.exe' for a valid reason,
// consider adding more specific command-line filtering or excluding that specific parent-child relationship.
