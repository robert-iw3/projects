// Name: Potential OpenC3 Cosmos Vulnerability Exploitation
// Author: RW
// Date: 2025-08-15
// Description: Detects potential exploitation attempts against OpenC3 Cosmos, a framework often used in satellite ground systems.
// The rule looks for web requests targeting known OpenC3 paths that also contain indicators of path traversal, command injection, or XSS.
// This activity could represent reconnaissance or an attempt to exploit known vulnerabilities like CVE-2025-28382.
// Tactic: Initial Access
// Technique: T1190 - Exploit Public-Facing Application
// False Positive Sensitivity: Medium. This rule may trigger on legitimate but poorly-formed URLs or aggressive vulnerability scanners.
// Consider adding known scanner IPs to an exclusion list to improve fidelity.
// References:
// - https://github.com/advisories/GHSA-cf8v-5mrc-jv7f
// - https://visionspace.com/openc3-cosmos-a-security-assessment-of-an-open-source-mission-framework/
// - https://vulert.com/vuln-db/pypi-openc3-172070

let lookback = 1h;
// Define known OpenC3 Cosmos paths. This list should be customized to your environment for better accuracy.
let OpenC3Paths = dynamic([
    "/openc3-api/tables",
    "/CmdTlmServer",
    "/ScriptRunner"
]);
// Define common path traversal and web attack indicators.
let AttackIndicators = dynamic([
    "../",
    "..\\",
    "..%2f",
    "..%5c",
    "%2e%2e%2f",
    "/etc/passwd",
    "win.ini",
    "cmd.exe",
    "/bin/sh",
    "<script>",
    "alert(",
    "onload="
]);
// Union of common web log tables
union isfuzzy=true DeviceNetworkEvents, CommonSecurityLog
| where TimeGenerated > ago(lookback)
// Check for a URL/Request field and that it contains a known OpenC3 path
| extend Url = iif(isempty(RequestURL), tostring(parse_url(Url)["Path"]), RequestURL)
| where isnotempty(Url) and Url has_any (OpenC3Paths)
// Check for attack indicators in the URL
| where Url has_any (AttackIndicators)
// FP Tuning: Exclude known vulnerability scanners or trusted IPs if necessary.
// | where RemoteIP !in ("<scanner_ip_1>", "<scanner_ip_2>")
| extend
    // Extract the matched indicators for easier analysis.
    MatchedPath = extract_all(tostring(dynamic_to_json(OpenC3Paths)), Url),
    MatchedPayload = extract_all(tostring(dynamic_to_json(AttackIndicators)), Url)
| project
    TimeGenerated,
    DeviceName,
    Activity = iif(isempty(Activity), "DeviceNetworkEvents", Activity),
    ActionType,
    RemoteIP,
    RemotePort,
    DestinationIP,
    DestinationPort,
    Url,
    MatchedPath,
    MatchedPayload,
    AdditionalFields,
    RequestURL
| extend
    timestamp = TimeGenerated,
    HostName = tostring(split(DeviceName, ".")[0]),
    DvcHostname = DeviceName,
    AccountCustomEntity = RemoteIP
