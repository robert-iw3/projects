// Name: Potential Web Vulnerability Exploitation Leading to Data Exfiltration
// Author: RW
// Date: 2025-08-18
// Description: This rule detects a pattern where a source IP address first receives an HTTP 403 'Forbidden' error, followed by one or
// more successful HTTP 200 'OK' responses that involve a large data transfer from a sensitive-looking URL path. This pattern can indicate
// that an attacker first probed a directory or resource, was denied, and then successfully exploited a vulnerability
// (e.g., authorization bypass, path traversal) to access and exfiltrate data.
// This behavior was observed in the Hack-A-Sat competition where a web vulnerability was used to leak sensitive radio configuration data.
// False Positive Sensitivity: Medium. False positives may occur if a legitimate user is denied access to a resource and then navigates to
// another page that legitimately serves large files (e.g., reports, software downloads).
// Tuning:
// - Adjust the 'exfil_threshold_bytes' value based on baseline traffic. A higher value will reduce noise but may miss smaller exfiltration events.
// - Modify the 'sensitive_path_keywords' list to include terms specific to your critical web applications and data stores.

let timeframe = 1h;
let time_window = 10m;
let exfil_threshold_bytes = 100000; // 100 KB
let sensitive_path_keywords = dynamic(['config', 'setting', 'database', 'db', 'admin', 'backup', 'dump', 'export', 'secret', 'key', 'radio', 'cred', 'token']);

// The query can be adapted for different web log sources like W3CIISLog, AppServiceHTTPLogs, etc. by changing the table name and field names.
CommonSecurityLog
| where TimeGenerated > ago(timeframe)
| where isnotempty(RequestURL) and isnotempty(SourceIP)
// Filter for the relevant status codes to reduce initial dataset size
| where ResponseCode in (200, 403)
// Summarize activity by source IP over a short time window to correlate related requests
| summarize
    StartTime = min(TimeGenerated),
    EndTime = max(TimeGenerated),
    StatusCodes = make_set(ResponseCode),
    // Collect details of successful requests that look suspicious (large response size and sensitive keywords in URL)
    SuspiciousSuccessfulRequests = make_set_if(pack('URL', RequestURL, 'BytesSent', SentBytes), ResponseCode == 200 and SentBytes > exfil_threshold_bytes and RequestURL has_any (sensitive_path_keywords))
    by SourceIP, bin(TimeGenerated, time_window)
// Core detection logic: find sessions with both a 403 error and a suspicious successful request
| where 403 in (StatusCodes) and array_length(SuspiciousSuccessfulRequests) > 0
| project
    StartTime,
    EndTime,
    SourceIP,
    SuspiciousSuccessfulRequests
