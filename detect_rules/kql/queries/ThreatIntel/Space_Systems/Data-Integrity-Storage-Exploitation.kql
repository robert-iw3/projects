// Name: Data Integrity and Storage Exploitation (SPARTA DISE)
// Author: RW
// Date: 2025-08-15
// Description: Aligned with the SPARTA DISE threat pattern, this rule detects activity related to data destruction, manipulation,
// or inhibition of system recovery. This includes deletion of volume shadow copies, clearing of event logs, and mass file
// modification/deletion indicative of ransomware or wiper malware.
// Tactic: Impact, Defense Evasion
// Technique: T1485, T1486, T1490, T1070.001
// False Positive Sensitivity: Medium

let timeframe = 1d;
let mass_file_threshold = 200;
let mass_file_time_window = 5m;

// Part 1: Detect deletion of volume shadow copies (inhibits system recovery)
let shadow_copy_deletion =
    DeviceProcessEvents
    | where Timestamp > ago(timeframe)
    | where ProcessVersionInfoOriginalFileName =~ 'vssadmin.exe'
    | where ProcessCommandLine has 'delete' and ProcessCommandLine has 'shadows'
    | extend
        DetectionType = "Volume Shadow Copy Deletion",
        Description = strcat("Volume shadow copies were deleted by: ", ProcessCommandLine)
    | project Timestamp, DeviceName, AccountName, DetectionType, Description, FileName, ProcessCommandLine, InitiatingProcessFileName;

// Part 2: Detect clearing of critical event logs
let event_log_clearing =
    DeviceProcessEvents
    | where Timestamp > ago(timeframe)
    | where (ProcessVersionInfoOriginalFileName =~ 'wevtutil.exe' and (ProcessCommandLine has 'clear-log' or ProcessCommandLine has 'cl'))
        or (FileName in~ ('powershell.exe', 'pwsh.exe') and ProcessCommandLine has 'Clear-EventLog')
    // FP Mitigation: Exclude known administrative scripts or system maintenance activities.
    | where not (InitiatingProcessFileName has_any ('sccm.exe', 'tanium.exe'))
    | extend
        DetectionType = "Event Log Clearing",
        Description = strcat("System event logs were cleared by: ", ProcessCommandLine)
    | project Timestamp, DeviceName, AccountName, DetectionType, Description, FileName, ProcessCommandLine, InitiatingProcessFileName;

// Part 3: Detect mass file modification or renaming (ransomware/wiper behavior)
let mass_file_activity =
    DeviceFileEvents
    | where Timestamp > ago(timeframe)
    | where ActionType in ("FileRenamed", "FileModified")
    // FP Mitigation: Exclude common system processes, software installers, and backup tools. This list requires tuning.
    | where not(InitiatingProcessFileName in~ ('svchost.exe', 'TiWorker.exe', 'MsMpEng.exe', 'setup.exe', 'msiexec.exe', 'SearchIndexer.exe') or InitiatingProcessFolderPath endswith '\\Windows\\System32\\')
    | summarize
        ActivityCount = count(),
        RenamedCount = countif(ActionType == "FileRenamed"),
        DistinctFolders = dcount(FolderPath)
        by bin(Timestamp, mass_file_time_window), DeviceName, AccountName, InitiatingProcessFileName, InitiatingProcessCommandLine
    // A high number of file renames or modifications across multiple folders is a strong indicator.
    | where ActivityCount > mass_file_threshold and DistinctFolders > 3
    | extend
        DetectionType = "Mass File Modification/Rename",
        Description = strcat("Process '", InitiatingProcessFileName, "' performed ", ActivityCount, " file modification/rename actions across ", DistinctFolders, " folders."),
        FileName = InitiatingProcessFileName,
        ProcessCommandLine = InitiatingProcessCommandLine,
        InitiatingProcessFileName = "" // Field already exists as FileName
    | project Timestamp, DeviceName, AccountName, DetectionType, Description, FileName, ProcessCommandLine, InitiatingProcessFileName;

// Combine results from all detection types
union shadow_copy_deletion, event_log_clearing, mass_file_activity
