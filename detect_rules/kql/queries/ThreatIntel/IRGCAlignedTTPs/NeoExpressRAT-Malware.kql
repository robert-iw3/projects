// Name: NeoExpressRAT Malware Activity
// Author: RW
// Date: 2025-08-08
// Description: Detects potential activity of NeoExpressRAT, a Golang-based backdoor used by Iranian state-sponsored actors in
//              critical infrastructure attacks. This rule looks for behavioral patterns associated with the malware, such as an
//               unsigned executable running from a suspicious public or temporary location that subsequently performs system
//              discovery or initiates external network connections.
// False Positives: Legitimate but unsigned custom applications, administrative tools, or software updaters may be flagged.
// Investigation of the file hash, network destination, and parent process is necessary to determine legitimacy.
// MITRE TTPs: T1083 (File and Directory Discovery), T1059 (Command and Scripting Interpreter), T1003 (OS Credential Dumping)

let suspiciousPaths = dynamic([@"C:\ProgramData\", @"C:\Users\Public\", @"C:\PerfLogs\", @"C:\Windows\Temp\", @"C:\$Recycle.bin\"]);
let discoveryCommands = dynamic(["whoami", "hostname", "systeminfo", "ipconfig", "net user", "net group", "quser", "qwinsta", "tasklist", "sc query", "nltest"]);
// Find unsigned executables running from suspicious locations, which is characteristic of dropped RATs like NeoExpressRAT.
let suspiciousProcesses =
    DeviceProcessEvents
    | where FolderPath has_any (suspiciousPaths)
    | where FileName endswith ".exe"
    | where isempty(Signer)
    | project-rename ProcessTime = TimeGenerated
    | project ProcessTime, DeviceId, DeviceName, AccountName, ProcessGuid, FileName, FolderPath, ProcessCommandLine, SHA256, InitiatingProcessFileName;
// Correlate the suspicious process execution with follow-on discovery or C2 activity.
suspiciousProcesses
| join kind=inner (
    union
    (
        // Look for network connections from the suspicious process to an external IP.
        DeviceNetworkEvents
        | where isnotempty(InitiatingProcessGuid)
        | where RemoteIPType == "Public"
        | extend Activity = "Outbound Network Connection from Suspicious Unsigned Process", Detail = strcat("Connected to ", RemoteIP, ":", RemotePort)
        | project-rename JoinTime = TimeGenerated, JoinProcessGuid = InitiatingProcessGuid
        | project JoinTime, DeviceId, Activity, Detail, JoinProcessGuid
    ),
    (
        // Look for system discovery commands spawned by the suspicious process.
        DeviceProcessEvents
        | where isnotempty(InitiatingProcessGuid)
        | where ProcessCommandLine has_any (discoveryCommands)
        | extend Activity = "System Discovery from Suspicious Unsigned Process", Detail = ProcessCommandLine
        | project-rename JoinTime = TimeGenerated, JoinProcessGuid = InitiatingProcessGuid
        | project JoinTime, DeviceId, Activity, Detail, JoinProcessGuid
    )
) on $left.ProcessGuid == $right.JoinProcessGuid and $left.DeviceId == $right.DeviceId
// Ensure the suspicious activity happens within 5 minutes of the process starting.
| where JoinTime between (ProcessTime .. (ProcessTime + 5m))
// --- FP Tuning ---
// To reduce noise, exclude known legitimate software updaters or admin tools that are unsigned.
// For example:
// | where FileName !in ("legit_tool.exe", "updater.exe")
| summarize
    StartTime = min(ProcessTime),
    EndTime = max(ProcessTime),
    Activities = make_set(Activity),
    Details = make_set(Detail)
    by DeviceName, AccountName, FileName, FolderPath, ProcessCommandLine, SHA256, InitiatingProcessFileName
| extend timestamp = StartTime
