// Name: HanifNet Malware Activity
// Author: RW
// Date: 2025-08-08
// Description: Detects potential activity of HanifNet, a .NET-based backdoor used by Iranian state-sponsored actors.
//              This rule looks for a combination of indicators, including execution from suspicious paths, persistence
//              via scheduled tasks, and unique PDB path artifacts.
// False Positives: Legitimate applications, especially updaters, may be installed in C:\ProgramData and create scheduled tasks.
// Review the process, its signer, and the context of its execution to determine legitimacy.
// MITRE TTPs: T1059 (Command and Scripting Interpreter), T1083 (File and Directory Discovery), T1053.005 (Scheduled Task/Job: Scheduled Task)

let suspiciousPaths = dynamic([@"C:\ProgramData\", @"%APPDATA%"]);
let suspiciousTaskNames = dynamic(["System Update", "Windows Update Service"]);
// The PDB path is a high-fidelity indicator if available in logs.
let pdbIndicator = @"\Hanif\";
(union isouter=true
    (
        DeviceProcessEvents
        // Looks for processes running from common staging directories used by the malware.
        | where FolderPath has_any (suspiciousPaths)
        // The PDB path is a strong indicator of HanifNet. Field name may vary.
        | where ProcessVersionInfoPdbFileName has pdbIndicator
        | extend Tactic = "Execution", Technique = "T1204.002", Activity = "Process Execution with HanifNet PDB Path"
    ),
    (
        DeviceEvents
        // Detects persistence via scheduled task creation.
        | where ActionType == "ScheduledTaskCreated"
        | where AdditionalFields.TaskName has_any (suspiciousTaskNames) and AdditionalFields.TaskContent has_any (suspiciousPaths)
        | extend Tactic = "Persistence", Technique = "T1053.005", Activity = "Suspicious Scheduled Task Creation"
    ),
    (
        DeviceFileEvents
        // Detects the creation of a file with the HanifNet PDB path artifact.
        | where FolderPath has_any (suspiciousPaths)
        | where FilePdbFileName has pdbIndicator
        | extend Tactic = "Execution", Technique = "T1204.002", Activity = "File Creation with HanifNet PDB Path"
    )
)
// --- FP Tuning ---
// To reduce noise from legitimate updaters, consider excluding processes signed by trusted vendors.
// For example:
// | where not(ProcessSigner has_any ("Microsoft Corporation", "Google LLC"))
| project
    TimeGenerated,
    DeviceName,
    AccountName,
    Tactic,
    Technique,
    Activity,
    FileName,
    FolderPath,
    ProcessCommandLine,
    InitiatingProcessFileName,
    SHA256
