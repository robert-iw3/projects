// Name: Wiper Malware Precursor Activity
// Author: RW
// Date: 2025-08-08
// Description: Detects precursor activities commonly associated with wiper malware campaigns, such as those used by
//              threat actors like Handala Hack. This rule looks for two main patterns: 1) Execution of processes from
//              unusual, often world-writable, locations where legitimate software rarely runs. 2) Use of built-in system
//              utilities to inhibit system recovery (e.g., deleting volume shadow copies) or clear evidence
//              (e.g., clearing event logs), which are common preparation steps for data destruction.
// False Positive Sensitivity: Medium
// MITRE ATT&CK: T1485, T1490, T1070.001

// Define unusual execution paths often used by malware droppers and wipers.
let suspicious_paths = dynamic([
    "C:\\PerfLogs\\",
    "C:\\Users\\Public\\",
    "\\Users\\Default\\",
    "\\Windows\\debug\\",
    "\\Windows\\fonts\\",
    "\\Windows\\Media\\",
    "\\Windows\\repair\\",
    "\\Windows\\servicing\\",
    "\\Windows\\Temp\\",
    "\\Temp\\",
    "\\PerfLogs\\",
    "\\Recycle.bin\\"
]);

// Define command-line patterns associated with inhibiting system recovery or clearing evidence.
let destructive_commands = dynamic([
    "vssadmin delete shadows",
    "wevtutil cl",
    "wevtutil.exe cl",
    "bcdedit /set {default} bootstatuspolicy ignoreallfailures",
    "bcdedit /set {default} recoveryenabled no",
    "wbadmin delete catalog -quiet"
]);

// Search for processes executing from suspicious locations.
let suspicious_execution = DeviceProcessEvents
| where FolderPath has_any (suspicious_paths)
// FP Tuning: Exclude known legitimate software that runs from these locations.
// For example: | where not (InitiatingProcessFileName == "legit_updater.exe" and FolderPath has "C:\\Windows\\Temp\\")
| extend Tactic = "Execution from Suspicious Location", TTP = "T1204.002", MatchedPattern=FolderPath;

// Search for processes executing destructive commands.
let destructive_execution = DeviceProcessEvents
| where ProcessCommandLine has_any (destructive_commands)
// FP Tuning: Some admin scripts may perform these actions. Exclude known administrative hosts or scripts.
// For example: | where DeviceName !in ("admin-host-01", "backup-server")
| extend Tactic = "Inhibit System Recovery / Clear Logs", TTP = "T1490/T1070.001", MatchedPattern=ProcessCommandLine;

// Combine the results from both searches.
union suspicious_execution, destructive_execution
| project
    TimeGenerated,
    DeviceName,
    AccountName,
    Tactic,
    TTP,
    FileName,
    ProcessCommandLine,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    MatchedPattern
