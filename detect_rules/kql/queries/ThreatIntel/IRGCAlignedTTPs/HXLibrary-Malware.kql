// Name: HXLibrary Malicious IIS Module Activity
// Author: RW
// Date: 2025-08-08
// Description: Detects suspicious activity related to the installation or loading of potentially malicious IIS modules,
//              a technique used by malware like HXLibrary. HXLibrary was used by Iranian state-sponsored actors in attacks
//              against critical infrastructure. This rule looks for new DLLs created in IIS directories by suspicious processes
//              or the IIS worker process (w3wp.exe) loading modules from non-standard locations.
// False Positives: Legitimate application deployments or updates on an IIS server may trigger this rule.
// Custom applications may use unsigned DLLs or be installed by scripts. Investigation of the file, its signer, and the initiating process context is required.
// MITRE TTPs: T1505.004 (Server Software Component: IIS Components), T1003 (OS Credential Dumping), T1059 (Command and Scripting Interpreter), T1083 (File and Directory Discovery)

let iisPaths = dynamic([@"C:\inetpub\", @"C:\Windows\System32\inetsrv\"]);
let suspiciousInitiators = dynamic(["powershell.exe", "cmd.exe", "wsmprovhost.exe", "certutil.exe", "bitsadmin.exe"]);
union
(
    DeviceFileEvents
    // Looks for new DLLs being written to common IIS directories.
    | where ActionType == "FileCreated" and FileName endswith ".dll" and FolderPath has_any (iisPaths)
    // The creator process is a script interpreter, a web shell, or the IIS process itself (highly suspicious).
    | where InitiatingProcessFileName in (suspiciousInitiators) or InitiatingProcessFileName =~ "w3wp.exe"
    | extend
        Activity = "Suspicious DLL created in IIS directory",
        SuspiciousProcess = InitiatingProcessFileName,
        TargetFile = FileName,
        TargetFolderPath = FolderPath,
        Signer = "", // Field added for schema consistency
        InitiatingProcessCommandLine = "" // Field added for schema consistency
),
(
    DeviceImageLoadEvents
    // Looks for the IIS worker process loading a module.
    | where InitiatingProcessFileName =~ "w3wp.exe"
    // The module is loaded from an unusual path, not the standard IIS or .NET directories.
    | where FolderPath !startswith @"C:\Windows\System32\inetsrv" and FolderPath !startswith @"C:\Windows\assembly" and FolderPath !startswith @"C:\Windows\Microsoft.NET"
    // Further filtering for unsigned or non-Microsoft signed modules can help, but may cause FPs with legitimate custom apps.
    | where not(isnotempty(Signer) and Signer has "Microsoft")
    | extend
        Activity = "IIS worker process loaded module from non-standard path",
        SuspiciousProcess = InitiatingProcessFileName,
        TargetFile = FileName,
        TargetFolderPath = FolderPath
)
// --- FP Tuning ---
// Legitimate application deployments might be flagged.
// Consider excluding known good DLLs, signers, or deployment script processes.
// For example:
// | where TargetFile !in ("my_custom_app.dll")
| project
    TimeGenerated,
    DeviceName,
    Activity,
    SuspiciousProcess,
    InitiatingProcessCommandLine,
    TargetFile,
    TargetFolderPath,
    SHA256,
    Signer
