//
// Name: Storm-2603 SharePoint Exploitation (ToolShell)
//
// Author: RW
//
// Date: 2025-07-31
//
// Description: This query detects suspicious child processes spawned by the Microsoft SharePoint worker process (w3wp.exe), a common indicator of exploitation of vulnerabilities like ToolShell (CVE-2025-49704, CVE-2025-49706, CVE-2025-53770, CVE-2025-53771). It also detects the creation of potential web shells by the same process.
//
// Tactic: Initial Access
//
// Technique: T1190 - Exploit Public-Facing Application
//
// False Positive Sensitivity: Medium
//
// Detection Comment Level: Medium
//
(
// Look for suspicious processes spawned by the SharePoint worker process.
DeviceProcessEvents
| where InitiatingProcessFileName =~ "w3wp.exe"
    and InitiatingProcessFolderPath endswith @"\inetsrv\w3wp.exe"
    // A web server process should not typically spawn command shells or reconnaissance tools.
    and FileName in~ (
        "cmd.exe",
        "powershell.exe",
        "pwsh.exe",
        "whoami.exe",
        "systeminfo.exe",
        "net.exe",
        "net1.exe",
        "quser.exe",
        "qwinsta.exe",
        "tasklist.exe",
        "certutil.exe",
        "bitsadmin.exe",
        "nltest.exe"
    )
// FP Tuning: Legitimate SharePoint administration or custom solutions might spawn command shells.
// Exclude known legitimate command lines or parent-child relationships if they cause noise in your environment.
// For example: | where ProcessCommandLine !contains "legit_script.ps1"
| project
    Timestamp,
    ActivityType = "Suspicious Process Creation by SharePoint",
    DeviceName,
    AccountName,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileName,
    ProcessCommandLine,
    SHA256
)
| union (
// Look for potential web shells being written by the SharePoint worker process.
DeviceFileEvents
| where ActionType == "FileCreated"
    and InitiatingProcessFileName =~ "w3wp.exe"
    and InitiatingProcessFolderPath endswith @"\inetsrv\w3wp.exe"
    // Focus on common web-accessible directories for SharePoint.
    and (
        FolderPath contains @"\inetpub\wwwroot\wss\VirtualDirectories\"
        or FolderPath contains @"\Program Files\Common Files\Microsoft Shared\Web Server Extensions\"
    )
    // Look for common web shell file extensions.
    and FileName has_any (".aspx", ".ashx", ".asmx", ".asp", ".php", ".cer")
// FP Tuning: Some SharePoint operations or updates might create .aspx files.
// Exclude known good file names or paths if necessary.
// For example: | where FileName !in ("known_good_file.aspx")
| project
    Timestamp,
    ActivityType = "Potential Webshell Drop by SharePoint",
    DeviceName,
    AccountName,
    InitiatingProcessFileName,
    InitiatingProcessCommandLine,
    FileName,
    ProcessCommandLine = strcat("File written to ", FolderPath), // Re-using column for context
    SHA256
)
