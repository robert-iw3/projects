// Name: Multi-Stage Docker API Exploitation Campaign
// Author: RW
// Date: 2025-09-09
// Description: This rule identifies a multi-stage attack targeting exposed Docker APIs, as detailed by Akamai research.
// The malware strain aims to establish persistent root access, create a botnet, and perform reconnaissance.
// This rule combines several detection concepts into a single query to provide a broad overview of related malicious activities.
// Tactic: Initial Access, Execution, Persistence, Discovery, Command and Control
// False Positive Sensitivity: Medium. FP notes are included for tuning.

let timeframe = 1d;
union
(
    // Tactic: Initial Access - Detects exploitation of the Docker API to create malicious containers.
    // This part is most effective with logs that parse HTTP requests (e.g., from a WAF, proxy, or Zeek).
    DeviceNetworkEvents
    | where TimeGenerated > ago(timeframe)
    | where ActionType startswith "Network" and RemotePort == 2375
    // FP-Note: Legitimate Docker API usage will trigger this. Filter by known-good source IPs or baseline activity.
    | summarize EstTime = arg_max(TimeGenerated, *) by DeviceName, RemoteIP, LocalIP
    | project
        TimeGenerated = EstTime,
        Tactic = "Initial Access",
        Technique = "Exposed Docker Daemon API",
        Description = strcat("Potential Docker API exploitation attempt on port 2375 from ", RemoteIP),
        DeviceName,
        SourceIP = RemoteIP,
        DestinationIP = LocalIP
),
(
    // Tactic: Execution - Looks for package installers or downloaders common in initial container setup for malware.
    DeviceProcessEvents
    | where TimeGenerated > ago(timeframe)
    | where InitiatingProcessFileName in ("sh", "bash") and (ProcessCommandLine has_all ("apk", "add", "curl") or ProcessCommandLine has_all ("apk", "add", "wget") or ProcessCommandLine has_all ("apk", "add", "tor"))
    | project
        TimeGenerated,
        Tactic = "Execution",
        Technique = "Command and Scripting Interpreter",
        Description = "Suspicious package installation and downloader execution in a container.",
        DeviceName,
        ContainerId,
        ProcessCommandLine
),
(
    // Tactic: Persistence - Modification of sensitive files for persistence (SSH keys, cron).
    DeviceFileEvents
    | where TimeGenerated > ago(timeframe)
    | where ActionType in ("FileCreated", "FileModified")
    | where (FolderPath endswith "/.ssh" and FileName == "authorized_keys") or (FolderPath has_prefix "/etc/cron") or (FolderPath has_prefix "/var/spool/cron")
    | project
        TimeGenerated,
        Tactic = "Persistence",
        Technique = "SSH Authorized Keys or Cron Job",
        Description = "Modification of sensitive files for persistence (SSH keys, cron).",
        DeviceName,
        FilePath,
        InitiatingProcessAccountName
),
(
    // Tactic: Persistence/Defense Evasion - Firewall modification to block competing attackers.
    DeviceProcessEvents
    | where TimeGenerated > ago(timeframe)
    | where FileName in ("firewall-cmd", "iptables") and ProcessCommandLine has_any ("--add-rich-rule", "--reload", "-A INPUT", "-p tcp")
    | project
        TimeGenerated,
        Tactic = "Persistence",
        Technique = "Impair Defenses: Modify Firewall Rule",
        Description = "Firewall modification to block competing attackers or allow C2.",
        DeviceName,
        ProcessCommandLine,
        AccountName = InitiatingProcessAccountName
),
(
    // Tactic: Discovery - Execution of masscan network scanner.
    DeviceProcessEvents
    | where TimeGenerated > ago(timeframe)
    | where FileName =~ "masscan"
    | project
        TimeGenerated,
        Tactic = "Discovery",
        Technique = "Network Service Scanning",
        Description = "Execution of masscan network scanner.",
        DeviceName,
        ProcessCommandLine
),
(
    // Tactic: Discovery/Lateral Movement - Connection attempts to Telnet, Chrome Debug, or Docker API ports.
    DeviceNetworkEvents
    | where TimeGenerated > ago(timeframe)
    | where ActionType startswith "Network" and RemotePort in (23, 9222)
    // FP-Note: Connections to Telnet (23) or Chrome Debug (9222) may be legitimate. Baseline normal activity and focus on anomalous sources.
    | summarize EstTime = arg_max(TimeGenerated, *) by DeviceName, LocalIP, RemoteIP, RemotePort
    | project
        TimeGenerated = EstTime,
        Tactic = "Discovery",
        Technique = "Remote Services",
        Description = strcat("Connection attempt to sensitive port: ", RemotePort),
        DeviceName,
        SourceIP = LocalIP,
        DestinationIP = RemoteIP,
        DestinationPort = RemotePort
),
(
    // Tactic: Command and Control - Tor-related activity detected via DNS.
    DnsEvents
    | where TimeGenerated > ago(timeframe)
    | where Name endswith ".onion"
    | project
        TimeGenerated,
        Tactic = "Command and Control",
        Technique = "Proxy: Tor",
        Description = "DNS query for .onion domain detected.",
        DeviceName,
        Query = Name,
        SourceIP = ClientIP
),
(
    // Tactic: Command and Control - Tor-related activity detected via process execution.
    DeviceProcessEvents
    | where TimeGenerated > ago(timeframe)
    | where FileName =~ "torsocks"
    | project
        TimeGenerated,
        Tactic = "Command and Control",
        Technique = "Proxy: Tor",
        Description = "Execution of torsocks process.",
        DeviceName,
        ProcessCommandLine
)
