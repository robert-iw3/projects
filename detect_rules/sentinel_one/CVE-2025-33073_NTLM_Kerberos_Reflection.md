### NTLM and Kerberos Reflection Vulnerability (CVE-2025-33073)
---

CVE-2025-33073 is a critical logical vulnerability in Windows SMB clients that bypasses existing NTLM reflection mitigations, allowing an authenticated remote attacker to execute arbitrary commands as SYSTEM on machines not enforcing SMB signing. This vulnerability leverages crafted DNS records to trick the SMB client into believing a remote server is localhost, leading to the reuse of SYSTEM tokens for privilege escalation.

Beyond traditional NTLM reflection, this vulnerability extends to Kerberos authentication, where a similar DNS manipulation technique allows for the relay of Kerberos tickets back to the originating host, resulting in SYSTEM-level privileges. This is significant because Kerberos was previously thought to be more resilient to such reflection attacks due to its design.

### Actionable Threat Data
---

Monitor for SMB authentication attempts originating from `lsass.exe` to external or unusual internal IP addresses, especially when SMB signing is not enforced on the target.

Look for DNS queries and resolutions involving highly unusual or malformed hostnames, particularly those containing long alphanumeric strings or `1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA` patterns, as these may indicate an attempt to exploit the vulnerability.

Detect the use of NTLM relaying tools such as `ntlmrelayx.py` or Kerberos relaying tools like `krbrelayx.py` in your environment, which are commonly used in conjunction with this vulnerability.

Alert on successful SMB or Kerberos authentications where the authenticating account is a machine account (e.g., `SRV1$`) but the activity performed (e.g., `SAM hive dumping, service manipulation`) is indicative of SYSTEM-level privileges.

Implement and enforce SMB signing across all Windows machines to prevent NTLM and Kerberos relay attacks, as this mitigation directly addresses the core vulnerability.

### SMB Auth from LSASS to External IP
---
```sql
SELECT
  MIN(eventTime) AS firstTime,
  MAX(eventTime) AS lastTime,
  srcIp,
  dstIp,
  ProcessName,
  User,
  COUNT(*) AS count
FROM network
WHERE
  ProcessName = 'lsass.exe'
  AND dstPort = 445
  AND NOT (dstIp IN ('10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16', '127.0.0.0/8', '::1/128'))
GROUP BY
  srcIp,
  dstIp,
  ProcessName,
  User
```

### DNS Queries with Long Base64-like String (CVE-2025-33073)
---
```sql
SELECT
  MIN(eventTime) AS firstTime,
  MAX(eventTime) AS lastTime,
  srcIp,
  dstIp,
  dnsRequest,
  ProcessName,
  User,
  COUNT(*) AS count
FROM network
WHERE dnsRequest REGEXP '[A-Za-z0-9+/]{20,}={0,2}'
GROUP BY
  srcIp,
  dstIp,
  dnsRequest,
  ProcessName,
  User
```

### Privileged Actions by Machine Account
---
```sql
SELECT
  MIN(eventTime) AS firstTime,
  MAX(eventTime) AS lastTime,
  AgentName,
  User,
  ParentProccessName,
  ProcessName,
  ProcessCmd,
  COUNT(*) AS count
FROM endpoint
WHERE User LIKE '%$'
  AND (
    ProcessName IN ('cmd.exe', 'powershell.exe', 'pwsh.exe')
    OR (ProcessName = 'reg.exe' AND (ProcessCmd LIKE '%save%hklm\\sam%' OR ProcessCmd LIKE '%save%hklm\\system%'))
    OR (ProcessName = 'vssadmin.exe' AND ProcessCmd LIKE '%create%shadow%')
    OR (ProcessName = 'rundll32.exe' AND ProcessCmd LIKE '%comsvcs.dll%MiniDump%')
  )
GROUP BY
  AgentName,
  User,
  ParentProccessName,
  ProcessName,
  ProcessCmd
```

### SMB Signing Disabled
---
```sql
SELECT
  registryValueData,
  MIN(eventTime) AS firstTime,
  MAX(eventTime) AS lastTime,
  AgentName,
  RegistryPath,
  registryValueName
FROM registry
WHERE
  registryValueData = '0'
  AND registryValueName IN ('EnableSecuritySignature', 'RequireSecuritySignature')
  AND (RegistryPath LIKE '%\\LanmanServer\\Parameters' OR RegistryPath LIKE '%\\LanmanWorkstation\\Parameters')
GROUP BY
  AgentName,
  RegistryPath,
  registryValueName
```
