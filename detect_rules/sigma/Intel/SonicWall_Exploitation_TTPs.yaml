title: Threat Patterns Following SonicWall Exploitation
id: 675744f6-e8d5-443c-955d-10c607b5f721
status: experimental
description: >-
  Detects a wide range of attacker techniques observed in post-exploitation activity following the compromise of SonicWall VPN appliances.
  This includes credential dumping, persistence, defense evasion, lateral movement, and data staging.
references:
  - https://www.huntress.com/blog/exploitation-of-sonicwall-vpn?utm_source=twitter&utm_medium=social&utm_campaign=cy25-08-rr-multi-global-broad-all-sonicwall_vpn
author: RW
date: 2025-08-06
tags:
  - attack.credential_access
  - attack.persistence
  - attack.defense_evasion
  - attack.lateral_movement
  - attack.collection
  - attack.impact
  - attack.discovery
  - attack.t1003.003
  - attack.t1021.002
  - attack.t1021.003
  - attack.t1070.004
  - attack.t1087.002
  - attack.t1136.001
  - attack.t1486
  - attack.t1490
  - attack.t1543.003
  - attack.t1562.004
logsource:
  category: process_creation
  product: windows
detection:
  # Credential Access: Dumping NTDS.dit or browser login data
  selection_cred_access:
    - Image|endswith: '\wbadmin.exe'
      CommandLine|contains|all:
        - 'start backup'
        - '-include:C:\Windows\NTDS\NTDS.dit'
    - Image|endswith: '\cmd.exe'
      CommandLine|contains|all:
        - 'copy'
        - '\AppData\Local\Microsoft\Edge\User Data\Default\Login Data'
    - CommandLine|contains: 'Veeam_Dump_Postgresql.ps1'

  # Persistence: Creating new users, adding to privileged groups, or installing SSH
  selection_persistence:
    - Image|endswith:
        - '\net.exe'
        - '\net1.exe'
      CommandLine|contains|all:
        - 'user'
        - '/add'
    - Image|endswith:
        - '\net.exe'
        - '\net1.exe'
      CommandLine|contains|all:
        - 'group'
        - '/add'
    - Image|endswith: '\reg.exe'
      CommandLine|contains|all:
        - 'add'
        - 'HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList'
    - Image|endswith: '\msiexec.exe'
      CommandLine|contains: 'C:\ProgramData\OpenSSHa.msi'

  # Defense Evasion: Deleting volume shadow copies or modifying firewall rules
  selection_defense_evasion:
    - Image|endswith: '\vssadmin.exe'
      CommandLine|contains|all:
        - 'delete'
        - 'shadows'
        - '/all'
    - Image|endswith: '\netsh.exe'
      CommandLine|contains|all:
        - 'advfirewall'
        - 'firewall'
        - 'add rule'
    - Image|endswith:
        - '\powershell.exe'
        - '\pwsh.exe'
      CommandLine|contains: 'Set-MpPreference'

  # Lateral Movement: Remote execution via WMI or WinRM
  selection_lateral_movement:
    ParentImage|endswith:
      - '\wmiprvse.exe'
      - '\wsmprovhost.exe'
    Image|endswith:
      - '\powershell.exe'
      - '\pwsh.exe'
      - '\cmd.exe'

  # Staging & Exfiltration: Using specific tools or commands to archive data
  selection_staging:
    - Image|endswith: '\WinRAR.exe'
      CommandLine|contains|all:
        - ' a '
        - '-ep1'
        - '-scul'
        - '-r0'
    - Image|endswith: '\fzsftp.exe'

  # Impact: Execution of known Akira ransomware variants
  selection_impact:
    - Image|endswith:
        - '\w.exe'
        - '\win.exe'
    - Hashes|contains: 'SHA256=d080f553c9b1276317441894ec6861573fa64fb1fae46165a55302e782b1614d'

  # Discovery: Enumerating domain information
  selection_discovery:
    - Image|endswith: '\nltest.exe'
      CommandLine|contains:
        - '/dclist:'
        - '/domain_trusts'
    - Image|endswith:
        - '\net.exe'
        - '\net1.exe'
      CommandLine|contains|all:
        - 'group'
        - '"Domain admins"'
        - '/dom'

  # Attacker Tools: Execution of known attacker scripts or scanning tools
  selection_tools:
    Image|endswith:
      - '\Advanced_IP_Scanner_2.5.4594.1.exe'
      - '\netscan.exe'
      - '\Advanced_Port_Scanner_2.5.3869.exe'
    CommandLine|contains:
      - 'C:\ProgramData\1.bat'
      - 'C:\ProgramData\2.bat'

  condition: 1 of selection_*
falsepositives:
  - This is a broad rule designed for threat hunting and may generate false positives. Many of the commands detected (e.g., net.exe, wbadmin.exe, vssadmin.exe, netsh.exe) are legitimate administrative tools. Alerts should be correlated with other suspicious activity. It is recommended to baseline normal administrative behavior and tune the rule by excluding known good parent processes, users, or command-line patterns.
level: high
