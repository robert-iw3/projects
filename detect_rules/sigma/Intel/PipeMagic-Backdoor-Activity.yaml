title: PipeMagic Backdoor Activity
description: >-
  Detects various Tactics, Techniques, and Procedures (TTPs) associated with the PipeMagic backdoor framework used by the Storm-2460 threat actor.
references:
    - https://www.microsoft.com/en-us/security/blog/2025/08/18/dissecting-pipemagic-inside-the-architecture-of-a-modular-backdoor-framework/
    - https://securelist.com/pipemagic/117270/
author: RW
date: 2025-08-20
tags:
    - attack.execution
    - attack.defense_evasion
    - attack.command_and_control
    - attack.credential_access
    - attack.t1059
    - attack.t1071.001
    - attack.t1140
    - attack.t1218.010
    - attack.t1003.001
logsource:
    # This is a composite rule and requires multiple log sources.
    # The logic for each selection specifies the required category.
    product: windows
detection:
    # IOC Hashes for PipeMagic components
    # Requires file creation, image load, or process creation events
    selection_hashes:
        Hashes|contains:
            - 'SHA256=dc54117b965674bad3d7cd203ecf5e7fc822423a3f692895cf5e96e83fb88f6a'  # In-memory dropper (trojanized ChatGPT)
            - 'SHA256=4843429e2e8871847bc1e97a0f12fa1f4166baa4735dff585cb3b4736e3fe49e'  # PipeMagic backdoor (unpacked)
            - 'SHA256=297ea881aa2b39461997baf75d83b390f2c36a9a0a4815c81b5cf8be42840fd1'  # PipeMagic network module (unpacked)

    # PipeMagic Named Pipe Creation
    # Requires pipe creation events (e.g., Sysmon Event ID 17)
    selection_pipe:
        category: pipe_created
        PipeName|startswith: '\pipe\1.' # Pipe name format is \\.\pipe\1.<32-char-hex-string>

    # PipeMagic C2 Domain
    # Requires network connection or proxy logs
    selection_c2_domain:
        DestinationHostname|contains:
            - 'aaaaabbbbbbb.eastus.cloudapp.azure.com'
        DestinationIp:
            - '127.0.0.1' # Local testing mode
    selection_c2_port:
        DestinationPort:
            - 443
            - 8082 # Local testing mode

    # PipeMagic C2 HTTP Request Pattern
    # Requires proxy or deep packet inspection logs
    selection_c2_http:
        category: proxy
        cs-method: 'GET'
        c-uri|re: '^/[a-fA-F0-9]{16}$'
        cs-header|contains|all:
            - 'Upgrade: websocket'
            - 'Connection: Upgrade'

    # Initial access using certutil to download payload
    # Requires process creation events
    selection_certutil:
        category: process_creation
        Image|endswith: '\certutil.exe'
        CommandLine|contains|all:
            - '-urlcache'
            - '-f'
        CommandLine|contains:
            - '.tmp'
            - '.dat'
            - '.msbuild'

    # Execution of payload via MSBuild
    # Requires process creation events
    selection_msbuild:
        category: process_creation
        Image|endswith: '\msbuild.exe'
        CommandLine|contains: '.mshi' # Newly observed loader mechanism

    # Credential dumping via LSASS access from a masqueraded process
    # Requires LSASS access events (e.g., Sysmon Event ID 10)
    selection_lsass:
        category: process_access
        TargetImage|endswith: '\lsass.exe'
        SourceImage|endswith: '\dllhost.exe' # Storm-2460 has been observed renaming processes to dllhost.exe for this purpose

    condition: 1 of selection_hashes or selection_pipe or (selection_c2_domain and selection_c2_port) or selection_c2_http or selection_certutil or selection_msbuild or selection_lsass
falsepositives:
    - The named pipe pattern `\pipe\1.` could be generated by legitimate applications, although the full pattern including a 32-character hex string is more specific.
    - certutil.exe is a legitimate Windows utility and can be used for valid certificate and file operations. Filter based on the reputation of the download source if possible.
    - dllhost.exe accessing `lsass.exe` can be legitimate in some scenarios. Investigate the parent process and associated activity.
level: high
