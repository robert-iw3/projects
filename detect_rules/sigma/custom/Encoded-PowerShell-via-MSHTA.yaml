title: MSHTA Spawning PowerShell with Encoded or Compressed Command
id: e50442ad-bc81-435c-a9fd-3d1099179607
status: experimental
description: |
  Detects the execution of a PowerShell process with an encoded or compressed command line, spawned by `mshta.exe`.
  This technique is frequently used by adversaries for stealthy payload delivery and execution, often as a second stage after initial access, bypassing traditional defenses.
  The parent-child relationship of `mshta.exe` -> `powershell.exe` combined with command-line indicators of encoding or compression is a strong indicator of malicious activity.
author: Rob Weber
date: 2025-07-27
tags:
  - attack.execution
  - attack.t1059.001
  - attack.defense_evasion
  - attack.t1218.005
logsource:
  category: process_creation
  product: windows
detection:
  # Detects mshta.exe spawning a PowerShell process
  selection_process:
    ParentImage|endswith: '\mshta.exe'
    Image|endswith:
      - '\powershell.exe'
      - '\pwsh.exe'
  # Looks for keywords related to Base64 decoding or Gzip/Deflate decompression
  selection_keywords:
    CommandLine|contains:
      - 'FromBase64String'
      - 'System.IO.Compression.GzipStream'
      - 'System.IO.Compression.DeflateStream'
  condition: selection_process and 1 of selection_keywords
falsepositives:
  - Legitimate, complex administrative scripts might use these .NET classes for data manipulation. However, being spawned from `mshta.exe` significantly reduces the likelihood of it being benign. Review the HTA source if available.
level: high
