### OPC UA Protocol Cryptographic Vulnerabilities
---

This report details two critical cryptographic vulnerabilities in the OPC UA protocol that can lead to authentication bypass. These flaws, a signing oracle vulnerability over HTTPS and an RSA padding oracle vulnerability, enable attackers to impersonate servers, decrypt traffic, or forge signatures, posing significant risks to industrial control systems.

Recent intelligence confirms that the vulnerabilities discussed in the report have been assigned CVEs (CVE-2024-42512 and CVE-2024-42513) and affect the OPC UA .NET Standard Stack, with Siemens products also confirmed to be vulnerable. This is noteworthy as it provides official recognition and broader impact assessment beyond the initial research.

### Actionable Threat Data
---

Monitor for OPC UA HTTPS traffic anomalies: Look for unusual or excessive CreateSession and ActivateSession requests over HTTPS, especially from unexpected source IPs or to unusual destinations. This could indicate an attacker attempting to exploit the signing oracle vulnerability.

Detect use of deprecated Basic128Rsa15 security policy: Log and alert on any OPC UA communication attempts using the Basic128Rsa15 security policy, as this policy is known to be vulnerable to RSA padding oracle attacks.

Analyze OPC UA error messages for padding oracle indicators: Implement logging and analysis of OPC UA error messages, specifically looking for variations in error descriptions or timing discrepancies that could indicate a padding oracle vulnerability being exploited.

Monitor for repeated authentication failures followed by successful authentication: While not a direct indicator of these specific attacks, a high rate of authentication failures followed by a sudden successful authentication could suggest brute-force attempts or the successful exploitation of an authentication bypass.

Track and alert on changes to OPC UA server configurations: Monitor for unauthorized modifications to OPC UA server configurations, particularly changes related to security policies, endpoint descriptions, or the enabling/disabling of HTTPS transport.

### Splunk
---
```sql
--  Name: Combined OPC UA Threat Detection
--  Author: RW
--  Date: 2025-08-14
--  Description: This is a consolidated Splunk rule that combines multiple detection techniques for threats against OPC UA systems, based on recent vulnerability research. It includes checks for anomalous session requests, use of deprecated cryptography, potential padding oracle attacks, brute-force attempts, and sensitive configuration changes.
--  References: https://www.cisa.gov/news-events/ics-advisories/icsa-25-072-09
--  MITRE TTPs: T1566.001

--  IMPORTANT: This is a complex, multi-part query. For performance, it is HIGHLY recommended to run each section as a separate, scheduled search. This combined rule is provided for completeness but may be slow in large environments. It also relies on specific data sources and field names that MUST be customized for your environment.

--  PREREQUISITES:
--  1. Data sources: Network traffic (firewall, proxy, Zeek), OPC UA application/server logs, and endpoint logs (e.g., Windows Event Logs, Sysmon, or a FIM solution).
--  2. Field Extractions: Consistent field names for source/destination IPs and hosts (`src_ip`, `dest_ip`, `dest_host`, `user`, `url`, etc.) are assumed. Use your CIM data models where possible.
--  3. Tuning: Thresholds for counts and time windows must be tuned to your environment's baseline activity to minimize false positives.


--  MACRO/LOOKUP DEFINITIONS (placeholders for customization):
--  - `opcua_network_logs`: e.g., `(index=proxy OR index=firewall OR sourcetype=zeek:http)`
--  - `opcua_app_logs`: e.g., `(index=opcua OR sourcetype=opcua:log)`
--  - `opcua_endpoint_logs`: e.g., `(index=wineventlog OR index=osquery)`
--  - `opc_ua_config_paths_lookup`: A lookup file containing sensitive OPC UA file and registry paths.


--  ================================================================================
--  Detection 1: OPC UA Excessive Session Requests over HTTPS (CVE-2024-42512)
--  Looks for an anomalously high number of CreateSession/ActivateSession requests.
--  ================================================================================
search `opcua_network_logs` dest_port IN (443, 4843) (url="*CreateSession*" OR url="*ActivateSession*")
| bucket _time span=5m
| stats count by _time, src_ip, dest_ip, dest_host
| where count > 15
| eval rule_name="OPC UA Excessive Session Requests", description="Possible signing oracle attack. " + count + " session requests seen from " + src_ip + " to " + dest_ip + ".", user=null()
| rename dest_host as hostname
| fields _time, rule_name, description, src_ip, dest_ip, hostname, user

--  ================================================================================
--  Detection 2: OPC UA Communication Using Deprecated Basic128Rsa15 Policy
--  Detects use of a weak, deprecated security policy vulnerable to padding oracle attacks.
--  ================================================================================
| append [
    search `opcua_app_logs` "*Basic128Rsa15*"
    | stats values(user) as user by _time, src_ip, dest_ip, host
    | eval rule_name="OPC UA Deprecated Policy Usage", description="Insecure 'Basic128Rsa15' policy used in connection from " + src_ip + " to " + dest_ip + ".", hostname=host
    | fields _time, rule_name, description, src_ip, dest_ip, hostname, user
]

--  ================================================================================
--  Detection 3: Potential OPC UA Padding Oracle Probing Attempt (CVE-2024-42513)
--  Detects a high volume of error messages indicative of padding oracle probing.
--  ================================================================================
| append [
    search `opcua_app_logs` ("error" OR "fail" OR "Bad*" OR "incorrect")
    | bucket _time span=5m
    | stats count by _time, src_ip, dest_ip, dest_host
    | where count > 50
    | eval rule_name="Potential OPC UA Padding Oracle Probe", description="High volume of OPC UA errors (" + count + ") from " + src_ip + " to " + dest_ip + ", possibly indicating a padding oracle attack.", user=null()
    | rename dest_host as hostname
    | fields _time, rule_name, description, src_ip, dest_ip, hostname, user
]

--  ================================================================================
--  Detection 4: OPC UA Brute-Force Followed by Success
--  Detects a high ratio of failed to successful logins from a single source.
--  ================================================================================
| append [
    search `opcua_app_logs`
    | eval auth_result=case(match(_raw, "(?i)success|granted"), "Success", match(_raw, "(?i)fail|denied|BadUserAccessDenied|BadIdentityTokenInvalid"), "Failure")
    | where auth_result IN ("Success", "Failure")
    | bucket _time span=30m
    | stats count(eval(auth_result="Failure")) as failures, count(eval(auth_result="Success")) as successes, values(user) as user by _time, src_ip, dest_ip, dest_host
    | where failures > 10 AND successes > 0
    | eval rule_name="OPC UA Brute-Force Followed by Success", description="Potential brute force from " + src_ip + " with " + failures + " failures and " + successes + " successes. Affected user: " + user
    | rename dest_host as hostname
    | fields _time, rule_name, description, src_ip, dest_ip, hostname, user
]

--  ================================================================================
--  Detection 5: OPC UA Server Configuration Modified
--  Monitors for changes to sensitive OPC UA configuration files or registry keys.
--  ================================================================================
| append [
    search `opcua_endpoint_logs` (EventCode=4657 OR EventCode=4663 OR sourcetype=*-fim)
    | search (
        ObjectName="*\\Kepware\\KEPServerEX\\V6*" OR
        ObjectName="*\\Prosys\\OPC UA Simulation Server*" OR
        file_path="*\\KEPServerEX\\V6\\config.json" OR
        file_path="*\\Ignition\\data\\opcua\\server\\settings.xml" OR
        file_path="*/etc/open62541/server_config.xml"
    )
    | stats values(Account_Name) as win_user, values(user) as fim_user, values(process) as process by _time, host
    | eval user=coalesce(win_user, fim_user)
    | where NOT user IN ("SYSTEM", "*$")
    | eval rule_name="OPC UA Server Configuration Modified", description="Sensitive OPC UA configuration modified on " + host + " by user " + user + " via process " + process + ".", src_ip=null(), dest_ip=null()
    | rename host as hostname
    | fields _time, rule_name, description, src_ip, dest_ip, hostname, user
]

--  ================================================================================
--  Final Formatting
--  ================================================================================
| rename _time as timestamp
| convert ctime(timestamp)
| table timestamp, rule_name, description, src_ip, dest_ip, hostname, user
```

### Crowdstrike
---
```sql
-- Detection 1: OPC UA Excessive Session Requests over HTTPS
event_simpleName="UserModeHttpRequest" + RemotePort IN (443, 4843) + (HttpUrl:"CreateSession" OR HttpUrl:"ActivateSession")
| group by ContextTimeStamp_bin(5m), LocalAddressIP4, RemoteAddressIP4, ComputerName
| count > 15

-- Note: FQL primarily filters; use API to aggregate counts over time windows for optimization.
-- Detection 2: OPC UA Communication Using Deprecated Basic128Rsa15 Policy
event_simpleName="ModuleLoad" OR event_simpleName="ProcessRollup2" + ImageFileName:"opcua" + (CommandLine:"Basic128Rsa15" OR RawProcessId:"Basic128Rsa15")
| group by ContextTimeStamp, LocalAddressIP4, RemoteAddressIP4, ComputerName

-- Detection 3: Potential OPC UA Padding Oracle Probing Attempt
event_simpleName="ProcessRollup2" + ImageFileName:"opcua" + (CommandLine:"error" OR CommandLine:"fail" OR CommandLine:"Bad" OR CommandLine:"incorrect")
| group by ContextTimeStamp_bin(5m), LocalAddressIP4, RemoteAddressIP4, ComputerName
| count > 50

-- Detection 4: OPC UA Brute-Force Followed by Success
event_simpleName="UserLogon" + ImageFileName:"opcua" + (CommandLine:"success" OR CommandLine:"granted" AS Success) OR (CommandLine:"fail" OR CommandLine:"denied" OR CommandLine:"BadUserAccessDenied" OR CommandLine:"BadIdentityTokenInvalid" AS Failure)
| group by ContextTimeStamp_bin(30m), LocalAddressIP4, RemoteAddressIP4, ComputerName
| where Failure_count > 10 AND Success_count > 0

-- Detection 5: OPC UA Server Configuration Modified
event_simpleName="FileCreate" OR event_simpleName="RegistryEvent" + (FilePath:"\Kepware\KEPServerEX\V6" OR FilePath:"\Prosys\OPC UA Simulation Server" OR FilePath:"\KEPServerEX\V6\config.json" OR FilePath:"\Ignition\data\opcua\server\settings.xml" OR FilePath:"/etc/open62541/server_config.xml")
| where UserName NOT IN ("SYSTEM", "$")
| group by ContextTimeStamp, ComputerName
```

### Datadog
---
```sql
-- Detection 1: OPC UA Excessive Session Requests over HTTPS
source:network dest_port:(443 OR 4843) (url:"CreateSession" OR url:"ActivateSession")
| group by time(5m), @src_ip, @dest_ip, @dest_host
| measure count() > 15

-- Detection 2: OPC UA Communication Using Deprecated Basic128Rsa15 Policy
source:opcua_app "Basic128Rsa15"
| group by time, @src_ip, @dest_ip, @host
| facet @user

-- Detection 3: Potential OPC UA Padding Oracle Probing Attempt
source:opcua_app ("error" OR "fail" OR "Bad*" OR "incorrect")
| group by time(5m), @src_ip, @dest_ip, @dest_host
| measure count() > 50

-- Detection 4: OPC UA Brute-Force Followed by Success
source:opcua_app
| process if(match("(?i)success|granted"), "Success") OR if(match("(?i)fail|denied|BadUserAccessDenied|BadIdentityTokenInvalid"), "Failure") AS auth_result
| group by time(30m), @src_ip, @dest_ip, @dest_host
| measure count(Failure) AS failures, count(Success) AS successes, unique(@user)
| filter failures > 10 AND successes > 0

-- Detection 5: OPC UA Server Configuration Modified
source:endpoint (EventCode:(4657 OR 4663) OR source:fim)
| filter (ObjectName:"\Kepware\KEPServerEX\V6" OR ObjectName:"\Prosys\OPC UA Simulation Server" OR file_path:"\KEPServerEX\V6\config.json" OR file_path:"\Ignition\data\opcua\server\settings.xml" OR file_path:"/etc/open62541/server_config.xml")
| group by time, @host
| facet @Account_Name
 AS win_user, @user
 AS fim_user, @process
| process coalesce(win_user, fim_user) AS user
| filter user NOT ("SYSTEM" OR "$")
```

### Elastic
```sql
-- Detection 1: OPC UA Excessive Session Requests over HTTPS
FROM * -- <-- opcua_network_logs index or data-stream
| WHERE destination.port IN (443, 4843) AND (url.full LIKE "CreateSession" OR url.full LIKE "ActivateSession")
| EVAL _time = DATE_TRUNC(5 minutes, @timestamp)
| STATS cnt = COUNT() BY _time, source.ip, destination.ip, destination.domain
| WHERE cnt > 15
| EVAL rule_name = "OPC UA Excessive Session Requests", description = CONCAT("Possible signing oracle attack. ", TO_STRING(cnt), " session requests seen from ", source.ip, " to ", destination.ip, "."), user = NULL
| RENAME destination.domain AS hostname
| KEEP @timestamp, rule_name, description, source.ip, destination.ip, hostname, user

-- Detection 2: OPC UA Communication Using Deprecated Basic128Rsa15 Policy
FROM * -- <-- opcua_app_logs
| WHERE message LIKE "Basic128Rsa15"
| STATS user = VALUES(user.name) BY @timestamp
, source.ip, destination.ip, host.hostname
| EVAL rule_name = "OPC UA Deprecated Policy Usage", description = CONCAT("Insecure 'Basic128Rsa15' policy used in connection from ", source.ip, " to ", destination.ip, "."), hostname = host.hostname
| KEEP @timestamp, rule_name, description, source.ip, destination.ip, hostname, user

-- Detection 3: Potential OPC UA Padding Oracle Probing Attempt
FROM * -- <-- opcua_app_logs
| WHERE message IN ("error", "fail", "Bad", "incorrect")
| EVAL _time = DATE_TRUNC(5 minutes, @timestamp)
| STATS cnt = COUNT() BY _time, source.ip, destination.ip, destination.domain
| WHERE cnt > 50
| EVAL rule_name = "Potential OPC UA Padding Oracle Probe", description = CONCAT("High volume of OPC UA errors (", TO_STRING(cnt), ") from ", source.ip, " to ", destination.ip, ", possibly indicating a padding oracle attack."), user = NULL
| RENAME destination.domain AS hostname
| KEEP @timestamp, rule_name, description, source.ip, destination.ip, hostname, user

-- Detection 4: OPC UA Brute-Force Followed by Success
FROM * -- <-- opcua_app_logs
| EVAL auth_result = CASE(REGEX(message, "(?i)success|granted"), "Success", REGEX(message, "(?i)fail|denied|BadUserAccessDenied|BadIdentityTokenInvalid"), "Failure", 1=1, NULL)
| WHERE auth_result IN ("Success", "Failure")
| EVAL _time = DATE_TRUNC(30 minutes, @timestamp)
| STATS failures = COUNT_IF(auth_result == "Failure"), successes = COUNT_IF(auth_result == "Success"), user = VALUES(user.name) BY _time, source.ip, destination.ip, destination.domain
| WHERE failures > 10 AND successes > 0
| EVAL rule_name = "OPC UA Brute-Force Followed by Success", description = CONCAT("Potential brute force from ", source.ip, " with ", TO_STRING(failures), " failures and ", TO_STRING(successes), " successes. Affected user: ", user)
| RENAME destination.domain AS hostname
| KEEP @timestamp, rule_name, description, source.ip, destination.ip, hostname, user

-- Detection 5: OPC UA Server Configuration Modified
FROM * -- <-- opcua_endpoint_logs
| WHERE event.code IN ("4657", "4663") OR event.module LIKE "-fim"
| WHERE file.path LIKE "\Kepware\KEPServerEX\V6" OR file.path LIKE "\Prosys\OPC UA Simulation Server" OR file.path LIKE "\KEPServerEX\V6\config.json" OR file.path LIKE "\Ignition\data\opcua\server\settings.xml" OR file.path LIKE "/etc/open62541/server_config.xml"
| STATS win_user = VALUES(user.name), fim_user = VALUES(user.name), process = VALUES(process.name) BY @timestamp
, host.hostname
| EVAL user = COALESCE(win_user, fim_user)
| WHERE user NOT IN ("SYSTEM", "$")
| EVAL rule_name = "OPC UA Server Configuration Modified", description = CONCAT("Sensitive OPC UA configuration modified on ", host.hostname, " by user ", user, " via process ", process, "."), source.ip = NULL, destination.ip = NULL
| RENAME host.hostname AS hostname
| KEEP @timestamp, rule_name, description, source.ip, destination.ip, hostname, user
| RENAME @timestamp
 AS timestamp
| SORT timestamp
| LIMIT 10000
```

### Sentinel One
---
```sql
-- Detection 1: OPC UA Excessive Session Requests over HTTPS
EventType = "HTTP Request" AND DstPort IN (443, 4843) AND (URL CONTAINS "CreateSession" OR URL CONTAINS "ActivateSession")
| GROUP BY Time_bin(5m), SrcIP, DstIP, EndpointName
| HAVING COUNT > 15
| SET rule_name = "OPC UA Excessive Session Requests", description = "Possible signing oracle attack. " + COUNT + " session requests seen from " + SrcIP + " to " + DstIP + ".", User = NULL
| RENAME EndpointName AS hostname
| SELECT Time, rule_name, description, SrcIP, DstIP, hostname, User
-- UNION

-- Detection 2: OPC UA Communication Using Deprecated Basic128Rsa15 Policy
ProcessName CONTAINS "opcua" AND (Cmdline CONTAINS "Basic128Rsa15" OR IndicatorValue CONTAINS "Basic128Rsa15")
| GROUP BY Time, SrcIP, DstIP, EndpointName
| SET rule_name = "OPC UA Deprecated Policy Usage", description = "Insecure 'Basic128Rsa15' policy used in connection from " + SrcIP + " to " + DstIP + ".", hostname = EndpointName
| SELECT Time, rule_name, description, SrcIP, DstIP, hostname, User
-- UNION

-- Detection 3: Potential OPC UA Padding Oracle Probing Attempt
ProcessName CONTAINS "opcua" AND (Cmdline CONTAINS "error" OR Cmdline CONTAINS "fail" OR Cmdline CONTAINS "Bad" OR Cmdline CONTAINS "incorrect")
| GROUP BY Time_bin(5m), SrcIP, DstIP, EndpointName
| HAVING COUNT > 50
| SET rule_name = "Potential OPC UA Padding Oracle Probe", description = "High volume of OPC UA errors (" + COUNT + ") from " + SrcIP + " to " + DstIP + ", possibly indicating a padding oracle attack.", User = NULL
| RENAME EndpointName AS hostname
| SELECT Time, rule_name, description, SrcIP, DstIP, hostname, User
-- UNION

-- Detection 4: OPC UA Brute-Force Followed by Success
EventType = "Login" AND ProcessName CONTAINS "opcua"
| SET auth_result = IF(Cmdline CONTAINS_CASE_INSENSITIVE "success" OR Cmdline CONTAINS_CASE_INSENSITIVE "granted", "Success", IF(Cmdline CONTAINS_CASE_INSENSITIVE "fail" OR Cmdline CONTAINS_CASE_INSENSITIVE "denied" OR Cmdline CONTAINS_CASE_INSENSITIVE "BadUserAccessDenied" OR Cmdline CONTAINS_CASE_INSENSITIVE "BadIdentityTokenInvalid", "Failure"))
| WHERE auth_result IN ("Success", "Failure")
| GROUP BY Time_bin(30m), SrcIP, DstIP, EndpointName
| HAVING COUNT_IF(auth_result = "Failure") AS failures > 10 AND COUNT_IF(auth_result = "Success") AS successes > 0
| SET rule_name = "OPC UA Brute-Force Followed by Success", description = "Potential brute force from " + SrcIP + " with " + failures + " failures and " + successes + " successes. Affected user: " + User
| RENAME EndpointName AS hostname
| SELECT Time, rule_name, description, SrcIP, DstIP, hostname, User
-- UNION

-- Detection 5: OPC UA Server Configuration Modified
EventType IN ("File Modification", "Registry Modification") AND (TgtFilePath CONTAINS "\Kepware\KEPServerEX\V6" OR TgtFilePath CONTAINS "\Prosys\OPC UA Simulation Server" OR TgtFilePath CONTAINS "\KEPServerEX\V6\config.json" OR TgtFilePath CONTAINS "\Ignition\data\opcua\server\settings.xml" OR TgtFilePath CONTAINS "/etc/open62541/server_config.xml")
| GROUP BY Time, EndpointName
| SET User = COALESCE(WinUser, FimUser)
| WHERE User NOT IN ("SYSTEM", "*$")
| SET rule_name = "OPC UA Server Configuration Modified", description = "Sensitive OPC UA configuration modified on " + EndpointName + " by user " + User + " via process " + SrcProcName + ".", SrcIP = NULL, DstIP = NULL
| RENAME EndpointName AS hostname
| SELECT Time, rule_name, description, SrcIP, DstIP, hostname, User
| RENAME Time AS timestamp
| ORDER BY timestamp
```