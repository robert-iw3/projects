### Haunted by Legacy: Discovering and Exploiting Vulnerable Tunnelling Hosts
---

This report details the widespread vulnerabilities in various tunneling protocols (IPIP, GRE, GUE, 4in6, and 6in4) that allow for source IP spoofing and enable new Denial-of-Service (DoS) attacks. Researchers identified over 4 million vulnerable hosts globally, including critical infrastructure, which can be abused as one-way proxies and facilitate attacks like Economic Denial of Sustainability (EDoS) and amplified DoS attacks.

Recent research confirms the continued prevalence of these vulnerabilities, with over 4.2 million internet hosts still susceptible to exploitation as of early 2025. Notably, the identified vulnerabilities have been assigned CVEs (CVE-2024-7595, CVE-2025-23018, CVE-2025-23019, and CVE-2024-7596), highlighting their severity and ongoing relevance.

### Actionable Threat Data
---

Vulnerable Protocols: IPIP, GRE, GUE, 4in6, and 6in4 tunneling protocols are susceptible to unauthenticated traffic injection and source IP spoofing.

Attack Types: Exploitation enables various attacks, including one-way proxying, administrative DoS (abuse report generation), Routing Loop DoS, Ping-Pong Amplification DoS, Tunnelled-Temporal Lensing (TuTL) DoS, and Economic Denial of Sustainability (EDoS) attacks.

Amplification Factors: Ping-Pong attacks can achieve an amplification factor of up to 75, while TuTL attacks can reach an amplification factor of at least 16.

Spoofing Capability: Over 1.8 million hosts are identified as spoofing-capable, allowing attackers to send traffic with arbitrary source IP addresses.

Open Ports: Vulnerable hosts often have common ports open, such as HTTP (80), HTTPS (443), BGP (179), NTP (123), and SNMP (161/162), which can be indicative of their role (e.g., servers for IPIP/IP6IP6, routers for 6in4/4in6, mobile networks for GRE).

### Splunk
---
```sql
'''
Detection 1: Routing Loop DoS Attack
Description: This search identifies a high volume of outbound traffic to a specific range of IPv6 addresses (::/96, excluding IPv4-mapped addresses) that are known to cause packet loops on vulnerable tunneling interfaces. This is indicative of a Routing Loop DoS attack.
Data Source: CIM Network_Traffic data model. Requires network logs with direction, bytes_out, and destination IPv6 information.
'''

| tstats `summariesonly` sum(All_Traffic.bytes_out) as TotalBytesSent from datamodel=Network_Traffic where All_Traffic.direction="outbound" AND All_Traffic.dest_ipv6!="" by All_Traffic.src_ip, All_Traffic.dest_ipv6, _time span=10m
-- The Routing Loop DoS attack uses a specially crafted IPv6 destination address in the ::/96 range.
| where cidrmatch("::/96", All_Traffic.dest_ipv6)
-- Exclude standard IPv4-mapped addresses and loopback to reduce false positives.
| where NOT cidrmatch("::ffff:0:0/96", All_Traffic.dest_ipv6) AND All_Traffic.dest_ipv6 != "::1" AND All_Traffic.dest_ipv6 != "::"
-- Threshold in bytes. 100MB is a starting point and may need tuning.
| where TotalBytesSent > 100000000
| stats min(_time) as StartTime, max(_time) as EndTime, sum(TotalBytesSent) as TotalBytesSent, values(All_Traffic.dest_ipv6) as DestinationIpSet by All_Traffic.src_ip
| rename All_Traffic.src_ip as Computer
| eval Name="Routing Loop DoS Attack", Description="A high volume of outbound traffic, potentially indicative of a Routing Loop DoS attack, was detected from host " . Computer . ". The attack leverages specially crafted IPv6 packets to cause a packet loop on vulnerable tunneling interfaces.", Tactics="Denial ofService", Techniques="Network Denial of Service"
| table StartTime, EndTime, Computer, TotalBytesSent, DestinationIpSet, Name, Description, Tactics, Techniques


'''
Detection 2: Ping-Pong Amplification DoS Attack
Description: Detects high-volume, symmetric, two-way traffic between two internal hosts, which is characteristic of a Ping-Pong DoS attack where packets are looped between vulnerable tunneling hosts.
Data Source: CIM Network_Traffic data model.
'''

-- Summarize flows between internal hosts. Define your internal networks in the where clause.
| tstats `summariesonly` sum(All_Traffic.bytes) as TotalBytes from datamodel=Network_Traffic where (cidrmatch("10.0.0.0/8", All_Traffic.src_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.src_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.src_ip)) AND (cidrmatch("10.0.0.0/8", All_Traffic.dest_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.dest_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.dest_ip)) by All_Traffic.src_ip, All_Traffic.dest_ip
| rename All_Traffic.src_ip as host1, All_Traffic.dest_ip as host2, TotalBytes as host1_to_host2_bytes
-- Join the flows with their reverse to find symmetric communication.
| join type=inner host1, host2 [
    | tstats `summariesonly` sum(All_Traffic.bytes) as TotalBytes from datamodel=Network_Traffic where (cidrmatch("10.0.0.0/8", All_Traffic.src_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.src_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.src_ip)) AND (cidrmatch("10.0.0.0/8", All_Traffic.dest_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.dest_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.dest_ip)) by All_Traffic.src_ip, All_Traffic.dest_ip
    | rename All_Traffic.src_ip as host2, All_Traffic.dest_ip as host1, TotalBytes as host2_to_host1_bytes
]
-- Ensure each pair is reported only once.
| where host1 < host2
-- Volume threshold in bytes (e.g., 500MB) and symmetry ratio are key tuning parameters.
| where host1_to_host2_bytes > 500000000 AND host2_to_host1_bytes > 500000000
| eval SymmetryRatio = min(host1_to_host2_bytes, host2_to_host1_bytes) / max(host1_to_host2_bytes, host2_to_host1_bytes)
| where SymmetryRatio >= 0.7
| eval Name="Ping-Pong Amplification DoS Attack", Description="Potential Ping-Pong DoS attack detected between hosts " . host1 . " and " . host2 . ". A high volume of symmetric traffic was observed, characteristic of this attack pattern.", Tactics="Denial of Service", Techniques="Network Denial of Service"
| table host1, host2, host1_to_host2_bytes, host2_to_host1_bytes, SymmetryRatio, Name, Description, Tactics, Techniques


'''
Detection 3: Tunnelled-Temporal Lensing (TuTL) DoS Attack
Description: Identifies a sudden, anomalous spike in inbound traffic from an unusually high number of distinct sources, characteristic of a TuTL attack concentrating traffic into a short time window.
Data Source: CIM Network_Traffic data model.
'''

| tstats `summariesonly` sum(All_Traffic.bytes_in) as SpikeBytesReceived, dc(All_Traffic.src_ip) as DistinctSourceIpCount from datamodel=Network_Traffic where All_Traffic.direction="inbound" by All_Traffic.dest_ip, _time span=1m
-- Set minimums for spike volume and source count to focus on significant events.
| where SpikeBytesReceived > 500000000 AND DistinctSourceIpCount > 20
-- Use eventstats to calculate a baseline (average and standard deviation) for each destination host.
| eventstats avg(SpikeBytesReceived) as avg_bytes, stdev(SpikeBytesReceived) as stdev_bytes by All_Traffic.dest_ip
| where isnotnull(stdev_bytes) AND stdev_bytes > 0
-- An anomaly is a spike significantly above the baseline (e.g., 2 standard deviations). Tune the multiplier as needed.
| where SpikeBytesReceived > (avg_bytes + (stdev_bytes * 2))
| rename All_Traffic.dest_ip as VictimHost
| eval Name="Tunnelled-Temporal Lensing (TuTL) DoS Attack", Description="A sudden, high-volume traffic spike, characteristic of a TuTL DoS attack, was detected targeting host " . VictimHost . ". The attack concentrates traffic from " . DistinctSourceIpCount . " distinct IPs into a short time window.", Tactics="Denial of Service", Techniques="Network Denial of Service"
| table _time, VictimHost, SpikeBytesReceived, DistinctSourceIpCount, Name, Description, Tactics, Techniques


'''
Detection 4: Administrative DoS via Spoofed Traffic
Description: Identifies hosts sending a high number of TCP SYN packets outbound without receiving corresponding SYN-ACK replies. This indicates the source IP is likely spoofed, potentially to trigger abuse reports against a victim.
Data Source: CIM Network_Traffic data model. Requires logs with TCP flag details.
'''

-- Find hosts sending a high number of outbound SYN packets.
| tstats `summariesonly` count as SentSYNs from datamodel=Network_Traffic where All_Traffic.direction="outbound" AND All_Traffic.tcp_flags="S" by All_Traffic.src_ip, All_Traffic.dest_ip
| where SentSYNs > 1000
-- Join with corresponding inbound SYN-ACKs.
| join type=left src_ip, dest_ip [
    | tstats `summariesonly` count as ReceivedSYNACKs from datamodel=Network_Traffic where All_Traffic.direction="inbound" AND All_Traffic.tcp_flags="SA" by All_Traffic.src_ip, All_Traffic.dest_ip
    | rename src_ip as dest_ip, dest_ip as src_ip
]
| fillnull value=0 ReceivedSYNACKs
| eval SynAckRatio = ReceivedSYNACKs / SentSYNs
-- A very low ratio of replies is a strong indicator of spoofing.
| where SynAckRatio < 0.05
| rename src_ip as ProxyHost, dest_ip as TargetHost
| eval Name="Administrative DoS via Spoofed Traffic", Description="Host " . ProxyHost . " sent " . SentSYNs . " TCP SYN packets to " . TargetHost . " with a reply ratio of " . round(SynAckRatio*100, 2) . "%. This suggests source IP spoofing, potentially to trigger abuse reports.", Tactics="Denial of Service, Defense Evasion", Techniques="Network Denial of Service, IP Address Spoofing"
| table ProxyHost, TargetHost, SentSYNs, ReceivedSYNACKs, SynAckRatio, Name, Description, Tactics, Techniques


'''
Detection 5: Economic Denial of Sustainability (EDoS) Attack
Description: Identifies internal hosts with anomalously high volumes of both inbound and outbound traffic, consistent with being abused as a traffic relay in a Ping-Pong attack, which can incur high egress costs.
Data Source: CIM Network_Traffic data model.
'''

-- Calculate inbound and outbound traffic volumes for each internal host.
| tstats `summariesonly` append=t [
    | tstats `summariesonly` sum(All_Traffic.bytes) as bytes from datamodel=Network_Traffic where All_Traffic.direction="inbound" AND (cidrmatch("10.0.0.0/8", All_Traffic.dest_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.dest_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.dest_ip)) by All_Traffic.dest_ip
    | rename All_Traffic.dest_ip as host, bytes as TotalBytesReceived
] [
    | tstats `summariesonly` sum(All_Traffic.bytes) as bytes from datamodel=Network_Traffic where All_Traffic.direction="outbound" AND (cidrmatch("10.0.0.0/8", All_Traffic.src_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.src_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.src_ip)) by All_Traffic.src_ip
    | rename All_Traffic.src_ip as host, bytes as TotalBytesSent
]
| stats values(TotalBytesReceived) as TotalBytesReceived, values(TotalBytesSent) as TotalBytesSent by host
| where isnotnull(TotalBytesReceived) AND isnotnull(TotalBytesSent)
-- Thresholds in bytes (e.g., 1GB). Tune based on environment baselines.
| where TotalBytesReceived > 1000000000 AND TotalBytesSent > 1000000000
| rename host as AbusedHost
| eval Name="Economic Denial of Sustainability (EDoS) Attack", Description="Host " . AbusedHost . " has generated high volumes of both inbound (" . round(TotalBytesReceived/1024/1024/1024, 2) . " GB) and outbound (" . round(TotalBytesSent/1024/1024/1024, 2) . " GB) traffic, consistent with an EDoS attack.", Tactics="Denial of Service", Techniques="Network Denial of Service"
| table AbusedHost, TotalBytesReceived, TotalBytesSent, Name, Description, Tactics, Techniques


'''
Detection 6: Unauthenticated Tunneling Traffic from External Source
Description: Detects inbound traffic from the internet to internal hosts using common tunneling protocols (IPIP, GRE, GUE). This can indicate a misconfigured device or an attempt to establish an unauthorized channel.
Data Source: CIM Network_Traffic data model or firewall logs.
'''

-- Define your internal networks and known external tunnel peers to reduce FPs.
| tstats `summariesonly` count, sum(All_Traffic.bytes) as TotalBytes from datamodel=Network_Traffic where NOT (cidrmatch("10.0.0.0/8", All_Traffic.src_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.src_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.src_ip) OR match(All_Traffic.src_ip, "KNOWN_PEER_IP_1") OR match(All_Traffic.src_ip, "KNOWN_PEER_IP_2")) AND (cidrmatch("10.0.0.0/8", All_Traffic.dest_ip) OR cidrmatch("172.16.0.0/12", All_Traffic.dest_ip) OR cidrmatch("192.168.0.0/16", All_Traffic.dest_ip))
-- Filter for tunneling protocols: IPIP (4), GRE (47), 6in4 (41), or GUE (UDP/6080).
| where (All_Traffic.protocol_id=4 OR All_Traffic.protocol_id=47 OR All_Traffic.protocol_id=41 OR (All_Traffic.transport="udp" AND All_Traffic.dest_port=6080))
| by All_Traffic.src_ip, All_Traffic.dest_ip, All_Traffic.protocol_id, All_Traffic.transport, All_Traffic.dest_port
| eval TunnelProtocol=case(All_Traffic.protocol_id=4, "IPIP", All_Traffic.protocol_id=47, "GRE", All_Traffic.protocol_id=41, "6in4/4in6", All_Traffic.transport="udp", "GUE", true(), "Unknown")
| rename All_Traffic.src_ip as ExternalSource, All_Traffic.dest_ip as InternalHost
| eval Name="Unauthenticated Tunneling Traffic from External Source", Description="Detected unauthenticated tunneling traffic (Protocol: " . TunnelProtocol . ") from an unknown external source (" . ExternalSource . ") to an internal host (" . InternalHost . ").", Tactics="Initial Access, Defense Evasion", Techniques="T1090"
| table ExternalSource, InternalHost, TunnelProtocol, count, TotalBytes, Name, Description, Tactics, Techniques


'''
Detection 7: Source IP Spoofing via Vulnerable Tunneling Host
Description: Identifies internal hosts that both receive inbound tunneling traffic and send outbound traffic with a spoofed (non-authorized) source IP. This requires firewall logs with an 'orig_src_ip' field.
Data Source: Firewall logs (e.g., Palo Alto, Fortinet) with original source IP visibility.
'''

-- This search requires a specific field like 'orig_src_ip' and known public IP ranges.
| search sourcetype=pan:traffic
-- Part 1: Find hosts sending spoofed traffic.
| eval is_spoofed = if(direction="outbound" AND isnotnull(orig_src_ip) AND (cidrmatch("10.0.0.0/8", orig_src_ip) OR cidrmatch("172.16.0.0/12", orig_src_ip) OR cidrmatch("192.168.0.0/16", orig_src_ip)) AND NOT (cidrmatch("YOUR_PUBLIC_IP_1/24", src_ip) OR cidrmatch("YOUR_PUBLIC_IP_2/24", src_ip)), 1, 0)
-- Part 2: Find hosts receiving tunnel traffic.
| eval receives_tunnel = if(direction="inbound" AND NOT (cidrmatch("10.0.0.0/8", src_ip) OR cidrmatch("172.16.0.0/12", src_ip) OR cidrmatch("192.168.0.0/16", src_ip)) AND (cidrmatch("10.0.0.0/8", dest_ip) OR cidrmatch("172.16.0.0/12", dest_ip) OR cidrmatch("192.168.0.0/16", dest_ip)) AND (proto="ipip" OR proto="gre" OR (proto="udp" AND dest_port=6080)), 1, 0)
| eval host_ip = if(is_spoofed=1, orig_src_ip, if(receives_tunnel=1, dest_ip, null))
| where isnotnull(host_ip)
| stats values(is_spoofed) as spoofed_flag, values(receives_tunnel) as tunnel_flag, values(src_ip) as spoofed_sources by host_ip
-- A host is suspicious if it has flags for both behaviors.
| where mvcount(spoofed_flag) > 0 AND mvcount(tunnel_flag) > 0
| rename host_ip as AbusedHost
| eval Name="Source IP Spoofing via Vulnerable Tunneling Host", Description="Internal host " . AbusedHost . " is suspected of being abused for source IP spoofing. It has been observed receiving inbound tunneling traffic AND sending outbound traffic with a non-authorized source IP address (e.g., " . mvindex(spoofed_sources, 0) . ").", Tactics="Defense Evasion, Initial Access", Techniques="T1090"
| table AbusedHost, spoofed_sources, Name, Description, Tactics, Techniques


'''
Detection 8: Suspicious Open Ports on Tunneling Hosts
Description: Correlates internal hosts receiving tunneling traffic with those also accepting traffic on common service ports (HTTP, BGP, NTP, SNMP), suggesting a potentially misconfigured and abusable host.
Data Source: Firewall or network traffic logs.
'''

-- Part 1: Find hosts receiving tunneling traffic from the internet.
| search index=* (sourcetype=pan:traffic OR sourcetype=cisco:asa) action=allow direction=inbound (proto=ipip OR proto=gre OR (proto="udp" dest_port=6080))
| where NOT (cidrmatch("10.0.0.0/8", src) OR cidrmatch("172.16.0.0/12", src) OR cidrmatch("192.168.0.0/16", src)) AND (cidrmatch("10.0.0.0/8", dest) OR cidrmatch("172.16.0.0/12", dest) OR cidrmatch("192.168.0.0/16", dest))
| stats values(proto) as TunnelProtocols, values(src) as TunnelSources by dest as InternalHost
-- Part 2: Join with hosts that have other suspicious ports open to the internet.
| join type=inner InternalHost [
    | search index=* (sourcetype=pan:traffic OR sourcetype=cisco:asa) action=allow direction=inbound (dest_port=80 OR dest_port=443 OR dest_port=179 OR dest_port=123 OR dest_port=161 OR dest_port=162)
    | where NOT (cidrmatch("10.0.0.0/8", src) OR cidrmatch("172.16.0.0/12", src) OR cidrmatch("192.168.0.0/16", src)) AND (cidrmatch("10.0.0.0/8", dest) OR cidrmatch("172.16.0.0/12", dest) OR cidrmatch("192.168.0.0/16", dest))
    | stats values(dest_port) as OpenPorts, values(src) as OpenPortSources by dest as InternalHost
]
| eval Name="Suspicious Open Ports on Tunneling Host", Description="Host " . InternalHost . " receives tunneling traffic (Protocols: " . mvjoin(TunnelProtocols, ", ") . ") and also has common service ports open (Ports: " . mvjoin(OpenPorts, ", ") . "). This combination suggests a misconfigured or vulnerable host.", Tactics="Resource Development, Reconnaissance", Techniques="T1583, T1595"
| table InternalHost, TunnelProtocols, OpenPorts, TunnelSources, OpenPortSources, Name, Description, Tactics, Techniques
```

### Crowdstrike
---
```sql
-- Detection 1: Routing Loop DoS Attack
event_simpleName="NetworkConnectIP6" + Direction="Outbound" + RemoteAddressIP6!="" + RemoteAddressIP6:"::/96" -RemoteAddressIP6:"::ffff:0:0/96" -RemoteAddressIP6:"::1" -RemoteAddressIP6:"::"
| group by ContextTimeStamp_bin(10m), LocalAddressIP4, RemoteAddressIP6
| sum(NetworkBytesSent) as TotalBytesSent
| TotalBytesSent >100000000
| select [StartTime=MIN(ContextTimeStamp), EndTime=MAX(ContextTimeStamp), Computer=LocalAddressIP4, TotalBytesSent, DestinationIpSet=RemoteAddressIP6, Name="Routing Loop DoS Attack", Description=concat("A high volume of outbound traffic, potentially indicative of a Routing Loop DoS attack, was detected from host ", LocalAddressIP4, ". The attack leverages specially crafted IPv6 packets to cause a packet loop on vulnerable tunneling interfaces."), Tactics="Denial ofService", Techniques="Network Denial of Service"]

-- Detection 2: Ping-Pong Amplification DoS Attack
event_simpleName="NetworkConnectIP4" + (LocalAddressIP4:"10.0.0.0/8" OR LocalAddressIP4:"172.16.0.0/12" OR LocalAddressIP4:"192.168.0.0/16") + (RemoteAddressIP4:"10.0.0.0/8" OR RemoteAddressIP4:"172.16.0.0/12" OR RemoteAddressIP4:"192.168.0.0/16")
| group by LocalAddressIP4, RemoteAddressIP4
| sum(NetworkBytes) as host1_to_host2_bytes
| join [event_simpleName="NetworkConnectIP4" + (LocalAddressIP4:"10.0.0.0/8" OR LocalAddressIP4:"172.16.0.0/12" OR LocalAddressIP4:"192.168.0.0/16") + (RemoteAddressIP4:"10.0.0.0/8" OR RemoteAddressIP4:"172.16.0.0/12" OR RemoteAddressIP4:"192.168.0.0/16")
| group by LocalAddressIP4 as host2, RemoteAddressIP4 as host1
| sum(NetworkBytes) as host2_to_host1_bytes]
| LocalAddressIP4 < RemoteAddressIP4
| host1_to_host2_bytes >500000000 + host2_to_host1_bytes >500000000
| select [host1=LocalAddressIP4, host2=RemoteAddressIP4, host1_to_host2_bytes, host2_to_host1_bytes, SymmetryRatio=MIN(host1_to_host2_bytes,host2_to_host1_bytes)/MAX(host1_to_host2_bytes,host2_to_host1_bytes), Name="Ping-Pong Amplification DoS Attack", Description=concat("Potential Ping-Pong DoS attack detected between hosts ", LocalAddressIP4, " and ", RemoteAddressIP4, ". A high volume of symmetric traffic was observed, characteristic of this attack pattern."), Tactics="Denial of Service", Techniques="Network Denial of Service"]
| SymmetryRatio >=0.7

-- Detection 3: Tunnelled-Temporal Lensing (TuTL) DoS Attack
event_simpleName="NetworkReceiveIP4" + Direction="Inbound"
| group by ContextTimeStamp_bin(1m), RemoteAddressIP4
| sum(NetworkBytesReceived) as SpikeBytesReceived, count_distinct(LocalAddressIP4) as DistinctSourceIpCount
| SpikeBytesReceived >500000000 + DistinctSourceIpCount >20
| stats [avg(SpikeBytesReceived) as avg_bytes, stdev(SpikeBytesReceived) as stdev_bytes by RemoteAddressIP4]
| stdev_bytes >0 | SpikeBytesReceived >(avg_bytes + (stdev_bytes * 2))
| select [VictimHost=RemoteAddressIP4, SpikeBytesReceived, DistinctSourceIpCount, Name="Tunnelled-Temporal Lensing (TuTL) DoS Attack", Description=concat("A sudden, high-volume traffic spike, characteristic of a TuTL DoS attack, was detected targeting host ", RemoteAddressIP4, ". The attack concentrates traffic from ", DistinctSourceIpCount, " distinct IPs into a short time window."), Tactics="Denial of Service", Techniques="Network Denial of Service"]

-- Detection 4: Administrative DoS via Spoofed Traffic
event_simpleName="NetworkConnectIP4" + Direction="Outbound" + TCPFlags:"S"
| group by LocalAddressIP4, RemoteAddressIP4
| count as SentSYNs
| SentSYNs >1000
| join left [event_simpleName="NetworkReceiveIP4" + Direction="Inbound" + TCPFlags:"SA"
| group by LocalAddressIP4 as RemoteAddressIP4, RemoteAddressIP4 as LocalAddressIP4
| count as ReceivedSYNACKs]
| select [ReceivedSYNACKs=coalesce(ReceivedSYNACKs,0), SynAckRatio=ReceivedSYNACKs/SentSYNs, ProxyHost=LocalAddressIP4, TargetHost=RemoteAddressIP4, Name="Administrative DoS via Spoofed Traffic", Description=concat("Host ", LocalAddressIP4, " sent ", SentSYNs, " TCP SYN packets to ", RemoteAddressIP4, " with a reply ratio of ", round(SynAckRatio*100,2), "%. This suggests source IP spoofing, potentially to trigger abuse reports."), Tactics="Denial of Service, Defense Evasion", Techniques="Network Denial of Service, IP Address Spoofing"]
| SynAckRatio <0.05

-- Detection 5: Economic Denial of Sustainability (EDoS) Attack
event_simpleName IN ("NetworkReceiveIP4","NetworkConnectIP4") + (LocalAddressIP4:"10.0.0.0/8" OR LocalAddressIP4:"172.16.0.0/12" OR LocalAddressIP4:"192.168.0.0/16")
| group by Direction, LocalAddressIP4
| sum(NetworkBytes) as bytes
| pivot [Direction="Inbound":TotalBytesReceived=bytes; Direction="Outbound":TotalBytesSent=bytes] by LocalAddressIP4
| TotalBytesReceived >1000000000 + TotalBytesSent >1000000000
| select [AbusedHost=LocalAddressIP4, Name="Economic Denial of Sustainability (EDoS) Attack", Description=concat("Host ", LocalAddressIP4, " has generated high volumes of both inbound (", round(TotalBytesReceived/1024/1024/1024,2), " GB) and outbound (", round(TotalBytesSent/1024/1024/1024,2), " GB) traffic, consistent with an EDoS attack."), Tactics="Denial of Service", Techniques="Network Denial of Service"]

-- Detection 6: Unauthenticated Tunneling Traffic from External Source
event_simpleName="NetworkReceiveIP4" + -(LocalAddressIP4:"10.0.0.0/8" OR LocalAddressIP4:"172.16.0.0/12" OR LocalAddressIP4:"192.168.0.0/16" OR LocalAddressIP4:"KNOWN_PEER_IP_1" OR LocalAddressIP4:"KNOWN_PEER_IP_2") + (RemoteAddressIP4:"10.0.0.0/8" OR RemoteAddressIP4:"172.16.0.0/12" OR RemoteAddressIP4:"192.168.0.0/16") + (Protocol IN ("ipip","gre","41") OR (Protocol="udp" + RemotePort="6080"))
| group by LocalAddressIP4, RemoteAddressIP4, Protocol, Transport, RemotePort
| count, sum(NetworkBytes) as TotalBytes
| select [ExternalSource=LocalAddressIP4, InternalHost=RemoteAddressIP4, TunnelProtocol=case(Protocol="ipip":"IPIP"; Protocol="gre":"GRE"; Protocol="41":"6in4/4in6"; Transport="udp":"GUE"; default:"Unknown"), count, TotalBytes, Name="Unauthenticated Tunneling Traffic from External Source", Description=concat("Detected unauthenticated tunneling traffic (Protocol: ", TunnelProtocol, ") from an unknown external source (", LocalAddressIP4, ") to an internal host (", RemoteAddressIP4, ")."), Tactics="Initial Access, Defense Evasion", Techniques="T1090"]

-- Detection 7: Source IP Spoofing via Vulnerable Tunneling Host
event_simpleName IN ("NetworkConnectIP4","NetworkReceiveIP4") + SourceIP!=""
| case { Direction="Outbound" + SourceIP!="" + (SourceIP:"10.0.0.0/8" OR SourceIP:"172.16.0.0/12" OR SourceIP:"192.168.0.0/16") + -(LocalAddressIP4:"YOUR_PUBLIC_IP_1/24" OR LocalAddressIP4:"YOUR_PUBLIC_IP_2/24"): is_spoofed=1; Direction="Inbound" + -(LocalAddressIP4:"10.0.0.0/8" OR LocalAddressIP4:"172.16.0.0/12" OR LocalAddressIP4:"192.168.0.0/16") + (RemoteAddressIP4:"10.0.0.0/8" OR RemoteAddressIP4:"172.16.0.0/12" OR RemoteAddressIP4:"192.168.0.0/16") + (Protocol IN ("ipip","gre") OR (Protocol="udp" + RemotePort="6080")): receives_tunnel=1; default: null }
| group by host_ip=case(is_spoofed=1:SourceIP; receives_tunnel=1:RemoteAddressIP4; default:null)
| collect(is_spoofed as spoofed_flag, receives_tunnel as tunnel_flag, LocalAddressIP4 as spoofed_sources)
| count(spoofed_flag) >0 + count(tunnel_flag) >0
| select [AbusedHost=host_ip, spoofed_sources, Name="Source IP Spoofing via Vulnerable Tunneling Host", Description=concat("Internal host ", host_ip, " is suspected of being abused for source IP spoofing. It has been observed receiving inbound tunneling traffic AND sending outbound traffic with a non-authorized source IP address (e.g., ", spoofed_sources[0], ")."), Tactics="Defense Evasion, Initial Access", Techniques="T1090"]

-- Detection 8: Suspicious Open Ports on Tunneling Hosts
event_simpleName="NetworkReceiveIP4" + Action="Allow" + (Protocol IN ("ipip","gre") OR (Protocol="udp" + RemotePort="6080")) + -(LocalAddressIP4:"10.0.0.0/8" OR LocalAddressIP4:"172.16.0.0/12" OR LocalAddressIP4:"192.168.0.0/16") + (RemoteAddressIP4:"10.0.0.0/8" OR RemoteAddressIP4:"172.16.0.0/12" OR RemoteAddressIP4:"192.168.0.0/16")
| group by RemoteAddressIP4
| collect(Protocol as TunnelProtocols, LocalAddressIP4 as TunnelSources)
| join [event_simpleName="NetworkReceiveIP4" + Action="Allow" + RemotePort IN (80,443,179,123,161,162) + -(LocalAddressIP4:"10.0.0.0/8" OR LocalAddressIP4:"172.16.0.0/12" OR LocalAddressIP4:"192.168.0.0/16") + (RemoteAddressIP4:"10.0.0.0/8" OR RemoteAddressIP4:"172.16.0.0/12" OR RemoteAddressIP4:"192.168.0.0/16") | group by RemoteAddressIP4
| collect(RemotePort as OpenPorts, LocalAddressIP4 as OpenPortSources)]
| select [InternalHost=RemoteAddressIP4, TunnelProtocols, OpenPorts, TunnelSources, OpenPortSources, Name="Suspicious Open Ports on Tunneling Host", Description=concat("Host ", RemoteAddressIP4, " receives tunneling traffic (Protocols: ", TunnelProtocols.join(", "), ") and also has common service ports open (Ports: ", OpenPorts.join(", "), "). This combination suggests a misconfigured or vulnerable host."), Tactics="Resource Development, Reconnaissance", Techniques="T1583, T1595"]
```

### Datadog
---
```sql
-- Detection 1: Routing Loop DoS Attack
logs("source:network direction:outbound dest_ipv6:* -dest_ipv6:(::ffff:0:0/96 OR ::1 OR ::) dest_ipv6:*::/96").rollup("sum", "@All_Traffic.bytes_out").by("@All_Traffic.src_ip,@All_Traffic.dest_ipv6").last("10m") >100000000
| select StartTime=min(timestamp), EndTime=max(timestamp), Computer=@All_Traffic.src_ip, TotalBytesSent, DestinationIpSet=@All_Traffic.dest_ipv6, Name="Routing Loop DoS Attack", Description="A high volume of outbound traffic, potentially indicative of a Routing Loop DoS attack, was detected from host #{@All_Traffic.src_ip}. The attack leverages specially crafted IPv6 packets to cause a packet loop on vulnerable tunneling interfaces.", Tactics="Denial ofService", Techniques="Network Denial of Service"

-- Detection 2: Ping-Pong Amplification DoS Attack
logs("source:network (@All_Traffic.src_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) AND @All_Traffic.dest_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16))").rollup("sum", "@All_Traffic.bytes").by("@All_Traffic.src_ip,@All_Traffic.dest_ip").as("host1_to_host2_bytes")
| join(logs("source:network (@All_Traffic.src_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) AND @All_Traffic.dest_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16))").rollup("sum", "@All_Traffic.bytes").by("@All_Traffic.src_ip AS host2,@All_Traffic.dest_ip AS host1").as("host2_to_host1_bytes"))
| filter @All_Traffic.src_ip < @All_Traffic.dest_ip AND host1_to_host2_bytes >500000000 AND host2_to_host1_bytes >500000000
| select host1=@All_Traffic.src_ip, host2=@All_Traffic.dest_ip, host1_to_host2_bytes, host2_to_host1_bytes, SymmetryRatio=min(host1_to_host2_bytes,host2_to_host1_bytes)/max(host1_to_host2_bytes,host2_to_host1_bytes), Name="Ping-Pong Amplification DoS Attack", Description="Potential Ping-Pong DoS attack detected between hosts #{@All_Traffic.src_ip} and #{@All_Traffic.dest_ip}. A high volume of symmetric traffic was observed, characteristic of this attack pattern.", Tactics="Denial of Service", Techniques="Network Denial of Service"
| filter SymmetryRatio >=0.7

-- Detection 3: Tunnelled-Temporal Lensing (TuTL) DoS Attack
logs("source:network direction:inbound").rollup("sum", "@All_Traffic.bytes_in").by("@All_Traffic.dest_ip").last("1m").as("SpikeBytesReceived").rollup("count_distinct", "@All_Traffic.src_ip").as("DistinctSourceIpCount")
| filter SpikeBytesReceived >500000000 AND DistinctSourceIpCount >20
| stats avg(SpikeBytesReceived) AS avg_bytes, stddev(SpikeBytesReceived) AS stdev_bytes BY @All_Traffic.dest_ip
| filter stdev_bytes >0 AND SpikeBytesReceived >(avg_bytes + (stdev_bytes * 2))
| select VictimHost=@All_Traffic.dest_ip, SpikeBytesReceived, DistinctSourceIpCount, Name="Tunnelled-Temporal Lensing (TuTL) DoS Attack", Description="A sudden, high-volume traffic spike, characteristic of a TuTL DoS attack, was detected targeting host #{@All_Traffic.dest_ip}. The attack concentrates traffic from {DistinctSourceIpCount} distinct IPs into a short time window.", Tactics="Denial of Service", Techniques="Network Denial of Service"

-- Detection 4: Administrative DoS via Spoofed Traffic
logs("source:network direction:outbound tcp_flags:S").rollup("count").by("@All_Traffic.src_ip,@All_Traffic.dest_ip").as("SentSYNs")
| filter SentSYNs >1000
| join left(logs("source:network direction:inbound tcp_flags:SA").rollup("count").by("@All_Traffic.src_ip AS dest_ip,@All_Traffic.dest_ip AS src_ip").as("ReceivedSYNACKs"))
| select ProxyHost=@All_Traffic.src_ip, TargetHost=@All_Traffic.dest_ip, SentSYNs, ReceivedSYNACKs=coalesce(ReceivedSYNACKs,0), SynAckRatio=ReceivedSYNACKs/SentSYNs, Name="Administrative DoS via Spoofed Traffic", Description="Host #{@All_Traffic.src_ip} sent {SentSYNs} TCP SYN packets to {@All_Traffic
.dest_ip} with a reply ratio of {round(SynAckRatio*100,2)}%. This suggests source IP spoofing, potentially to trigger abuse reports.", Tactics="Denial of Service, Defense Evasion", Techniques="Network Denial of Service, IP Address Spoofing"
| filter SynAckRatio <0.05

-- Detection 5: Economic Denial of Sustainability (EDoS) Attack
logs("source:network (@All_Traffic.dest_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) AND direction:inbound)").rollup("sum", "@All_Traffic.bytes").by("@All_Traffic.dest_ip").as("TotalBytesReceived")
| join(logs("source:network (@All_Traffic.src_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) AND direction:outbound)").rollup("sum", "@All_Traffic.bytes").by("@All_Traffic.src_ip").as("TotalBytesSent"))
| filter TotalBytesReceived >1000000000 AND TotalBytesSent >1000000000
| select AbusedHost=@All_Traffic.src_ip, TotalBytesReceived, TotalBytesSent, Name="Economic Denial of Sustainability (EDoS) Attack", Description="Host #{@All_Traffic.src_ip} has generated high volumes of both inbound ({round(TotalBytesReceived/1024/1024/1024,2)} GB) and outbound ({round(TotalBytesSent/1024/1024/1024,2)} GB) traffic, consistent with an EDoS attack.", Tactics="Denial of Service", Techniques="Network Denial of Service"

-- Detection 6: Unauthenticated Tunneling Traffic from External Source
logs("source:network -@All_Traffic.src_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16 OR KNOWN_PEER_IP_1 OR KNOWN_PEER_IP_2) @All_Traffic.dest_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) (protocol_id:(4 OR 47 OR 41) OR (transport:udp dest_port:6080))").rollup("count").by("@All_Traffic.src_ip,@All_Traffic.dest_ip,@All_Traffic.protocol_id,@All_Traffic.transport,@All_Traffic.dest_port").rollup("sum", "@All_Traffic.bytes").as("TotalBytes")
| select ExternalSource=@All_Traffic.src_ip, InternalHost=@All_Traffic.dest_ip, TunnelProtocol=case(@All_Traffic.protocol_id=4:"IPIP",@All_Traffic.protocol_id=47:"GRE",@All_Traffic.protocol_id=41:"6in4/4in6",@All_Traffic.transport=udp:"GUE",default:"Unknown"), count, TotalBytes, Name="Unauthenticated Tunneling Traffic from External Source", Description="Detected unauthenticated tunneling traffic (Protocol: {TunnelProtocol}) from an unknown external source ({@All_Traffic.src_ip}) to an internal host ({@All_Traffic.dest_ip}).", Tactics="Initial Access, Defense Evasion", Techniques="T1090"

-- Detection 7: Source IP Spoofing via Vulnerable Tunneling Host
logs("source:pan_traffic (@orig_src_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) AND direction:outbound AND -@src_ip:(YOUR_PUBLIC_IP_1/24 OR YOUR_PUBLIC_IP_2/24)) OR (direction:inbound AND -@src_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) AND @dest_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) AND (proto:(ipip OR gre) OR (proto:udp AND dest_port:6080)))").process("host_ip=if(direction=outbound AND orig_src_ip IS NOT NULL,orig_src_ip,if(direction=inbound,dest_ip,null))").rollup("collect", "@is_spoofed AS spoofed_flag,@receives_tunnel AS tunnel_flag,@src_ip AS spoofed_sources").by("host_ip")
| filter count(spoofed_flag) >0 AND count(tunnel_flag) >0
| select AbusedHost=host_ip, spoofed_sources, Name="Source IP Spoofing via Vulnerable Tunneling Host", Description="Internal host {host_ip} is suspected of being abused for source IP spoofing. It has been observed receiving inbound tunneling traffic AND sending outbound traffic with a non-authorized source IP address (e.g., {spoofed_sources[0]}).", Tactics="Defense Evasion, Initial Access", Techniques="T1090"

-- Detection 8: Suspicious Open Ports on Tunneling Hosts
logs("source:(pan_traffic OR cisco_asa) action:allow direction:inbound (proto:(ipip OR gre) OR (proto:udp dest_port:6080)) -src:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) dest:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16)").rollup("collect", "@proto AS TunnelProtocols,@src AS TunnelSources").by("@dest
")
| join(logs("source:(pan_traffic OR cisco_asa) action:allow direction:inbound dest_port:(80 OR 443 OR 179 OR 123 OR 161 OR 162) -src:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) dest:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16)").rollup("collect", "@dest_port AS OpenPorts,@src AS OpenPortSources").by("@dest"))
| select InternalHost=@dest, TunnelProtocols, OpenPorts, TunnelSources, OpenPortSources, Name="Suspicious Open Ports on Tunneling Host", Description="Host {@dest
} receives tunneling traffic (Protocols: {TunnelProtocols.join(', ')}) and also has common service ports open (Ports: {OpenPorts.join(', ')}). This combination suggests a misconfigured or vulnerable host.", Tactics="Resource Development, Reconnaissance", Techniques="T1583, T1595"
```

### Elastic
---
```sql
-- Detection 1: Routing Loop DoS Attack
FROM network_traffic -- << network log source
| WHERE network.direction == "outbound" AND destination.ipv6 IS NOT NULL AND destination.ipv6 LIKE "::/96" AND NOT destination.ipv6 LIKE "::ffff:0:0/96" AND destination.ipv6 != "::1" AND destination.ipv6 != "::"
| EVAL _time = DATE_TRUNC(10 minutes, @timestamp)
| STATS TotalBytesSent = SUM(network.bytes) BY _time, source.ip, destination.ipv6
| WHERE TotalBytesSent > 100000000
| STATS StartTime = MIN(_time), EndTime = MAX(_time), TotalBytesSent = SUM(TotalBytesSent), DestinationIpSet = VALUES(destination.ipv6) BY source.ip
| EVAL Name = "Routing Loop DoS Attack", Description = CONCAT("A high volume of outbound traffic, potentially indicative of a Routing Loop DoS attack, was detected from host ", source.ip, ". The attack leverages specially crafted IPv6 packets to cause a packet loop on vulnerable tunneling interfaces."), Tactics = "Denial ofService", Techniques = "Network Denial of Service"
| RENAME source.ip AS Computer
| KEEP StartTime, EndTime, Computer, TotalBytesSent, DestinationIpSet, Name, Description, Tactics, Techniques

-- Detection 2: Ping-Pong Amplification DoS Attack
FROM network_traffic
| WHERE (source.ip LIKE "10.0.0.0/8" OR source.ip LIKE "172.16.0.0/12" OR source.ip LIKE "192.168.0.0/16") AND (destination.ip LIKE "10.0.0.0/8" OR destination.ip LIKE "172.16.0.0/12" OR destination.ip LIKE "192.168.0.0/16")
| STATS host1_to_host2_bytes = SUM(network.bytes) BY source.ip, destination.ip
| RENAME source.ip AS host1, destination.ip AS host2
| JOIN [FROM network_traffic | WHERE (source.ip LIKE "10.0.0.0/8" OR source.ip LIKE "172.16.0.0/12" OR source.ip LIKE "192.168.0.0/16") AND (destination.ip LIKE "10.0.0.0/8" OR destination.ip LIKE "172.16.0.0/12" OR destination.ip LIKE "192.168.0.0/16") | STATS host2_to_host1_bytes = SUM(network.bytes) BY source.ip AS host2, destination.ip AS host1] ON host1, host2
| WHERE host1 < host2 AND host1_to_host2_bytes > 500000000 AND host2_to_host1_bytes > 500000000
| EVAL SymmetryRatio = MIN(host1_to_host2_bytes, host2_to_host1_bytes) / MAX(host1_to_host2_bytes, host2_to_host1_bytes), Name = "Ping-Pong Amplification DoS Attack", Description = CONCAT("Potential Ping-Pong DoS attack detected between hosts ", host1, " and ", host2, ". A high volume of symmetric traffic was observed, characteristic of this attack pattern."), Tactics = "Denial of Service", Techniques = "Network Denial of Service"
| WHERE SymmetryRatio >= 0.7
| KEEP host1, host2, host1_to_host2_bytes, host2_to_host1_bytes, SymmetryRatio, Name, Description, Tactics, Techniques

-- Detection 3: Tunnelled-Temporal Lensing (TuTL) DoS Attack
FROM network_traffic
| WHERE network.direction == "inbound"
| EVAL _time = DATE_TRUNC(1 minute, @timestamp)
| STATS SpikeBytesReceived = SUM(network.bytes), DistinctSourceIpCount = COUNT_DISTINCT(source.ip) BY _time, destination.ip
| WHERE SpikeBytesReceived > 500000000 AND DistinctSourceIpCount > 20
| STATS avg_bytes = AVG(SpikeBytesReceived), stdev_bytes = STDEV(SpikeBytesReceived) BY destination.ip
| WHERE stdev_bytes IS NOT NULL AND stdev_bytes > 0 AND SpikeBytesReceived > (avg_bytes + (stdev_bytes * 2))
| EVAL Name = "Tunnelled-Temporal Lensing (TuTL) DoS Attack", Description = CONCAT("A sudden, high-volume traffic spike, characteristic of a TuTL DoS attack, was detected targeting host ", destination.ip, ". The attack concentrates traffic from ", TO_STRING(DistinctSourceIpCount), " distinct IPs into a short time window."), Tactics = "Denial of Service", Techniques = "Network Denial of Service"
| RENAME destination.ip AS VictimHost
| KEEP _time, VictimHost, SpikeBytesReceived, DistinctSourceIpCount, Name, Description, Tactics, Techniques

-- Detection 4: Administrative DoS via Spoofed Traffic
FROM network_traffic
| WHERE network.direction == "outbound" AND network.tcp.flags == "SYN"
| STATS SentSYNs = COUNT() BY source.ip, destination.ip
| WHERE SentSYNs > 1000
| LEFT JOIN [FROM network_traffic | WHERE network.direction == "inbound" AND network.tcp.flags == "SYN-ACK" | STATS ReceivedSYNACKs = COUNT() BY source.ip AS dest_ip, destination.ip AS src_ip] ON source.ip, destination.ip
| EVAL ReceivedSYNACKs = COALESCE(ReceivedSYNACKs, 0), SynAckRatio = ReceivedSYNACKs / SentSYNs
| WHERE SynAckRatio < 0.05
| EVAL Name = "Administrative DoS via Spoofed Traffic", Description = CONCAT("Host ", source.ip, " sent ", TO_STRING(SentSYNs), " TCP SYN packets to ", destination.ip, " with a reply ratio of ", TO_STRING(ROUND(SynAckRatio*100, 2)), "%. This suggests source IP spoofing, potentially to trigger abuse reports."), Tactics = "Denial of Service, Defense Evasion", Techniques = "Network Denial of Service, IP Address Spoofing"
| RENAME source.ip AS ProxyHost, destination.ip AS TargetHost
| KEEP ProxyHost, TargetHost, SentSYNs, ReceivedSYNACKs, SynAckRatio, Name, Description, Tactics, Techniques

-- Detection 5: Economic Denial of Sustainability (EDoS) Attack
FROM network_traffic
| WHERE (network.direction == "inbound" AND destination.ip LIKE "10.0.0.0/8" OR destination.ip LIKE "172.16.0.0/12" OR destination.ip LIKE "192.168.0.0/16") OR (network.direction == "outbound" AND source.ip LIKE "10.0.0.0/8" OR source.ip LIKE "172.16.0.0/12" OR source.ip LIKE "192.168.0.0/16")
| EVAL host = CASE(network.direction == "inbound", destination.ip, network.direction == "outbound", source.ip, true(), NULL), bytes = CASE(network.direction == "inbound", network.bytes, network.direction == "outbound", network.bytes)
| STATS TotalBytesReceived = SUM(CASE(network.direction == "inbound", bytes, 0)), TotalBytesSent = SUM(CASE(network.direction == "outbound", bytes, 0)) BY host
| WHERE TotalBytesReceived IS NOT NULL AND TotalBytesSent IS NOT NULL AND TotalBytesReceived > 1000000000 AND TotalBytesSent > 1000000000
| EVAL Name = "Economic Denial of Sustainability (EDoS) Attack", Description = CONCAT("Host ", host, " has generated high volumes of both inbound (", TO_STRING(ROUND(TotalBytesReceived/1024/1024/1024, 2)), " GB) and outbound (", TO_STRING(ROUND(TotalBytesSent/1024/1024/1024, 2)), " GB) traffic, consistent with an EDoS attack."), Tactics = "Denial of Service", Techniques = "Network Denial of Service"
| RENAME host AS AbusedHost
| KEEP AbusedHost, TotalBytesReceived, TotalBytesSent, Name, Description, Tactics, Techniques

-- Detection 6: Unauthenticated Tunneling Traffic from External Source
FROM network_traffic
| WHERE NOT (source.ip LIKE "10.0.0.0/8" OR source.ip LIKE "172.16.0.0/12" OR source.ip LIKE "192.168.0.0/16" OR source.ip IN ("KNOWN_PEER_IP_1", "KNOWN_PEER_IP_2")) AND (destination.ip LIKE "10.0.0.0/8" OR destination.ip LIKE "172.16.0.0/12" OR destination.ip LIKE "192.168.0.0/16") AND (network.protocol IN (4, 47, 41) OR (network.transport == "udp" AND destination.port == 6080))
| STATS count = COUNT(*), TotalBytes = SUM(network.bytes) BY source.ip, destination.ip, network.protocol, network.transport, destination.port
| EVAL TunnelProtocol = CASE(network.protocol == 4, "IPIP", network.protocol == 47, "GRE", network.protocol == 41, "6in4/4in6", network.transport == "udp", "GUE", true(), "Unknown"), Name = "Unauthenticated Tunneling Traffic from External Source", Description = CONCAT("Detected unauthenticated tunneling traffic (Protocol: ", TunnelProtocol, ") from an unknown external source (", source.ip, ") to an internal host (", destination.ip, ")."), Tactics = "Initial Access, Defense Evasion", Techniques = "T1090"
| RENAME source.ip AS ExternalSource, destination.ip AS InternalHost
| KEEP ExternalSource, InternalHost, TunnelProtocol, count, TotalBytes, Name, Description, Tactics, Techniques

-- Detection 7: Source IP Spoofing via Vulnerable Tunneling Host
FROM pan_traffic
| EVAL is_spoofed = CASE(network.direction == "outbound" AND orig_src_ip IS NOT NULL AND (orig_src_ip LIKE "10.0.0.0/8" OR orig_src_ip LIKE "172.16.0.0/12" OR orig_src_ip LIKE "192.168.0.0/16") AND NOT (source.ip LIKE "YOUR_PUBLIC_IP_1/24" OR source.ip LIKE "YOUR_PUBLIC_IP_2/24"), 1, true(), 0), receives_tunnel = CASE(network.direction == "inbound" AND NOT (source.ip LIKE "10.0.0.0/8" OR source.ip LIKE "172.16.0.0/12" OR source.ip LIKE "192.168.0.0/16") AND (destination.ip LIKE "10.0.0.0/8" OR destination.ip LIKE "172.16.0.0/12" OR destination.ip LIKE "192.168.0.0/16") AND (network.protocol IN ("ipip", "gre") OR (network.transport == "udp" AND destination.port == 6080)), 1, true(), 0), host_ip = CASE(is_spoofed == 1, orig_src_ip, receives_tunnel == 1, destination.ip, true(), NULL)
| WHERE host_ip IS NOT NULL
| STATS spoofed_flag = VALUES(is_spoofed), tunnel_flag = VALUES(receives_tunnel), spoofed_sources = VALUES(source.ip) BY host_ip
| WHERE MV_COUNT(spoofed_flag) > 0 AND MV_COUNT(tunnel_flag) > 0
| EVAL Name = "Source IP Spoofing via Vulnerable Tunneling Host", Description = CONCAT("Internal host ", host_ip, " is suspected of being abused for source IP spoofing. It has been observed receiving inbound tunneling traffic AND sending outbound traffic with a non-authorized source IP address (e.g., ", MV_INDEX(spoofed_sources, 0), ")."), Tactics = "Defense Evasion, Initial Access", Techniques = "T1090"
| RENAME host_ip AS AbusedHost
| KEEP AbusedHost, spoofed_sources, Name, Description, Tactics, Techniques

-- Detection 8: Suspicious Open Ports on Tunneling Hosts
FROM pan_traffic, cisco_asa
| WHERE event.action == "allow" AND network.direction == "inbound" AND (network.protocol IN ("ipip", "gre") OR (network.transport == "udp" AND destination.port == 6080)) AND NOT (source.ip LIKE "10.0.0.0/8" OR source.ip LIKE "172.16.0.0/12" OR source.ip LIKE "192.168.0.0/16") AND (destination.ip LIKE "10.0.0.0/8" OR destination.ip LIKE "172.16.0.0/12" OR destination.ip LIKE "192.168.0.0/16")
| STATS TunnelProtocols = VALUES(network.protocol), TunnelSources = VALUES(source.ip) BY destination.ip AS InternalHost
| JOIN [FROM pan_traffic, cisco_asa | WHERE event.action == "allow" AND network.direction == "inbound" AND destination.port IN (80, 443, 179, 123, 161, 162) AND NOT (source.ip LIKE "10.0.0.0/8" OR source.ip LIKE "172.16.0.0/12" OR source.ip LIKE "192.168.0.0/16") AND (destination.ip LIKE "10.0.0.0/8" OR destination.ip LIKE "172.16.0.0/12" OR destination.ip LIKE "192.168.0.0/16") | STATS OpenPorts = VALUES(destination.port), OpenPortSources = VALUES(source.ip) BY destination.ip AS InternalHost] ON InternalHost
| EVAL Name = "Suspicious Open Ports on Tunneling Host", Description = CONCAT("Host ", InternalHost, " receives tunneling traffic (Protocols: ", MV_JOIN(TunnelProtocols, ", "), ") and also has common service ports open (Ports: ", MV_JOIN(OpenPorts, ", "), "). This combination suggests a misconfigured or vulnerable host."), Tactics = "Resource Development, Reconnaissance", Techniques = "T1583, T1595"
| KEEP InternalHost, TunnelProtocols, OpenPorts, TunnelSources, OpenPortSources, Name, Description, Tactics, Techniques
```

### Sentinel One
---
```sql
-- Detection 1: Routing Loop DoS Attack
SELECT FLOOR(UNIX_TIMESTAMP(EventTime)/600)*600 AS _time, SrcIP AS Computer, SUM(NetworkBytes) AS TotalBytesSent, GROUP_CONCAT(DstIP6) AS DestinationIpSet, 'Routing Loop DoS Attack' AS Name, CONCAT('A high volume of outbound traffic, potentially indicative of a Routing Loop DoS attack, was detected from host ', SrcIP, '. The attack leverages specially crafted IPv6 packets to cause a packet loop on vulnerable tunneling interfaces.') AS Description, 'Denial ofService' AS Tactics, 'Network Denial of Service' AS Techniques
FROM events
WHERE EventType='Network' AND Direction='Outbound' AND DstIP6 IS NOT NULL AND DstIP6 LIKE '::/96' AND DstIP6 NOT LIKE '::ffff:0:0/96' AND DstIP6 != '::1' AND DstIP6 != '::'
GROUP BY _time, SrcIP
HAVING TotalBytesSent > 100000000
SELECT MIN(_time) AS StartTime, MAX(_time) AS EndTime, Computer, SUM(TotalBytesSent) AS TotalBytesSent, DestinationIpSet, Name, Description, Tactics, Techniques
GROUP BY Computer;

-- Detection 2: Ping-Pong Amplification DoS Attack
SELECT host1, host2, host1_to_host2_bytes, host2_to_host1_bytes, MIN(host1_to_host2_bytes, host2_to_host1_bytes)/MAX(host1_to_host2_bytes, host2_to_host1_bytes) AS SymmetryRatio, 'Ping-Pong Amplification DoS Attack' AS Name, CONCAT('Potential Ping-Pong DoS attack detected between hosts ', host1, ' and ', host2, '. A high volume of symmetric traffic was observed, characteristic of this attack pattern.') AS Description, 'Denial of Service' AS Tactics, 'Network Denial of Service' AS Techniques
FROM (
  SELECT SrcIP AS host1, DstIP AS host2, SUM(NetworkBytes) AS host1_to_host2_bytes
  FROM events
  WHERE EventType='Network' AND (SrcIP LIKE '10.0.0.0/8' OR SrcIP LIKE '172.16.0.0/12' OR SrcIP LIKE '192.168.0.0/16') AND (DstIP LIKE '10.0.0.0/8' OR DstIP LIKE '172.16.0.0/12' OR DstIP LIKE '192.168.0.0/16')
  GROUP BY SrcIP, DstIP
) t1
JOIN (
  SELECT SrcIP AS host2, DstIP AS host1, SUM(NetworkBytes) AS host2_to_host1_bytes
  FROM events
  WHERE EventType='Network' AND (SrcIP LIKE '10.0.0.0/8' OR SrcIP LIKE '172.16.0.0/12' OR SrcIP LIKE '192.168.0.0/16') AND (DstIP LIKE '10.0.0.0/8' OR DstIP LIKE '172.16.0.0/12' OR DstIP LIKE '192.168.0.0/16')
  GROUP BY SrcIP, DstIP
) t2 ON t1.host1 = t2.host2 AND t1.host2 = t2.host1
WHERE t1.host1 < t1.host2 AND host1_to_host2_bytes > 500000000 AND host2_to_host1_bytes > 500000000 AND SymmetryRatio >= 0.7;

-- Detection 3: Tunnelled-Temporal Lensing (TuTL) DoS Attack
SELECT FLOOR(UNIX_TIMESTAMP(EventTime)/60)60 AS _time, DstIP AS VictimHost, SUM(NetworkBytes) AS SpikeBytesReceived, COUNT(DISTINCT SrcIP) AS DistinctSourceIpCount, 'Tunnelled-Temporal Lensing (TuTL) DoS Attack' AS Name, CONCAT('A sudden, high-volume traffic spike, characteristic of a TuTL DoS attack, was detected targeting host ', DstIP, '. The attack concentrates traffic from ', COUNT(DISTINCT SrcIP), ' distinct IPs into a short time window.') AS Description, 'Denial of Service' AS Tactics, 'Network Denial of Service' AS Techniques
FROM events
WHERE EventType='Network' AND Direction='Inbound'
GROUP BY _time, DstIP
HAVING SpikeBytesReceived > 500000000 AND DistinctSourceIpCount > 20
HAVING SpikeBytesReceived > (SELECT AVG(SpikeBytesReceived) + 2STDDEV(SpikeBytesReceived) FROM (SELECT SUM(NetworkBytes) AS SpikeBytesReceived FROM events WHERE EventType='Network' AND Direction='Inbound' GROUP BY DstIP) t WHERE t.DstIP = VictimHost);

-- Detection 4: Administrative DoS via Spoofed Traffic
SELECT t1.SrcIP AS ProxyHost, t1.DstIP AS TargetHost, t1.SentSYNs, COALESCE(t2.ReceivedSYNACKs, 0) AS ReceivedSYNACKs, COALESCE(t2.ReceivedSYNACKs, 0)/t1.SentSYNs AS SynAckRatio, 'Administrative DoS via Spoofed Traffic' AS Name, CONCAT('Host ', t1.SrcIP, ' sent ', t1.SentSYNs, ' TCP SYN packets to ', t1.DstIP, ' with a reply ratio of ', ROUND(COALESCE(t2.ReceivedSYNACKs, 0)/t1.SentSYNs100, 2), '%. This suggests source IP spoofing, potentially to trigger abuse reports.') AS Description, 'Denial of Service, Defense Evasion' AS Tactics, 'Network Denial of Service, IP Address Spoofing' AS Techniques
FROM (
  SELECT SrcIP, DstIP, COUNT() AS SentSYNs
  FROM events
  WHERE EventType='Network' AND Direction='Outbound' AND TCPFlags='S'
  GROUP BY SrcIP, DstIP
  HAVING SentSYNs > 1000
) t1
LEFT JOIN (
  SELECT SrcIP, DstIP, COUNT(*) AS ReceivedSYNACKs
  FROM events
  WHERE EventType='Network' AND Direction='Inbound' AND TCPFlags='SA'
  GROUP BY SrcIP, DstIP
) t2 ON t1.SrcIP = t2.DstIP AND t1.DstIP = t2.SrcIP
WHERE COALESCE(t2.ReceivedSYNACKs, 0)/t1.SentSYNs < 0.05;

-- Detection 5: Economic Denial of Sustainability (EDoS) Attack
SELECT host, SUM(TotalBytesReceived) AS TotalBytesReceived, SUM(TotalBytesSent) AS TotalBytesSent, 'Economic Denial of Sustainability (EDoS) Attack' AS Name, CONCAT('Host ', host, ' has generated high volumes of both inbound (', ROUND(SUM(TotalBytesReceived)/1024/1024/1024, 2), ' GB) and outbound (', ROUND(SUM(TotalBytesSent)/1024/1024/1024, 2), ' GB) traffic, consistent with an EDoS attack.') AS Description, 'Denial of Service' AS Tactics, 'Network Denial of Service' AS Techniques
FROM (
  SELECT DstIP AS host, SUM(NetworkBytes) AS TotalBytesReceived, 0 AS TotalBytesSent
  FROM events
  WHERE EventType='Network' AND Direction='Inbound' AND (DstIP LIKE '10.0.0.0/8' OR DstIP LIKE '172.16.0.0/12' OR DstIP LIKE '192.168.0.0/16')
  GROUP BY DstIP
  UNION
  SELECT SrcIP AS host, 0 AS TotalBytesReceived, SUM(NetworkBytes) AS TotalBytesSent
  FROM events
  WHERE EventType='Network' AND Direction='Outbound' AND (SrcIP LIKE '10.0.0.0/8' OR SrcIP LIKE '172.16.0.0/12' OR SrcIP LIKE '192.168.0.0/16')
  GROUP BY SrcIP
) t
GROUP BY host
HAVING TotalBytesReceived > 1000000000 AND TotalBytesSent > 1000000000;

-- Detection 6: Unauthenticated Tunneling Traffic from External Source
SELECT SrcIP AS ExternalSource, DstIP AS InternalHost, CASE WHEN Protocol=4 THEN 'IPIP' WHEN Protocol=47 THEN 'GRE' WHEN Protocol=41 THEN '6in4/4in6' WHEN Transport='udp' THEN 'GUE' ELSE 'Unknown' END AS TunnelProtocol, COUNT(*) AS count, SUM(NetworkBytes) AS TotalBytes, 'Unauthenticated Tunneling Traffic from External Source' AS Name, CONCAT('Detected unauthenticated tunneling traffic (Protocol: ', CASE WHEN Protocol=4 THEN 'IPIP' WHEN Protocol=47 THEN 'GRE' WHEN Protocol=41 THEN '6in4/4in6' WHEN Transport='udp' THEN 'GUE' ELSE 'Unknown' END, ') from an unknown external source (', SrcIP, ') to an internal host (', DstIP, ').') AS Description, 'Initial Access, Defense Evasion' AS Tactics, 'T1090' AS Techniques
FROM events
WHERE EventType='Network' AND NOT (SrcIP LIKE '10.0.0.0/8' OR SrcIP LIKE '172.16.0.0/12' OR SrcIP LIKE '192.168.0.0/16' OR SrcIP IN ('KNOWN_PEER_IP_1', 'KNOWN_PEER_IP_2')) AND (DstIP LIKE '10.0.0.0/8' OR DstIP LIKE '172.16.0.0/12' OR DstIP LIKE '192.168.0.0/16') AND (Protocol IN (4, 47, 41) OR (Transport='udp' AND DstPort=6080))
GROUP BY SrcIP, DstIP, Protocol, Transport, DstPort;

-- Detection 7: Source IP Spoofing via Vulnerable Tunneling Host
SELECT host_ip AS AbusedHost, GROUP_CONCAT(spoofed_sources) AS spoofed_sources, 'Source IP Spoofing via Vulnerable Tunneling Host' AS Name, CONCAT('Internal host ', host_ip, ' is suspected of being abused for source IP spoofing. It has been observed receiving inbound tunneling traffic AND sending outbound traffic with a non-authorized source IP address (e.g., ', GROUP_CONCAT(spoofed_sources), ').') AS Description, 'Defense Evasion, Initial Access' AS Tactics, 'T1090' AS Techniques
FROM (
  SELECT OrigSrcIP AS host_ip, 1 AS spoofed_flag, 0 AS tunnel_flag, SrcIP AS spoofed_sources
  FROM events
  WHERE SourceType='pan:traffic' AND Direction='Outbound' AND OrigSrcIP IS NOT NULL AND (OrigSrcIP LIKE '10.0.0.0/8' OR OrigSrcIP LIKE '172.16.0.0/12' OR OrigSrcIP LIKE '192.168.0.0/16') AND NOT (SrcIP LIKE 'YOUR_PUBLIC_IP_1/24' OR SrcIP LIKE 'YOUR_PUBLIC_IP_2/24')
  UNION
  SELECT DstIP AS host_ip, 0 AS spoofed_flag, 1 AS tunnel_flag, SrcIP AS spoofed_sources
  FROM events
  WHERE SourceType='pan:traffic' AND Direction='Inbound' AND NOT (SrcIP LIKE '10.0.0.0/8' OR SrcIP LIKE '172.16.0.0/12' OR SrcIP LIKE '192.168.0.0/16') AND (DstIP LIKE '10.0.0.0/8' OR DstIP LIKE '172.16.0.0/12' OR DstIP LIKE '192.168.0.0/16') AND (Protocol IN ('ipip', 'gre') OR (Protocol='udp' AND DstPort=6080))
) t
GROUP BY host_ip
HAVING COUNT(spoofed_flag) > 0 AND COUNT(tunnel_flag) > 0;

-- Detection 8: Suspicious Open Ports on Tunneling Hosts
SELECT t1.DstIP AS InternalHost, GROUP_CONCAT(t1.Protocol) AS TunnelProtocols, GROUP_CONCAT(t1.SrcIP) AS TunnelSources, GROUP_CONCAT(t2.OpenPorts) AS OpenPorts, GROUP_CONCAT(t2.SrcIP) AS OpenPortSources, 'Suspicious Open Ports on Tunneling Host' AS Name, CONCAT('Host ', t1.DstIP, ' receives tunneling traffic (Protocols: ', GROUP_CONCAT(t1.Protocol), ') and also has common service ports open (Ports: ', GROUP_CONCAT(t2.OpenPorts), '). This combination suggests a misconfigured or vulnerable host.') AS Description, 'Resource Development, Reconnaissance' AS Tactics, 'T1583, T1595' AS Techniques
FROM (
  SELECT DstIP, Protocol, SrcIP
  FROM events
  WHERE SourceType IN ('pan:traffic', 'cisco:asa') AND Action='Allow' AND Direction='Inbound' AND (Protocol IN ('ipip', 'gre') OR (Protocol='udp' AND DstPort=6080)) AND NOT (SrcIP LIKE '10.0.0.0/8' OR SrcIP LIKE '172.16.0.0/12' OR SrcIP LIKE '192.168.0.0/16') AND (DstIP LIKE '10.0.0.0/8' OR DstIP LIKE '172.16.0.0/12' OR DstIP LIKE '192.168.0.0/16')
  GROUP BY DstIP, Protocol, SrcIP
) t1
JOIN (
  SELECT DstIP, GROUP_CONCAT(DstPort) AS OpenPorts, SrcIP
  FROM events
  WHERE SourceType IN ('pan:traffic', 'cisco:asa') AND Action='Allow' AND Direction='Inbound' AND DstPort IN (80, 443, 179, 123, 161, 162) AND NOT (SrcIP LIKE '10.0.0.0/8' OR SrcIP LIKE '172.16.0.0/12' OR SrcIP LIKE '192.168.0.0/16') AND (DstIP LIKE '10.0.0.0/8' OR DstIP LIKE '172.16.0.0/12' OR DstIP LIKE '192.168.0.0/16')
  GROUP BY DstIP, SrcIP
) t2 ON t1.DstIP = t2.DstIP
GROUP BY t1.DstIP;
```