### Active Directory Group Policy Exploitation Threat Report
---

This report details advanced Group Policy Object (GPO) exploitation techniques that allow attackers to leverage Active Directory for command and control (C2) and privilege escalation. These methods exploit GPO configurations, access control lists (ACLs), and NTLM relaying to achieve persistent and stealthy control over compromised environments.

Recent research highlights novel GPO exploitation methods, including the use of NTLM relaying to compromise GPOs by manipulating the gPCFileSysPath attribute, and GPO link poisoning via gPLink attribute modification to affect protected Organizational Units (OUs). These techniques are noteworthy as they enable attackers to gain control over GPOs even without direct write privileges over the Group Policy Template (GPT) files, and to target OUs that are typically considered more secure due to adminCount=1 settings.

### Actionable Threat Data
---

Suspicious GPO Modifications (LDAP): Monitor for modifications to critical GPO attributes, specifically gPCFileSysPath and gPLink. Unauthorized changes to gPCFileSysPath could indicate an attacker redirecting GPO clients to a malicious SMB share for C2. Changes to gPLink on OUs, especially those with adminCount=1 objects, could signal GPO link poisoning to inject malicious policies.

NTLM Relay Activity Targeting LDAP: Detect NTLM relay attacks where authentication attempts are relayed to the LDAP service. This can be identified by analyzing network traffic for NTLM authentication followed by LDAP communication from an unusual source, or by monitoring for Event ID 4624 (Logon Success) with a Logon Type 3 (Network Logon) where the Security ID is NULL SID and Logon ID and LogonGUID are null, indicating a relayed authentication.

Unusual SMB Share Access from Domain Controllers: Monitor for domain controllers accessing SMB shares from unusual or external IP addresses, particularly those not part of the SYSVOL replication. Attackers leveraging NTLM relaying to modify gPCFileSysPath will host malicious GPTs on their controlled SMB shares, leading to domain controllers attempting to retrieve GPO files from these rogue locations.

Creation or Modification of Scheduled Tasks via GPO: GPOs are frequently used to deploy scheduled tasks. Monitor for the creation or modification of scheduled tasks through GPOs that execute unusual commands, scripts, or executables, especially those with high privileges (e.g., SYSTEM). This is a common method for attackers to establish persistence and execute arbitrary code.

GPO-driven Privilege Assignment Changes: Monitor for GPO modifications that alter group memberships (e.g., adding users to "Domain Admins," "Enterprise Admins," or "Remote Desktop Users") or assign sensitive privileges (e.g., SeTcbPrivilege). Such changes can indicate privilege escalation attempts.

### Suspicious GPO Modifications
---
Rule Title: Suspicious GPO Modification via gPLink or gPCFileSysPath

Author: RW

Date: 2025-08-12

References:
 - https:ww.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more
 - https:ww.synacktiv.com/publications/ounedpy-exploiting-hidden-organizational-units-acl-attack-vectors-in-active-directory
 - https:ttack.mitre.org/techniques/T1484/001/

MITRE ATT&CK: T1484.001 - Group Policy Modification

Description:

Detects modifications to sensitive Group Policy Object (GPO) attributes (gPCFileSysPath, gPLink)
by non-standard administrative accounts. Such changes can indicate an attacker is attempting to
redirect clients to a malicious SMB share for C2 (gPCFileSysPath) or poison an
Organizational Unit (OU) with a malicious GPO (gPLink).

False Positives:

Legitimate GPO changes made by administrators not on the exclusion list.

It is critical to customize the 'known_gpo_admins' macro or list for your environment.

Triage Steps:

    1. Verify the user ('Subject_User_Name') and their role. Should they be modifying GPOs?
    2. Examine the 'Object_DN' to understand which GPO or OU was modified.
    3. Analyze the 'Attribute_Value'. If 'gPCFileSysPath' was changed, is the new path a legitimate SYSVOL share?
    If 'gPLink' was changed, is the new link to a valid and expected GPO?
    4. Review the change with the responsible administrator or team.

splunk:
```sql
`wineventlog_security`
-- Event ID 5136 indicates a directory service object was modified. This is logged on Domain Controllers.
EventCode=5136
-- Filter for modifications to gPCFileSysPath or gPLink attributes.
(Attribute_LDAP_Display_Name="gPCFileSysPath" OR Attribute_LDAP_Display_Name="gPLink")
-- The 'Object_Class' attribute helps confirm the type of object being modified.
Object_Class IN ("groupPolicyContainer", "organizationalUnit")
-- Exclude changes made by computer accounts (ending in '$').
NOT Subject_User_Name LIKE "%$"
-- Exclude known GPO administrator accounts to reduce false positives.
-- This list should be customized for your environment.
NOT Subject_User_Name IN ("Administrator", "SYSTEM" /*, "CONTOSO\\gpo_admin", "gpo_service_account" */)
-- Structure the output for readability and analysis.
| `get_old_attribute_value_from_eventdata`
| table _time, host, Subject_User_Name, Object_DN, Object_Class, Attribute_LDAP_Display_Name, Attribute_Value, Old_Attribute_Value
| rename host as "DomainController", Subject_User_Name as "User", Object_DN as "ModifiedObjectDN", Attribute_LDAP_Display_Name as "ModifiedAttribute", Attribute_Value as "NewValue", Old_Attribute_Value as "OldValue"
```

crowdstrike fql:
```sql
event_simpleName=WindowsEventLogSecurity EventID=5136
| filter (AttributeLDAPDisplayName="gPCFileSysPath" OR AttributeLDAPDisplayName="gPLink")
| filter ObjectClass IN ("groupPolicyContainer", "organizationalUnit")
| filter SubjectUserName !endswith "$"
| filter SubjectUserName !in ("Administrator", "SYSTEM")
| project timestamp, ComputerName, SubjectUserName, ObjectDN, ObjectClass, AttributeLDAPDisplayName, AttributeValue, OldAttributeValue
| rename ComputerName="DomainController", SubjectUserName="User", ObjectDN="ModifiedObjectDN", AttributeLDAPDisplayName="ModifiedAttribute", AttributeValue="NewValue", OldAttributeValue="OldValue"
```

datadog:
```sql
source:windows_security event_id:5136 (AttributeLDAPDisplayName:gPCFileSysPath OR AttributeLDAPDisplayName:gPLink) ObjectClass:(groupPolicyContainer OR organizationalUnit) -SubjectUserName:*$ -SubjectUserName:(Administrator OR SYSTEM)
| select @timestamp, host as DomainController, SubjectUserName as User, ObjectDN as ModifiedObjectDN, AttributeLDAPDisplayName as ModifiedAttribute, AttributeValue as NewValue, OldAttributeValue as OldValue
```

elastic:
```sql
FROM logs-windows.security-*
| WHERE event.code == "5136"
  AND (winlog.event_data.AttributeLDAPDisplayName IN ("gPCFileSysPath", "gPLink"))
  AND winlog.event_data.ObjectClass IN ("groupPolicyContainer", "organizationalUnit")
  AND NOT winlog.event_data.SubjectUserName LIKE "*\\$"
  AND NOT winlog.event_data.SubjectUserName IN ("Administrator", "SYSTEM")
| KEEP @timestamp, host.hostname, winlog.event_data.SubjectUserName, winlog.event_data.ObjectDN, winlog.event_data.ObjectClass, winlog.event_data.AttributeLDAPDisplayName, winlog.event_data.AttributeValue, winlog.event_data.OldAttributeValue
| EVAL DomainController = host.hostname, User = winlog.event_data.SubjectUserName, ModifiedObjectDN = winlog.event_data.ObjectDN, ModifiedAttribute = winlog.event_data.AttributeLDAPDisplayName, NewValue = winlog.event_data.AttributeValue, OldValue = winlog.event_data.OldAttributeValue
| DROP host.hostname, winlog.event_data.SubjectUserName, winlog.event_data.ObjectDN, winlog.event_data.ObjectClass, winlog.event_data.AttributeLDAPDisplayName, winlog.event_data.AttributeValue, winlog.event_data.OldAttributeValue
```

sentinel one:
```sql
EventType = "Windows Security Event" AND EventID = 5136
AND (AttributeLDAPDisplayName = "gPCFileSysPath" OR AttributeLDAPDisplayName = "gPLink")
AND ObjectClass IN ("groupPolicyContainer", "organizationalUnit")
AND SubjectUserName NOT LIKE "%$"
AND SubjectUserName NOT IN ("Administrator", "SYSTEM")
| SELECT Timestamp AS _time, EndpointName AS DomainController, SubjectUserName AS User, ObjectDN AS ModifiedObjectDN, ObjectClass, AttributeLDAPDisplayName AS ModifiedAttribute, AttributeValue AS NewValue, OldAttributeValue AS OldValue
```

### NTLM Relay to LDAP
---
Rule Title: NTLM Relay Attack to LDAP Service

Author: RW

Date: 2025-08-12

References:
- https:ww.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more
- https:ww.hackthebox.com/blog/ntlm-relay-attack-detection
- https:ww.crowdstrike.com/en-us/blog/how-to-detect-domain-controller-account-relay-attacks-with-crowdstrike-identity-protection/

MITRE ATT&CK: T1187 - Forced Authentication, T1557.001 - LLMNR/NBT-NS Poisoning and SMB Relay

Description:

Detects a successful NTLM network logon from a NULL SID (S-1-0-0). This pattern is a strong indicator of an NTLM relay attack,
where an attacker intercepts an authentication attempt and relays it to a target service, such as LDAP on a Domain Controller,
to perform actions on behalf of the relayed user. This is often used to modify Group Policy Objects (GPOs).

False Positives:

Some legitimate applications or network scanners might perform anonymous logons.

These should be investigated and excluded if they are determined to be benign.

Triage Steps:

    1. Identify the source IP address ('IpAddress'). Is this a known and trusted system?
    2. Identify the target host ('Computer'). Is it a Domain Controller or another high-value asset?
    3. Correlate the source IP with other logs (e.g., LDAP queries, SMB activity) around the time of the alert to understand the attacker's actions post-authentication.
    4. Verify that security controls like SMB signing and LDAP signing/channel binding are enabled to mitigate this type of attack.

splunk:
```sql
`wineventlog_security`
-- Event ID 4624 indicates a successful logon.
EventCode=4624
-- Logon Type 3 is a network logon, common for relayed authentication.
Logon_Type=3
-- The key indicator for a relayed session is a logon by the NULL SID.
Security_ID="S-1-0-0"
-- Filter for NTLM authentication, the protocol being relayed.
Authentication_Package="NTLM"
-- Exclude local logons which are typically not indicative of a relay attack.
Source_Network_Address!="127.0.0.1" Source_Network_Address!="::1"
-- Format the results for clear analysis.
| table _time, host, Source_Network_Address, Logon_Type, Authentication_Package, Logon_ID
| rename host as TargetComputer, Source_Network_Address as AttackerIp, Logon_Type as LogonType, Authentication_Package as AuthenticationPackage, Logon_ID as TargetLogonId
```

crowdstrike fql:
```sql
event_simpleName=WindowsEventLogSecurity EventID=4624
| filter LogonType=3
| filter SecurityID="S-1-0-0"
| filter AuthenticationPackageName="NTLM"
| filter SourceNetworkAddress !in ("127.0.0.1", "::1")
| project timestamp, ComputerName, SourceNetworkAddress, LogonType, AuthenticationPackageName, LogonID
| rename ComputerName="TargetComputer", SourceNetworkAddress="AttackerIp", LogonType="LogonType", AuthenticationPackageName="AuthenticationPackage", LogonID="TargetLogonId"
```

datadog:
```sql
source:windows_security event_id:4624 LogonType:3 SecurityID:"S-1-0-0" AuthenticationPackageName:NTLM -SourceNetworkAddress:(127.0.0.1 OR ::1)
| select @timestamp, host as TargetComputer, SourceNetworkAddress as AttackerIp, LogonType, AuthenticationPackageName as AuthenticationPackage, LogonID as TargetLogonId
```

elastic:
```sql
FROM logs-windows.security-*
| WHERE event.code == "4624"
  AND winlog.event_data.LogonType == "3"
  AND winlog.event_data.SecurityID == "S-1-0-0"
  AND winlog.event_data.AuthenticationPackageName == "NTLM"
  AND winlog.event_data.IpAddress NOT IN ("127.0.0.1", "::1")
| KEEP @timestamp, host.hostname, winlog.event_data.IpAddress, winlog.event_data.LogonType, winlog.event_data.AuthenticationPackageName, winlog.event_data.LogonID
| EVAL TargetComputer = host.hostname, AttackerIp = winlog.event_data.IpAddress, LogonType = winlog.event_data.LogonType, AuthenticationPackage = winlog.event_data.AuthenticationPackageName, TargetLogonId = winlog.event_data.LogonID
| DROP host.hostname, winlog.event_data.IpAddress, winlog.event_data.LogonType, winlog.event_data.AuthenticationPackageName, winlog.event_data.LogonID
```

sentinel one:
```sql
EventType = "Windows Security Event" AND EventID = 4624
AND LogonType = 3
AND SecurityID = "S-1-0-0"
AND AuthenticationPackageName = "NTLM"
AND SourceNetworkAddress NOT IN ("127.0.0.1", "::1")
| SELECT Timestamp AS _time, EndpointName AS TargetComputer, SourceNetworkAddress AS AttackerIp, LogonType, AuthenticationPackageName AS AuthenticationPackage, LogonID AS TargetLogonId
```

### Unusual SMB from DC
---
Rule Title: Unusual Outbound SMB from Domain Controller

Author: RW

Date: 2025-08-12

References:
- https:ww.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more

MITRE ATT&CK: T1021.002 - SMB/Windows Admin Shares, T1070.004 - Indicator Removal on Host: File Deletion

Description:

Detects a Domain Controller (DC) initiating an outbound SMB connection to an external (non-private) IP address.
This is highly anomalous behavior. A primary cause for this is an NTLM relay attack where an attacker
modifies a GPO's 'gPCFileSysPath' attribute to point to an attacker-controlled, external SMB share.
When the DC attempts to fetch the Group Policy Template (GPT) from this malicious share, it triggers this alert.

False Positives:

This activity is rare. However, some environments might have legitimate reasons for a DC to connect to an external SMB share (e.g., specific cloud services).

Such known-good destinations should be added to the 'TrustedExternalSmbDestinations' list to prevent false positives.

Triage Steps:

    1. Confirm the source device ('DeviceName') is a Domain Controller.
    2. Investigate the destination IP ('RemoteIP'). Is this a known and trusted business partner or cloud service?
    3. On the Domain Controller, look for recent Directory Service Changes events (Event ID 5136) for modifications to the 'gPCFileSysPath' attribute on any GPO.
    4. Examine the 'InitiatingProcessFileName' to understand what process on the DC made the connection. For GPO updates, this is typically 'svchost.exe'.
    5. Correlate this activity with any recent NTLM relay or forced authentication alerts.

splunk:
```sql
`sysmon_index` EventCode=3 DestinationPort=445
-- Filter for connections originating from Domain Controllers.
| where `domain_controllers`
-- Filter for destination IPs that are not in private RFC 1918 ranges.
| where NOT (cidrmatch("10.0.0.0/8", DestinationIp) OR cidrmatch("172.16.0.0/12", DestinationIp) OR cidrmatch("192.168.0.0/16", DestinationIp) OR cidrmatch("127.0.0.0/8", DestinationIp) OR cidrmatch("169.254.0.0/16", DestinationIp))
-- Exclude any specifically trusted external IPs.
| where `trusted_external_smb_destinations`
-- Format the output for readability.
| table _time, Computer, Image, CommandLine, DestinationIp
| rename Computer as DeviceName, Image as InitiatingProcessFileName, CommandLine as InitiatingProcessCommandLine, DestinationIp as RemoteIP
```

crowdstrike fql:
```sql
event_simpleName=NetworkConnect EventID=3 DestinationPort=445
| filter ComputerName IN (domain_controllers)
| filter DestinationIPAddress !in ("10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.0/8", "169.254.0.0/16")
| filter DestinationIPAddress !in (trusted_external_smb_destinations)
| project timestamp, ComputerName, Image, CommandLine, DestinationIPAddress
| rename ComputerName="DeviceName", Image="InitiatingProcessFileName", CommandLine="InitiatingProcessCommandLine", DestinationIPAddress="RemoteIP"
```

datadog:
```sql
source:sysmon event_id:3 DestinationPort:445 Computer:(domain_controllers) -DestinationIp:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16 OR 127.0.0.0/8 OR 169.254.0.0/16) -DestinationIp:(trusted_external_smb_destinations)
| select @timestamp, Computer as DeviceName, Image as InitiatingProcessFileName, CommandLine as InitiatingProcessCommandLine, DestinationIp as RemoteIP
```

elastic:
```sql
FROM logs-sysmon-*
| WHERE event.code == "3" AND destination.port == 445
  AND host.hostname IN (domain_controllers)
  AND NOT (destination.ip MATCHES "10.0.0.0/8" OR destination.ip MATCHES "172.16.0.0/12" OR destination.ip MATCHES "192.168.0.0/16" OR destination.ip MATCHES "127.0.0.0/8" OR destination.ip MATCHES "169.254.0.0/16")
  AND NOT destination.ip IN (trusted_external_smb_destinations)
| KEEP @timestamp, host.hostname, process.executable, process.command_line, destination.ip
| EVAL DeviceName = host.hostname, InitiatingProcessFileName = process.executable, InitiatingProcessCommandLine = process.command_line, RemoteIP = destination.ip
| DROP host.hostname, process.executable, process.command_line, destination.ip
```

sentinel one:
```sql
EventType = "Sysmon Network Connect" AND EventID = 3 AND DestinationPort = 445
AND EndpointName IN (domain_controllers)
AND DestinationIPAddress NOT IN ("10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.0/8", "169.254.0.0/16")
AND DestinationIPAddress NOT IN (trusted_external_smb_destinations)
| SELECT Timestamp AS _time, EndpointName AS DeviceName, Image AS InitiatingProcessFileName, CommandLine AS InitiatingProcessCommandLine, DestinationIPAddress AS RemoteIP
```

### GPO Scheduled Task Creation
---
Rule Title: GPO Modified to Include Scheduled Task

Author: RW

Date: 2025-08-12

References:
- https:ww.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more
- https:earn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpac/13333232-d52a-46a3-959f-63311ad74197 (Scheduled Tasks CSE GUID)

MITRE ATT&CK: T1053.005 - Scheduled Task/Job: Scheduled Task, T1484.001 - Group Policy Modification

Description:

Detects when a Group Policy Object (GPO) is modified to include the Scheduled Tasks Client-Side Extension (CSE).
This indicates that a policy to create, modify, or delete a scheduled task is being configured within the GPO.
While this is a legitimate administrative action, attackers can abuse it to deploy malicious scheduled tasks for persistence or execution.
This alert serves as an early warning to investigate the content of the GPO change.

False Positives:

Legitimate administrative activity where a new GPO is created to manage scheduled tasks, or an existing GPO is modified to do so for the first time.

It is crucial to tune the 'known_gpo_admins' list to exclude routine administrative accounts.

Triage Steps:

    1. Identify the user who made the change ('SubjectUserName'). Is this an authorized administrator?
    2. Identify the GPO that was modified ('ObjectDN'). What is its purpose and what systems does it apply to?
    3. Manually inspect the GPO's corresponding files on the SYSVOL share (e.g., \\<domain>\SYSVOL\<domain>\Policies\<GPO_GUID>\Machine\Preferences\ScheduledTasks\ScheduledTasks.xml).
    4. Look for the specific task being configured. Analyze its command line, arguments, and execution context for suspicious activity (e.g., running PowerShell from a non-standard location, obfuscated commands, etc.).
    5. Correlate this change with any file modification events on the SYSVOL share for the specific GPO.

splunk:
```sql
`wineventlog_security`
-- Event ID 5136 indicates a directory service object was modified.
EventCode=5136
-- Focus on GPO objects.
Object_Class="groupPolicyContainer"
-- Focus on the attributes that list the enabled Client-Side Extensions.
Attribute_LDAP_Display_Name IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
-- Check if the new attribute value contains the GUID for the Scheduled Tasks CSE.
-- GUID for Scheduled Tasks CSE: {A2E30F80-D7DE-411d-99C3-236F796636B8}
Attribute_Value="*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
-- Exclude changes made by computer accounts (ending in '$') and known administrators.
-- This list should be customized for your environment.
NOT Subject_User_Name IN ("*$", "Administrator", "SYSTEM" /*, "CONTOSO\\gpo_admin" */)
-- Extract the Old Value from the message field to compare. This macro should be defined to suit your data source.
| `get_old_attribute_value_from_eventdata`
-- Alert only when the Scheduled Tasks CSE is newly added, which is a more significant change.
| where NOT like(Old_Attribute_Value, "%{A2E30F80-D7DE-411d-99C3-236F796636B8}%")
-- Format the output for readability.
| table _time, host, Subject_User_Name, Object_DN, Attribute_LDAP_Display_Name, Attribute_Value, Old_Attribute_Value
| rename host as "DomainController", Subject_User_Name as "User", Object_DN as "ModifiedObjectDN", Attribute_LDAP_Display_Name as "ModifiedAttribute", Attribute_Value as "NewValue", Old_Attribute_Value as "OldValue"
```

crowdstrike fql:
```sql
event_simpleName=WindowsEventLogSecurity EventID=5136
| filter ObjectClass="groupPolicyContainer"
| filter AttributeLDAPDisplayName IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
| filter AttributeValue LIKE "*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
| filter SubjectUserName !in ("Administrator", "SYSTEM") AND SubjectUserName !endswith "$"
| filter OldAttributeValue !LIKE "*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
| project timestamp, ComputerName, SubjectUserName, ObjectDN, AttributeLDAPDisplayName, AttributeValue, OldAttributeValue
| rename ComputerName="DomainController", SubjectUserName="User", ObjectDN="ModifiedObjectDN", AttributeLDAPDisplayName="ModifiedAttribute", AttributeValue="NewValue", OldAttributeValue="OldValue"
```

datadog:
```sql
source:windows_security event_id:5136 ObjectClass:groupPolicyContainer (AttributeLDAPDisplayName:gPCMachineExtensionNames OR AttributeLDAPDisplayName:gPCUserExtensionNames) AttributeValue:"*{A2E30F80-D7DE-411d-99C3-236F796636B8}*" -SubjectUserName:(*$ OR Administrator OR SYSTEM) -OldAttributeValue:"*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
| select @timestamp, host as DomainController, SubjectUserName as User, ObjectDN as ModifiedObjectDN, AttributeLDAPDisplayName as ModifiedAttribute, AttributeValue as NewValue, OldAttributeValue as OldValue
```

elastic:
```sql
FROM logs-windows.security-*
| WHERE event.code == "5136"
  AND winlog.event_data.ObjectClass == "groupPolicyContainer"
  AND winlog.event_data.AttributeLDAPDisplayName IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
  AND winlog.event_data.AttributeValue LIKE "*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
  AND NOT winlog.event_data.SubjectUserName LIKE "*\\$"
  AND NOT winlog.event_data.SubjectUserName IN ("Administrator", "SYSTEM")
  AND NOT winlog.event_data.OldAttributeValue LIKE "*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
| KEEP @timestamp, host.hostname, winlog.event_data.SubjectUserName, winlog.event_data.ObjectDN, winlog.event_data.AttributeLDAPDisplayName, winlog.event_data.AttributeValue, winlog.event_data.OldAttributeValue
| EVAL DomainController = host.hostname, User = winlog.event_data.SubjectUserName, ModifiedObjectDN = winlog.event_data.ObjectDN, ModifiedAttribute = winlog.event_data.AttributeLDAPDisplayName, NewValue = winlog.event_data.AttributeValue, OldValue = winlog.event_data.OldAttributeValue
| DROP host.hostname, winlog.event_data.SubjectUserName, winlog.event_data.ObjectDN, winlog.event_data.AttributeLDAPDisplayName, winlog.event_data.AttributeValue, winlog.event_data.OldAttributeValue
```

sentinel one:
```sql
EventType = "Windows Security Event" AND EventID = 5136
AND ObjectClass = "groupPolicyContainer"
AND AttributeLDAPDisplayName IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
AND AttributeValue LIKE "*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
AND SubjectUserName NOT IN ("Administrator", "SYSTEM") AND SubjectUserName NOT LIKE "%$"
AND OldAttributeValue NOT LIKE "*{A2E30F80-D7DE-411d-99C3-236F796636B8}*"
| SELECT Timestamp AS _time, EndpointName AS DomainController, SubjectUserName AS User, ObjectDN AS ModifiedObjectDN, AttributeLDAPDisplayName AS ModifiedAttribute, AttributeValue AS NewValue, OldAttributeValue AS OldValue
```

### GPO Privilege Assignment
---
Rule Title: GPO Modified for Privilege Assignment

Author: RW

Date: 2025-08-12

References:
- https:ww.synacktiv.com/publications/gpoddity-exploiting-active-directory-gpos-through-ntlm-relaying-and-more
- https:earn.microsoft.com/en-us/openspecs/windows_protocols/ms-gpac/4dc17448-3336-4ae4-9570-33359b1f4242 (Security CSE)
- https:earn.microsoft.com/en-us/openspecs/windows_protocols/ms-gppc/26a24583-8315-47b8-b2ff-f88c01ab0e1e (Local Users and Groups CSE)

MITRE ATT&CK: T1484.001 - Group Policy Modification, T1098 - Account Manipulation

Description:

Detects when a Group Policy Object (GPO) is modified to include Client-Side Extensions (CSEs) for managing local group memberships or user rights assignments.
While this can be a legitimate administrative action, attackers can abuse this capability to escalate privileges by adding accounts to sensitive local groups (e.g., Administrators) or granting powerful user rights.

This alert serves as an early warning to investigate the specific changes made within the GPO.

False Positives:

Legitimate administrative activity where a GPO is configured to manage local security settings for the first time.

It is crucial to customize the 'known_gpo_admins' list to exclude routine administrative accounts and reduce noise.

Triage Steps:

    1. Identify the user who made the change ('SubjectUserName'). Is this an authorized administrator for GPOs?
    2. Identify the GPO that was modified ('ObjectDN'). What is its purpose and what systems does it apply to?
    3. Manually inspect the GPO's corresponding files on the SYSVOL share.
    - For group membership changes, check: \\<domain>\SYSVOL\<domain>\Policies\<GPO_GUID>\Machine\Preferences\Groups\Groups.xml
    - For user rights changes, check: \\<domain>\SYSVOL\<domain>\Policies\<GPO_GUID>\Machine\Microsoft\Windows NT\SecEdit\GptTmpl.inf
    4. Look for suspicious modifications, such as adding non-standard users to the local Administrators group or granting high-impact privileges like SeDebugPrivilege.

splunk:
```sql
`wineventlog_security`
-- Event ID 5136 indicates a directory service object was modified.
EventCode=5136
-- Focus on GPO objects.
Object_Class="groupPolicyContainer"
-- Focus on the attributes that list the enabled Client-Side Extensions.
Attribute_LDAP_Display_Name IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
-- Exclude changes made by computer accounts (ending in '$') and known administrators.
-- This list should be customized for your environment.
NOT Subject_User_Name IN ("*$", "Administrator", "SYSTEM" /*, "CONTOSO\\gpo_admin" */)
-- Extract the Old Value from the message field to compare. This may require a custom macro or rex command.
| `get_old_attribute_value_from_eventdata`
-- Check for the new addition of CSEs related to privilege assignment.
-- Security CSE GUID: {827D319E-6EAC-11D2-A4EA-00C04F79F83A}
-- Local Users and Groups CSE GUID: {17D8960F-8550-4c99-842A-693041CEE45A}
| where ( (like(Attribute_Value, "%{827D319E-6EAC-11D2-A4EA-00C04F79F83A}%") AND NOT like(Old_Attribute_Value, "%{827D319E-6EAC-11D2-A4EA-00C04F79F83A}%")) OR
          (like(Attribute_Value, "%{17D8960F-8550-4c99-842A-693041CEE45A}%") AND NOT like(Old_Attribute_Value, "%{17D8960F-8550-4c99-842A-693041CEE45A}%")) )
-- Format the output for readability.
| table _time, host, Subject_User_Name, Object_DN, Attribute_LDAP_Display_Name, Attribute_Value, Old_Attribute_Value
| rename host as "DomainController", Subject_User_Name as "User", Object_DN as "ModifiedObjectDN", Attribute_LDAP_Display_Name as "ModifiedAttribute", Attribute_Value as "NewValue", Old_Attribute_Value as "OldValue"
```

crowdstrike fql:
```sql
event_simpleName=WindowsEventLogSecurity EventID=5136
| filter ObjectClass="groupPolicyContainer"
| filter AttributeLDAPDisplayName IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
| filter SubjectUserName !in ("Administrator", "SYSTEM") AND SubjectUserName !endswith "$"
| filter (
    (AttributeValue LIKE "*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*" AND OldAttributeValue !LIKE "*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*") OR
    (AttributeValue LIKE "*{17D8960F-8550-4c99-842A-693041CEE45A}*" AND OldAttributeValue !LIKE "*{17D8960F-8550-4c99-842A-693041CEE45A}*")
)
| project timestamp, ComputerName, SubjectUserName, ObjectDN, AttributeLDAPDisplayName, AttributeValue, OldAttributeValue
| rename ComputerName="DomainController", SubjectUserName="User", ObjectDN="ModifiedObjectDN", AttributeLDAPDisplayName="ModifiedAttribute", AttributeValue="NewValue", OldAttributeValue="OldValue"
```

datadog:
```sql
source:windows_security event_id:5136 ObjectClass:groupPolicyContainer (AttributeLDAPDisplayName:gPCMachineExtensionNames OR AttributeLDAPDisplayName:gPCUserExtensionNames) -SubjectUserName:(*$ OR Administrator OR SYSTEM) ((AttributeValue:"*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*" -OldAttributeValue:"*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*") OR (AttributeValue:"*{17D8960F-8550-4c99-842A-693041CEE45A}*" -OldAttributeValue:"*{17D8960F-8550-4c99-842A-693041CEE45A}*"))
| select @timestamp, host as DomainController, SubjectUserName as User, ObjectDN as ModifiedObjectDN, AttributeLDAPDisplayName as ModifiedAttribute, AttributeValue as NewValue, OldAttributeValue as OldValue
```

elastic:
```sql
FROM logs-windows.security-*
| WHERE event.code == "5136"
  AND winlog.event_data.ObjectClass == "groupPolicyContainer"
  AND winlog.event_data.AttributeLDAPDisplayName IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
  AND NOT winlog.event_data.SubjectUserName LIKE "*\\$"
  AND NOT winlog.event_data.SubjectUserName IN ("Administrator", "SYSTEM")
  AND (
      (winlog.event_data.AttributeValue LIKE "*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*" AND NOT winlog.event_data.OldAttributeValue LIKE "*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*") OR
      (winlog.event_data.AttributeValue LIKE "*{17D8960F-8550-4c99-842A-693041CEE45A}*" AND NOT winlog.event_data.OldAttributeValue LIKE "*{17D8960F-8550-4c99-842A-693041CEE45A}*")
  )
| KEEP @timestamp, host.hostname, winlog.event_data.SubjectUserName, winlog.event_data.ObjectDN, winlog.event_data.AttributeLDAPDisplayName, winlog.event_data.AttributeValue, winlog.event_data.OldAttributeValue
| EVAL DomainController = host.hostname, User = winlog.event_data.SubjectUserName, ModifiedObjectDN = winlog.event_data.ObjectDN, ModifiedAttribute = winlog.event_data.AttributeLDAPDisplayName, NewValue = winlog.event_data.AttributeValue, OldValue = winlog.event_data.OldAttributeValue
| DROP host.hostname, winlog.event_data.SubjectUserName, winlog.event_data.ObjectDN, winlog.event_data.AttributeLDAPDisplayName, winlog.event_data.AttributeValue, winlog.event_data.OldAttributeValue
```

sentinel one:
```sql
EventType = "Windows Security Event" AND EventID = 5136
AND ObjectClass = "groupPolicyContainer"
AND AttributeLDAPDisplayName IN ("gPCMachineExtensionNames", "gPCUserExtensionNames")
AND SubjectUserName NOT IN ("Administrator", "SYSTEM") AND SubjectUserName NOT LIKE "%$"
AND (
    (AttributeValue LIKE "*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*" AND OldAttributeValue NOT LIKE "*{827D319E-6EAC-11D2-A4EA-00C04F79F83A}*") OR
    (AttributeValue LIKE "*{17D8960F-8550-4c99-842A-693041CEE45A}*" AND OldAttributeValue NOT LIKE "*{17D8960F-8550-4c99-842A-693041CEE45A}*")
)
| SELECT Timestamp AS _time, EndpointName AS DomainController, SubjectUserName AS User, ObjectDN AS ModifiedObjectDN, AttributeLDAPDisplayName AS ModifiedAttribute, AttributeValue AS NewValue, OldAttributeValue AS OldValue
```