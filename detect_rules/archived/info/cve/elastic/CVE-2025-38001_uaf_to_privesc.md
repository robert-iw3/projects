### CVE-2025-38001: A RBTree Family Drama
---

CVE-2025-38001 is a Use-After-Free (UAF) vulnerability in the Linux kernel's Hierarchical Fair Service Curve (HFSC) queuing discipline, exploitable when combined with the Network Emulation (NETEM) module's packet duplication feature and a low-rate Token Bucket Filter (TBF) root qdisc. This flaw allows for local privilege escalation by manipulating RBTree structures to achieve a page-level data-only attack, ultimately leading to arbitrary code execution and root access.

Recent intelligence confirms that this vulnerability has been actively exploited in the wild to compromise Google kernelCTF instances and Debian 12 systems, demonstrating its effectiveness in real-world scenarios. The exploit leverages an innovative RBTree pointer-copy primitive to achieve a page-level Use-After-Free, a more sophisticated technique than traditional ROP chains.

### Actionable Threat Data
---

Vulnerable Configuration Identification: Look for systems running Linux kernels, particularly versions 6.6.7 and earlier, where the HFSC queuing discipline is configured with NETEM packet duplication enabled. This specific combination of `tc qdisc` and `tc class` commands is crucial for the vulnerability.

Anomalous tc Command Usage: Monitor for unusual or rapid sequences of tc qdisc and tc class commands, especially those involving `hfsc`, `netem` with `duplicate` options, and `tbf` with very low rates. This could indicate an attacker attempting to set up the vulnerable environment.

Kernel Module Monitoring: Alert on attempts to load or unload kernel modules related to network scheduling, specifically `sch_hfsc` and `sch_netem`, as attackers might manipulate these modules during exploitation.

Unexpected Network Traffic Control Modifications: Detect unauthorized or rapid changes to network traffic control configurations, particularly the addition or deletion of qdiscs and classes, which are integral to triggering the UAF.

Process Behavior Anomalies: Monitor for processes exhibiting unusual behavior after network traffic control modifications, such as unexpected memory access patterns, attempts to access `/dev/mem` or `/dev/kmem`, or sudden privilege escalation.

### HFSC/NETEM/TBF Configuration
---
```sql
-- name: Linux CVE-2025-38001 Vulnerable Configuration
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects a sequence of traffic control (tc) commands used to configure the specific vulnerable environment for CVE-2025-38001. This involves setting up HFSC, NETEM with packet duplication, and TBF qdiscs on a host within a short time window.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--
-- kill_chain_phases:
--   - Exploitation
--
-- risk_score: 80
--
-- severity: High
--
-- security_domain: endpoint
--
-- false_positives:
--   - This specific combination of traffic control modules is highly indicative of the exploit setup. However, false positives may occur in environments where complex network testing or simulation is performed.
--   - Tuning may be required to whitelist specific hosts or service accounts that perform legitimate, automated network configuration tasks.

FROM * -- <-- linux audit logs or data-stream
| WHERE process.name == "tc" AND process.command_line MATCHES ".*(hfsc|netem|tbf|duplicate).*"
| EVAL has_hfsc = CASE(process.command_line LIKE "%hfsc%", 1, 0),
       has_netem_dup = CASE(process.command_line LIKE "%netem%" AND process.command_line LIKE "%duplicate%", 1, 0),
       has_tbf = CASE(process.command_line LIKE "%tbf%", 1, 0)
| STATS hfsc_found = SUM(has_hfsc),
         netem_dup_found = SUM(has_netem_dup),
         tbf_found = SUM(has_tbf),
         commands = ARRAY_AGG(process.command_line),
         parent_processes = ARRAY_AGG(process.parent.name)
         BY host.name, user.name, BUCKET(@timestamp, 5 minutes)
| WHERE hfsc_found > 0 AND netem_dup_found > 0 AND tbf_found > 0
| KEEP host.name, user.name, commands, parent_processes
```

### Anomalous tc Command Usage
---
```sql
-- name: Linux CVE-2025-38001 Vulnerable Configuration Setup
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects a sequence of traffic control (tc) commands used to configure the specific vulnerable environment for CVE-2025-38001. This involves setting up HFSC, NETEM with packet duplication, and TBF qdiscs on a host within a short time window.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--
-- kill_chain_phases:
--   - Exploitation
--
-- risk_score: 80
--
-- severity: High
--
-- security_domain: endpoint
--
-- false_positives:
--   - This specific combination of traffic control modules is highly indicative of the exploit setup. However, false positives may occur in environments where complex network testing or simulation is performed.
--   - Tuning may be required to whitelist specific hosts or service accounts that perform legitimate, automated network configuration tasks.

FROM *
| WHERE process.name == "tc" AND process.command_line MATCHES ".*(hfsc|netem|tbf|duplicate).*"
| EVAL has_hfsc = CASE(process.command_line LIKE "%hfsc%", 1, 0),
       has_netem_dup = CASE(process.command_line LIKE "%netem%" AND process.command_line LIKE "%duplicate%", 1, 0),
       has_tbf = CASE(process.command_line LIKE "%tbf%", 1, 0)
| STATS hfsc_found = SUM(has_hfsc),
         netem_dup_found = SUM(has_netem_dup),
         tbf_found = SUM(has_tbf),
         commands = ARRAY_AGG(process.command_line),
         parent_processes = ARRAY_AGG(process.parent.name)
         BY host.name, user.name, BUCKET(@timestamp, 5 minutes)
| WHERE hfsc_found > 0 AND netem_dup_found > 0 AND tbf_found > 0
| KEEP host.name, user.name, commands, parent_processes
```

### Kernel Module Manipulation
---
```sql
-- name: Linux CVE-2025-38001 Kernel Module Manipulation
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects attempts to load or unload kernel modules (sch_hfsc, sch_netem) associated with the exploitation of CVE-2025-38001.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1548.006: Kernel Modules and Extensions
--
-- kill_chain_phases:
--   - Defense Evasion
--   - Privilege Escalation
--
-- risk_score: 60
--
-- severity: Medium
--
-- security_domain: endpoint
--
-- false_positives:
--   - Legitimate system administration or automated configuration tasks might load or unload these network scheduling modules.
--   - Kernel updates or system startup/shutdown scripts could trigger this activity.
--   - Consider filtering for non-standard users or parent processes to reduce noise.

FROM *
| WHERE process.name IN ("insmod", "rmmod", "modprobe")
  AND process.command_line MATCHES ".*(sch_hfsc|sch_netem).*"
| KEEP @timestamp, host.name, user.name, process.parent.name, process.name, process.command_line
```

### Unexpected Network Config Changes
---
```sql
-- name: Linux Rapid Network Traffic Control Changes
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects a high frequency of network traffic control (tc) configuration changes on a single host. This behavior is associated with the setup for exploiting vulnerabilities like CVE-2025-38001, which requires multiple 'tc' commands to create, modify, and delete qdiscs and classes in a specific sequence.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--
-- kill_chain_phases:
--   - Exploitation
--
-- risk_score: 70
--
-- severity: Medium
--
-- security_domain: endpoint
--
-- false_positives:
--   - Legitimate network initialization or configuration management scripts (e.g., Ansible, Puppet) may execute multiple 'tc' commands in a short period.
--   - Container orchestration platforms (e.g., Kubernetes with CNI plugins) frequently manipulate traffic control rules.
--   - The threshold for 'command_count' may need to be adjusted based on baseline activity. Consider filtering for non-standard users or parent processes.

FROM *
| WHERE process.name == "tc" AND process.command_line MATCHES ".*( add | del ).*"
| STATS command_count = COUNT(*),
         commands = ARRAY_AGG(process.command_line),
         parent_processes = ARRAY_AGG(process.parent.name)
         BY host.name, user.name, BUCKET(@timestamp, 5 minutes)
| WHERE command_count > 5
| KEEP @timestamp, host.name, user.name, parent_processes, command_count, commands
```

### Process Behavior Anomalies
---
```sql
-- name: Linux Post-Exploitation Behavior Following TC Modification
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Correlates network traffic control (tc) command execution with subsequent high-confidence anomalous behavior, such as privilege escalation or access to sensitive device files (/dev/mem, /dev/kmem). This pattern is indicative of post-exploitation activity related to vulnerabilities like CVE-2025-38001.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--   - T1548: Abuse Elevation Control Mechanism
--
-- kill_chain_phases:
--   - Privilege Escalation
--   - Defense Evasion
--
-- risk_score: 85
--
-- severity: High
--
-- security_domain: endpoint
--
-- false_positives:
--   - A legitimate administrator might use 'tc' and then perform a privileged action. The close temporal correlation reduces this risk, but whitelisting of known administrative scripts or users may be necessary.
--   - Access to /dev/mem or /dev/kmem is extremely rare and highly suspicious in most environments.

FROM *
| WHERE process.name == "tc"
   OR (user.name != "root" AND destination.user.name == "root")
   OR file.path IN ("/dev/mem", "/dev/kmem")
| EVAL tc_time = CASE(process.name == "tc", @timestamp, NULL),
       anomaly_time = CASE(
         (user.name != "root" AND destination.user.name == "root") OR file.path IS NOT NULL, @timestamp, NULL),
       anomaly_type = CASE(
         user.name != "root" AND destination.user.name == "root", "Privilege Escalation",
         file.path IS NOT NULL, "Sensitive Device Access", NULL),
       anomaly_details = COALESCE(process.command_line, file.path),
       tc_details = CASE(process.name == "tc", process.command_line, NULL)
| STATS tc_execution_time = MIN(tc_time),
         anomaly_time = MAX(anomaly_time),
         anomaly_types = ARRAY_AGG(anomaly_type),
         anomaly_details = ARRAY_AGG(anomaly_details),
         tc_commands = ARRAY_AGG(tc_details),
         parent_processes = ARRAY_AGG(process.parent.name),
         users = ARRAY_AGG(user.name)
         BY host.name, BUCKET(@timestamp, 10 minutes)
| WHERE tc_execution_time IS NOT NULL AND anomaly_time IS NOT NULL AND anomaly_time >= tc_execution_time
| KEEP @timestamp, host.name, users, tc_execution_time, tc_commands, anomaly_time, anomaly_types, anomaly_details, parent_processes
```