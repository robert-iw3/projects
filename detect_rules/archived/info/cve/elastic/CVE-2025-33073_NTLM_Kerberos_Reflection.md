### NTLM and Kerberos Reflection Vulnerability (CVE-2025-33073)
---

CVE-2025-33073 is a critical logical vulnerability in Windows SMB clients that bypasses existing NTLM reflection mitigations, allowing an authenticated remote attacker to execute arbitrary commands as SYSTEM on machines not enforcing SMB signing. This vulnerability leverages crafted DNS records to trick the SMB client into believing a remote server is localhost, leading to the reuse of SYSTEM tokens for privilege escalation.

Beyond traditional NTLM reflection, this vulnerability extends to Kerberos authentication, where a similar DNS manipulation technique allows for the relay of Kerberos tickets back to the originating host, resulting in SYSTEM-level privileges. This is significant because Kerberos was previously thought to be more resilient to such reflection attacks due to its design.

### Actionable Threat Data
---

Monitor for SMB authentication attempts originating from `lsass.exe` to external or unusual internal IP addresses, especially when SMB signing is not enforced on the target.

Look for DNS queries and resolutions involving highly unusual or malformed hostnames, particularly those containing long alphanumeric strings or `1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA` patterns, as these may indicate an attempt to exploit the vulnerability.

Detect the use of NTLM relaying tools such as `ntlmrelayx.py` or Kerberos relaying tools like `krbrelayx.py` in your environment, which are commonly used in conjunction with this vulnerability.

Alert on successful SMB or Kerberos authentications where the authenticating account is a machine account (e.g., `SRV1$`) but the activity performed (e.g., `SAM hive dumping, service manipulation`) is indicative of SYSTEM-level privileges.

Implement and enforce SMB signing across all Windows machines to prevent NTLM and Kerberos relay attacks, as this mitigation directly addresses the core vulnerability.

### SMB Auth from LSASS to External IP
---
```sql
FROM *
| WHERE process.name == "lsass.exe" AND destination.port == 445
  AND NOT (destination.ip IN ("10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "127.0.0.0/8", "::1/128"))
| STATS count = COUNT(*), firstTime = MIN(@timestamp), lastTime = MAX(@timestamp)
  BY source.ip, destination.ip, process.name, user.name
| KEEP firstTime, lastTime, source.ip, destination.ip, process.name, user.name, count
| RENAME source.ip AS src, destination.ip AS dest, process.name AS process
```

### Unusual DNS Hostnames
---
```sql
FROM *
| WHERE REGEXP(dns.question.name, "[A-Za-z0-9+/]{20,}={0,2}")
| STATS count = COUNT(*), firstTime = MIN(@timestamp), lastTime = MAX(@timestamp)
  BY source.ip, destination.ip, dns.question.name, process.name, user.name
| KEEP firstTime, lastTime, source.ip, destination.ip, dns.question.name, process.name, user.name, count
| RENAME source.ip AS src_ip, destination.ip AS dest_ip, dns.question.name AS dns_query, process.name AS process
```

### DNS Queries with Long Base64-like String (CVE-2025-33073)
---
```sql
FROM *
| WHERE REGEXP(dns.question.name, "[A-Za-z0-9+/]{20,}={0,2}")
| STATS count = COUNT(*), firstTime = MIN(@timestamp), lastTime = MAX(@timestamp)
  BY source.ip, destination.ip, dns.question.name, process.name, user.name
| KEEP firstTime, lastTime, source.ip, destination.ip, dns.question.name, process.name, user.name, count
| RENAME source.ip AS src_ip, destination.ip AS dest_ip, dns.question.name AS dns_query, process.name AS process
```

### Privileged Actions by Machine Account
---
```sql
FROM *
| WHERE user.name LIKE "%$" AND (
    process.name IN ("cmd.exe", "powershell.exe", "pwsh.exe") OR
    (process.name == "reg.exe" AND (process.command_line LIKE "*save*hklm\\sam*" OR process.command_line LIKE "*save*hklm\\system*")) OR
    (process.name == "vssadmin.exe" AND process.command_line LIKE "*create*shadow*") OR
    (process.name == "rundll32.exe" AND process.command_line LIKE "*comsvcs.dll*MiniDump*")
  )
| STATS count = COUNT(*), firstTime = MIN(@timestamp), lastTime = MAX(@timestamp)
  BY host.hostname, user.name, process.parent.name, process.name, process.command_line
| KEEP firstTime, lastTime, host.hostname, user.name, process.parent.name, process.name, process.command_line, count
| RENAME host.hostname AS host, user.name AS machine_account, process.parent.name AS parent_process, process.name AS suspicious_process, process.command_line AS command_line
```

### SMB Signing Disabled
---
```sql
FROM endpoint
| WHERE registry.data.strings == "0"
  AND registry.key.name IN ("EnableSecuritySignature", "RequireSecuritySignature")
  AND (registry.path LIKE "*\\LanmanServer\\Parameters" OR registry.path LIKE "*\\LanmanWorkstation\\Parameters")
| STATS registry_value_data = VALUES(registry.data.strings), firstTime = MIN(@timestamp), lastTime = MAX(@timestamp)
  BY host.hostname, registry.path, registry.key.name
| KEEP firstTime, lastTime, host.hostname, registry.path, registry.key.name, registry_value_data
| RENAME host.hostname AS host, registry.path AS registry_path, registry.key.name AS registry_value_name
```
