### SharePoint Vulnerability CVE-2025-53770 Threat Detections

Good news elastic users.  If you had an elastic agent with defend/protection rules enabled, the following would have alerted of a possible attack:

https://github.com/elastic/detection-rules/blob/main/rules/windows/persistence_webshell_detection.toml?linkId=844747781

https://github.com/elastic/protections-artifacts/blob/main/behavior/rules/windows/initial_access_suspicious_microsoft_iis_worker_descendant.toml?linkId=844747783

---

Microsoft has identified active exploitation of CVE-2025-53770, a critical unauthenticated remote code execution (RCE) vulnerability affecting on-premises SharePoint Server versions 2016, 2019, and Subscription Edition. This vulnerability, a variant of CVE-2025-49706, allows attackers to execute arbitrary code and access sensitive configuration files without authentication, posing a significant risk to affected organizations.

Recent intelligence indicates that CVE-2025-53770 is part of an exploit chain, dubbed "ToolShell," that leverages deserialization flaws and authentication bypasses to achieve full RCE and extract cryptographic secrets for persistence. This is noteworthy as it highlights a sophisticated multi-stage attack rather than a standalone vulnerability, enabling attackers to maintain access even after initial remediation efforts.

### Actionable Threat Data
---

Monitor for the creation of `spinstall0.aspx` or files with `spinstall0` in the filename within SharePoint server directories, specifically `MICROS~1\WEBSER~1\16\TEMPLATE\LAYOUTS`.

Look for suspicious process creation originating from `w3wp.exe` that involves `cmd.exe` followed by `powershell.exe` with encoded commands, indicating potential post-exploitation activity.

Implement logging and monitor for unauthenticated `POST` requests to `/_layouts/15/ToolPane.aspx` with a spoofed Referer: `/_layouts/SignOut.aspx` header, as this is a key indicator of the authentication bypass used in the exploit chain.

Monitor network traffic for connections to known malicious IP addresses associated with this exploitation, such as `107.191.58[.]76`, `104.238.159[.]149`, and `96.9.125[.]147`.

Investigate alerts related to "Possible web shell installation," "Possible exploitation of SharePoint server vulnerabilities," "Suspicious IIS worker process behavior," and "malware blocked" on SharePoint servers, specifically `SuspSignoutReq` and `HijackSharePointServer`.

### SharePoint spinstall0.aspx Creation
---
```sql
file where host.os.type == "windows" and event.type == "creation" and
  file.extension : ("aspx" or "js") and
    file.path : (
      "C:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\16\\Template\\Layouts\\*" or
      "C:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\15\\Template\\Layouts\\*" or
      "C:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\*\\Template\\Layouts\\*" or
      "?:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\16\\Template\\Layouts\\*" or
      "?:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\15\\Template\\Layouts\\*" or
      "?:\\Program Files\\Common Files\\Microsoft Shared\\Web Server Extensions\\*\\Template\\Layouts\\*") and
        file.name : (
          "spinstall0.aspx" or
          "%spinstall0%" or
          "*spinstall*" or
          "debug_dev.js" or
          "%debug_dev%" or
          "*debug_dev*" or
          "*info*" or
          "*3plx*" or
          "*xxx*" or
          "*VFM*")
```

### Suspicious w3wp.exe Child Process Chain
---
```sql
process where host.os.type == "windows" and
  event.type : ("start" or "process_started") and
    process.parent.name : ("w3wp.exe" or "svchost.exe") and
      process.name : ("cmd.exe" or
                      "cscript.exe" or
                      "powershell.exe" or
                      "pwsh.exe" or
                      "powershell_ise.exe" or
                      "wmic.exe" or
                      "wscript.exe") and
        process.args : ("SharePoint" or
                        "sharepoint" or
                        "*SharePoint*" or
                        "*sharepoint*" or
                        "%spinstall%" or
                        "%TEMPLATE\\LAYOUTS%")
```

### Unauthenticated ToolPane.aspx POST
---
```sql
network where host.os.type == "windows" and
  network.protocol == "http" and
    http.request.method : "POST" and
        url.path : (
          "*/_layouts/15/ToolPane.aspx" or
          "*/_layouts/SignOut.aspx" or
          "*/_layouts/16/ToolPane.aspx" or
          "*/_layouts/SignOut*" or
          "*/_layouts/*/ToolPane*" or
          "*/_layouts/*/*info*" or
          "*/_layouts/*/3plx.aspx" or
          "*/_layouts/*/*spinstall*")
```

### Known Malicious IPs (NOTE: very preliminary)
---
```sql
network where host.os.type == "windows" and event.category : ("network" or "network_traffic")
  and event.action in ("connection_attempted" or "connection_accepted")
    and destination.ip : (
          "107.191.58.76" or
          "104.238.159.149" or
          "96.9.125.147" or
          "139.144.199.41" or
          "89.46.223.88" or
          "45.77.155.170" or
          "95.179.158.42" or
          "149.40.50.15" or
          "154.223.19.106" or
          "185.197.248.131" or
          "131.226.2.6" or
          "134.199.202.205" or
          "188.130.206.168" or
          "65.38.121.198")
    or source.ip : (
          "107.191.58.76" or
          "104.238.159.149" or
          "96.9.125.147" or
          "139.144.199.41" or
          "89.46.223.88" or
          "45.77.155.170" or
          "95.179.158.42" or
          "149.40.50.15" or
          "154.223.19.106" or
          "185.197.248.131" or
          "131.226.2.6" or
          "134.199.202.205" or
          "188.130.206.168" or
          "65.38.121.198")
```

### Known Malicious Domains
---
```sql
network where event.category : ("network" or "network_traffic") and type: ("tls" or "http") and
  destination.domain : (
    "c34718cbb4c6.ngrok-free.app" or
    "*ngrok*" or
    "msupdate.updatemicfosoft.com" or
    "*micfosoft*" or
    "dynastyjusticecollective.site" or
    "*dynasty*")
```

### Known Malicious Hashes
---
```sql
file where host.os.type == "windows" and
  file.hash.256 : (
    "92bb4ddb98eeaf11fc15bb32e71d0a63256a0ed826a03ba293ce3a8bf057a514" or
    "24480dbe306597da1ba393b6e30d542673066f98826cc07ac4b9033137f37dbf" or
    "b5a78616f709859a0d9f830d28ff2f9dbbb2387df1753739407917e96dadf6b0" or
    "c27b725ff66fdfb11dd6487a3815d1d1eba89d61b0e919e4d06ed3ac6a74fe94" or
    "1eb914c09c873f0a7bcf81475ab0f6bdfaccc6b63bf7e5f2dbf19295106af192" or
    "4c1750a14915bf2c0b093c2cb59063912dfa039a2adfe6d26d6914804e2ae928" or
    "83705c75731e1d590b08f9357bc3b0f04741e92a033618736387512b40dab060" or
    "f54ae00a9bae73da001c4d3d690d26ddf5e8e006b5562f936df472ec5e299441" or
    "b180ab0a5845ed619939154f67526d2b04d28713fcc1904fbd666275538f431d" or
    "6753b840cec65dfba0d7d326ec768bff2495784c60db6a139f51c5e83349ac4d" or
    "7ae971e40528d364fa52f3bb5e0660ac25ef63e082e3bbd54f153e27b31eae68" or
    "567cb8e8c8bd0d909870c656b292b57bcb24eb55a8582b884e0a228e298e7443" or
    "445a37279d3a229ed18513e85f0c8d861c6f560e0f914a5869df14a74b679b86" or
    "ffbc9dfc284b147e07a430fe9471e66c716a84a1f18976474a54bee82605fa9a" or
    "6b273c2179518dacb1218201fd37ee2492a5e1713be907e69bf7ea56ceca53a5" or
    "c2c1fec7856e8d49f5d49267e69993837575dbbec99cd702c5be134a85b2c139" or
    "d6da885c90a5d1fb88d0a3f0b5d9817a82d5772d5510a0773c80ca581ce2486d" or
    "62881359e75c9e8899c4bc9f452ef9743e68ce467f8b3e4398bebacde9550dea")
```

### Update: 7/23/2025
---
New tactic, payload is a .dll executed in memory.

It collects System Info and the sensitive machine key.

Sends back in response. Single Request takeover.

SHA256: 3461da3a2ddcced4a00f87dcd7650af48f97998a3ac9ca649d7ef3b7332bd997

osvmhdfl[.]dll

```sql
library where host.os.type == "windows" and event.action == "load"
  and dll.name like~ "osvmhdfl[.]dll" or dll.name like "osvmhdfl.dll"
    and process.name : ("rundll32.exe" or "regsvr32.exe")
      and dll.hash.sha256 == "3461da3a2ddcced4a00f87dcd7650af48f97998a3ac9ca649d7ef3b7332bd997"
        or file.hash.sha256 == "3461da3a2ddcced4a00f87dcd7650af48f97998a3ac9ca649d7ef3b7332bd997"
```

### BadPotato Privilege Escalation
---
```sql
`comment("
-- name: BadPotato Privilege Escalation
-- author: Rob Weber
-- date: 2025-07-25
-- description: Detects command-line activity referencing the 'pwncat' named pipe. This is the default pipe name created and used by the BadPotato privilege escalation tool, which has been leveraged by threat actors like Storm-2603 to elevate privileges to SYSTEM.
-- references:
--   - https://thehackernews.com/2025/07/storm-2603-exploits-sharepoint-flaws-to.html
--   - https://github.com/calebstewart/pwncat-badpotato
-- mitre_tactic: Privilege Escalation
-- mitre_technique: T1068
")`

from logs-endpoint.events-*
| where process.command_line rlike "(?i).*\\\\pipe\\\\pwncat.*"
| stats
    count = COUNT(*),
    firstTime = MIN(@timestamp),
    lastTime = MAX(@timestamp)
  by host.name, user.name, process.parent.name, process.name, process.command_line
| keep firstTime, lastTime, host.name, user.name, process.parent.name, process.name, process.command_line, count
| SORT firstTime asc
```

```sql
from logs-endpoint.events-*
| where event.code in ("17", "18") and pipe.name rlike "(?i).*pwn.*"
| stats count = COUNT(*) by host.name, pipe.name
```

### Impacket Lateral Movement Toolkit Usage
---
```sql
from logs-endpoint.events-*
| where process.parent.name in ("WmiPrvSE.exe", "services.exe")
  and process.name = "cmd.exe"
  and process.command_line rlike ".* 1> \\\\127\\.0\\.0\\.1\\\\.*"
  and process.command_line rlike ".* 2>&1.*"
| stats
    count = COUNT(*),
    firstTime = MIN(@timestamp),
    lastTime = MAX(@timestamp)
  by host.name, user.name, process.parent.name, process.name, process.command_line
| keep firstTime, lastTime, host.name, user.name, process.parent.name, process.name, process.command_line, count
| sort firstTime asc
```
```sql
from logs-endpoint.events-*
| where event.code in ("19", "20") and process.name = "WmiPrvSE.exe"
| stats count = COUNT(*) by host.name, process.command_line
```
```sql
from packetbeat-*
| where smb.share rlike ".*\\\\127\\.0\\.0\\.1\\\\(C\\$|ADMIN\\$).*"
| stats count = COUNT(*) by source.ip, destination.ip, smb.share
```

### PsExec Lateral Movement
---
```sql
from logs-endpoint.events-*
| where process.parent.name = "services.exe" and process.name = "PSEXESVC.exe"
| stats
    count = COUNT(*),
    firstTime = MIN(@timestamp),
    lastTime = MAX(@timestamp)
  by host.name, user.name, process.parent.name, process.name, process.command_line
| keep firstTime, lastTime, host.name, user.name, process.parent.name, process.name, process.command_line, count
| sort firstTime asc
```
```sql
from logs-endpoint.events-*
| where process.parent.name = "services.exe" and process.executable rlike ".*[C|c]:\\\\[W|w][I|i][N|n][D|d][O|o][W|w][S|s].*"
| stats count = COUNT(*) by host.name, process.name, process.executable
```

### IIS Component Modification for Persistence
---
```sql
from logs-endpoint.events-*
| where process.name = "appcmd.exe"
  and (process.command_line rlike ".* add module .*"
       or process.command_line rlike ".* install module .*"
       or (process.command_line rlike ".* set config .*" and process.command_line rlike ".*section.*modules.*"))
| stats
    count = COUNT(*),
    firstTime = MIN(@timestamp),
    lastTime = MAX(@timestamp)
  by host.name, user.name, process.parent.name, process.name, process.command_line
| keep firstTime, lastTime, host.name, user.name, process.parent.name, process.name, process.command_line, count
| sort firstTime asc
```
```sql
from packetbeat-*
| where http.request.method in ("GET", "POST") and destination.domain rlike ".*(microsoftonline|office365|sharepoint).*" and http.request.url rlike ".*(\\.aspx|\\.ashx).*"
| stats count = COUNT(*) by source.ip, destination.domain, http.request.url
```
```sql
from logs-endpoint.events-*
| where process.name = "appcmd.exe"
| stats count = COUNT(*) by host.name, user.name, process.command_line
```