### NTLM and Kerberos Reflection Vulnerability (CVE-2025-33073)
---

CVE-2025-33073 is a critical logical vulnerability in Windows SMB clients that bypasses existing NTLM reflection mitigations, allowing an authenticated remote attacker to execute arbitrary commands as SYSTEM on machines not enforcing SMB signing. This vulnerability leverages crafted DNS records to trick the SMB client into believing a remote server is localhost, leading to the reuse of SYSTEM tokens for privilege escalation.

Beyond traditional NTLM reflection, this vulnerability extends to Kerberos authentication, where a similar DNS manipulation technique allows for the relay of Kerberos tickets back to the originating host, resulting in SYSTEM-level privileges. This is significant because Kerberos was previously thought to be more resilient to such reflection attacks due to its design.

### Actionable Threat Data
---

Monitor for SMB authentication attempts originating from `lsass.exe` to external or unusual internal IP addresses, especially when SMB signing is not enforced on the target.

Look for DNS queries and resolutions involving highly unusual or malformed hostnames, particularly those containing long alphanumeric strings or `1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA` patterns, as these may indicate an attempt to exploit the vulnerability.

Detect the use of NTLM relaying tools such as `ntlmrelayx.py` or Kerberos relaying tools like `krbrelayx.py` in your environment, which are commonly used in conjunction with this vulnerability.

Alert on successful SMB or Kerberos authentications where the authenticating account is a machine account (e.g., `SRV1$`) but the activity performed (e.g., `SAM hive dumping, service manipulation`) is indicative of SYSTEM-level privileges.

Implement and enforce SMB signing across all Windows machines to prevent NTLM and Kerberos relay attacks, as this mitigation directly addresses the core vulnerability.

### SMB Auth from LSASS to External IP
---
```sql
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic where All_Traffic.process_name = "lsass.exe" AND All_Traffic.dest_port = 445 by All_Traffic.src_ip, All_Traffic.dest_ip, All_Traffic.process_name, All_Traffic.user
| `drop_dm_object_name("All_Traffic")`
`comment("This search identifies SMB connections from lsass.exe, which is highly unusual and can indicate an NTLM or Kerberos reflection attack like CVE-2025-33073.")`
| where NOT (cidrmatch("10.0.0.0/8", dest_ip) OR cidrmatch("172.16.0.0/12", dest_ip) OR cidrmatch("192.168.0.0/16", dest_ip) OR cidrmatch("127.0.0.0/8", dest_ip) OR cidrmatch("::1/128", dest_ip))
`comment("FP Tuning: Legitimate but rare external SMB connections from lsass.exe may occur. If so, add known-good destinations to an allowlist lookup and filter them out.")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename src_ip as src, dest_ip as dest, process_name as process
| table firstTime, lastTime, src, dest, process, user, count
```

### Unusual DNS Hostnames
---
```sql
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Resolution by DNS.src, DNS.dest, DNS.query, DNS.process_name, DNS.user
| `drop_dm_object_name("DNS")`
`comment("This search looks for DNS queries containing a long Base64-like string, a pattern used in CVE-2025-33073 to trick SMB clients into local authentication reflection.")`
| where regex(query, "[A-Za-z0-9+\/]{20,}={0,2}")
`comment("FP Tuning: This regex is broad and may match legitimate, long, auto-generated hostnames (e.g., from CDNs or cloud services). Consider adding allowlists for known domains or processes that generate such queries.")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename src as src_ip, dest as dest_ip, query as dns_query, process_name as process
| table firstTime, lastTime, src_ip, dest_ip, dns_query, process, user, count
```

### DNS Queries with Long Base64-like String (CVE-2025-33073)
---
```sql
`dns`
`comment("This search looks for DNS queries containing a long Base64-like string, a pattern used in CVE-2025-33073, by leveraging the Network Resolution data model.")`
| where regex(query, "[A-Za-z0-9+/]{20,}={0,2}")
`comment("FP Tuning: This regex is broad and may match legitimate, long, auto-generated hostnames (e.g., from CDNs or cloud services). Consider adding allowlists for known domains or processes.")`
| stats count min(_time) as firstTime max(_time) as lastTime by src, dest, query, process, user
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename src as src_ip, dest as dest_ip, query as dns_query
| table firstTime, lastTime, src_ip, dest_ip, dns_query, process, user, count
```

### Privileged Actions by Machine Account
---
```sql
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes where (Processes.user LIKE "%$") AND (Processes.process_name IN ("cmd.exe", "powershell.exe", "pwsh.exe") OR (Processes.process_name="reg.exe" AND (Processes.process="*save*hklm\\sam*" OR Processes.process="*save*hklm\\system*")) OR (Processes.process_name="vssadmin.exe" AND Processes.process="*create*shadow*") OR (Processes.process_name="rundll32.exe" AND Processes.process="*comsvcs.dll*MiniDump*")) by Processes.dest, Processes.user, Processes.parent_process_name, Processes.process_name, Processes.process
| `drop_dm_object_name("Processes")`
`comment("Identifies when a machine account (user ending in '$') performs privileged actions like spawning a shell or dumping credentials. This is highly anomalous and can indicate a compromise from attacks like CVE-2025-33073.")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
`comment("FP Tuning: Legitimate backup or management software may rarely perform these actions under a machine account. If such activity is found, investigate the parent process and command line to verify legitimacy and consider adding an exception.")`
| rename dest as host, user as machine_account, parent_process_name as parent_process, process_name as suspicious_process, process as command_line
| table firstTime, lastTime, host, machine_account, parent_process, suspicious_process, command_line, count
```

### SMB Signing Disabled
---
```sql
| tstats `security_content_summariesonly` values(Registry.registry_value_data) as registry_value_data min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Registry where Registry.registry_value_data="0" AND (Registry.registry_value_name IN ("EnableSecuritySignature", "RequireSecuritySignature")) AND (Registry.registry_path="*\\LanmanServer\\Parameters" OR Registry.registry_path="*\\LanmanWorkstation\\Parameters") by Registry.dest, Registry.registry_path, Registry.registry_value_name
| `drop_dm_object_name("Registry")`
`comment("This search identifies hosts where SMB signing is disabled or not required, a critical misconfiguration that enables NTLM/Kerberos relay attacks like CVE-2025-33073.")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
`comment("FP Tuning: This detection identifies a configuration state, not an active attack. Some legacy systems may require SMB signing to be disabled for compatibility. Investigate and document any such systems as exceptions.")`
| rename dest as host
| table firstTime, lastTime, host, registry_path, registry_value_name, registry_value_data
```
