### CVE-2025-38001: A RBTree Family Drama
---

CVE-2025-38001 is a Use-After-Free (UAF) vulnerability in the Linux kernel's Hierarchical Fair Service Curve (HFSC) queuing discipline, exploitable when combined with the Network Emulation (NETEM) module's packet duplication feature and a low-rate Token Bucket Filter (TBF) root qdisc. This flaw allows for local privilege escalation by manipulating RBTree structures to achieve a page-level data-only attack, ultimately leading to arbitrary code execution and root access.

Recent intelligence confirms that this vulnerability has been actively exploited in the wild to compromise Google kernelCTF instances and Debian 12 systems, demonstrating its effectiveness in real-world scenarios. The exploit leverages an innovative RBTree pointer-copy primitive to achieve a page-level Use-After-Free, a more sophisticated technique than traditional ROP chains.

### Actionable Threat Data
---

Vulnerable Configuration Identification: Look for systems running Linux kernels, particularly versions 6.6.7 and earlier, where the HFSC queuing discipline is configured with NETEM packet duplication enabled. This specific combination of `tc qdisc` and `tc class` commands is crucial for the vulnerability.

Anomalous tc Command Usage: Monitor for unusual or rapid sequences of tc qdisc and tc class commands, especially those involving `hfsc`, `netem` with `duplicate` options, and `tbf` with very low rates. This could indicate an attacker attempting to set up the vulnerable environment.

Kernel Module Monitoring: Alert on attempts to load or unload kernel modules related to network scheduling, specifically `sch_hfsc` and `sch_netem`, as attackers might manipulate these modules during exploitation.

Unexpected Network Traffic Control Modifications: Detect unauthorized or rapid changes to network traffic control configurations, particularly the addition or deletion of qdiscs and classes, which are integral to triggering the UAF.

Process Behavior Anomalies: Monitor for processes exhibiting unusual behavior after network traffic control modifications, such as unexpected memory access patterns, attempts to access `/dev/mem` or `/dev/kmem`, or sudden privilege escalation.

### HFSC/NETEM/TBF Configuration
---
```sql
-- name: Linux CVE-2025-38001 Vulnerable Configuration
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects a sequence of traffic control (tc) commands used to configure the specific vulnerable environment for CVE-2025-38001. This involves setting up HFSC, NETEM with packet duplication, and TBF qdiscs on a host within a short time window.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--
-- kill_chain_phases:
--   - Exploitation
--
-- risk_score: 80
--
-- severity: High
--
-- security_domain: endpoint
--
-- false_positives:
--   - This specific combination of traffic control modules is highly indicative of the exploit setup. However, false positives may occur in environments where complex network testing or simulation is performed.
--   - Tuning may be required to whitelist specific hosts or service accounts that perform legitimate, automated network configuration tasks.

(index=* OR sourcetype=linux:audit* OR sourcetype=stream:process) `process_creation` process_name=tc
-- search:
| eval process=coalesce(process, cmdline)
-- comment: Filter for tc commands containing keywords related to the exploit setup.
| where match(process, /(hfsc|netem|tbf|duplicate)/)
-- comment: Set flags for each component of the vulnerable configuration.
| eval has_hfsc = if(like(process, "%hfsc%"), 1, 0)
| eval has_netem_dup = if(like(process, "%netem%") AND like(process, "%duplicate%"), 1, 0)
| eval has_tbf = if(like(process, "%tbf%"), 1, 0)
-- comment: Group by host and user over a 5 minute window to identify a sequence of related commands.
| stats sum(has_hfsc) as hfsc_found, sum(has_netem_dup) as netem_dup_found, sum(has_tbf) as tbf_found, values(process) as commands, values(parent_process) as parent_processes by host, user, bin(_time, 5m)
-- comment: Trigger if all components (hfsc, netem with duplicate, and tbf) are found within the time window.
| where hfsc_found > 0 AND netem_dup_found > 0 AND tbf_found > 0
| fields - hfsc_found, netem_dup_found, tbf_found
```

### Anomalous tc Command Usage
---
```sql
-- name: Linux CVE-2025-38001 Vulnerable Configuration Setup
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects a sequence of traffic control (tc) commands used to configure the specific vulnerable environment for CVE-2025-38001. This involves setting up HFSC, NETEM with packet duplication, and TBF qdiscs on a host within a short time window.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--
-- kill_chain_phases:
--   - Exploitation
--
-- risk_score: 80
--
-- severity: High
--
-- security_domain: endpoint
--
-- false_positives:
--   - This specific combination of traffic control modules is highly indicative of the exploit setup. However, false positives may occur in environments where complex network testing or simulation is performed.
--   - Tuning may be required to whitelist specific hosts or service accounts that perform legitimate, automated network configuration tasks.

(index=* OR sourcetype=linux:audit* OR sourcetype=stream:process) `process_creation` process_name=tc
-- search:
| eval process=coalesce(process, cmdline)
-- comment: Filter for tc commands containing keywords related to the exploit setup.
| where match(process, /(hfsc|netem|tbf|duplicate)/)
-- comment: Set flags for each component of the vulnerable configuration.
| eval has_hfsc = if(like(process, "%hfsc%"), 1, 0)
| eval has_netem_dup = if(like(process, "%netem%") AND like(process, "%duplicate%"), 1, 0)
| eval has_tbf = if(like(process, "%tbf%"), 1, 0)
-- comment: Group by host and user over a 5 minute window to identify a sequence of related commands.
| stats sum(has_hfsc) as hfsc_found, sum(has_netem_dup) as netem_dup_found, sum(has_tbf) as tbf_found, values(process) as commands, values(parent_process) as parent_processes by host, user, bin(_time, 5m)
-- comment: Trigger if all components (hfsc, netem with duplicate, and tbf) are found within the time window.
| where hfsc_found > 0 AND netem_dup_found > 0 AND tbf_found > 0
| fields - hfsc_found, netem_dup_found, tbf_found
```

### Kernel Module Manipulation
---
```sql
-- name: Linux CVE-2025-38001 Kernel Module Manipulation
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects attempts to load or unload kernel modules (sch_hfsc, sch_netem) associated with the exploitation of CVE-2025-38001.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1548.006: Kernel Modules and Extensions
--
-- kill_chain_phases:
--   - Defense Evasion
--   - Privilege Escalation
--
-- risk_score: 60
--
-- severity: Medium
--
-- security_domain: endpoint
--
-- false_positives:
--   - Legitimate system administration or automated configuration tasks might load or unload these network scheduling modules.
--   - Kernel updates or system startup/shutdown scripts could trigger this activity.
--   - Consider filtering for non-standard users or parent processes to reduce noise.

(index=* OR sourcetype=linux:audit* OR sourcetype=stream:process) `process_creation` process_name IN (insmod, rmmod, modprobe)
-- search:
| eval process=coalesce(process, cmdline)
-- comment: Filter for the specific kernel modules related to CVE-2025-38001.
| where match(process, /(sch_hfsc|sch_netem)/)
-- comment: Present the relevant fields for investigation.
| table _time, host, user, parent_process, process_name, process
```

### Unexpected Network Config Changes
---
```sql
-- name: Linux Rapid Network Traffic Control Changes
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Detects a high frequency of network traffic control (tc) configuration changes on a single host. This behavior is associated with the setup for exploiting vulnerabilities like CVE-2025-38001, which requires multiple 'tc' commands to create, modify, and delete qdiscs and classes in a specific sequence.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--
-- kill_chain_phases:
--   - Exploitation
--
-- risk_score: 70
--
-- severity: Medium
--
-- security_domain: endpoint
--
-- false_positives:
--   - Legitimate network initialization or configuration management scripts (e.g., Ansible, Puppet) may execute multiple 'tc' commands in a short period.
--   - Container orchestration platforms (e.g., Kubernetes with CNI plugins) frequently manipulate traffic control rules.
--   - The threshold for 'command_count' may need to be adjusted based on baseline activity. Consider filtering for non-standard users or parent processes.

(index=* OR sourcetype=linux:audit* OR sourcetype=stream:process) `process_creation` process_name=tc
-- search:
| eval process=coalesce(process, cmdline)
-- comment: Filter for commands that add or delete network configurations.
| where match(process, /( add | del )/)
-- comment: Group events by host and user within a 5-minute window.
| stats count as command_count, values(process) as commands, values(parent_process) as parent_processes by host, user, bin(_time, 5m)
-- comment: Alert if more than 5 configuration changes occur. This threshold may need tuning.
| where command_count > 5
-- comment: Present the relevant fields for investigation.
| table _time, host, user, parent_processes, command_count, commands
```

### Process Behavior Anomalies
---
```sql
-- name: Linux Post-Exploitation Behavior Following TC Modification
-- author: RW
-- date: 2025-08-09
-- last_updated: 2025-08-09
--
-- description: Correlates network traffic control (tc) command execution with subsequent high-confidence anomalous behavior, such as privilege escalation or access to sensitive device files (/dev/mem, /dev/kmem). This pattern is indicative of post-exploitation activity related to vulnerabilities like CVE-2025-38001.
--
-- data_source:
--   - linux:audit
--   - edr
--
-- mitre_attack:
--   - T1068: Exploitation for Privilege Escalation
--   - T1548: Abuse Elevation Control Mechanism
--
-- kill_chain_phases:
--   - Privilege Escalation
--   - Defense Evasion
--
-- risk_score: 85
--
-- severity: High
--
-- security_domain: endpoint
--
-- false_positives:
--   - A legitimate administrator might use 'tc' and then perform a privileged action. The close temporal correlation reduces this risk, but whitelisting of known administrative scripts or users may be necessary.
--   - Access to /dev/mem or /dev/kmem is extremely rare and highly suspicious in most environments.

( (index=* OR sourcetype=linux:audit* OR sourcetype=stream:process) `process_creation` (process_name=tc OR (user!="root" AND dest_user="root")) ) OR ( (index=* OR sourcetype=linux:audit*) `file_event` file_path IN ("/dev/mem", "/dev/kmem") )
-- search:
-- comment: Identify the time of the initial 'tc' command execution.
| eval tc_time = if(process_name="tc", _time, null())
-- comment: Identify the time and type of the subsequent anomalous behavior.
| eval anomaly_time = if((user!="root" AND dest_user="root") OR isnotnull(file_path), _time, null())
| eval anomaly_type = case(
    user!="root" AND dest_user="root", "Privilege Escalation",
    isnotnull(file_path), "Sensitive Device Access"
    )
| eval anomaly_details = coalesce(process, cmdline, file_path)
| eval tc_details = if(process_name="tc", coalesce(process, cmdline), null())
-- comment: Group events by host within a 10-minute window to correlate the setup command with the anomaly.
| stats earliest(tc_time) as tc_execution_time,
        latest(anomaly_time) as anomaly_time,
        values(anomaly_type) as anomaly_types,
        values(anomaly_details) as anomaly_details,
        values(tc_details) as tc_commands,
        values(parent_process) as parent_processes,
        values(user) as users
        by host, bin(_time, 10m)
-- comment: Alert only when a 'tc' command is followed by an anomaly on the same host within the time window.
| where isnotnull(tc_execution_time) AND isnotnull(anomaly_time) AND anomaly_time >= tc_execution_time
-- comment: Format the output for clear analysis.
| `ctime(tc_execution_time)`
| `ctime(anomaly_time)`
| table _time, host, users, tc_execution_time, tc_commands, anomaly_time, anomaly_types, anomaly_details, parent_processes
```