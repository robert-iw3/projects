rule TTP_Citrix_NetScaler_Backdoor_User_Creation {
    meta:
        description = "Detects potential post-exploitation activity on Citrix NetScaler devices by identifying the addition of new user accounts within configuration files. This is a common TTP following exploitation of vulnerabilities like CVE-2025-5777 (CitrixBleed 2)."
        date = "2025-07-24"
        version = 1
        tags = "FILE, CONFIG, CITRIX, NETSCALER, POST_EXPLOITATION, CVE_2025_5777"
        mitre_attack = "T1136"

    strings:
        // Private strings to identify NetScaler configuration files.
        $_conf_marker1 = "set ns config" ascii
        $_conf_marker2 = "enable ns feature" ascii
        $_conf_marker3 = "add ns ip" ascii

        // Commands for adding a user account.
        $cmd_add_user = "add aaa user" ascii
        $cmd_add_system_user = "add system user" ascii

        // Parameters associated with user creation, especially for backdoors.
        $param_password = "-password" ascii
        $param_shell = "-shell" ascii

    condition:
        // This rule may flag legitimate configuration files where users are defined.
        // It is intended to highlight potential unauthorized user additions for manual review.
        filesize < 10MB
        and 2 of ($_conf_*) // Establishes that this is likely a NetScaler config file.
        and (
            $cmd_add_user or $cmd_add_system_user
        )
        and (
            $param_password or $param_shell // A user creation command should have a password or grant shell access.
        )
}
