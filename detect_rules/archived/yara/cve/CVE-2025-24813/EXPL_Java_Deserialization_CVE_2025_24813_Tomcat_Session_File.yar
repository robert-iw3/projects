rule EXPL_Java_Deserialization_CVE_2025_24813_Tomcat_Session_File
{
    meta:
        description = "Detects potentially malicious Java serialized session files created during exploitation of Apache Tomcat vulnerability CVE-2025-24813. Attackers can upload a malicious serialized object which is later deserialized, leading to Remote Code Execution (RCE)."
        author = "Rob Weber"
        date = "2025-07-24"
        version = 1
        reference = "https://unit42.paloaltonetworks.com/apache-cve-2025-24813-cve-2025-27636-cve-2025-29891/"
        hash = "6a9a0a3f0763a359737da801a48c7a0a7a75d6fa810418216628891893773540"
        hash = "6b7912e550c66688c65f8cf8651b638defc4dbeabae5f0f6a23fb20d98333f6b"
        tags = "FILE, RCE, APACHE, TOMCAT, CVE_2025_24813"
        mitre_attack = "T1190"
        malware_type = "Exploit"

    strings:
        // Private string for Java serialized object magic bytes (AC ED = STREAM_MAGIC, 00 05 = STREAM_VERSION)
        $_magic = { AC ED 00 05 }

        // Strings commonly found in Java deserialization gadget chains used for RCE
        $gadget_ysoserial = "ysoserial/payloads" wide ascii
        $gadget_commons1 = "InvokerTransformer" wide ascii
        $gadget_commons2 = "ChainedTransformer" wide ascii
        $gadget_groovy = "MethodClosure" wide ascii

        // Classes used for command execution
        $exec_runtime = "java.lang.Runtime" wide ascii
        $exec_procbuilder = "java.lang.ProcessBuilder" wide ascii

    condition:
        // Check for Java serialized object magic bytes at the start of the file
        $_magic at 0
        and filesize < 500KB
        // Condition to detect common exploit patterns.
        // This looks for either a known tool artifact (ysoserial) or a combination of an
        // execution class and a gadget chain class.
        // FP-Risk: Legitimate applications could potentially use these classes, but the combination
        // within a session file is highly indicative of an exploit.
        and (
            $gadget_ysoserial or
            (1 of ($exec_*) and 1 of ($gadget_*))
        )
}
