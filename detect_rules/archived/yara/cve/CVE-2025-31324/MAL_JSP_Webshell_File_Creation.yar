rule MAL_JSP_Webshell_File_Creation
{
    meta:
        description = "Detects JavaServer Pages (JSP) files containing common web shell patterns. Adversaries deploy web shells for persistence and remote command execution, as observed in post-exploitation activity for vulnerabilities like SAP NetWeaver CVE-2025-31324."
        date = "2025-07-24"
        version = 1
        reference = "https://redcanary.com/blog/threat-intelligence/cve-2025-31324/"
        tags = "FILE, WEBSHELL, JSP, SAP, CVE_2025_31324"
        mitre_attack = "T1505.003"
        malware_type = "Webshell"

    strings:
        // JSP page directive, a strong indicator of a JSP file
        $jsp_directive = "<%@ page import=" ascii

        // High-confidence patterns for executing a command from an HTTP request parameter
        $cmd_exec1 = "Runtime.getRuntime().exec(request.getParameter(" ascii
        $cmd_exec2 = "new ProcessBuilder(request.getParameter(" ascii

        // Generic command execution functions in Java
        $exec_runtime = "Runtime.getRuntime().exec(" ascii
        $exec_processbuilder = "new ProcessBuilder(" ascii

        // Common functions for handling web shell I/O
        $get_param = ".getParameter(" ascii
        $get_stream = ".getInputStream()" ascii
        $out_print = "out.print" ascii

    condition:
        // Rule targets smaller text-based files, typical for web shells.
        filesize < 100KB
        // The file should identify as a JSP page.
        and $jsp_directive
        and
        (
            // High-confidence: direct execution of a request parameter.
            $cmd_exec1 or $cmd_exec2 or

            // Medium-confidence: combination of generic execution, parameter reading, and output handling.
            // This logic may flag some legitimate admin or diagnostic scripts.
            (
                ($exec_runtime or $exec_processbuilder)
                and $get_param
                and $get_stream
                and $out_print
            )
        )
}
