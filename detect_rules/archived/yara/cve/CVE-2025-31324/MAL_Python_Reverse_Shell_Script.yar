rule MAL_Python_Reverse_Shell_Script
{
    meta:
        description = "Detects Python-based reverse shell scripts. These scripts are commonly used by adversaries for post-exploitation command and control, as seen in attacks following the exploitation of vulnerabilities like CVE-2025-31324."
        date = "2025-07-24"
        version = 1
        reference = "https://redcanary.com/blog/threat-intelligence/cve-2025-31324/"
        tags = "FILE, SCRIPT, PYTHON, REVERSE_SHELL, CVE_2025_31324"
        mitre_attack = "T1059.006"
        malware_type = "Reverse Shell"

    strings:
        // Key module imports for network and process operations
        $imp_socket = "import socket" ascii
        $imp_subprocess = "import subprocess" ascii
        $imp_os = "import os" ascii

        // Core components of a reverse shell
        $func_connect = ".connect((" ascii
        $func_dup2 = "dup2(" ascii // Used to redirect stdin/stdout/stderr to the socket
        $func_call = "subprocess.call" ascii
        $func_popen = "subprocess.Popen" ascii
        $shell_nix = "/bin/sh" ascii
        $shell_win = "cmd.exe" ascii nocase

    condition:
        // This rule may trigger on penetration testing tools or custom remote admin scripts.
        // The combination of socket, subprocess, and I/O redirection is a strong indicator of a reverse shell.
        filesize < 50KB
        and all of ($imp*)
        and $func_connect
        and $func_dup2
        and ($func_call or $func_popen)
        and ($shell_nix or $shell_win)
}
