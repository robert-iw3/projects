import "pe"
import "hash"

rule SUSP_Akira_Ransomware_SonicWall_PostExploitation
{
    meta:
        description = "Detects tools, scripts, and ransomware payloads associated with post-exploitation activity following SonicWall VPN compromises, often leading to Akira ransomware deployment."
        author = "RW"
        date = "2025-08-04"
        version = 1
        reference = "https://www.huntress.com/blog/exploitation-of-sonicwall-vpn?utm_source=twitter&utm_medium=social&utm_campaign=cy25-08-rr-multi-global-broad-all-sonicwall_vpn"
        hash = "d080f553c9b1276317441894ec6861573fa64fb1fae46165a55302e782b1614d"
        tags = "CRIME, RANSOMWARE, AKIRA, SONICWALL, FILE"
        mitre_attack = "T1486, T1490, T1003.003, T1087, T1041"
        malware_family = "Akira"
        malware_type = "Ransomware"

    strings:
        // Specific hash for Akira ransomware executable "w.exe"
        $hash_akira = "d080f553c9b1276317441894ec6861573fa64fb1fae46165a55302e782b1614d"

        // Reconnaissance tool string
        // FP risk: Advanced IP Scanner is a legitimate tool; detection relies on co-occurrence with other indicators.
        $tool_scanner = "Advanced_IP_Scanner" wide

        // Specific command-line arguments for WinRAR used for staging
        $tool_winrar_cli = "a -ep1 -scul -r0 -iext -imon1" ascii

        // Command to delete Volume Shadow Copies to prevent recovery
        $cmd_vssadmin = "vssadmin.exe\" delete shadows /all /quiet" wide nocase

        // Commands to backup the Active Directory database for offline credential theft
        $cmd_wbadmin = "wbadmin.exe\" start backup -backupTarget:" wide nocase
        $cmd_ntds = "include:C:\\Windows\\NTDS\\NTDS.dit" wide nocase

    condition:
        // High-fidelity match on the known ransomware hash
        (hash.sha256(0, filesize) == $hash_akira) or

        // Broader detection for related tools and scripts
        (
            pe.is_pe and filesize < 10MB and
            (
                // Detects scripts/tools that combine reconnaissance with recovery prevention
                $tool_scanner and $cmd_vssadmin
                or
                // Detects scripts/tools that perform NTDS.dit theft
                all of ($cmd_*)
                or
                // Detects tools with the specific WinRAR command line used by the threat actor
                $tool_winrar_cli
            )
        )
}
