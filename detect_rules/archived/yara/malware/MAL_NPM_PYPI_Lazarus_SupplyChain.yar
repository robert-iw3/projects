rule MAL_NPM_PYPI_Lazarus_SupplyChain
{
    meta:
        description = "Detects malicious npm and PyPI packages associated with the Lazarus Group's software supply chain attacks. The rule identifies artifacts from typosquatted or brand-jacked packages, as well as strings from their malicious payloads."
        author = "RW"
        date = "2025-07-30"
        version = 1
        reference = "https://blog.sonatype.com/how-north-korea-backed-lazarus-group-is-weaponizing-open-source-to-target-developers"
        tags = "APT, Lazarus, SupplyChain, NPM, PYPI, BeaverTail, FILE"
        mitre_attack = "T1195.001"
        malware_family = "Lazarus"

    strings:
        // --- PyPI 'oscrypto' impersonation (e.g., pycryptoconf, pycryptoenv) ---
        // These packages contain metadata copied from the legitimate 'oscrypto' package.
        $py_impersonation_id1 = "Name: pycryptoconf" ascii
        $py_impersonation_id2 = "Name: pycryptoenv" ascii
        $oscrypto_meta1 = "Home-page: https://github.com/wbond/oscrypto" ascii
        $oscrypto_meta2 = "Author: wbond" ascii
        $oscrypto_meta3 = "Summary: TLS (SSL) sockets, key generation, encryption, decryption" ascii

        // --- NPM 'pino' impersonation (e.g., servula) ---
        // The malicious 'servula' package contains a modified README from the 'pino' logger.
        $servula_impersonation1 = "#jsontostr (Pino)" ascii
        $servula_impersonation2 = "$ npm install jsontostr" ascii

        // --- BeaverTail Credential Stealer Payload ---
        // Hardcoded cryptocurrency wallet extension IDs targeted by the stealer.
        $beaver_tail_wallet1 = "acmacodkjbdgmoleebolmdjonilkdbch" ascii // MetaMask
        $beaver_tail_wallet2 = "bfnaelmomeimhlpmgjnjophhpkkoljpa" ascii // Phantom
        $beaver_tail_wallet3 = "ibnejdfjmmkpcnlpebklmnkoeoihofec" ascii // Coinbase Wallet
        $beaver_tail_wallet4 = "hifafgmccdpekplomjjkcfgodnhcellj" ascii // Ronin Wallet

        // --- Broad File Stealer Payload ---
        // Keywords used by the file stealer to find sensitive files.
        $file_stealer_kw1 = "const searchKey = [" ascii
        $file_stealer_kw2 = "\"*metamask*\"" ascii
        $file_stealer_kw3 = "\"*mnemonic*\"" ascii
        $file_stealer_kw4 = "\"*keypair*\"" ascii

        // --- Dropper/Loader C2 and UID ---
        $dropper_c2 = "0927.vercel.app/api/ipcheck" ascii
        $loader_uid = "const uid = '4a3703430a2ec2ae30f362b29e994f77'" ascii

    condition:
        // Scope to smaller files typical of scripts and package metadata.
        filesize < 1MB and
        (
            // Condition for PyPI packages impersonating 'oscrypto'.
            // Potential for FP if other packages legitimately fork oscrypto but this is unlikely with the malicious names.
            (1 of ($py_impersonation_id*)) and (2 of ($oscrypto_meta*)) or

            // Condition for NPM package 'servula' impersonating 'pino'.
            all of ($servula_impersonation*) or

            // Condition for the BeaverTail credential stealer payload.
            2 of ($beaver_tail_wallet*) or

            // Condition for the broad file stealer payload.
            ($file_stealer_kw1 and 2 of ($file_stealer_kw*)) or

            // Condition for dropper/loader artifacts.
            $dropper_c2 or $loader_uid
        )
}
