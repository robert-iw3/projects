rule MAL_PXA_Stealer_CMD_Script_1
{
    meta:
        description = "Detects command (CMD) scripts used by PXA Stealer to orchestrate its multi-stage infection chain. These scripts often use certutil to decode payloads and a renamed WinRAR to extract them."
        author = "RW"
        date = "2025-08-04"
        version = 1
        reference = "https://www.sentinelone.com/labs/ghost-in-the-zip-new-pxa-stealer-and-its-telegram-powered-ecosystem/"
        tags = "CRIME, INFOSTEALER, PXA_STEALER, FILE, SCRIPT"
        mitre_attack = "T1059.003, T1204.002"
        malware_family = "PXA Stealer"
        malware_type = "Dropper"

    strings:
        // Uses certutil to decode embedded files (e.g., archives disguised as PDFs)
        $s1 = "certutil -decode" ascii wide nocase

        // Uses a renamed WinRAR executable ('images.png') to extract archives
        $s2 = "images.png x -" ascii wide nocase

        // Extracts files to the C:\\Users\\Public directory
        $s3 = "C:\\Users\\Public" ascii wide

        // Sets a Run key for persistence
        $s4 = "reg add \"HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\"" ascii wide nocase

        // Passes a bot identifier as a command-line argument
        $s5 = "_NEW_VER_BOT" ascii wide

    condition:
        // Detects small files that are not PEs (likely scripts)
        uint16(0) != 0x5A4D and filesize < 20KB and
        // Core TTPs: using certutil to decode and a renamed executable to extract to a public directory
        // While some of these strings could appear in legitimate scripts, their combination is highly indicative of this malware.
        $s1 and $s2 and $s3 and
        // Requires at least one other specific indicator to increase confidence
        1 of ($s4, $s5)
}
