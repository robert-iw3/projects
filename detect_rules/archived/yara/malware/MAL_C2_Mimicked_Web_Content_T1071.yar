import "pe"

rule MAL_C2_Mimicked_Web_Content_T1071_001
{
    meta:
        description = "Detects executable files that may be C2 loaders masquerading network traffic as legitimate web content, such as font file downloads. This technique is used to blend in with normal traffic and evade detection."
        author = "RW"
        date = "2025-07-28"
        version = 1
        tags = "FILE, C2, LOADER, T1071.001"
        mitre_attack = "T1071.001"

    strings:
        // Regex to detect URL paths that mimic font file downloads, a common C2 technique.
        $re_path_font = /\/assets\/fonts\/[a-zA-Z0-9_-]+\.ttf/ wide ascii

        // Partial User-Agent strings. Finding multiple of these in a non-browser executable is suspicious.
        // Legitimate updaters or libraries might contain one, but multiple is a stronger indicator of malicious intent.
        $ua_chrome = "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/" wide ascii
        $ua_firefox = "Gecko/20100101 Firefox/" wide ascii
        $ua_edge = "AppleWebKit/537.36 (KHTML, like Gecko) Edge/" wide ascii

        // A specific Accept header used by the loader in the reference article.
        $header_accept = "Accept: text/css,*/*;q=0.1" wide ascii

    condition:
        // Must be a PE file under 5MB.
        pe.is_pe and
        filesize < 5MB and

        // Must use the WinHTTP library for networking.
        pe.imports("winhttp.dll") and

        // Must contain the suspicious font file path.
        $re_path_font and

        // Must also contain either multiple User-Agent strings or the specific Accept header.
        (2 of ($ua_*) or $header_accept)
}
