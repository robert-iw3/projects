import "pe"

rule MAL_Lumma_Loader_Process_Injection
{
    meta:
        description = "Detects Lumma Stealer or its associated Amadey loader based on artifacts related to its process injection routine. The malware resolves a specific set of APIs to create a suspended process, write its payload into it, and then resume its execution."
        author = "Rob Weber"
        date = "2025-07-28"
        reference = "https://labs.withsecure.com/publications/reverse-engineering-a-lumma-infection"
        malware_family = "Lumma"
        malware_type = "Loader"
        mitre_attack = "T1055, T1055.001, T1055.012"
        tags = "CRIME, INFOSTEALER, LOADER, LUMMA, AMADEY, FILE"

    strings:
        // Process injection API strings resolved at runtime
        $api_1 = "CreateProcessW" ascii
        $api_2 = "VirtualAllocEx" ascii
        $api_3 = "WriteProcessMemory" ascii
        $api_4 = "GetThreadContext" ascii
        $api_5 = "SetThreadContext" ascii
        $api_6 = "ResumeThread" ascii
        $api_7 = "ReadProcessMemory" ascii

        // Unique strings from the unpacked Lumma payload
        $unique_1 = "Do you want to run a malware?" wide
        $unique_2 = "FATE99--test" ascii
        $unique_3 = "Purpose.Finder" wide // .NET class name from the loader

        // Hardcoded key from the C# loader's Finder class
        $key_1 = { 05 07 0A 0B 01 00 02 00 01 57 }

        // C2 beaconing artifact
        $c2_post = "act=life" ascii

    condition:
        // Target PE files under 2MB
        pe.is_pe and filesize < 2MB and
        (
            // Condition 1: A high number of process injection APIs are present
            5 of ($api_*) or
            // Condition 2: At least one of the highly unique strings is found
            1 of ($unique_*) or
            // Condition 3: The specific hardcoded key is present
            $key_1 or
            // Condition 4: The specific C2 POST data is present
            $c2_post
        )
}
