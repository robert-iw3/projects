rule MAL_Lazarus_Clipboard_Stealer
{
    meta:
        description = "Detects a multi-platform clipboard stealer payload used by the Lazarus Group. This payload, often part of a larger Node.js-based attack, periodically checks the clipboard content and exfiltrates it. The strings are based on code observed in the 'vite-postcss-helper' malicious package."
        author = "RW"
        date = "2025-07-30"
        version = 1
        reference = "https://blog.sonatype.com/how-north-korea-backed-lazarus-group-is-weaponizing-open-source-to-target-developers"
        tags = "APT, Lazarus, Stealer, Clipboard, FILE"
        mitre_attack = "T1115, T1041"
        malware_family = "Lazarus"

    strings:
        // --- Core function and logic ---
        // Main function declaration for the clipboard watcher
        $func_watch = "async function watchClipboard()" ascii

        // Logic to compare current and previous clipboard content
        $logic_compare = "currentClipboardContent !== lastClipboardContent" ascii
        $logic_handler = "handleClipboardChange(currentClipboardContent)" ascii

        // Periodic execution of the watcher function
        $logic_interval = "setInterval(watchClipboard, 500)" ascii

        // --- Platform-specific commands ---
        // macOS command to get clipboard content
        $cmd_macos = "exec(\"pbpaste\", {windowsHide: true, stdio: \"ignore\"}" ascii

        // Windows command to get clipboard content
        $cmd_win = "exec(\"powershell Get-Clipboard\", {windowsHide: true, stdio: \"ignore\"}" ascii

    condition:
        // Target smaller files, typical for scripts
        filesize < 1MB
        and
        // Require the main function declaration
        $func_watch
        and
        // Require at least one of the platform-specific commands
        ( $cmd_macos or $cmd_win )
        and
        // Require at least two of the other logic strings to increase confidence
        // This helps avoid FPs on legitimate admin scripts that might use pbpaste or Get-Clipboard.
        2 of ($logic_*)
}
