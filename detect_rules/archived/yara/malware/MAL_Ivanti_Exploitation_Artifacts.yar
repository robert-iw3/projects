import "hash"

rule Ivanti_Exploitation_Artifacts
{
    meta:
        author = "RW"
        date = "2025-08-15"
        description = "Detects malware artifacts associated with attacks exploiting Ivanti Connect Secure vulnerabilities, as detailed by JPCERT/CC. This rule identifies specific malware components like MDifyLoader, a custom Cobalt Strike beacon, vshell, and Fscan based on file hashes and embedded strings."
        reference = "https://blogs.jpcert.or.jp/en/2025/07/ivanti_cs.html"
        tactic = "Defense Evasion, Command and Control, Discovery"
        technique = "T1027, T1071.001, T1046"
        false_positive_sensitivity = "Medium"

    strings:
        // Custom Cobalt Strike Beacon v4.5 strings
        $cs_s1 = "google" ascii wide nocase // RC4 key for config decryption
        $cs_s2 = "NewBeacon.dll" ascii wide // Internal name for the beacon

        // Fscan Loader (python311.dll) strings
        $fscan_loader_s1 = "99999999" ascii wide // RC4 key for decoding Fscan

        // vshell RAT strings
        $vshell_s1 = "safeshell" ascii wide // vkey and salt from config
        $vshell_s2 = "proxy.objectlook.com" ascii // C2 server from config

    condition:
        // --- Part 1: High-fidelity detection based on known file hashes ---
        hash.sha256 == "45ecb7b23b328ab762d8519e69738a20eb0cd5618a10abb2c57a9c72582aa7e7" or // MDifyLoader (jli.dll)
        hash.sha256 == "9e91862b585fc4d213e9aaadd571435c1a007d326bd9b07b72dbecb77d1a27ac" or // MDifyLoader (Microsoft.WindowsAppRuntime.Bootstrap.dll)
        hash.sha256 == "09087fc4f8c261a810479bb574b0ecbf8173d4a8365a73113025bd506b95e3d7" or // Cobalt Strike Beacon (update.dat)
        hash.sha256 == "1652ab693512cd4f26cc73e253b5b9b0e342ac70aa767524264fef08706d0e69" or // Cobalt Strike Beacon (config.ini)
        hash.sha256 == "699290a753f35ae3f05a7ea1984d95f6e6f21971a146714fca5708896e5e6218" or // Fscan Loader (python311.dll)
        hash.sha256 == "cff2afc651a9cba84a11a4e275cc9ec49e29af5fd968352d40aeee07fb00445e" or // Fscan (k.bin)
        hash.sha256 == "48f3915fb8d8ad39dc5267894a950efc863bcc660f1654187b3d77a302fd040f" or // vshell
        hash.sha256 == "54350d677174269b4dc25b0ccfb0029d6aeac5abbbc8d39eb880c9fd95691125" or // vshell
        hash.sha256 == "85f9819118af284e6b00ce49fb0c85ff0c0b9d7a0589e1bb56a275ed91314965" or // vshell

        // --- Part 2: String-based detection for potential variants ---
        // FP Tuning: These conditions are scoped to PE files to reduce false positives.
        (
            uint16(0) == 0x5a4d and // Check for PE file (MZ header)
            (
                (all of ($cs*)) or
                (1 of ($fscan_loader*)) or
                (all of ($vshell*))
            )
        )
}
