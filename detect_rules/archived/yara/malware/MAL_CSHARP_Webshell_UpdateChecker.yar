import "hash"

rule MAL_CSHARP_Webshell_UpdateChecker
{
    meta:
        description = "Detects the UpdateChecker.aspx web shell, a highly obfuscated C# tool used by state-sponsored actors for persistence on Microsoft IIS servers. This rule detects the known sample by its SHA256 hash and uses specific strings from the deobfuscated code to identify potential variants."
        date = "2025-07-28"
        version = 1
        hash = "A841C8179AC48BDC2EBF1E646D4F552D9CD02FC79207FDC2FC783889049F32BC"
        tags = "FILE, WEBSHELL, APT, CSHARP, IIS"
        mitre_attack = "T1505.003"
        malware_family = "UpdateChecker"
        malware_type = "Webshell"

    strings:
        // ASPX page directives, common for C# web shells
        $header_1 = "<%@ Page Language=\"C#\" %>" ascii
        $header_2 = "<script runat=\"server\">" ascii

        // Specific JSON keys used in commands, likely to be stable across variants
        $json_key_1 = "ProtocolVersion" wide
        $json_key_2 = "ModuleName" wide
        $json_key_3 = "RequestName" wide

        // Core module names
        $module_1 = "CommandShell" wide
        $module_2 = "FileManager" wide

        // Specific request names indicating functionality
        $request_1 = "GetBasicServerApplicationInfo" wide
        $request_2 = "ExecuteCommand" wide
        $request_3 = "GetFileSystemsList" wide

    condition:
        // Primary condition: high-fidelity check for the known sample hash
        hash.sha256(0, filesize) == "a841c8179ac48bdc2ebf1e646d4f552d9cd02fc79207fdc2fc783889049f32bc" or
        (
            // Secondary condition: string-based detection for close variants
            filesize < 200KB and
            all of ($header_*) and
            all of ($json_key_*) and
            1 of ($module_*) and
            2 of ($request_*)
        )
}
