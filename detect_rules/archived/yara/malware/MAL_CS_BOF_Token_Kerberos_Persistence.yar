import "pe"

rule MAL_CS_BOF_Token_Kerberos_Persistence
{
    meta:
        description = "Detects Cobalt Strike Beacon Object Files (BOFs) designed to steal Windows tokens and generate Kerberos tickets for persistence, as described in the sokarepo blog."
        author = "RW"
        date = "2025-08-07"
        version = 1
        tags = "FILE, COBALT_STRIKE, BOF, KERBEROS, TOKEN_THEFT"
        mitre_attack = "T1055, T1547, T1134.001, T1558.003"
        malware_family = "Cobalt Strike"
        malware_type = "BOF"

    strings:
        // -- Private strings for file format check --
        // A BOF is a COFF (Common Object File Format) file.
        $_coff_x64 = { 64 86 } // IMAGE_FILE_MACHINE_AMD64
        $_coff_x86 = { 4C 01 } // IMAGE_FILE_MACHINE_I386

        // -- Strings related to token storage and manipulation --
        $s_store1 = "tokenstore" wide
        $s_api1 = "BeaconUseToken" wide
        $s_api2 = "BeaconAddValue" wide
        $s_api3 = "BeaconGetValue" wide

        // -- Strings related to Kerberos ticket generation --
        $s_store2 = "ticketstore" wide
        $s_kerb1 = "TgtDeleg" wide // Specific function for TGT delegation trick
        $s_out1 = "Add ticket to store" wide

    condition:
        // Check if the file is a 32-bit or 64-bit COFF file
        ($_coff_x86 at 0 or $_coff_x64 at 0)
        and filesize < 100KB // BOFs are typically small object files

        and (
            // Detects the token management BOF variant
            ($s_store1 and 2 of ($s_api*))
            or
            // Detects the Kerberos TGT generation BOF variant
            ($s_store2 and $s_kerb1 and $s_out1)
        )
}
