import "elf"

rule LINUX_DPRK_TrackerFS_Rootkit
{
    meta:
        description = "Detects components of a North Korean Linux rootkit, including the backdoor binary and persistence scripts. This rule identifies specific anti-forensic strings, communication artifacts, and script commands."
        author = "RW"
        date = "2025-08-15"
        version = 1
        reference = "https://sandflysecurity.com/blog/leaked-north-korean-linux-stealth-rootkit-analysis"
        tags = "APT, ROOTKIT, LINUX, DPRK, FILE"
        mitre_attack = "T1059.004, T1543.002, T1027"
        malware_family = "Tracker-FS"
        malware_type = "Rootkit"

    strings:
        // --- Backdoor Binary Strings ('tracker-efs') ---
        // Specific anti-forensic environment variables set by the backdoor
        $bin_af1 = "BASH_HISTORY=/dev/null" ascii
        $bin_af2 = "HISTORY=/dev/null" ascii
        $bin_af3 = "HISTFILE=/dev/null" ascii

        // Unique communication socket path
        $bin_socket = "/proc/acpi/pcicard" ascii

        // Unique password/key strings from the binary
        $bin_key1 = "Mtu2jACqXeDsxd" ascii
        $bin_key2 = "gfb1akuVAYtz" ascii

        // Backdoor help menu strings
        $bin_help1 = "trans, trans next machine, -h for more help" ascii
        $bin_help2 = "socks5 -o -p port, socks proxy, -h for more help" ascii

        // --- Persistence Script Strings ('tracker-fs' init script) ---
        // Command to load the malicious kernel module
        $script_insmod = "/sbin/insmod /usr/lib64//tracker-fs" ascii
        // Basic shell script structure
        $script_case = "case \"$1\" in" ascii
        $script_start = "'start')" ascii

    condition:
        // Condition 1: Detects the ELF backdoor binary
        (
            elf.is_elf and filesize < 500KB and
            // Requires the specific socket path and at least one unique key
            $bin_socket and 1 of ($bin_key*) and
            // Plus two other indicators for higher confidence
            2 of ($bin_af1, $bin_af2, $bin_af3, $bin_help1, $bin_help2)
        )
        or
        // Condition 2: Detects the shell persistence script
        (
            // Check for shell script shebang
            uint32(0) == 0x21232f62 and filesize < 2KB and
            // Requires all specific script components
            all of ($script_*)
        )
}
