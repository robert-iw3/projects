import "pe"
import "hash"

rule MAL_CS_Beacon_Loader_setup_wm_exe_LockBit {
    meta:
        description = "Detects a specific Cobalt Strike beacon loader (setup_wm.exe) by its hash and unique strings, as observed in a LockBit ransomware intrusion. The malware masquerades as a Microsoft Windows Media Configuration Utility."
        author = "Rob Weber"
        date = "2025-07-27"
        version = 1
        hash = "d8b2d883d3b376833fa8e2093e82d0a118ba13b01a2054f8447f57d9fec67030"
        tags = "CRIME, LOADER, COBALT_STRIKE, LOCKBIT, FILE"
        mitre_attack = "T1204.002"
        malware_family = "Cobalt Strike"
        malware_type = "Loader"

    strings:
        // Masquerading PE metadata from the file properties
        $pe_desc = "Microsoft Windows Media Configuration" wide
        $pe_prod = "Microsoft\xae Windows\xae Operating System" wide
        $pe_orig_fn = "setup_wm.exe" wide

        // Unique strings from the Cobalt Strike beacon configuration
        $c2_host = "compdatasystems.com" ascii
        $c2_uri = "/_next.css" ascii
        $c2_post = "/boards" ascii
        $c2_host_header = "user.compdatasystems.com" ascii

    condition:
        // Check for PE file and a reasonable file size (original was 1.93 MB)
        pe.is_pe and filesize < 3MB and
        (
            // High-fidelity match on the specific known hash
            hash.sha256(0, filesize) == "d8b2d883d3b376833fa8e2093e82d0a118ba13b01a2054f8447f57d9fec67030" or
            // Broader detection for variants based on a combination of unique strings
            (
                all of ($pe_*) and
                2 of ($c2_*)
            )
        )
}
