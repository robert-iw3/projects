import "pe"

rule MAL_APT41_DodgeBox_Loader
{
    meta:
        description = "Detects the DodgeBox loader DLL, a tool used by APT41. This malware is often named 'Sbiedll.dll' or 'Atstrust.dll' and sideloaded by legitimate executables like 'taskhost.exe'."
        author = "RW"
        date = "2025-07-30"
        version = 1
        reference = "https://www.zscaler.com/blogs/security-research/dodgebox-deep-dive-updated-arsenal-apt41-part-1"
        hash = "d72f202c1d684c9a19f075290a60920f"
        hash = "393065ef9754e3f39b24b2d1051eab61"
        tags = "APT, APT41, LOADER, DODGEBOX, FILE"
        mitre_attack = "T1574.002"
        malware_family = "DodgeBox"
        malware_type = "Loader"

    strings:
        // Unique export name mentioned in the analysis
        $exp_hook = "SbieDll_Hook"

        // Specific strings related to DodgeBox functionality
        $s1 = "MalwareMain" wide
        $s2 = "--type driver" wide
        $s3 = "LdrpHandleInvalidUserCallTarget" wide
        $s4 = "_DebugMallocator::~_DebugMallocator" wide

        // Byte sequence for the CFG bypass patch (jmp rax)
        $hex_cfg_patch = { 48 FF E0 }

    condition:
        // Must be a PE file, specifically a DLL
        uint16(0) == 0x5A4D and pe.is_dll() and filesize < 1MB
        and
        (
            // High-confidence match on the specific export name
            pe.exports($exp_hook)
            or
            // Combination of strings and the CFG patch for broader detection
            (2 of ($s*) and $hex_cfg_patch)
        )
}
