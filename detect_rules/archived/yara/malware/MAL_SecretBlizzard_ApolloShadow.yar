import "pe"

rule MAL_SecretBlizzard_ApolloShadow
{
    meta:
        description = "Detects the ApolloShadow malware, a tool used by the Russian state-sponsored actor Secret Blizzard. This malware was observed in Adversary-in-the-Middle (AiTM) campaigns targeting diplomats. It is capable of privilege escalation via UAC bypass, installing root certificates for traffic interception, and creating a new administrative user for persistence."
        author = "RW"
        date = "2025-07-31"
        version = 1
        reference = "https://www.microsoft.com/en-us/security/blog/2025/07/31/frozen-in-transit-secret-blizzards-aitm-campaign-against-diplomats/"
        hash = "13fafb1ae2d5de024e68f2e2fc820bc79ef0690c40dbfd70246bcc394c52ea20"
        tags = "FILE, MALWARE, APT, SECRET_BLIZZARD, APOLLOSHADOW, TURLA"
        mitre_attack = "T1548.002, T1553.004, T1136.001, T1557"
        malware_family = "ApolloShadow"
        malware_type = "Backdoor"

    strings:
        // Unique strings related to C2 communication and payload handling
        $c2_param = "code=DQBBBBBBBBBOBBBBBBBBBBgBBBBBBBBBny_t" ascii
        $c2_resp_header = "MDERPWSAB64B" ascii

        // Artifacts related to privilege escalation and persistence
        $file_name = "CertificateDB.exe" wide
        $vbs_name = "edgB4ACD.vbs" wide
        $ff_pref_file = "wincert.js" wide
        $ff_pref_content = "pref(\"security.enterprise_roots.enabled\", true);" ascii
        $user_name = "UpdatusUser" wide

        // Strings for modifying firewall rules and network profiles
        $fw_rule_1 = "FirewallAPI.dll,-32752" wide // Enables Network Discovery
        $fw_rule_2 = "FirewallAPI.dll,-28502" wide // Enables File and Printer Sharing
        $reg_key_net = "SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Profiles" wide

    condition:
        // Must be a PE file under 5MB
        pe.is_pe and filesize < 5MB and
        // Requires at least one of the highly specific C2-related strings
        (
            $c2_param or $c2_resp_header
        ) and
        // Requires at least 3 other indicators to increase confidence and reduce FPs
        3 of ($file_name, $vbs_name, $ff_*, $user_name, $fw_rule_*, $reg_key_net)
        // Match on the specific SHA256 hash of the ApolloShadow sample.
        hash.sha256(0, filesize) == "13fafb1ae2d5de024e68f2e2fc820bc79ef0690c40dbfd70246bcc394c52ea20"
}
