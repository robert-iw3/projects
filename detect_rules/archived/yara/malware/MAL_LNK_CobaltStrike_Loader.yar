import "pe"

rule MAL_LNK_CobaltStrike_Loader
{
    meta:
        description = "Detects malicious LNK files that execute a command to copy, rename, and run a loader for Cobalt Strike, as seen in a campaign leveraging social media for C2."
        author = "RW"
        date = "2025-07-31"
        version = 1
        hash = "30D11958BFD72FB63751E8F8113A9B04"
        hash = "92481228C18C336233D242DA5F73E2D5"
        tags = "CRIME, COBALT_STRIKE, SPEARPHISHING, LNK, FILE"
        mitre_attack = "T1566.001"
        malware_family = "Cobalt Strike"

    strings:
        // -- LNK File Header and CLSID --
        // LNK files start with 0x4C and have a specific CLSID
        $_lnk_header = { 4C 00 00 00 }
        $_lnk_clsid = { 01 14 02 00 00 00 00 00 C0 00 00 00 00 00 00 46 }

        // -- Command line artifacts from the LNK payload --
        $cmd_1 = "xcopy /h /y" ascii wide
        $cmd_2 = "ren %public%\\\\Downloads" ascii wide
        $file_1 = "BugSplatRc64.dll" ascii wide
        $file_2 = "nau.exe" ascii wide
        $path_1 = "Требования" wide  // Cyrillic for "Requirements"

    condition:
        // -- Rule Logic --
        // 1. Check for LNK file signature and CLSID at the correct offsets.
        // 2. Limit scan to small files, typical for LNKs.
        // 3. Require the specific xcopy and ren commands.
        // 4. Require at least one of the specific filenames or the unique Cyrillic path name.
        // This combination is specific to this campaign and has a low chance of false positives.
        $_lnk_header at 0
        and $_lnk_clsid at 4
        and filesize < 20KB
        and all of ($cmd_*)
        and (1 of ($file_*) or $path_1)
}
