import "pe"

rule MAL_Win_TerraLogger_Keylogger {
    meta:
        description = "Detects TerraLogger, a keylogger associated with the Venom Spider threat actor. The rule identifies samples by looking for the use of the SetWindowsHookExA API in conjunction with specific log file paths and formats."
        author = "Rob Weber"
        date = "2025-07-24"
        version = 1
        reference = "https://blog.polyswarm.io/venom-spider-using-new-terrastealerv2-and-terralogger-malware"
        // Hashes are associated with the broader Venom Spider campaign which includes TerraLogger and TerraStealerV2
        hash = "14d9d56bc4c17a971a9d69b41a4663ab7eb2ca5b52d860f9613823101f072c31"
        hash = "1ed9368d5ac629fa2e7e81516e4520f02eb970d010d3087e902cd4f2e35b1752"
        hash = "313203cb71acd29e6cc542bf57f0e90ce9e9456e2483a20418c8f17b7afe0b57"
        tags = "CRIME, KEYLOGGER, VENOM_SPIDER, TERRALOGGER, FILE"
        mitre_attack = "T1056.001"
        malware_family = "TerraLogger"
        malware_type = "Keylogger"

    strings:
        // Core API for setting a low-level keyboard hook. Common in many applications, so requires other indicators.
        $api_1 = "SetWindowsHookExA" ascii

        // Specific log file paths used by TerraLogger.
        $path_1 = "C:\\ProgramData\\a.txt" wide
        $path_2 = "C:\\ProgramData\\save.txt" wide

        // Unique formats used within the keylogger's output files.
        $log_format_1 = "<KEY-" wide
        $log_format_2 = "|bck|" wide // Pipe-delimited abbreviation for backspace

    condition:
        // Target PE files under 2MB.
        pe.is_pe and filesize < 2MB and
        // Require the keylogging API call...
        $api_1 and
        // ...in combination with either a specific file path or a unique log format string to increase confidence.
        (1 of ($path_*) or 1 of ($log_*))
}
