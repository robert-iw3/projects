import "hash"

rule MAL_COLDRIVER_LOSTKEYS_VBS_Payload
{
    meta:
        description = "Detects the decoded VBS payload of the LOSTKEYS malware, used by the COLDRIVER APT group. This script is an infostealer that collects system information, running processes, and exfiltrates data to a C2 server."
        date = "2025-07-24"
        version = 1
        reference = "https://cloud.google.com/blog/topics/threat-intelligence/coldriver-steal-documents-western-targets-ngos"
        hash = "28a0596b9c62b7b7aca9cac2a07b067109f27d327581a60e8cb4fab92f8f4fa9"
        tags = "APT, COLDRIVER, LOSTKEYS, VBS, FILE, Infostealer"
        mitre_attack = "T1005, T1057, T1082"
        malware_family = "LOSTKEYS"
        malware_type = "Infostealer"

    strings:
        // Substitution cipher logic used for decoding/encoding
        $rep_1 = "my_str = replace(my_str,a1,\"!\" )" ascii nocase
        $rep_2 = "my_str = replace(my_str,b1 ,a1 )" ascii nocase
        $rep_3 = "my_str = replace(my_str,\"!\" ,b1 )" ascii nocase

        // Beacon data construction with system information
        $beacon_1 = "ws.ExpandEnvironmentStrings(\"%COMPUTERNAME%\")" ascii nocase
        $beacon_2 = "fso.GetDrive(\"C:\\\").SerialNumber" ascii nocase
        $beacon_3 = "ReqStr = Chain(ReqStr,\"=+/\",\",-_\")" ascii nocase

        // System information gathering commands
        $cmd_1 = "CapIN \"systeminfo > \"\"\" & TmpF & \"\"\"\", 1, True" ascii nocase
        $cmd_2 = "CapIN \"ipconfig /all >>  \"\"\" & TmpF & \"\"\"\", 1, True" ascii nocase
        $cmd_3 = "CapIN \"tasklist >>  \"\"\" & TmpF & \"\"\"\", 1, True" ascii nocase

    condition:
        // Detects by specific hash or a combination of characteristic strings for broader variant detection.
        hash.sha256(0, filesize) == "28a0596b9c62b7b7aca9cac2a07b067109f27d327581a60e8cb4fab92f8f4fa9" or
        (
            filesize < 100KB and
            (all of ($rep_*) or (all of ($beacon_*)) or 2 of ($cmd_*))
        )
}
