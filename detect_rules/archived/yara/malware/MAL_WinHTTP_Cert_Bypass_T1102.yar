import "pe"

rule MAL_WinHTTP_Cert_Bypass_T1102
{
    meta:
        description = "Detects executable files configured to bypass SSL/TLS certificate validation using the WinHTTP API. This technique is commonly used by malware and loaders to establish covert C2 communications with servers using self-signed or invalid certificates. Legitimate internal tools or updaters may also use this functionality, potentially causing false positives."
        author = "RW"
        date = "2025-07-28"
        version = 1
        tags = "FILE, C2, LOADER, T1102"
        mitre_attack = "T1102"

    strings:
        // WinHTTP security flags used to ignore certificate errors
        $flag_cn = "SECURITY_FLAG_IGNORE_CERT_CN_INVALID" ascii wide
        $flag_date = "SECURITY_FLAG_IGNORE_CERT_DATE_INVALID" ascii wide
        $flag_ca = "SECURITY_FLAG_IGNORE_UNKNOWN_CA" ascii wide
        $flag_usage = "SECURITY_FLAG_IGNORE_CERT_WRONG_USAGE" ascii wide

    condition:
        // Target is a Windows PE file under 5MB
        pe.is_pe and
        filesize < 5MB and

        // Imports the function used to set security options
        pe.imports("winhttp.dll", "WinHttpSetOption") and

        // Contains at least one of the specific flag strings
        1 of ($flag_*)
}
