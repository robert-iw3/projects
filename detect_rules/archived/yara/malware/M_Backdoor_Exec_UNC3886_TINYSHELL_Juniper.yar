import "elf"

rule M_Backdoor_Exec_UNC3886_TINYSHELL_Juniper
{
    meta:
        description = "Detects TINYSHELL-based backdoors (`appid`, `to`, `irad`, `lmpad`, `jdosd`, `oemd`) used by the China-nexus actor UNC3886 to target Juniper Junos OS devices."
        author = "Rob Weber"
        date = "2025-07-24"
        version = 1
        reference = "https://cloud.google.com/blog/topics/threat-intelligence/china-nexus-espionage-targets-juniper-routers/"
        hash = "98380ec6bf4e03d3ff490cdc6c48c37714450930e4adf82e6e14d244d8373888"
        hash = "5bef7608d66112315eefff354dae42f49178b7498f994a728ae6203a8a59f5a2"
        hash = "c0ec15e08b4fb3730c5695fb7b4a6b85f7fe341282ad469e4e141c40ead310c3"
        hash = "5995aaff5a047565c0d7fe3c80fa354c40e7e8c3e7d4df292316c8472d4ac67a"
        hash = "905b18d5df58dd6c16930e318d9574a2ad793ec993ad2f68bca813574e3d854b"
        hash = "e1de05a2832437ab70d36c4c05b43c4a57f856289224bbd41182deea978400ed"
        hash = "3751997cfcb038e6b658e9180bc7cce28a3c25dbb892b661bcd1065723f11f7e"
        hash = "7ae38a27494dd6c1bc9ab3c02c3709282e0ebcf1e5fcf59a57dc3ae56cfd13b4"
        tags = "UNC3886, TINYSHELL, BACKDOOR, FILE, CHINA, JUNIPER"
        mitre_attack = "T1219, T1573, T1090"
        malware_family = "TINYSHELL"
        malware_type = "Backdoor"

    strings:
        // Common TINYSHELL function names for active backdoors (appid, to)
        $tshd_1 = "tshd_get_file" ascii
        $tshd_2 = "tshd_put_file" ascii
        $tshd_3 = "tshd_runshell" ascii
        $tshd_4 = "tshd_setproxy" ascii
        $tshd_5 = "tshd_config" ascii

        // irad passive backdoor artifacts
        $irad_1 = "uSarguuS62bKRA0J" ascii // Magic string for activation
        $irad_2 = "WZtOTig2m42gXB6U" ascii // Hardcoded key string
        $irad_3 = "ek63a21km7WSWkfk" ascii // Exit string
        $irad_4 = "1spCq0BMbJwCoeZn" ascii // Terminate listener string

        // lmpad passive backdoor artifacts
        $lmpad_1 = "/var/tmp/pfed_jdhcp6_trace.log" ascii // Dropped script path
        $lmpad_2 = "0b3330c0b41d1ae2" ascii // RC4 key
        $lmpad_3 = { 26 e7 2b 3a 1c a2 16 2d 61 89 57 a9 cd 4c e7 3c } // Magic bytes

        // jdosd passive backdoor artifacts
        $jdosd_1 = "4fd37426-65dd-4a8d-8ba6-1382a011dae9" ascii // RC4 key
        $jdosd_2 = { ef be ad de } // Magic value 0xDEADBEEF

        // oemd passive backdoor artifacts
        $oemd_1 = "ifinfo '<interface>' | grep local-index | grep -Eo '[0-9]+'" ascii
        $oemd_2 = "INTFS" ascii // Environment variable for interfaces
        $oemd_3 = "UPRT" ascii // Environment variable for port

    condition:
        // Check for ELF file type, as these are FreeBSD/Junos binaries
        elf.is_elf and
        (
            // Detects active backdoors like 'appid' and 'to'
            3 of ($tshd_*) or
            // Detects passive backdoor 'irad'
            2 of ($irad_*) or
            // Detects passive backdoor 'lmpad'
            // The path and key are highly specific, reducing potential FPs.
            2 of ($lmpad_*) or
            // Detects passive backdoor 'jdosd'
            // The magic value 0xDEADBEEF can be common, so it's paired with the unique key.
            all of ($jdosd_*) or
            // Detects passive backdoor 'oemd'
            2 of ($oemd_*)
        )
}
