import "pe"

rule MAL_Skynet_Sandbox_Evasion_Checks
{
    meta:
        description = "Detects files containing multiple sandbox and virtualization evasion checks characteristic of the Skynet malware. This includes checks for specific BIOS vendors, disk devices, running processes, and MAC addresses associated with virtual environments."
        date = "2025-07-24"
        version = 1
        reference = "https://research.checkpoint.com/2025/ai-evasion-prompt-injection/"
        hash = "6cdf54a6854179bf46ad7bc98d0a0c0a6d82c804698d1a52f6aa70ffa5207b02"
        tags = "FILE, MALWARE, EVASION, SANDBOX_EVASION, SKYNET"
        mitre_attack = "T1497"
        malware_family = "Skynet"

    strings:
        // Strings related to VM vendors, products, and processes
        $vm_1 = "VMware" wide ascii nocase
        $vm_2 = "VirtualBox" wide ascii nocase
        $vm_3 = "QEMU" wide ascii nocase
        $vm_4 = "Parallels" wide ascii nocase
        $vm_5 = "vboxservice" wide ascii nocase
        $vm_6 = "qemu-ga.exe" wide ascii nocase
        $vm_7 = "VBOX" wide ascii // Common artifact for VirtualBox

        // Registry keys used for enumeration
        $reg_1 = "HARDWARE\\DESCRIPTION\\System\\BIOS\\SystemManufacturer" wide ascii nocase
        $reg_2 = "SYSTEM\\CurrentControlSet\\Services\\disk\\Enum" wide ascii nocase

        // MAC address prefixes for common hypervisors
        // Note: Legitimate software may contain these strings, so they are combined with other indicators.
        $mac_1 = "00-05-69" ascii // VMWare
        $mac_2 = "08-00-27" ascii // VirtualBox

    condition:
        // Must be a PE file
        pe.is_pe
        and
        (
            // High confidence: 3 or more distinct VM artifacts are present
            3 of ($vm_*)
            or
            // Medium confidence: A specific registry key path is present with at least 2 VM artifacts
            (1 of ($reg_*) and 2 of ($vm_*))
            or
            // Medium confidence: A specific VM MAC address prefix is present with at least one other VM artifact
            (1 of ($mac_*) and 1 of ($vm_*))
        )
}
