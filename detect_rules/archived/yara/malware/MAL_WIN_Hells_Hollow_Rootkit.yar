import "pe"

rule MAL_WIN_Hells_Hollow_Rootkit
{
    meta:
        description = "Detects the Hells Hollow rootkit, which uses an undocumented Alt Syscalls feature on Windows 11 to hook the SSDT and manipulate the KTRAP_FRAME. This allows the rootkit to intercept and modify system calls to evade security products."
        author = "RW"
        date = "2025-08-03"
        version = 1
        tags = "FILE, ROOTKIT, KERNEL, WINDOWS, HELLS_HOLLOW"
        mitre_attack = "T1014"
        malware_family = "Hells Hollow"
        malware_type = "Rootkit"

    strings:
        // mov rax, gs:[0x188] - Accessing KTHREAD structure directly to get current thread
        $asm_kthread = { 65 48 8B 04 25 88 01 00 00 }

        // Specific strings from the public Proof-of-Concept code
        $poc_str1 = "Found hello world" ascii wide
        $poc_str2 = "Addr: {:p}" ascii wide
        $poc_str3 = "RAX: {:X}" ascii wide
        $poc_str4 = "hello_world" ascii wide // Target process name in PoC

        // Hardcoded stack offsets mentioned in the research used to locate the KTRAP_FRAME
        // This may trigger on unrelated files, so it's combined with other indicators.
        $offset1 = { 40 07 } // 0x740
        $offset2 = { 50 07 } // 0x750 (0x540 + 0x210)

    condition:
        // Target must be a Windows kernel driver
        pe.is_pe and pe.subsystem == pe.SUBSYSTEM_NATIVE and filesize < 2MB
        and
        (
            // High-confidence: KTHREAD access + specific PoC strings
            $asm_kthread and 1 of ($poc_str1, $poc_str2, $poc_str3)
            or
            // Medium-confidence: Multiple PoC strings and a characteristic stack offset
            (2 of ($poc_str*) and 1 of ($offset*))
        )
}
