rule MAL_Lazarus_BeaverTail_Stealer
{
    meta:
        description = "Detects the 'BeaverTail' credential and crypto wallet stealer, a payload used by the Lazarus Group in their software supply chain attacks. This rule identifies hardcoded cryptocurrency wallet extension IDs and file paths used to locate browser data on Windows, macOS, and Linux."
        author = "RW"
        date = "2025-07-30"
        version = 1
        reference = "https://blog.sonatype.com/how-north-korea-backed-lazarus-group-is-weaponizing-open-source-to-target-developers"
        tags = "APT, Lazarus, BeaverTail, Stealer, Credential, Wallet, FILE"
        mitre_attack = "T1555.003, T1041, T1048.003"
        malware_family = "Lazarus"
        malware_type = "Infostealer"

    strings:
        // --- BeaverTail C2 URL ---
        $c2_url = "http://144.172.94.226:5961/upload" ascii

        // --- Hardcoded cryptocurrency wallet extension IDs ---
        $wallet_id1 = "acmacodkjbdgmoleebolmdjonilkdbch" ascii // MetaMask
        $wallet_id2 = "bfnaelmomeimhlpmgjnjophhpkkoljpa" ascii // Phantom
        $wallet_id3 = "ibnejdfjmmkpcnlpebklmnkoeoihofec" ascii // Coinbase Wallet
        $wallet_id4 = "hifafgmccdpekplomjjkcfgodnhcellj" ascii // Ronin Wallet
        $wallet_id5 = "nkbihfbeogaeaoehlefnkodbefgpgknn" ascii // MetaMask (alternate)

        // --- Path-finding logic and strings ---
        $func_name = "const getBasePaths = () => {" ascii
        $path_win = "BraveSoftware/Brave-Browser/User Data" ascii
        $path_mac = "Library/Application Support/Google/Chrome" ascii
        $path_linux = ".config/google-chrome" ascii

    condition:
        // Scope to smaller files, typical for scripts
        filesize < 1MB and
        (
            // High-confidence match on the specific C2 URL
            $c2_url or

            // Broader match requiring path-finding logic and multiple wallet IDs
            // This combination is highly specific to this stealer's implementation.
            ( $func_name and 2 of ($path_*) and 2 of ($wallet_id*) )
        )
}
