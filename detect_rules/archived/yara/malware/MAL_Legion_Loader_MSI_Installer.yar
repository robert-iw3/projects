import "pe"

rule MAL_Legion_Loader_MSI_Installer {
    meta:
        description = "Detects Legion Loader MSI installers based on artifacts related to its execution chain, including decoy software names, custom action DLLs, and strings associated with DLL sideloading and process hollowing."
        author = "Rob Weber"
        date = "2025-07-24"
        version = 1
        reference = "https://www.zscaler.com/blogs/security-research/black-hat-seo-poisoning-search-engine-results-ai-distribute-malware"
        hash = "14642E8FFD81298F649E28DC046D84BB"
        tags = "CRIME, LOADER, LEGION_LOADER, MSI, FILE"
        mitre_attack = "T1574.002, T1055"
        malware_family = "Legion Loader"
        malware_type = "Loader"

    strings:
        // Private string for MSI/OLE file header
        $_header_msi = { D0 CF 11 E0 A1 B1 1A E1 }

        // Decoy software names embedded in the installer
        $decoy_1 = "Tao Raiqsuv Utils" wide
        $decoy_2 = "Frankwo Utilities" wide
        $decoy_3 = "Heizer Kroop Sortic" wide
        $decoy_4 = "Kraew Loop Sols" wide

        // Custom action DLL and its exported function
        $dll_1 = "DataUploader.dll" ascii
        $func_1 = "SendCollectedData" ascii

        // Strings related to payload extraction and process hollowing target
        $exec_1 = "7z.exe" wide
        $exec_2 = "explorer.exe" wide

        // Common installation directory string
        $path_1 = "AppData" nocase

    condition:
        // File must be an MSI/OLE container and under 20MB
        $_header_msi at 0
        and filesize < 20MB
        and (
            // High-confidence match on unique decoy software names
            1 of ($decoy_*)
            or
            // High-confidence match on custom action artifacts
            ($dll_1 and $func_1)
            or
            // Medium-confidence match on execution chain artifacts
            // Potential for FPs, but this combination is suspicious in an MSI
            (all of ($exec_*) and $path_1)
        )
}