import "pe"

rule MAL_Lumma_Anti_Analysis_Checks
{
    meta:
        description = "Detects Lumma Stealer based on its specific anti-analysis techniques. This includes checking if the system's default language is Russian (ru-RU) and a self-check to determine if the payload is running in a packed form."
        author = "Rob Weber"
        date = "2025-07-28"
        malware_family = "Lumma"
        malware_type = "Infostealer"
        mitre_attack = "T1497, T1036.003"
        tags = "CRIME, INFOSTEALER, LUMMA, ANTI_ANALYSIS, FILE"

    strings:
        // Anti-analysis: Language check for Russian (ru-RU, ID 0x0419)
        $api_lang_check = "GetUserDefaultUILanguage" ascii
        $const_russian_lang_id = { 19 04 } // The value 0x0419 (ru-RU) as a WORD

        // Anti-analysis: Unique string related to the self-check for being packed
        $str_packer_check = "FATE99--test" ascii

        // Anti-analysis: Unique strings from the warning message box for unpacked samples
        $str_popup_1 = "Do you want to run a malware?" wide
        $str_popup_2 = "(Crypt build to disable this message)" wide

    condition:
        // Must be a PE file and under 1MB to scope the rule
        pe.is_pe and filesize < 1MB and
        (
            // Condition 1: High confidence indicator for the packer check
            $str_packer_check or

            // Condition 2: High confidence indicators from the warning popup
            all of ($str_popup_*) or

            // Condition 3: Combination of the language check API and the specific Russian language ID
            // This combination is characteristic of Lumma's evasion technique.
            ( $api_lang_check and $const_russian_lang_id )
        )
}
