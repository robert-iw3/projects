import "elf"

rule MAL_LNX_Plague_Backdoor_PAM
{
    meta:
        description = "Detects the Plague Linux backdoor, a malicious Pluggable Authentication Module (PAM) designed to bypass authentication and maintain persistence. It features string obfuscation, anti-analysis checks, and session artifact removal."
        author = "RW"
        date = "2025-08-01"
        version = "1"
        reference = "https://www.nextron-systems.com/2025/08/01/plague-a-newly-discovered-pam-based-backdoor-for-linux/"
        hash = "85c66835657e3ee6a478a2e0b1fd3d87119bebadc43a16814c30eb94c53766bb"
        hash = "7c3ada3f63a32f4727c62067d13e40bcb9aa9cbec8fb7e99a319931fc5a9332e"
        hash = "9445da674e59ef27624cd5c8ffa0bd6c837de0d90dd2857cf28b16a08fd7dba6"
        hash = "5e6041374f5b1e6c05393ea28468a91c41c38dc6b5a5230795a61c2b60ed14bc"
        hash = "6d2d30d5295ad99018146c8e67ea12f4aaa2ca1a170ad287a579876bf03c2950"
        hash = "e594bca43ade76bbaab2592e9eabeb8dca8a72ed27afd5e26d857659ec173261"
        hash = "14b0c90a2eff6b94b9c5160875fcf29aff15dcfdfd3402d953441d9b0dca8b39"
        tags = "MALWARE, LINUX, BACKDOOR, PAM, PLAGUE, FILE"
        mitre_attack = "T1556.003, T1027, T1070.004"
        malware_family = "Plague"
        malware_type = "Backdoor"

    strings:
        // Core functions for string deobfuscation
        $func1 = "decrypt_phrase" ascii
        $func2 = "init_phrases" ascii

        // Stealth and anti-analysis strings
        $stealth1 = "ld.so.preload" ascii
        $stealth2 = "libselinux.so.8" ascii // Used in an anti-analysis check
        $stealth3 = "SSH_CONNECTION" ascii
        $stealth4 = "SSH_CLIENT" ascii
        $stealth5 = "HISTFILE=/dev/null" ascii

        // Hardcoded backdoor passwords
        $pass1 = "Mvi4Odm6tld7" ascii
        $pass2 = "IpV57KNK32Ih" ascii
        // The password "changeme" is too generic and has been excluded to avoid potential false positives.

        // Unique quote from the movie "Hackers"
        $quote = "Uh. Mr. The Plague, sir? I think we have a hacker." ascii

    condition:
        // Check for ELF shared library file type
        elf.is_elf and elf.type == elf.ET_DYN
        and filesize < 200KB
        // A key indicator is the export of a standard PAM authentication function
        and elf.exports("pam_sm_authenticate")
        and (
            // High-confidence indicators
            all of ($func*) or
            $quote or
            // Medium-confidence combination of other artifacts
            (2 of ($stealth*) and 1 of ($pass*))
        )
}
