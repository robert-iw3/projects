import "pe"

rule MAL_APT41_DodgeBox_CFG_Bypass
{
    meta:
        description = "Detects malware, such as APT41's DodgeBox loader, that contains code to disable Control Flow Guard (CFG) by patching the ntdll!LdrpHandleInvalidUserCallTarget function in memory."
        author = "RW"
        date = "2025-07-30"
        version = 1
        reference = "https://www.zscaler.com/blogs/security-research/dodgebox-deep-dive-updated-arsenal-apt41-part-1"
        hash = "d72f202c1d684c9a19f075290a60920f" // DodgeBox DLL (Sbiedll.dll)
        hash = "393065ef9754e3f39b24b2d1051eab61" // DodgeBox DLL (Atstrust.dll)
        tags = "APT, APT41, DODGEBOX, DEFENSE_EVASION, CFG_BYPASS, FILE"
        mitre_attack = "T1562.001"
        malware_family = "DodgeBox"
        malware_type = "Loader"

    strings:
        // String used to locate the CFG handler function in ntdll.
        $s_func_name = "LdrpHandleInvalidUserCallTarget" wide

        // The byte sequence for the patch (jmp rax), used to bypass the CFG check.
        $hex_patch = { 48 FF E0 }

    condition:
        // Must be a PE file.
        pe.is_pe
        and filesize < 2MB
        // The file must contain both the target function name and the patch code.
        and $s_func_name
        and $hex_patch
}
