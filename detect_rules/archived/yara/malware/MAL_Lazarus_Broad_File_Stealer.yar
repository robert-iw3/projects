rule MAL_Lazarus_Broad_File_Stealer
{
    meta:
        description = "Detects the Lazarus Group's broad file stealer payload. This script recursively scans the file system for valuable documents and configuration files based on a hardcoded list of keywords (e.g., 'wallet', 'secret', '.env') and file extensions (e.g., '.pdf', '.docx', '.csv'), then exfiltrates them."
        author = "RW"
        date = "2025-07-30"
        version = 1
        reference = "https://blog.sonatype.com/how-north-korea-backed-lazarus-group-is-weaponizing-open-source-to-target-developers"
        tags = "APT, Lazarus, Stealer, File, FILE"
        mitre_attack = "T1005, T1020, T1041, T1560"
        malware_family = "Lazarus"
        malware_type = "Infostealer"

    strings:
        // --- Core scanning function and logic from Figure 19 ---
        $func_scan = "const scanDir = async (dirPath) =>" ascii
        $logic_exclude = "const containsExcludedWord = excludeFolders.some((word) =>" ascii
        $logic_match = "else if (stat.isFile() && isFileMatching(item))" ascii
        $logic_upload = "uf(fullPath);" ascii

        // --- Keywords for sensitive files from searchKey array in Figure 18 ---
        $kw1 = "\"*.env*\"" ascii
        $kw2 = "\"*metamask*\"" ascii
        $kw3 = "\"*phantom*\"" ascii
        $kw4 = "\"*mnemonic*\"" ascii
        $kw5 = "\"*secret*\"" ascii
        $kw6 = "\"*wallet*\"" ascii
        $kw7 = "\"*keypair*\"" ascii
        $kw8 = "\"*credential\"" ascii
        $kw9 = "\"*recovery*\"" ascii

        // --- File extensions to target from searchKey array in Figure 18 ---
        $ext1 = "\"*.docx\"" ascii
        $ext2 = "\"*.pdf\"" ascii
        $ext3 = "\"*.csv\"" ascii
        $ext4 = "\"*.json\"" ascii
        $ext5 = "\"*.txt\"" ascii

    condition:
        // Target smaller files, typical for scripts
        filesize < 1MB
        and
        // Require the main scanning function and the file matching logic
        $func_scan and $logic_match
        and
        // Require a combination of keywords and extensions to ensure specificity.
        // This combination is a strong indicator of a targeted file stealer.
        // Legitimate backup or indexing scripts are unlikely to have this exact combination of hardcoded keywords.
        (4 of ($kw*) and 2 of ($ext*))
}
