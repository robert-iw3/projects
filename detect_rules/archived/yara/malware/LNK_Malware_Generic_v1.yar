rule LNK_Malware_Generic_v1 : MALWARE LNK FILE LOADER SCRIPT
{
    meta:
        description = "Detects suspicious Windows Shortcut (LNK) files that exhibit characteristics of malicious activity, including execution of system binaries with suspicious arguments, in-argument script execution, or overlay content execution."
        date = "2025-07-07"
        version = "1"
        reference = "https://unit42.paloaltonetworks.com/lnk-malware/"
        tags = "MALWARE, LNK, FILE, LOADER, SCRIPT, PHISHING"
        mitre_attack = "T1204.001, T1059.001, T1059.003, T1059.005, T1059.006, T1059.007, T1566.001, T1027, T1036.004, T1105, T1547.001"
        malware_type = "LNK Malware"

    strings:
        // LNK file header signature
        $_lnk_header = { 4C 00 00 00 01 14 02 00 00 00 00 00 C0 00 00 00 00 00 00 46 }

        // Exploit-specific CLSID for "All Control Panel Items" (CVE-2010-2568 variant 2)
        $e_clsid_control_panel = { 20 20 EC 21 3A EA 69 10 A2 DD 08 00 2B 30 30 9D }

        // Common system binaries abused by LNK malware
        $s_powershell = "powershell.exe" ascii wide nocase
        $s_cmd = "cmd.exe" ascii wide nocase
        $s_rundll32 = "rundll32.exe" ascii wide nocase
        $s_conhost = "conhost.exe" ascii wide nocase
        $s_wscript = "wscript.exe" ascii wide nocase
        $s_cscript = "cscript.exe" ascii wide nocase
        $s_forfiles = "forfiles.exe" ascii wide nocase
        $s_mshta = "mshta.exe" ascii wide nocase
        $s_msiexec = "msiexec.exe" ascii wide nocase
        $s_regsvr32 = "regsvr32.exe" ascii wide nocase
        $s_certutil = "certutil.exe" ascii wide nocase
        $s_bitsadmin = "bitsadmin.exe" ascii wide nocase

        // Malicious command line arguments and patterns
        $a_cmd_c = /\s+\/c\s+/ ascii wide nocase
        $a_powershell_exec = /\s+-(NoP|NonI|W\s+Hidden|Exec\s+Bypass|Enc|Command)\s+/ ascii wide nocase
        $a_iex = "Invoke-Expression" ascii wide nocase
        $a_iex_alias = "IEX" ascii wide nocase
        $a_iwr = "Invoke-WebRequest" ascii wide nocase
        $a_iwr_alias = "IWR" ascii wide nocase
        $a_downloadfile = "DownloadFile" ascii wide nocase
        $a_downloadstring = "DownloadString" ascii wide nocase
        $a_webclient = "System.Net.WebClient" ascii wide nocase
        $a_b64decode = "[System.Convert]::FromBase64String" ascii wide nocase
        $a_createobject = "CreateObject" ascii wide nocase
        $a_wscript_shell = "WScript.Shell" ascii wide nocase
        $a_shell_app = "Shell.Application" ascii wide nocase
        $a_activex = "ActiveXObject" ascii wide nocase
        $a_fso = "Scripting.FileSystemObject" ascii wide nocase
        $a_js_rundll32 = "rundll32.exe javascript:" ascii wide nocase
        $a_js_mshta = "mshta.exe javascript:" ascii wide nocase
        $a_regsvr32_dll = "regsvr32.exe /s /u /i:" ascii wide nocase
        $a_http_url = "http://" ascii wide nocase
        $a_https_url = "https://" ascii wide nocase
        $a_script_ext_vbs = ".vbs" ascii wide nocase
        $a_script_ext_js = ".js" ascii wide nocase
        $a_script_ext_hta = ".hta" ascii wide nocase
        $a_script_ext_ps1 = ".ps1" ascii wide nocase
        $a_script_ext_bat = ".bat" ascii wide nocase
        $a_script_ext_cmd = ".cmd" ascii wide nocase
        $a_temp_path = "%TEMP%" ascii wide nocase
        $a_tmp_path = "%TMP%" ascii wide nocase
        $a_appdata_path = "%APPDATA%" ascii wide nocase
        $a_programdata_path = "%PROGRAMDATA%" ascii wide nocase
        $a_public_path = "Public\\" ascii wide nocase
        $a_desktop_path = "Desktop\\" ascii wide nocase
        $a_downloads_path = "Downloads\\" ascii wide nocase
        $a_startup_path = "Startup\\" ascii wide nocase
        $a_recycle_bin = "$Recycle.Bin" ascii wide nocase
        $a_findstr = "findstr" ascii wide nocase
        $a_find = "find" ascii wide nocase
        $a_select_string = "Select-String" ascii wide nocase
        $a_get_content = "Get-Content" ascii wide nocase
        $a_substring = ".Substring" ascii wide nocase
        $a_b64_pe_start = "TVqQ" ascii wide // Base64 for MZ header
        $a_overlay_delimiter = "BS:D" ascii wide

    condition:
        $_lnk_header at 0 and filesize < 5MB and (
            $e_clsid_control_panel or // Exploit variant 2
            (
                any of ($s_powershell, $s_cmd, $s_rundll32, $s_conhost, $s_wscript, $s_cscript, $s_forfiles, $s_mshta, $s_msiexec, $s_regsvr32, $s_certutil, $s_bitsadmin) and
                (
                    any of ($a_cmd_c, $a_powershell_exec, $a_iex, $a_iex_alias, $a_iwr, $a_iwr_alias, $a_downloadfile, $a_downloadstring, $a_webclient, $a_b64decode, $a_createobject, $a_wscript_shell, $a_shell_app, $a_activex, $a_fso, $a_js_rundll32, $a_js_mshta, $a_regsvr32_dll, $a_http_url, $a_https_url) or
                    // At least one script extension or common path for dropped files
                    any of ($a_script_ext_vbs, $a_script_ext_js, $a_script_ext_hta, $a_script_ext_ps1, $a_script_ext_bat, $a_script_ext_cmd, $a_temp_path, $a_tmp_path, $a_appdata_path, $a_programdata_path, $a_public_path, $a_desktop_path, $a_downloads_path, $a_startup_path, $a_recycle_bin)
                )
            ) or
            (
                // Overlay content execution techniques
                any of ($a_findstr, $a_find, $a_select_string, $a_get_content, $a_substring) and
                any of ($a_b64_pe_start, $a_overlay_delimiter, $a_http_url, $a_https_url, $a_script_ext_hta)
            )
        )
}