import "macho"

rule MACOS_AMOS_Backdoor
{
    meta:
        description = "Detects components of the Atomic macOS Stealer (AMOS) malware, specifically the backdoor and persistence artifacts described in a July 2025 report."
        date = "2025-07-10"
        version = 1
        reference = "https://moonlock.com/amos-backdoor-persistent-access"
        hash = "8d8b40e87d3011de5b33103df2ed4ec81458b2a2f8807fbb7ffdbc351c7c7b5e"
        hash = "3402883ff6efadf0cc8b7434a0530fb769de5549b0e9510dfdd23bc0689670d6"
        hash = "f4976d9a90d2f9868fcaade1449ffcf9982ed2285ace90aafa7099ce246fd2ec"
        hash = "54b9576aad25d54d703adb9a26feaa5d80f44b94731ff8ecff7cf1ebc15cf3ff"
        hash = "11e55fa23f0303ae949f1f1d7766b79faf0eb77bccb6f976f519a29fe51ce838"
        hash = "ec11fd865c2f502c47f100131f699a5e0589092e722a0820e96bd698364eefdb"
        tags = "CRIME, MACOS, INFOSTEALER, BACKDOOR, AMOS, FILE"
        mitre_attack = "T1543.004, T1059.002, T1071.001"
        malware_family = "Atomic macOS Stealer"
        malware_type = "Infostealer, Backdoor"

    strings:
        // AppleScript artifacts for persistence and backdoor installation
        $as1 = "installBot(profile, password_entered, botUrl)" ascii
        $as2 = "com.finder.helper" ascii
        $as3 = "/Library/LaunchDaemons/com.finder.helper.plist" ascii
        $as4 = "set botPath to (quoted form of (profile & \"/.helper\"))" ascii
        $as5 = "while true; do\\n    osascript <<EOF" ascii

        // Backdoor C2 communication and file artifacts
        $bd1 = "/api/join/" ascii
        $bd2 = "/api/tasks/" ascii
        $bd3 = "$HOME/.id" ascii
        $bd4 = "$HOME/.helper" ascii

        // Backdoor C2 commands
        $cmd1 = "execute." ascii
        $cmd2 = "pong." ascii
        $cmd3 = "repeat." ascii
        $cmd4 = "delete." ascii

        // Anti-analysis / VM check strings
        // These strings could potentially cause FPs if not combined with other indicators.
        $vm1 = "system_profiler SPMemoryDataType" ascii
        $vm2 = "memData contains \\\"QEMU\\\"" ascii
        $vm3 = "memData contains \\\"VMware\\\"" ascii

    condition:
        // Must be a Mach-O file under 5MB
        macho.is_macho and filesize < 5MB and
        (
            // Detects the AppleScript dropper/installer component
            3 of ($as*) or
            // Detects the backdoor binary via C2 artifacts
            (all of ($bd*) and 2 of ($cmd*)) or
            // Detects anti-analysis checks, which are common in the payload
            all of ($vm*)
        )
}