rule MAL_Lazarus_Keylogger_Screenshotter
{
    meta:
        description = "Detects the Node.js-based keylogger and screenshotter payload used by the Lazarus Group. This malware uses 'node-global-key-listener' and 'screenshot-desktop' libraries to capture user activity and exfiltrates the data to a hardcoded C2 server."
        author = "RW"
        date = "2025-07-30"
        version = 1
        reference = "https://blog.sonatype.com/how-north-korea-backed-lazarus-group-is-weaponizing-open-source-to-target-developers"
        tags = "APT, Lazarus, Keylogger, Screenshotter, Surveillance, FILE"
        mitre_attack = "T1056.001, T1113"
        malware_family = "Lazarus"
        malware_type = "Spyware"

    strings:
        // --- C2 and Libraries from Figure 20 & 21 ---
        // Hardcoded C2 server URL for data exfiltration
        $c2_url = "http://144.172.94.226:5974/upload" ascii

        // Specific Node.js libraries used for surveillance
        $lib_keylogger = "node-global-key-listener" ascii wide
        $lib_screenshot = "screenshot-desktop" ascii wide

        // --- Unique artifacts from exfiltration logic ---
        // Unique header field sent in the C2 request
        $header_userkey = "userkey: 1995" ascii

        // Specific path used to cache the screenshot before upload
        $cache_file = "/windows cache/2.jpeg" ascii

    condition:
        // Scope to smaller files, typical for scripts
        filesize < 1MB
        and
        (
            // High-confidence match on the specific C2 URL
            $c2_url
            or
            // Combination of both surveillance libraries and another unique artifact
            // This combination is highly specific to this malware's implementation.
            ( $lib_keylogger and $lib_screenshot and ($header_userkey or $cache_file) )
        )
}
