import "pe"

rule MAL_UEFI_ShadeBios_Memory_Persistence
{
    meta:
        description = "Detects UEFI firmware modules attempting to persist in memory using the Shade BIOS technique. This involves hooking GetMemoryMap() to reclassify EfiBootServices memory as EfiRuntimeServices memory."
        author = "RW"
        date = "2025-08-10"
        version = 1
        reference = "https://github.com/FFRI/ShadeBIOS"
        malware_family = "Shade BIOS"
        malware_type = "Bootkit"
        mitre_attack = "T1542.001"
        tags = "FILE, BOOTKIT, UEFI, SHADE_BIOS"

    strings:
        // Project-specific strings from the public Shade BIOS implementation
        $s1 = "ShadeBiosDxe" ascii wide
        $s2 = "ShadeBiosEnter" ascii wide
        $s3 = "ShadeBiosExit" ascii wide
        $s4 = "HijackNicFromOS" ascii wide

        // Hex patterns for the memory type manipulation logic.
        // This technique relies on changing memory types to persist after ExitBootServices.
        // Potential for FPs in firmware analysis tools, hence combined with specific strings.

        // Checks for EfiBootServicesCode (type 4) or EfiBootServicesData (type 5)
        $check_boot_code = { 83 ?? ?? 04 } // cmp dword ptr [reg+disp], 4
        $check_boot_data = { 83 ?? ?? 05 } // cmp dword ptr [reg+disp], 5

        // Changes memory type to EfiRuntimeServicesData (type 7)
        $change_to_runtime = { C7 ?? ?? 07 00 00 00 } // mov dword ptr [reg+disp], 7

    condition:
        // Must be a PE file, likely a UEFI driver, and under a reasonable size
        pe.is_pe
        and filesize < 2MB

        // Detects the core TTP: checking for a boot-time memory type and changing it to a runtime type
        and ( ($check_boot_code or $check_boot_data) and $change_to_runtime )

        // Requires a project-specific string to increase confidence and reduce potential FPs
        and 1 of ($s*)
}
