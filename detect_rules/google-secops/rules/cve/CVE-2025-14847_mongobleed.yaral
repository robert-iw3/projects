rule high_frequency_mongobleed_exploit_attempt {
  meta:
    author = "RW"
    date = "2026-01-03"
    description = "Detects a high frequency of MongoDB connections from a single source IP that do not send the standard client metadata payload. This pattern of rapid, incomplete connections is a strong indicator of scanning or exploitation attempts related to MongoBleed (CVE-2025-14847)."
    reference = "https://www.wiz.io/blog/mongobleed-cve-2025-14847-exploited-in-the-wild-mongodb"
    tactic = "TA0001"
    technique = "T1190"
    false_positives = "Extremely high-volume, misconfigured applications that connect and disconnect from MongoDB without completing the handshake might trigger this. The threshold is set high to minimize this risk."
    tags = "MONGO_DB, CVE-2025-14847, MONGO_BLEED, INITIAL_ACCESS, EXPLOIT"

  events:
    // Event for any network connection to the MongoDB port
    $conn_attempt.metadata.event_type = "NETWORK_CONNECTION"
    $conn_attempt.target.port = 27017
    $conn_attempt.principal.ip = $src_ip

    // Event specifically for the MongoDB client metadata handshake (ID 51800)
    // This assumes the MongoDB event ID is parsed into a UDM field.
    $metadata_sent.metadata.event_type = "NETWORK_CONNECTION"
    $metadata_sent.target.port = 27017
    $metadata_sent.principal.ip = $src_ip
    re.regex($metadata_sent.metadata.product_log_id, `51800`)

  match:
    // Group events by the source IP over a 1 minute window
    $src_ip over 1m

  outcome:
    // Set a risk score for the detection
    $risk_score = 75
    // Assign the source IP to the principal_ip outcome variable for visibility
    $principal_ip = $src_ip
    // Count the number of suspicious connection attempts
    $event_count = #conn_attempt
    // Collect a sample of destination IPs
    $target_ip = array_distinct($conn_attempt.target.ip)

  condition:
    // Alert if we see more than 50 connection attempts AND zero metadata events from the same source IP
    #conn_attempt > 50 and #metadata_sent = 0
}
