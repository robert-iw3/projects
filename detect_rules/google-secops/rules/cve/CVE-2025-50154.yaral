rule cve_2025_50154_lnk_abuse_activity_chain {
  meta:
    author = "RW"
    date = "2025-08-13"
    description = "Detects a multi-stage attack chain associated with CVE-2025-50154. The rule correlates the creation of a malicious LNK file via PowerShell with subsequent suspicious activity from explorer.exe, such as connecting to a remote SMB share or dropping an executable in a temporary directory. This correlation provides a high-confidence indicator of compromise."
    tags = "T1204.002, T1566.001, T1021.002, CVE-2025-50154"
    tactic = "TA0002, TA0001, TA0008"
    technique = "T1204.002, T1566.001, T1021.002"
    severity = "HIGH"
    false_positives = "Legitimate administrative scripts may create shortcuts pointing to network resources. However, the correlation with subsequent explorer.exe activity significantly reduces the likelihood of false positives."

  events:
    // Part 1: Detects PowerShell creating a .LNK file with a remote path.
    $ps_lnk_creation.metadata.event_type = "PROCESS_LAUNCH"
    $ps_lnk_creation.principal.hostname = $hostname
    $ps_lnk_creation.principal.user.userid = $user
    // Looks for PowerShell executing a script that uses the WScript.Shell COM object to create a shortcut.
    re.regex($ps_lnk_creation.target.process.command_line, `(?i)WScript\.Shell`) and re.regex($ps_lnk_creation.target.process.command_line, `(?i)CreateShortcut`)
    // Identifies when the shortcut's TargetPath or IconLocation is set to a remote UNC path.
    re.regex($ps_lnk_creation.target.process.command_line, `(?i)(\.TargetPath|\.IconLocation)\s*=\s*['"].*?\\\\`)

    // Part 2: Detects Explorer.exe connecting to a remote SMB share.
    $explorer_smb_conn.metadata.event_type = "NETWORK_CONNECTION"
    $explorer_smb_conn.principal.hostname = $hostname
    $explorer_smb_conn.principal.user.userid = $user
    $explorer_smb_conn.principal.process.file.full_path = /explorer\.exe$/ nocase
    $explorer_smb_conn.target.port = 445
    // This indicates a connection to retrieve an executable or icon file, or a connection to any non-private IP.
    (
      re.regex($explorer_smb_conn.target.url, `\.(exe|dll|ico)$` nocase)
      or
      (
        $explorer_smb_conn.target.ip[0] != "127.0.0.1" and
        not net.ip_in_range_cidr($explorer_smb_conn.target.ip[0], "10.0.0.0/8") and
        not net.ip_in_range_cidr($explorer_smb_conn.target.ip[0], "172.16.0.0/12") and
        not net.ip_in_range_cidr($explorer_smb_conn.target.ip[0], "192.168.0.0/16")
      )
    )

    // Part 3: Detects Explorer.exe creating an executable file in a temp location.
    $explorer_file_creation.metadata.event_type = "FILE_CREATION"
    $explorer_file_creation.principal.hostname = $hostname
    $explorer_file_creation.principal.user.userid = $user
    $explorer_file_creation.principal.process.file.full_path = /explorer\.exe$/ nocase
    // Focuses on executables dropped in common temporary or cache directories.
    re.regex($explorer_file_creation.target.file.full_path, `\.(exe|dll)$` nocase)
    and re.regex($explorer_file_creation.target.file.full_path, `\\AppData\\Local\\(Temp|Microsoft\\Windows\\INetCache)\\` nocase)

  match:
    // Correlates these events on the same host and user within a 10 minute window.
    $hostname, $user over 10m

  outcome:
    $risk_score = 85
    $principal_hostname = $hostname
    $principal_user_userid = $user
    $event_count = count_distinct($ps_lnk_creation.metadata.id) + count_distinct($explorer_smb_conn.metadata.id) + count_distinct($explorer_file_creation.metadata.id)
    // Collect evidence from each stage of the attack chain.
    $powershell_command_lines = array_distinct($ps_lnk_creation.target.process.command_line)
    $smb_connection_urls = array_distinct($explorer_smb_conn.target.url)
    $smb_destination_ips = array_distinct($explorer_smb_conn.target.ip)
    $dropped_file_paths = array_distinct($explorer_file_creation.target.file.full_path)
    $dropped_file_sha256s = array_distinct($explorer_file_creation.target.file.sha256)

  condition:
    // The detection triggers if the initial LNK creation is observed, followed by either the SMB connection or the file drop by explorer.exe.
    $ps_lnk_creation and ($explorer_smb_conn or $explorer_file_creation)
}
