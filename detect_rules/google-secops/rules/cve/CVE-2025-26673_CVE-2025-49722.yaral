rule Windows_DoS_and_DDoS_RPC_LDAP_Abuse {
  meta:
    author = "RW"
    date = "2025-08-13"
    description = "This rule combines multiple detections for Denial of Service (DoS) and Distributed Denial of Service (DDoS) techniques that abuse Windows RPC and LDAP functionalities, as detailed by SafeBreach research. It identifies high-volume LDAP traffic from DCs (Win-DDoS), excessive RPC bind requests (TorpeDoS), and specific RPC call floods associated with CVE-2025-26673 and CVE-2025-49722. Each condition block represents a separate detection module from the original research."
    tactic = "TA0040"
    technique = "T1499.001, T1498.001"
    false_positives = "Legitimate administrative, monitoring, or inventory scanning tools may generate activity that resembles these attacks. It is crucial to baseline normal activity and tune the thresholds for each detection module. Consider allowlisting known-good scanners or administrative hosts/accounts where applicable."

  events:
    // Module 1: Win-DDoS - High Volume Outbound LDAP from Domain Controller
    $ldap.metadata.event_type = "NETWORK_CONNECTION"
    $ldap.principal.process.file.name = "lsass.exe"
    $ldap.target.port = 389
    // Filter for public destination IPs, excluding private ranges.
    not net.ip_in_range_cidr($ldap.target.ip, "10.0.0.0/8")
    not net.ip_in_range_cidr($ldap.target.ip, "172.16.0.0/12")
    not net.ip_in_range_cidr($ldap.target.ip, "192.168.0.0/16")
    // Match keys for LDAP DDoS
    $ldap_dc = $ldap.principal.hostname
    $ldap_victim_ip = $ldap.target.ip

    // Module 2: TorpeDoS - High Volume of RPC Bind Requests
    $rpc_bind.metadata.event_type = "NETWORK_CONNECTION"
    $rpc_bind.target.port = 135
    $rpc_bind.network.ip_protocol = "TCP"
    // Match keys for RPC-based attacks
    $rpc_victim_host = $rpc_bind.target.hostname
    $rpc_attacker_ip = $rpc_bind.principal.ip[0]

    // Module 3: Win-DDoS - Repeated DsrGetDcNameEx2 RPC Calls
    $dsr_flood.metadata.event_type = "PROCESS_RPC"
    $dsr_flood.target.process.file.name = "lsass.exe"
    $dsr_flood.target.process.rpc.interface_uuid = "12345678-1234-abcd-ef00-01234567cffb"
    $dsr_flood.target.process.rpc.method = "DsrGetDcNameEx2"
    $rpc_victim_host = $dsr_flood.target.hostname
    $rpc_attacker_ip = $dsr_flood.principal.ip[0]

    // Module 4: Spike in NetrServerReqChallenge RPC Calls (CVE-2025-26673)
    $netlogon_flood.metadata.event_type = "PROCESS_RPC"
    $netlogon_flood.target.process.file.name = "lsass.exe"
    $netlogon_flood.target.process.rpc.interface_uuid = "12345678-1234-abcd-ef00-01234567cffb"
    ($netlogon_flood.target.process.rpc.method = "NetrServerReqChallenge" or $netlogon_flood.target.process.rpc.op_num = 4)
    $rpc_victim_host = $netlogon_flood.target.hostname
    $rpc_attacker_ip = $netlogon_flood.principal.ip[0]

    // Module 5: Excessive RpcEnumPrinters Calls (CVE-2025-49722)
    $spooler_flood.metadata.event_type = "PROCESS_RPC"
    $spooler_flood.target.process.file.name = "spoolsv.exe"
    $spooler_flood.target.process.rpc.interface_uuid = "12345678-1234-abcd-ef00-0123456789ab"
    $spooler_flood.target.process.rpc.method = "RpcEnumPrinters"
    $rpc_victim_host = $spooler_flood.target.hostname
    $rpc_attacker_ip = $spooler_flood.principal.ip[0]
    $user = $spooler_flood.principal.user.userid

  match:
    // The match section uses different keys for the different attack types.
    // This structure allows the rule to detect any of the specified behaviors.
    $ldap_dc, $ldap_victim_ip over 15m
    $rpc_victim_host, $rpc_attacker_ip over 30m
    $user over 10m

  outcome:
    // The risk score is elevated as these are high-confidence indicators of DoS activity.
    $risk_score = 75
    // Populate outcome variables based on which condition is met.
    $principal_hostname = if($ldap, array_distinct($ldap.principal.hostname), array_distinct($rpc_bind.principal.hostname))
    $target_hostname = if($ldap, array_distinct($ldap.target.hostname), array_distinct($rpc_bind.target.hostname))
    $principal_ip = if($rpc_bind, array_distinct($rpc_bind.principal.ip), array_distinct($dsr_flood.principal.ip))
    $target_ip = if($ldap, array_distinct($ldap.target.ip), array_distinct($rpc_bind.target.ip))
    $principal_user = array_distinct($spooler_flood.principal.user.userid)

    $detection_name = if(#ldap > 100, "Win-DDoS: High Volume Outbound LDAP",
      if(#rpc_bind > 500, "TorpeDoS: High Volume RPC Bind Requests",
        if(#dsr_flood > 20, "Win-DDoS: DsrGetDcNameEx2 RPC Flood",
          if(#netlogon_flood > 500, "Netlogon DoS (CVE-2025-26673)",
            if(#spooler_flood > 200, "Spooler DoS (CVE-2025-49722)", "Unknown DoS Activity")
          )
        )
      )
    )
    $event_count = if(#ldap > 100, #ldap, if(#rpc_bind > 500, #rpc_bind, if(#dsr_flood > 20, #dsr_flood, if(#netlogon_flood > 500, #netlogon_flood, #spooler_flood))))

  condition:
    // Each condition corresponds to a specific DoS/DDoS technique.
    // An alert will fire if any of these thresholds are crossed for the associated match keys.
    ( #ldap > 100 and $ldap_dc and $ldap_victim_ip ) or
    ( #rpc_bind > 500 and $rpc_victim_host and $rpc_attacker_ip ) or
    ( #dsr_flood > 20 and $rpc_victim_host and $rpc_attacker_ip ) or
    ( #netlogon_flood > 500 and $rpc_victim_host and $rpc_attacker_ip ) or
    ( #spooler_flood > 200 and $rpc_victim_host and $rpc_attacker_ip and $user )
}
