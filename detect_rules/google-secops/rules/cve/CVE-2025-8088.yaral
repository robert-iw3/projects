rule RomCom_Activity_Collection_CVE_2025_8088 {
  meta:
    author = "RW"
    date = "2025-08-13"
    description = "This rule combines multiple detection patterns associated with the RomCom threat group's exploitation of CVE-2025-8088 and subsequent post-exploitation activities. It looks for WinRAR path traversal, COM hijacking, anti-analysis techniques, C2 communication, and suspicious WMIC execution."
    tactic = "TA0002, TA0003, TA0004, TA0005, TA0007, TA0011"
    technique = "T1204.002, T1566.001, T1546.015, T1059, T1497, T1071.001, T1047"
    false_positives = "This is a composite rule. The sensitivity of individual detections varies. Legitimate software installers or administration scripts may trigger parts of this rule. Tune by excluding known legitimate processes or domains as needed."

  events:
    // Detection 1: WinRAR Path Traversal (CVE-2025-8088)
    // Event for LNK file creation in a startup folder by WinRAR.
    $winrar_lnk.metadata.event_type = "FILE_CREATION"
    $winrar_lnk.principal.hostname = $hostname
    $winrar_lnk.target.process.name = "winrar.exe"
    $winrar_lnk.target.process.product_specific_process_id = $winrar_pid
    re.regex($winrar_lnk.target.file.full_path, `\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\[^\\]+\.lnk$`) nocase

    // Event for payload (EXE/DLL) creation in a temp location by WinRAR.
    $winrar_payload.metadata.event_type = "FILE_CREATION"
    $winrar_payload.principal.hostname = $hostname
    $winrar_payload.target.process.name = "winrar.exe"
    $winrar_payload.target.process.product_specific_process_id = $winrar_pid
    re.regex($winrar_payload.target.file.full_path, `\\AppData\\Local\\[^\\]+\.(exe|dll)$`) nocase

    // Detection 2: RomCom COM Hijacking for Persistence
    $com_hijack.metadata.event_type = "REGISTRY_MODIFICATION"
    $com_hijack.principal.hostname = $hostname
    re.regex($com_hijack.target.registry.key, `CLSID\\{1299CF18-C4F5-4B6A-BB0F-2299F0398E27}\\InprocServer32`) nocase
    re.regex($com_hijack.target.registry.value.data, `\\AppData\\Local\\Temp\\[^\\]+\.dll$`) nocase

    // Detection 3: Suspicious Execution from Temp with RecentDocs Anti-Analysis Check
    // Event for a process executing from a temporary directory.
    $temp_exec.metadata.event_type = "PROCESS_LAUNCH"
    $temp_exec.principal.hostname = $hostname
    $temp_exec.target.process.product_specific_process_id = $suspicious_pid
    re.regex($temp_exec.target.process.file.full_path, `\\AppData\\Local(\\Temp)?\\[^\\]+\.exe$`) nocase

    // Event for the same process reading the RecentDocs registry key.
    $recent_docs_check.metadata.event_type = "REGISTRY_READ"
    $recent_docs_check.principal.hostname = $hostname
    $recent_docs_check.principal.process.product_specific_process_id = $suspicious_pid
    re.regex($recent_docs_check.target.registry.key, `\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs`) nocase

    // Detection 4: RomCom C2 Domain Activity
    $c2_comm.metadata.event_type = "NETWORK_CONNECTION"
    $c2_comm.principal.hostname = $hostname
    re.regex($c2_comm.network.url, `srlaptop\.com|campanole\.com|melamorri\.com|gohazeldale\.com`)

    // Detection 5: RomCom Mythic Agent WMIC Execution
    $wmic_exec.metadata.event_type = "PROCESS_LAUNCH"
    $wmic_exec.principal.hostname = $hostname
    $wmic_exec.target.process.name = "wmic.exe"
    $wmic_exec.principal.process.name != "svchost.exe"
    re.regex($wmic_exec.principal.process.file.full_path, `(AppData\\Local(\\Temp)?|Users\\Public|ProgramData|C:\\Temp)`) nocase

  match:
    // Correlate any of these activities on the same host over a 1-hour window.
    $hostname over 1h

  outcome:
    $risk_score = 65
    $principal_hostname = $hostname
    // Collect the names of each detection component that was triggered.
    $detection_components = array_distinct(
      if($winrar_lnk and $winrar_payload, "WinRAR Path Traversal (CVE-2025-8088)", ""),
      if($com_hijack, "RomCom COM Hijacking", ""),
      if($temp_exec and $recent_docs_check, "Suspicious Temp Exec with RecentDocs Check", ""),
      if($c2_comm, "RomCom C2 Domain Activity", ""),
      if($wmic_exec, "RomCom Mythic Agent WMIC Execution", "")
    )
    $c2_urls = array_distinct($c2_comm.network.url)
    $wmic_parent_process = array_distinct($wmic_exec.principal.process.command_line)
    $hijacked_com_key = array_distinct($com_hijack.target.registry.key)
    $hijacked_com_value = array_distinct($com_hijack.target.registry.value.data)
    $winrar_dropped_files = array_distinct(strings.concat($winrar_payload.target.file.path, $winrar_payload.target.file.name))

  condition:
    // A detection is triggered if any of the individual RomCom TTPs are observed.
    (
      // Condition 1: WinRAR exploit dropping both LNK and payload from the same process.
      $winrar_lnk and $winrar_payload and $winrar_lnk.target.process.product_specific_process_id = $winrar_payload.target.process.product_specific_process_id
    ) or (
      // Condition 2: COM hijacking for persistence.
      $com_hijack
    ) or (
      // Condition 3: Process from temp location checking RecentDocs for anti-analysis.
      $temp_exec and $recent_docs_check and $temp_exec.target.process.product_specific_process_id = $recent_docs_check.principal.process.product_specific_process_id
    ) or (
      // Condition 4: Network connection to known RomCom C2 domains.
      $c2_comm
    ) or (
      // Condition 5: WMIC execution from a suspicious parent process.
      $wmic_exec
    )
}
