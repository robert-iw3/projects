rule deserialization_vulnerability_exploitation {
  meta:
    author = "RW"
    date = "2025-08-19"
    description = "Detects when a common application server process (e.g., Java, Tomcat), often vulnerable to deserialization attacks, spawns a command-line shell or a reconnaissance tool. This is a strong indicator of post-exploitation activity following a successful remote code execution vulnerability, such as the one demonstrated in the CYSAT analysis."
    tags = "Space, Deserialization, Java, Execution"
    tactic = "TA0002"
    technique = "T1203"
    false_positives = "Legitimate administrative scripts or applications that are designed to spawn shells from a Java process. Tuning may be required to exclude known benign parent-child process relationships."

  events:
    // A process launch event is the core of this detection.
    $process.metadata.event_type = "PROCESS_LAUNCH"

    // The parent process is a common application server type, like Java.
    // This list can be expanded based on the specific application servers in the environment.
    re.regex($process.principal.process.file.full_path, `(?i)\\java(\.exe)?$|\\tomcat\d?\.exe$|\\JBoss\.exe$`)

    // The child process is a shell or a common reconnaissance tool.
    // This indicates an attempt to gain interactive access or gather system information post-exploitation.
    // Potential for false positives if legitimate applications perform this behavior.
    re.regex($process.target.process.file.full_path, `(?i)(\\cmd\.exe|\\powershell\.exe|\/bin\/(ba)?sh|\\whoami\.exe|\\ipconfig\.exe|\\net(1)?\.exe|\/usr\/bin\/(curl|wget|whoami|ip|id))$`)

  outcome:
    // High risk score due to the likelihood of successful code execution.
    $risk_score = 70
    $principal_hostname = array_distinct($process.principal.hostname)
    $principal_user = array_distinct($process.principal.user.userid)
    $parent_process_path = array_distinct($process.principal.process.file.full_path)
    $parent_process_cmdline = array_distinct($process.principal.process.command_line)
    $child_process_path = array_distinct($process.target.process.file.full_path)
    $child_process_cmdline = array_distinct($process.target.process.command_line)
    $event_count = count_distinct($process.metadata.id)

  condition:
    $process
}
