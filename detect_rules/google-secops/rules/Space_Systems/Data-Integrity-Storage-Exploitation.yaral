rule data_integrity_and_storage_exploitation_dise {

  meta:
    author = "RW"
    date = "2025-08-18"
    description = "Detects behaviors aligned with the SPARTA DISE (Data Integrity and Storage Exploitation) threat pattern. This includes attempts to inhibit system recovery by deleting backups or clearing logs, and mass file modification or renaming indicative of ransomware or wiper malware. Such activities threaten data integrity and continuity."
    reference = "https://medium.com/the-aerospace-corporation/indicators-of-behavior-iobs-in-sparta-v3-0-c42ab0683100, https://sparta.aerospace.org/related-work/iob"
    tags = "attack.impact, attack.defense_evasion"
    tactic = "TA0040, TA0005"
    technique = "T1485, T1486, T1490, T1070.001"
    false_positives = "Legitimate administrative activity, such as clearing event logs for maintenance or manually deleting shadow copies., Backup software or system update processes that legitimately modify or delete large numbers of files., Software uninstallers removing application files."

  events:
    // Pattern 1: Detects commands used to inhibit system recovery.
    $recovery.metadata.event_type = "PROCESS_LAUNCH"
    $recovery.principal.hostname = $hostname
    (
      // Deletion of Volume Shadow Copies
      (
        re.regex($recovery.target.process.file.full_path, `\\vssadmin\.exe$`) nocase and
        re.regex($recovery.target.process.command_line, `delete shadows`) nocase
      ) or
      // Clearing critical Windows Event Logs
      (
        re.regex($recovery.target.process.file.full_path, `\\wevtutil\.exe$`) nocase and
        re.regex($recovery.target.process.command_line, `(cl|clear-log)\s+(Application|Security|System)`) nocase
      ) or
      // Disabling system recovery features via bcdedit
      (
        re.regex($recovery.target.process.file.full_path, `\\bcdedit\.exe$`) nocase and
        re.regex($recovery.target.process.command_line, `(recoveryenabled no|bootstatuspolicy ignoreallfailures)`) nocase
      ) or
      // Using PowerShell to remove shadow copies or clear logs
      (
        re.regex($recovery.target.process.file.full_path, `\\(powershell|pwsh)\.exe$`) nocase and
        re.regex($recovery.target.process.command_line, `(Clear-EventLog|Get-WmiObject\s+-Class\s+Win32_ShadowCopy.*Delete)`) nocase
      )
    )
    // Filter: Exclude known administrative or management tools. This may need tuning.
    and not re.regex($recovery.principal.process.file.full_path, `\\(sccm|tanium|bigfix)\.exe$`) nocase

    // Pattern 2: Detects mass file modification or renaming, indicative of ransomware/wipers.
    (
      $file.metadata.event_type = "FILE_MODIFICATION" or
      $file.metadata.event_type = "FILE_RENAME"
    )
    $file.principal.hostname = $hostname
    $file.principal.process.file.full_path = $process_path
    // Filter: Exclude common system processes and software installers known to be noisy.
    and not re.regex($file.principal.process.file.full_path, `\\(MsMpEng|SearchIndexer|svchost|TiWorker|System|setup|msiexec|explorer|GoogleUpdate)\.exe$`) nocase
    // Filter: Exclude common temporary file types to reduce noise.
    and not re.regex($file.target.file.full_path, `\.(log|tmp|temp|cache|bak)$`) nocase

  match:
    $hostname, $process_path over 5m

  outcome:
    // Use conditional logic to provide specific details based on which pattern was detected.
    $risk_score = if($recovery, 65, 85)
    $detection_pattern = if($recovery, "Inhibit System Recovery", "Mass File Manipulation (Ransomware/Wiper)")
    $principal_hostname = $hostname
    $user = if($recovery, array_distinct($recovery.principal.user.userid), array_distinct($file.principal.user.userid))
    $process_path_matched = if($recovery, array_distinct($recovery.target.process.file.full_path), $process_path)
    $command_line = if($recovery, array_distinct($recovery.target.process.command_line), array_distinct($file.principal.process.command_line))
    $parent_process = if($recovery, array_distinct($recovery.principal.process.file.full_path), array_distinct($file.principal.process.file.full_path))

    // Specific outcome for mass file manipulation
    $file_activity_count = count_distinct($file.metadata.id)
    $distinct_folders_affected = count_distinct($file.target.file.directory)

  condition:
    // A single recovery command OR mass file activity in multiple directories triggers a detection.
    $recovery or ($file_activity_count > 200 and $distinct_folders_affected > 5)
}
