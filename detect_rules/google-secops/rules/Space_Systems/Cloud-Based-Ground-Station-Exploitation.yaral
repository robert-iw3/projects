rule cloud_based_ground_station_exploitation {
  meta:
    author = "RW"
    date = "2025-08-19"
    description = "Detects when a user account designated as high-value (e.g., satellite ground crew) performs sensitive cloud management actions from an IP address associated with known threat activity. This could indicate a compromised account is being used to manipulate cloud-based ground station services for malicious purposes, such as data exfiltration or command injection."
    tactic = "TA0006, TA0011"
    technique = "T1078.004"
    tags = "SATELLITE, AEROSPACE, CLOUD, AZURE, AWS, GCP"
    false_positives = "Threat intelligence misattributions. Legitimate administrative activity from a shared or dynamic IP that was previously associated with malicious activity. Use of legitimate VPN services whose exit nodes are on threat lists."

  events:
    // Filter for cloud audit logs (e.g., GCP_CLOUDAUDIT, AWS_CLOUDTRAIL, AZURE_AD_AUDIT).
    $activity.metadata.event_type = /_CLOUDAUDIT$|_CLOUDTRAIL$|_AD_AUDIT$/

    // Filter for actions performed by high-value users.
    // Tuning: The %satellite_operations_crew list must be populated with the user IDs of your satellite operations team.
    $activity.principal.user.userid in %satellite_operations_crew

    // Filter for sensitive operations relevant to ground station control or data access.
    // Tuning: The %sensitive_cloud_operations list should be populated with high-risk operations for your environment.
    $activity.security_result.action in %sensitive_cloud_operations

    // Check for threat intelligence enrichment on the source IP address.
    $activity.principal.ip_threat_intel.threat_info.threat_type != "UNKNOWN"

    // Define placeholders for correlation.
    $user = $activity.principal.user.userid
    $ip = $activity.principal.ip

  match:
    // Group related activity by user and IP over a 1-hour window.
    $user, $ip over 1h

  outcome:
    // Set a risk score for the detection.
    $risk_score = 75

    // Consolidate details for the alert.
    $principal_user = array_distinct($activity.principal.user.userid)
    $suspicious_source_ip = array_distinct($activity.principal.ip)
    $target_resources = array_distinct($activity.target.resource.name)
    $attempted_operations = array_distinct($activity.security_result.action)
    $threat_intel_matches = array_distinct($activity.principal.ip_threat_intel.threat_info.description)
    $event_count = count_distinct($activity.metadata.id)

  condition:
    $activity
}
