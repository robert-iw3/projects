rule unencrypted_satellite_communication_traffic {
  meta:
    author = "RW"
    date = "2025-08-19"
    description = "Detects large volumes of potentially unencrypted network traffic between known ground station assets and satellite gateways. This could indicate an adversary exploiting unencrypted RF links for data interception or modification. This detection is highly dependent on environmental context and requires careful tuning of the associated reference lists and thresholds."
    tags = "SATELLITE, AEROSPACE, COLLECTION, MITM"
    tactic = "TA0009"
    technique = "T1040, T1557"
    false_positives = "Legitimate, high-volume unencrypted traffic used for specific telemetry or data transfer protocols. Normal operational traffic that uses non-standard ports but is still encrypted. The rule's effectiveness relies on accurate IP and port lists and a well-baselined data transfer threshold."

  events:
    // Filter for network connection events.
    $conn.metadata.event_type = "NETWORK_CONNECTION"

    // Condition for traffic flowing from a ground station to a satellite gateway.
    ($conn.principal.ip in %ground_station_ips and $conn.target.ip in %satellite_gateway_ips)
    or
    // Condition for traffic flowing from a satellite gateway to a ground station.
    ($conn.principal.ip in %satellite_gateway_ips and $conn.target.ip in %ground_station_ips)

    // Filter out traffic on ports known to carry encrypted protocols.
    // Tuning: The %known_encrypted_ports list should be updated with any custom encrypted ports used in your environment.
    not $conn.target.port in %known_encrypted_ports

    // Placeholders for grouping events in the match section.
    $src_ip = $conn.principal.ip
    $dest_ip = $conn.target.ip

  match:
    // Group events by the source and destination IP over a 1-hour window.
    $src_ip, $dest_ip over 1h

  outcome:
    // Tuning: Adjust this threshold based on baseline traffic analysis to avoid alerts for normal, low-volume unencrypted traffic.
    $data_transfer_threshold = 10485760 // 10 MB

    // Calculate the total data transferred in the matched events.
    $total_bytes_transferred = sum($conn.network.sent_bytes) + sum($conn.network.received_bytes)

    // Set a risk score for the detection.
    $risk_score = 55

    // Consolidate details for the alert.
    $principal_ip = array_distinct($conn.principal.ip)
    $target_ip = array_distinct($conn.target.ip)
    $destination_ports = array_distinct($conn.target.port)
    $event_count = count_distinct($conn.metadata.id)

  condition:
    // Trigger an alert if the total data transferred exceeds the defined threshold.
    $total_bytes_transferred > $data_transfer_threshold
}
