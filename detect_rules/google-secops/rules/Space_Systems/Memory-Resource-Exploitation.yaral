rule memory_and_resource_exploitation_mire {

  meta:
    author = "RW"
    date = "2025-08-18"
    description = "Detects memory dumping of sensitive processes (e.g., LSASS) or resource exhaustion attacks (e.g., fork bomb), where a process rapidly creates numerous child processes. This behavior is aligned with the SPARTA MIRE (Spacecraft Memory Integrity and Resource Exploitation) threat pattern."
    reference = "https://medium.com/the-aerospace-corporation/indicators-of-behavior-iobs-in-sparta-v3-0-c42ab0683100, https://sparta.aerospace.org/related-work/iob"
    tags = "attack.credential_access, attack.impact"
    tactic = "TA0006, TA0040"
    technique = "T1003.001, T1499.003"
    false_positives = "Memory Dumping: Legitimate crash dump utilities (e.g., Windows Error Reporting) or some security tools. Resource Exhaustion: Legitimate software installers, updaters, or complex build scripts. Tuning of filters may be required."

  events:
    // Event Type 1: Memory Dumping of sensitive processes
    $dumping.metadata.event_type = "PROCESS_LAUNCH"
    (
      // Procdump targeting LSASS
      (
        re.regex($dumping.target.process.file.full_path, `\\procdump(64)?\.exe$`) nocase and
        re.regex($dumping.target.process.command_line, `lsass`) nocase
      ) or
      // Rundll32 with comsvcs.dll to create a minidump of LSASS
      (
        re.regex($dumping.target.process.file.full_path, `\\rundll32\.exe$`) nocase and
        re.regex($dumping.target.process.command_line, `comsvcs\.dll.*MiniDump`) nocase and
        re.regex($dumping.target.process.command_line, `lsass`) nocase
      ) or
      // PowerShell commands for creating minidumps
      (
        re.regex($dumping.target.process.file.full_path, `\\(powershell|pwsh)\.exe$`) nocase and
        (
          re.regex($dumping.target.process.command_line, `Out-Minidump`) nocase or
          re.regex($dumping.target.process.command_line, `Get-Process lsass.*procdump`) nocase
        )
      )
    )
    // Filter: Exclude common legitimate processes that might interact with LSASS.
    and not re.regex($dumping.principal.process.file.full_path, `\\(MsMpEng|WerFault|Sysmon)\.exe$`) nocase

    // Event Type 2: Resource Exhaustion (Fork Bomb)
    $exhaustion.metadata.event_type = "PROCESS_LAUNCH"
    $exhaustion.principal.hostname = $hostname
    $exhaustion.principal.process.pid = $parent_pid
    // Filter: Excludes common noisy parent processes known to spawn many children legitimately.
    and not re.regex($exhaustion.principal.process.file.full_path, `\\(setup|installer|update|msiexec|TiWorker|GoogleUpdate|svchost)\.exe$`) nocase

  match:
    $hostname, $parent_pid over 1m

  outcome:
    // Use conditional logic to populate results based on which event type triggered the detection.
    $risk_score = if($dumping, 75, 60)
    $detection_type = if($dumping, "Memory Dumping", "Resource Exhaustion (Fork Bomb)")
    $principal_hostname = if($dumping, array_distinct($dumping.principal.hostname), $hostname)
    $principal_user_userid = if($dumping, array_distinct($dumping.principal.user.userid), array_distinct($exhaustion.principal.user.userid))
    $parent_process_command_line = if($dumping, array_distinct($dumping.principal.process.command_line), array_distinct($exhaustion.principal.process.command_line))
    $parent_process_path = if($dumping, array_distinct($dumping.principal.process.file.full_path), array_distinct($exhaustion.principal.process.file.full_path))
    $parent_process_pid_match = if($dumping, array_distinct($dumping.principal.process.pid), $parent_pid)

    // Specific outcome variables for each detection type
    $dumping_target_command_line = if($dumping, array_distinct($dumping.target.process.command_line), null)
    $exhaustion_child_process_count = if($dumping, null, count_distinct($exhaustion.metadata.id))
    $exhaustion_distinct_child_paths = if($dumping, null, array_distinct($exhaustion.target.process.file.full_path))

  condition:
    $dumping or #exhaustion > 100
}
