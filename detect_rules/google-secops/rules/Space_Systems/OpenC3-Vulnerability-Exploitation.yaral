rule openc3_cosmos_exploitation_attempt {
  meta:
    author = "RW"
    date = "2025-08-18"
    description = "Detects network-based attempts to exploit vulnerabilities in OpenC3 COSMOS, a common satellite ground control system. This rule identifies common web attack patterns such as path traversal and command injection in HTTP requests targeting COSMOS servers."
    false_positives = "Legitimate vulnerability scanning by authorized security teams or unusual but valid administrative actions may trigger this rule. It is recommended to whitelist known scanner IP addresses."
    reference = "https://cosmosrb.com/"
    tactic = "TA0001"
    technique = "T1190"
    tags = "SATELLITE, GROUND_SYSTEM, OPENC3, COSMOS, EXPLOIT, T1190"

  events:
    $http.metadata.event_type = "NETWORK_HTTP"
    $http.principal.ip = $source_ip
    $http.target.hostname = $target_hostname

    // Identifies OpenC3 COSMOS by looking for its distinctive page title in the HTTP response.
    // As an alternative or addition, consider filtering on default COSMOS ports: $http.target.port in (7777, 7778, 2900)
    re.regex($http.target.http.response_body, `(?i)<title>.*COSMOS.*</title>`)

    // Detects common exploitation patterns in the requested URL.
    (
      // Path Traversal patterns (e.g., ../, ..%2f)
      re.regex($http.target.http.url, `(\.\./|\.\.%2[Ff]|\.\.%[Cc]0%[Aa][Ff])`) or

      // Command Injection payloads (e.g., cmd.exe, /bin/sh, wget, curl, shell operators)
      // This regex should be tuned to your environment to avoid FPs from legitimate scripts.
      re.regex($http.target.http.url, `(?i)(wget|curl|powershell|cmd\.exe|/bin/(sh|bash)|ncat|nc\.exe|;|%3B|\||%7C|&&|%26)`)
    )

  match:
    // Groups multiple attempts from the same source against the same target over a 10 minute window.
    $source_ip, $target_hostname over 10m

  outcome:
    // A high risk score is assigned due to the active nature of the exploitation attempt.
    $risk_score = 75
    $principal_ip = array_distinct($source_ip)
    $target_hostname = array_distinct($target_hostname)
    $target_ip = array_distinct($http.target.ip)
    $target_port = array_distinct($http.target.port)
    $event_count = count_distinct($http.metadata.id)
    $suspicious_urls = array_distinct($http.target.http.url)
    $user_agents = array_distinct($http.network.http.user_agent)

  condition:
    $http
}
