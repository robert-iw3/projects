rule web_vulnerability_exploitation_leading_to_data_access {
  meta:
    author = "RW"
    date = "2025-08-19"
    description = "Detects a pattern indicative of web vulnerability exploitation, such as directory traversal or forced browsing. The rule looks for a high number of '403 Forbidden' errors from a single IP address, followed by a successful request that returns a significant amount of data. This pattern was observed in the Hack-A-Sat competition where an attacker bypassed controls to access sensitive configuration data."
    false_positives = "Legitimate scanning tools, misconfigured clients that retry after failures, or aggressive web crawlers."
    tactic = "TA0001"
    technique = "T1190"
    tags = "WEB, EXPLOITATION, INITIAL_ACCESS"

  events:
    // Match multiple '403 Forbidden' responses, which can indicate enumeration or a bypass attempt.
    $denials.metadata.event_type = "NETWORK_HTTP"
    $denials.network.http.response_code = 403
    $denials.principal.ip = $ip
    $denials.target.hostname = $hostname

    // Match a subsequent successful request from the same source IP.
    $success.metadata.event_type = "NETWORK_HTTP"
    $success.principal.ip = $ip
    $success.target.hostname = $hostname
    $success.network.http.response_code >= 200 and $success.network.http.response_code < 300
    // A successful request returning a non-trivial amount of data is more suspicious. Tune this threshold based on normal traffic.
    $success.network.http.response_body_size > 1024

  match:
    // Correlate events by source IP and target hostname over a 10 minute window.
    $ip, $hostname over 10m
    // Ensure the success happens after the denials, which is key to the attack pattern.
    $denials before $success

  outcome:
    // Set a risk score for the detection.
    $risk_score = 65
    $principal_ip = array_distinct($ip)
    $target_hostname = array_distinct($hostname)
    // Provide context for the analyst.
    $denial_count = count_distinct($denials.metadata.id)
    $denied_urls = array_distinct($denials.target.url.full)
    $successful_url = array_distinct($success.target.url.full)
    $user_agent = array_distinct($denials.network.http.user_agent)

  condition:
    // The core detection logic: a high number of denials followed by at least one success.
    // The denial count threshold can be raised to reduce false positives from misconfigured clients.
    #denials > 10 and #success >= 1
}
