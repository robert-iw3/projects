rule unauthorized_ics_protocol_commands {
  meta:
    author = "RW"
    date = "2025-08-18"
    description = "Detects the execution of potentially malicious or unauthorized commands over common Industrial Control System (ICS) protocols. Such commands can be used by ICS-specific malware (e.g., Industroyer, Triton) or by an attacker to directly manipulate physical processes, stop controllers, or download malicious logic to devices."
    tactic = "TA0040, TA0042" // Impair Process Control, Inhibit Response Function
    technique = "T0843, T0861" // Program Download, Manipulation of Control
    tags = "ICS, OT, MALWARE, INDUSTROYER, TRITON, IMPAIR_PROCESS_CONTROL"
    false_positives = "Legitimate remote maintenance, programming, or troubleshooting activities performed by authorized engineers. Automated system management scripts that have not been added to the exclusion list."

  events:
    // This rule requires network monitoring with deep packet inspection (DPI) for OT protocols (e.g., Zeek, Nozomi, Dragos).
    // The UDM fields used (e.g., about.summary) are placeholders and MUST be adapted to your specific log source.
    $event.metadata.event_type = "NETWORK_CONNECTION"

    // Filter for specific malicious/unauthorized commands across different ICS protocols.
    (
      // Pattern 1: S7 'STOP CPU' command, used by malware like Industroyer.
      (
        $event.network.application_protocol = "s7comm" and
        re.regex($event.about.summary, `stop cpu`, nocase)
      )
      or
      // Pattern 2: DNP3 'Cold Restart' command, which can cause a device to reboot.
      (
        $event.network.application_protocol = "dnp3" and
        // DNP3 Cold Restart is function code 13. Adapt regex to your log format.
        re.regex($event.about.summary, `cold restart|function.?code.?13`, nocase)
      )
      or
      // Pattern 3: Triton malware activity targeting Triconex safety controllers.
      (
        $event.network.application_protocol = "tristation" and
        re.regex($event.about.summary, `LoadProgram|Execute|Halt`, nocase)
      )
      or
      // Pattern 4: Generic program download to a PLC (T0843). This is often legitimate, so filtering is critical.
      (
        re.regex($event.network.application_protocol, `s7comm|enip|modbus`, nocase) and
        re.regex($event.about.summary, `download|write program`, nocase)
      )
    )

    // This filter is critical for reducing false positives.
    // Create a reference list named 'authorized_ics_sources_list' containing the IP addresses/CIDR ranges of your
    // authorized engineering workstations, HMIs, and management servers.
    not net.ip_in_range_cidr($event.principal.ip, %authorized_ics_sources_list)

  outcome:
    // A high risk score is assigned as these commands can directly impact physical processes.
    $risk_score = 80
    $principal_ip = array_distinct($event.principal.ip)
    $target_ip = array_distinct($event.target.ip)
    $target_hostname = array_distinct($event.target.hostname)
    $protocol = array_distinct($event.network.application_protocol)
    // The 'about.summary' field is a placeholder for the field containing command details.
    $command_details = array_distinct($event.about.summary)
    $source_user = array_distinct($event.principal.user.userid)

  condition:
    $event
}
