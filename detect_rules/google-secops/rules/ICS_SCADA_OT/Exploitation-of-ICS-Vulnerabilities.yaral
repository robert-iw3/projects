rule ics_process_spawns_shell {
  meta:
    author = "RW"
    date = "2025-08-18"
    description = "Detects when a known Industrial Control System (ICS) or Operational Technology (OT) process spawns a command shell or scripting interpreter. This is a strong indicator of successful exploitation of a vulnerability in the ICS software, leading to arbitrary code execution. This pattern is a critical TTP to monitor in sensitive environments like maritime mission systems, as discussed in the MOSAICS framework."
    reference = "https://attack.mitre.org/techniques/T1203/, https://attack.mitre.org/techniques/T1059/"
    false_positives = "Legitimate but rare administrative or diagnostic scripts launched from an HMI or engineering workstation software. These should be validated and potentially excluded based on command-line arguments or parent-child relationships."
    tags = "attack.execution, industry.ics, industry.maritime, siemens, schneider_electric, rockwell, hitachi, myscada"
    tactic = "TA0002"
    technique = "T1203, T1059"

  events:
    $process.metadata.event_type = "PROCESS_LAUNCH"

    // Parent process is a known ICS/OT application.
    // This list is an example and MUST be customized for the specific OT environment.
    re.regex($process.principal.process.file.full_path, `(?i)\\((S7oiehsx|pdlrt|CCAgent|CCProjectMgr|Citect32|Unity|Vijeo-Designer|RSLinx|FTView|LogixDesigner|mySCADA|AdvDsOPCServer)\.exe)$`)

    // Child process is a command shell or scripting engine, often used for post-exploitation.
    re.regex($process.target.process.file.full_path, `(?i)\\(powershell|pwsh|cmd|wscript|cscript|mshta|rundll32)\.exe$`)

    // Filter out benign rundll32 usage, which can be common for opening URLs.
    not re.regex($process.target.process.command_line, `(?i)rundll32\.exe\s.*url\.dll,FileProtocolHandler`)

  outcome:
    // High risk score due to strong indication of compromise on a critical system.
    $risk_score = 90
    $principal_hostname = array_distinct($process.principal.hostname)
    $principal_user = array_distinct($process.principal.user.userid)
    $parent_process_path = array_distinct($process.principal.process.file.full_path)
    $parent_process_cmd = array_distinct($process.principal.process.command_line)
    $parent_process_hash = array_distinct($process.principal.process.file.sha256)
    $child_process_path = array_distinct($process.target.process.file.full_path)
    $child_process_cmd = array_distinct($process.target.process.command_line)
    $child_process_hash = array_distinct($process.target.process.file.sha256)

  condition:
    $process
}
