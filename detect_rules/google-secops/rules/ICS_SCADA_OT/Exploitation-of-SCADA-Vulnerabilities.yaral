rule scada_dll_hijacking_attempt {
  meta:
    author = "RW"
    date = "2025-08-20"
    description = "Detects when a known SCADA/ICS application process loads a DLL from an unusual or user-writable directory. This is a strong indicator of a DLL Hijacking attack (T1574.001), often used for privilege escalation (T1068) or persistence on a critical OT asset. This aligns with threat patterns involving exploitation of uncontrolled search paths in SCADA software."
    tactic = "TA0004, TA0003, TA0005"
    technique = "T1068, T1574.001"
    false_positives = "Legitimate but poorly written plugins or helper applications might load DLLs from non-standard paths. It is critical to populate the placeholder lists accurately, especially 'scada_process_list' and 'legit_scada_app_paths', to match your environment."

  events:
    // Match DLL load events.
    $dll.metadata.event_type = "MODULE_LOAD"
    $dll.principal.hostname = $hostname
    $dll.principal.process.file.path = $process_path

    // Filter for events on designated critical ICS assets.
    // Tuning: Populate this list with hostnames of SCADA servers, HMIs, etc.
    $hostname in %ics_asset_list

    // Filter for a known SCADA process loading the DLL.
    // Tuning: Populate this list with the full paths to SCADA executables.
    $process_path in %scada_process_list

    // Core Logic: The DLL is loaded from a suspicious path AND not from a legitimate application directory or system folder.
    (
      // Condition 1: DLL is loaded from a common suspicious/user-writable path.
      re.regex($dll.target.file.path, `(?i)^C:\\(Users\\|ProgramData|PerfLogs|Windows\\Temp|Temp)`)
      or
      // Condition 2: DLL is loaded from a path that is NOT a legitimate SCADA path or a standard Windows directory.
      (
        not $dll.target.file.path in %legit_scada_app_paths
        and not re.regex($dll.target.file.path, `(?i)^C:\\Windows\\`)
      )
    )

    // Optional but recommended: Unsigned DLLs are much more likely to be malicious.
    // Consider enabling this for higher fidelity by uncommenting the line below.
    // $dll.target.file.is_signed = false

  match:
    // Group events by the host and the specific SCADA process being targeted.
    $hostname, $process_path over 1h

  outcome:
    // Set a high risk score due to the critical nature of SCADA systems.
    $risk_score = 70
    $principal_hostname = $hostname
    $principal_process_path = $process_path
    $principal_process_command_line = array_distinct($dll.principal.process.command_line)
    $hijacked_dll_paths = array_distinct($dll.target.file.path)
    $hijacked_dll_sha256s = array_distinct($dll.target.file.sha256)
    $event_count = count_distinct($dll.metadata.id)

  condition:
    $dll
}
