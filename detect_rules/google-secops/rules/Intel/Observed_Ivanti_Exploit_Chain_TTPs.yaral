rule Comprehensive_Ivanti_Exploitation_TTPs
{
  meta:
    author = "RW"
    date = "2025-08-16"
    description = "A composite rule that detects multiple tactics, techniques, and procedures (TTPs) associated with attacks exploiting Ivanti Connect Secure vulnerabilities, as detailed by JPCERT/CC. This includes DLL side-loading, specific malware artifacts, C2 communication, persistence mechanisms, and lateral movement patterns. Note: The ETW bypass technique (T1562.001) mentioned in the source report is difficult to model in a vendor-neutral way and has been omitted from this rule's logic."
    reference = "https://blogs.jpcert.or.jp/en/2025/07/ivanti_cs.html"
    tactic = "TA0002, TA0003, TA0004, TA0005, TA0006, TA0007, TA0008, TA0011"
    technique = "T1574.002, T1027, T1071.001, T1046, T1136.002, T1098, T1543.003, T1053.005, T1110.001, T1021.001, T1021.002"
    false_positives = "Legitimate administrative activity may trigger the account manipulation or persistence logic. Vulnerability scanners may trigger the brute-force logic. These should be tuned by excluding known administrative accounts, tools, or scanner IPs."

  events:
    // --- Part 1: DLL Side-Loading via Legitimate Processes ---
    // Key Logic: Identifies specific legitimate processes loading suspicious DLLs from the same directory.
    $dll_sideload.metadata.event_type = "DLL_LOAD"
    $dll_sideload.target.hostname = $hostname
    $dll_sideload.principal.ip = $ip
    (
      (re.regex($dll_sideload.target.process.file.path, `.*\\rmic\.exe$`) and re.regex($dll_sideload.target.dll.path, `.*\\jli\.dll$`)) or
      (re.regex($dll_sideload.target.process.file.path, `.*\\push_detect\.exe$`) and re.regex($dll_sideload.target.dll.path, `.*\\Microsoft\.WindowsAppRuntime\.Bootstrap\.dll$`)) or
      (re.regex($dll_sideload.target.process.file.path, `.*\\python\.exe$`) and re.regex($dll_sideload.target.dll.path, `.*\\python311\.dll$`))
    )
    and $dll_sideload.target.process.file.directory = $dll_sideload.target.dll.directory
    and not re.regex($dll_sideload.target.dll.path, `(?i)^C:\\(Program Files|Windows)`)

    // --- Part 2: Cobalt Strike & Fscan Artifacts ---
    // Key Logic: Detects the creation of files with SHA256 hashes or names associated with Cobalt Strike or Fscan.
    $file_creation.metadata.event_type = "FILE_CREATION"
    $file_creation.target.hostname = $hostname
    $file_creation.principal.ip = $ip
    (
      $file_creation.target.file.sha256 in (
        "09087fc4f8c261a810479bb574b0ecbf8173d4a8365a73113025bd506b95e3d7", // update.dat (CS)
        "1652ab693512cd4f26cc73e253b5b9b0e342ac70aa767524264fef08706d0e69", // config.ini (CS)
        "cff2afc651a9cba84a11a4e275cc9ec49e29af5fd968352d40aeee07fb00445e"  // k.bin (Fscan)
      )
      or
      (
        re.regex($file_creation.target.file.path, `.*\\(update\.dat|config\.ini)$`) and
        re.regex($file_creation.principal.process.file.path, `.*\\(rmic\.exe|push_detect\.exe)$`)
      )
    )

    // --- Part 3: Vshell C2 Communication ---
    // Key Logic: Detects network traffic to the known vshell C2 domain.
    $vshell_c2.metadata.event_type = "NETWORK_CONNECTION"
    $vshell_c2.principal.hostname = $hostname
    $vshell_c2.principal.ip = $ip
    $vshell_c2.network.destination.domain = "proxy.objectlook.com" and $vshell_c2.network.destination.port = 80

    // --- Part 4: Account Manipulation via CLI ---
    // Key Logic: Looks for command lines used to add users or add members to privileged groups.
    $account_manip.metadata.event_type = "PROCESS_LAUNCH"
    $account_manip.principal.hostname = $hostname
    $account_manip.principal.ip = $ip
    re.regex($account_manip.target.process.file.path, `.*\\net(1)?\.exe$`) and
    (
      re.regex($account_manip.target.process.command_line, `(?i)\suser\s.*\s/add`) or
      re.regex($account_manip.target.process.command_line, `(?i)\s(local)?group\s.*(Administrators|Domain Admins|Enterprise Admins|Remote Desktop Users).*\s/add`)
    )

    // --- Part 5: Suspicious Persistence Creation ---
    // Key Logic: Identifies services or tasks created by sc.exe or schtasks.exe pointing to user-writable locations.
    $persistence.metadata.event_type = "PROCESS_LAUNCH"
    $persistence.principal.hostname = $hostname
    $persistence.principal.ip = $ip
    (
      (re.regex($persistence.target.process.file.path, `.*\\sc\.exe$`) and re.regex($persistence.target.process.command_line, `(?i)\screate\s`)) or
      (re.regex($persistence.target.process.file.path, `.*\\schtasks\.exe$`) and re.regex($persistence.target.process.command_line, `(?i)\s/create\s`))
    )
    and re.regex($persistence.target.process.command_line, `(?i)(binpath|/tr)\s*(=|\s+)\s*"?C:\\(Users|ProgramData|Temp|Windows\\Temp|PerfLogs|Users\\Public|AppData)`)

    // --- Part 6: Brute-Force Followed by Successful Logon ---
    // Key Logic: Identifies numerous failed logons followed by a success from the same source IP to the same host.
    $logon_fail.metadata.event_type = "USER_LOGIN"
    $logon_fail.security_result.action = "BLOCK"
    $logon_fail.principal.ip = $ip
    $logon_fail.target.hostname = $hostname
    $logon_fail.target.user.windows.logon_type = "REMOTE_INTERACTIVE" or $logon_fail.target.user.windows.logon_type = "NETWORK" // RDP (10) or SMB (3)

    $logon_success.metadata.event_type = "USER_LOGIN"
    $logon_success.security_result.action = "ALLOW"
    $logon_success.principal.ip = $ip
    $logon_success.target.hostname = $hostname
    $logon_success.target.user.windows.logon_type = $logon_fail.target.user.windows.logon_type

  match:
    $ip, $hostname over 1h

  outcome:
    // Summarize which parts of the rule triggered to provide context to the analyst.
    $risk_score = if(#logon_fail > 20 and $logon_success > 0, 70, 45)
    $principal_ip = array_distinct($ip)
    $principal_hostname = array_distinct($hostname)
    $sideloading_events = count_distinct($dll_sideload.metadata.id)
    $file_creation_events = count_distinct($file_creation.metadata.id)
    $vshell_c2_events = count_distinct($vshell_c2.metadata.id)
    $account_manipulation_events = count_distinct($account_manip.metadata.id)
    $persistence_events = count_distinct($persistence.metadata.id)
    $failed_logon_count = #logon_fail
    $successful_logon_count = #logon_success
    $involved_users = array_distinct($logon_success.target.user.userid)
    $involved_processes = array_distinct($dll_sideload.target.process.file.path)
    $created_files = array_distinct($file_creation.target.file.path)
    $persistence_commands = array_distinct($persistence.target.process.command_line)

  condition:
    $dll_sideload or
    $file_creation or
    $vshell_c2 or
    $account_manip or
    $persistence or
    (#logon_fail > 20 and $logon_success > 0)
}