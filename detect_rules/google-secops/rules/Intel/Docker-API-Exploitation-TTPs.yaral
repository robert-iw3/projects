rule multi_stage_docker_api_exploitation {
  meta:
    author = "RW"
    date = "2025-09-09"
    description = "Detects a multi-stage attack campaign targeting exposed Docker APIs. The attack involves initial access via the API, followed by execution of tools, persistence, discovery, and C2 activity, as detailed in Akamai research."
    tactic = "TA0001, TA0002, TA0003, TA0005, TA0007, TA0011"
    technique = "T1190, T1059.004, T1098, T1053.003, T1562.004, T1046, T1090.003"
    false_positives = "Legitimate administrative activity on Docker hosts, such as package installation or firewall configuration, may trigger parts of this rule. Vulnerability scanning may also trigger network-related events."
    severity = "HIGH"

  events:
    // Tactic: Initial Access - Inbound connection to exposed Docker API port
    $initial_access.metadata.event_type = "NETWORK_CONNECTION"
    $initial_access.target.hostname = $hostname
    $initial_access.target.port = 2375

    // Tactic: Execution - Installation of tools like curl, wget, or tor
    $execution.metadata.event_type = "PROCESS_LAUNCH"
    $execution.principal.hostname = $hostname
    re.regex($execution.target.process.command_line, `(apk|apt|yum)\s+(add|install)\s+(curl|wget|tor)`) nocase

    // Tactic: Persistence - Modification of SSH authorized_keys or cron files
    $persistence_file.metadata.event_type = "FILE_MODIFICATION"
    $persistence_file.principal.hostname = $hostname
    re.regex($persistence_file.target.file.full_path, `(/root/\.ssh/authorized_keys|/etc/cron\.|/var/spool/cron)`)

    // Tactic: Persistence/Defense Evasion - Firewall modification
    $persistence_firewall.metadata.event_type = "PROCESS_LAUNCH"
    $persistence_firewall.principal.hostname = $hostname
    ($persistence_firewall.target.process.file.path endswith "/firewall-cmd" or $persistence_firewall.target.process.file.path endswith "/iptables")
    and re.regex($persistence_firewall.target.process.command_line, `(--add-rich-rule|-A\s+INPUT)`)

    // Tactic: Discovery - Execution of masscan
    $discovery_scan.metadata.event_type = "PROCESS_LAUNCH"
    $discovery_scan.principal.hostname = $hostname
    $discovery_scan.target.process.file.path endswith "/masscan"

    // Tactic: Discovery - Outbound connections to sensitive ports
    $discovery_connect.metadata.event_type = "NETWORK_CONNECTION"
    $discovery_connect.principal.hostname = $hostname
    $discovery_connect.target.port in (23, 9222)

    // Tactic: Command and Control - DNS query for .onion domain
    $c2_dns.metadata.event_type = "NETWORK_DNS"
    $c2_dns.principal.hostname = $hostname
    $c2_dns.network.dns.question endswith ".onion"

    // Tactic: Command and Control - Execution of torsocks
    $c2_process.metadata.event_type = "PROCESS_LAUNCH"
    $c2_process.principal.hostname = $hostname
    $c2_process.target.process.file.path endswith "/torsocks"

  match:
    // Correlate events on the same hostname over a 24-hour window
    $hostname over 24h

  condition:
    // Trigger if initial access is observed, followed by at least one other malicious activity
    $initial_access and (
      #execution > 0 or
      #persistence_file > 0 or
      #persistence_firewall > 0 or
      #discovery_scan > 0 or
      #discovery_connect > 0 or
      #c2_dns > 0 or
      #c2_process > 0
    )

  outcome:
    // Set a high risk score due to the correlated nature of the activity
    $risk_score = 85
    $principal_hostname = $hostname
    $principal_ip = array_distinct($initial_access.target.ip)

    // Collect details from each stage for investigation
    $attacker_ips = array_distinct($initial_access.principal.ip)
    $execution_commands = array_distinct($execution.target.process.command_line)
    $persistence_files_modified = array_distinct($persistence_file.target.file.full_path)
    $firewall_commands = array_distinct($persistence_firewall.target.process.command_line)
    $discovery_scan_commands = array_distinct($discovery_scan.target.process.command_line)
    $discovery_ports_probed = array_distinct($discovery_connect.target.port)
    $c2_domains_queried = array_distinct($c2_dns.network.dns.question)
    $c2_processes_executed = array_distinct($c2_process.target.process.command_line)
    $event_count = count_distinct($initial_access.metadata.id) + count_distinct($execution.metadata.id) + count_distinct($persistence_file.metadata.id) + count_distinct($persistence_firewall.metadata.id) + count_distinct($discovery_scan.metadata.id) + count_distinct($discovery_connect.metadata.id) + count_distinct($c2_dns.metadata.id) + count_distinct($c2_process.metadata.id)
}
