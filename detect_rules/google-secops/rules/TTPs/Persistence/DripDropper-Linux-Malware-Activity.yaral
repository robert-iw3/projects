rule dripdropper_linux_malware_activity {
  meta:
    author = "RW"
    date = "2025-08-19"
    description = "Detects a cluster of activities associated with the DripDropper Linux malware. This rule looks for multiple indicators on a single host, such as persistence via cron, SSH configuration changes, suspicious file execution, C2 communication over Dropbox, and post-exploitation patching of vulnerabilities."
    tags = "LINUX, CLOUD, MALWARE, DRIPDROPPER, PERSISTENCE, C2"
    tactic = "TA0003, TA0004, TA0011, TA0005"
    technique = "T1053.003, T1546.004, T1071.001, T1204.002"
    false_positives = "Legitimate administrative activity involving several of these behaviors in a short time frame could trigger this rule. The correlation of multiple distinct suspicious events is intended to reduce false positives."

  events:
    // Event for DripDropper establishing persistence by modifying anacron files.
    $cron_mod.metadata.event_type = "FILE_MODIFICATION"
    $cron_mod.principal.hostname = $hostname
    re.regex($cron_mod.target.file.full_path, `\/etc\/cron\.(hourly|daily|weekly|monthly)\/0anacron$`)

    // Event for changing the 'games' user shell, a persistence technique used by the actor.
    $ssh_user_mod.metadata.event_type = "PROCESS_LAUNCH"
    $ssh_user_mod.principal.hostname = $hostname
    $ssh_user_mod.target.process.file.path = /usermod$/
    re.regex($ssh_user_mod.target.process.command_line, `\s-s\s+\/bin\/sh\s+games`) nocase

    // Event for the adversary patching the exploited ActiveMQ vulnerability.
    $patch_download.metadata.event_type = "PROCESS_LAUNCH"
    $patch_download.principal.hostname = $hostname
    $patch_download.target.process.file.path = /curl$/
    re.regex($patch_download.target.process.command_line, `repo1\.maven\.org` nocase)
    re.regex($patch_download.target.process.command_line, `activemq.*\.jar` nocase)

    // Event for C2 communication with Dropbox.
    $dropbox_c2.metadata.event_type = "NETWORK_CONNECTION"
    $dropbox_c2.principal.hostname = $hostname
    re.regex($dropbox_c2.target.domain.name, `(\.|^)dropbox\.com$`)
    // FP Mitigation: Exclude common browsers and the legitimate Dropbox client.
    // This list may need to be expanded based on your environment.
    not re.regex($dropbox_c2.principal.process.file.path, `(firefox|chrome|safari|Dropbox|MicrosoftEdge)`)

    // Event for executing a suspicious file, matching the observed dropper behavior.
    $suspicious_exec.metadata.event_type = "PROCESS_LAUNCH"
    $suspicious_exec.principal.hostname = $hostname
    // The dropper is often placed in temporary or world-writable directories.
    re.regex($suspicious_exec.target.process.file.path, `^/(tmp|var/tmp|dev/shm)/`)
    // The malware was observed using an 8-character alphabetic name.
    re.regex($suspicious_exec.target.process.file.name, `^[a-zA-Z]{8}$`)

  match:
    // Correlate these distinct activities on the same host over a 1-hour window.
    $hostname over 1h

  outcome:
    // A higher risk score is assigned as multiple indicators are required for a detection.
    $risk_score = 75
    $principal_hostname = $hostname
    $event_count = count_distinct($cron_mod.metadata.id) + count_distinct($ssh_user_mod.metadata.id) + count_distinct($patch_download.metadata.id) + count_distinct($dropbox_c2.metadata.id) + count_distinct($suspicious_exec.metadata.id)
    $commands = array_distinct($ssh_user_mod.target.process.command_line, $patch_download.target.process.command_line, $suspicious_exec.target.process.command_line)
    $files_modified = array_distinct($cron_mod.target.file.full_path)
    $files_executed = array_distinct($suspicious_exec.target.process.file.path)
    $c2_domains = array_distinct($dropbox_c2.target.domain.name)

  condition:
    // The rule triggers if at least two of the distinct suspicious behaviors are observed.
    (
      ( #cron_mod > 0 ) +
      ( #ssh_user_mod > 0 ) +
      ( #patch_download > 0 ) +
      ( #dropbox_c2 > 0 ) +
      ( #suspicious_exec > 0 )
    ) >= 2
}
