rule ad_cs_esc8_ntlm_relay_exploitation {
  meta:
    author = "RW"
    date = "2025-08-13"
    description = "Detects a potential AD CS ESC8 exploitation attempt via NTLM relay. This is identified by correlating a successful NTLM authentication from a machine account to an AD CS server, immediately followed by a certificate request on behalf of that same account. This pattern is indicative of an attacker coercing authentication from a victim machine and relaying it to an AD CS HTTP endpoint to forge a certificate for privilege escalation."
    tactic = "TA0004"
    technique = "T1558.004"
    false_positives = "Legitimate certificate auto-enrollment processes, although NTLM usage for this is uncommon and may indicate misconfiguration. Ensure the AD CS server reference list is accurate to reduce noise."

  events:
    // Event 1: Successful NTLM authentication to an AD CS server, likely from a coerced machine account.
    $ntlm_auth.metadata.product_event_type = "4776"
    $ntlm_auth.metadata.event_type = "USER_LOGIN"
    $ntlm_auth.security_result.action = "ALLOW"
    $ntlm_auth.network.auth_protocol = "NTLM"
    // The target of the login is an AD CS server. Use a reference list for accuracy.
    // Example: $ntlm_auth.target.hostname in %ad_cs_servers
    $adcs_hostname = $ntlm_auth.target.hostname

    // Machine accounts are the typical victims of coercion for relaying.
    re.regex($ntlm_auth.principal.user.userid, `\$$`)

    // Define placeholders for correlation
    $attacker_ip = $ntlm_auth.principal.ip
    $victim_account = $ntlm_auth.principal.user.userid
    $victim_hostname = $ntlm_auth.principal.hostname // The coerced machine

    // Event 2: Certificate request on the AD CS server for the victim account.
    $cert_req.metadata.product_event_type = "4886"
    $cert_req.metadata.event_type = "CERTIFICATE_REQUEST"
    // The request happens on the same AD CS server.
    $cert_req.principal.hostname = $adcs_hostname
    // The certificate is requested for the same account that was just authenticated via NTLM relay.
    $cert_req.target.user.userid = $victim_account

  match:
    // Correlate the NTLM auth and cert request by the AD CS server and the victim account over a short window.
    $adcs_hostname, $victim_account over 5m

  outcome:
    $risk_score = 85
    // Consolidate key fields for investigation.
    $principal_ip = array_distinct($attacker_ip)
    $principal_hostname = array_distinct($victim_hostname) // The coerced machine
    $target_hostname = array_distinct($adcs_hostname)
    $victim_account_name = array_distinct($victim_account)
    // The field for certificate template name may vary based on log parsing.
    $certificate_template = array_distinct($cert_req.additional.fields["TemplateName"])
    $requester = array_distinct($cert_req.principal.user.userid) // Who initiated the request on the CA

  condition:
    // Ensure both events occurred for the same correlated entities.
    $ntlm_auth and $cert_req
}
