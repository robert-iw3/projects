rule kubernetes_runc_escape_attempt_cve_2019_5736 {
  meta:
    author = "RW"
    date = "2025-08-13"
    description = "Detects a process execution within a container that attempts to write to '/proc/self/exe'. This is a key indicator of container escape exploits like CVE-2019-5736 (runc), where an attacker tries to overwrite the container runtime binary on the host to achieve code execution."
    tactic = "TA0004"
    technique = "T1611, T1068"
    false_positives = "This behavior is highly anomalous. False positives are unlikely but could occur with unusual debugging or introspection tools. Legitimate system processes should not be writing to their own executable path via /proc/self/exe."
    tags = "KUBERNETES, CONTAINER, CONTAINER_ESCAPE, RUNC, CVE-2019-5736"

  events:
    // Filter for process launch events, which correspond to execve syscalls.
    $proc.metadata.event_type = "PROCESS_LAUNCH"

    // Ensure the event is from within a container, which is crucial context for this exploit.
    $proc.target.process.container.id != ""

    // Detect command lines attempting to write to /proc/self/exe.
    // This covers shell redirection (>), tools like dd (of=), or copy/move commands where the path is the last argument.
    re.regex($proc.target.process.command_line, `((>|of=)\s*['"]?/proc/self/exe['"]?\b|\s['"]?/proc/self/exe['"]?\s*$)`) nocase

  condition:
    $proc

  outcome:
    // This is a high-severity event indicating a likely container escape attempt.
    $risk_score = 90
    $principal_hostname = $proc.principal.hostname
    $principal_user = $proc.principal.user.userid
    $parent_process_command_line = $proc.principal.process.command_line
    $parent_process_path = $proc.principal.process.file.full_path
    $target_process_command_line = $proc.target.process.command_line
    $target_process_path = $proc.target.process.file.full_path
    $target_process_pid = $proc.target.process.pid
    $container_id = $proc.target.process.container.id
    $container_image = $proc.target.process.container.image.path
    $container_name = $proc.target.process.container.name
}
