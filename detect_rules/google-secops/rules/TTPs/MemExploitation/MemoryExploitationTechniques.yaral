rule MemoryExploitationTechniques {
  meta:
    author = "RW"
    date = "2025-08-10"
    description = "Detects advanced memory exploitation techniques such as ASLR/DEP bypass, including anomalous memory protection changes, direct writes to executable memory, and precursor attacks like format string exploits."
    mitre_attack = "T1055, T1068"
    false_positive_sensitivity = "Medium"
    severity = "HIGH"
    rule_name = "MemoryExploitationTechniques"

  events:
    // Detection 1: Anomalous Memory Protection Change (Non-Executable to Executable)
    $mem_protect_change.metadata.event_type = "VIRTUAL_PROTECT" // Corresponds to ActionType "VirtualProtect"
    $mem_protect_change.principal.process.file.full_path !in %process_allowlist // Exclude allowed processes
    $mem_protect_change.memory.old_protection not in ("PAGE_EXECUTE", "PAGE_EXECUTE_READ", "PAGE_EXECUTE_READWRITE") // Old protection not executable
    $mem_protect_change.memory.new_protection in ("PAGE_EXECUTE", "PAGE_EXECUTE_READ", "PAGE_EXECUTE_READWRITE") // New protection is executable

    // Detection 2: WriteProcessMemory to Executable Region in Self
    $write_mem_rx.metadata.event_type = "WRITE_PROCESS_MEMORY" // Corresponds to ActionType "WriteProcessMemory"
    $write_mem_rx.principal.process.file.full_path !in %process_allowlist // Exclude allowed processes
    $write_mem_rx.principal.process.file.product_id = $write_mem_rx.target.process.file.product_id // Target process is the initiating process
    $write_mem_rx.memory.protection in ("PAGE_EXECUTE", "PAGE_EXECUTE_READ", "PAGE_EXECUTE_READWRITE") // Writing to executable memory

    // Detection 3: Executable Memory Allocation Spike Followed by Network Activity
    $large_exec_alloc.metadata.event_type = "VIRTUAL_ALLOC" // Corresponds to ActionType "VirtualAlloc"
    $large_exec_alloc.principal.process.file.full_path !in %process_allowlist // Exclude allowed processes
    $large_exec_alloc.memory.protection in ("PAGE_EXECUTE", "PAGE_EXECUTE_READ", "PAGE_EXECUTE_READWRITE")
    $large_exec_alloc.memory.allocated_bytes > 1000000 // 1MB threshold

    $network_event.metadata.event_type = "NETWORK_CONNECTION" // Corresponds to DeviceNetworkEvents
    $network_event.principal.process.file.full_path !in %process_allowlist // Exclude allowed processes
    $network_event.network.direction = "OUTBOUND"
    $network_event.network.ip != "127.0.0.1" // Exclude localhost

    // Detection 4: Format String Exploit Attempt in Web Logs
    $format_string_exploit.metadata.log_type = "WEBSERVER_ACCESS_LOG" // Assuming web server access logs
    $format_string_exploit.network.http.request_url contains_any ("%x", "%s", "%n", "%p") // Contains format string specifiers
    $format_string_exploit.principal.ip != "127.0.0.1" // Exclude localhost

  // Conditions for joining and correlating events
  match:
    $mem_protect_change or $write_mem_rx or $format_string_exploit or ( $large_exec_alloc and $network_event )

  condition:
    // This allows for individual detections to trigger the rule
    // Or for the combined allocation and network activity to trigger it
    ( $mem_protect_change or $write_mem_rx or $format_string_exploit ) or
    ( $large_exec_alloc and $network_event.metadata.event_timestamp between $large_exec_alloc.metadata.event_timestamp and $large_exec_alloc.metadata.event_timestamp + 5m )

}

// Reference lists for allowlisted processes and IPs (can be managed in Chronicle)
// %process_allowlist = ["chrome.exe", "firefox.exe", "msedge.exe", "devenv.exe", "windbg.exe", "dotnet.exe", "powershell.exe", "svchost.exe", "csc.exe"]
// %ip_allowlist = ["127.0.0.1"]
