{
  "rule_id": "ad_shadow_credentials_added",
  "name": "Active Directory Shadow Credentials Added",
  "description": "Detects modifications to the 'msDS-KeyCredentialLink' attribute on user or computer objects. This activity can indicate an attacker adding 'Shadow Credentials' to gain persistent access to the target account.",
  "severity": "critical",
  "enabled": true,
  "language": "esql",
  "query": "from winlogbeat-* | where winlog.channel = 'Security' and winlog.event_id = '5136' and winlog.event_data.AttributeLDAPDisplayName = 'msDS-KeyCredentialLink' and winlog.event_data.ObjectClass IN ('user', 'computer') | keep host.name, winlog.event_data.SubjectUserName, winlog.event_data.ObjectName, winlog.event_data.ObjectClass, winlog.event_data.OperationType",
  "type": "esql",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0003",
        "name": "Persistence",
        "reference": "https://attack.mitre.org/tactics/TA0003/"
      },
      "technique": [
        {
          "id": "T1098",
          "name": "Account Manipulation",
          "reference": "https://attack.mitre.org/techniques/T1098/"
        },
        {
          "id": "T1098.005",
          "name": "Device Registration",
          "reference": "https://attack.mitre.org/techniques/T1098/005/"
        }
      ]
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0006",
        "name": "Credential Access",
        "reference": "https://attack.mitre.org/tactics/TA0006/"
      },
      "technique": [
        {
          "id": "T1003",
          "name": "OS Credential Dumping",
          "reference": "https://attack.mitre.org/techniques/T1003/"
        }
      ]
    }
  ],
  "interval": "10m",
  "from": "now-10m",
  "max_signals": 100,
  "risk_score": 95,
  "output_index": ".alerts-security.alerts-default",
  "meta": {},
  "version": 1,
  "references": [
    "https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab",
    "https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials"
  ],
  "tags": [
    "Active Directory",
    "Shadow Credentials",
    "Persistence",
    "Credential Access"
  ],
  "actions": [],
  "throttle": "no_throttle",
  "custom_query_fields": [],
  "event_group": "winlog.event_data.SubjectUserName, winlog.event_data.ObjectName, winlog.event_data.OperationType"
}
