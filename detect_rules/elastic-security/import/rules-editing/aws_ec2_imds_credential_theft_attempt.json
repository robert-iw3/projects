{
  "rule_id": "aws_ec2_imds_credential_theft_attempt",
  "name": "AWS EC2 Instance Metadata Credential Theft Attempt",
  "description": "Detects Server-Side Request Forgery (SSRF) attempts against the AWS EC2 Instance Metadata Service (IMDS) by monitoring processes attempting to access IAM security credentials. This indicates a potential compromise of the host to steal IAM role credentials.",
  "severity": "critical",
  "enabled": true,
  "language": "esql",
  "query": "from logs-endpoint.events-* | where event.category == 'process' and process.command_line LIKE '%169.254.169.254/latest/meta-data/iam/security-credentials%' and process.name != 'ecs-agent' and (container.id IS NOT NULL OR process.name != 'dockerd') | keep host.id, process.user.name, process.parent.name, process.name, process.command_line, container.id",
  "type": "esql",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0006",
        "name": "Credential Access",
        "reference": "https://attack.mitre.org/tactics/TA0006/"
      },
      "technique": [
        {
          "id": "T1557",
          "name": "Adversary-in-the-Middle",
          "reference": "https://attack.mitre.org/techniques/T1557/"
        }
      ]
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0008",
        "name": "Lateral Movement",
        "reference": "https://attack.mitre.org/tactics/TA0008/"
      },
      "technique": [
        {
          "id": "T1550",
          "name": "Use Alternate Authentication Material",
          "reference": "https://attack.mitre.org/techniques/T1550/"
        }
      ]
    }
  ],
  "interval": "5m",
  "from": "now-5m",
  "max_signals": 100,
  "risk_score": 90,
  "output_index": ".alerts-security.alerts-default",
  "meta": {},
  "version": 1,
  "references": [
    "https://hackingthe.cloud/aws/exploitation/ec2-metadata-ssrf/",
    "https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html"
  ],
  "tags": [
    "AWS",
    "EC2",
    "IMDS",
    "Credential Access"
  ],
  "actions": [],
  "throttle": "no_throttle",
  "custom_query_fields": [],
  "event_group": "host.id, process.user.name, process.name, process.command_line"
}
