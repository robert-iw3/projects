{
  "rule_id": "aws_suspicious_delegated_admin_activity",
  "name": "AWS Suspicious Delegated Administrator Activity",
  "description": "Detects the creation or enabling of delegated administrator accounts for sensitive AWS services via CloudTrail events. This can indicate an attacker attempting to establish persistence or elevate privileges by granting administrative permissions to a controlled account within the AWS Organization.",
  "severity": "high",
  "enabled": true,
  "language": "esql",
  "query": "from logs-aws.cloudtrail-* | where event.action in ('RegisterDelegatedAdministrator', 'EnableOrganizationAdminAccount') | eval delegated_service = COALESCE(aws.cloudtrail.requestParameters.servicePrincipal, event.provider), recipient_account_id = COALESCE(aws.cloudtrail.requestParameters.accountId, aws.cloudtrail.requestParameters.adminAccountId) | where delegated_service in ('sso.amazonaws.com', 'cloudformation.amazonaws.com', 'guardduty.amazonaws.com', 'securityhub.amazonaws.com', 'iam-access-analyzer.amazonaws.com', 'config.amazonaws.com')",
  "type": "esql",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0004",
        "name": "Privilege Escalation",
        "reference": "https://attack.mitre.org/tactics/TA0004/",
        "subtechniques": [
          {
            "id": "T1078.004",
            "name": "Valid Accounts: Cloud Accounts",
            "reference": "https://attack.mitre.org/techniques/T1078/004/"
          }
        ]
      }
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0003",
        "name": "Persistence",
        "reference": "https://attack.mitre.org/tactics/TA0003/",
        "subtechniques": [
          {
            "id": "T1078.004",
            "name": "Valid Accounts: Cloud Accounts",
            "reference": "https://attack.mitre.org/techniques/T1078/004/"
          }
        ]
      }
    }
  ],
  "interval": "10m",
  "from": "now-10m",
  "max_signals": 100,
  "risk_score": 80,
  "output_index": ".alerts-security.alerts-default",
  "meta": {},
  "version": 1,
  "references": [
    "https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-delegated-administrator.html"
  ],
  "tags": [
    "AWS",
    "CloudTrail",
    "Privilege Escalation",
    "Persistence"
  ],
  "actions": [],
  "throttle": "no_throttle",
  "custom_query_fields": [],
  "event_group": "aws.cloudtrail.userIdentity.arn, recipient_account_id"
}
