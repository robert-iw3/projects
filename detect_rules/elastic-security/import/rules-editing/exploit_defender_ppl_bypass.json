{
  "type": "detection-engine.rule",
  "id": "exploit-defender-ppl-bypass",
  "attributes": {
    "risk_score": 95,
    "enabled": true,
    "name": "Exploit Defender PPL Bypass Detection",
    "description": "Detects various indicators of compromise (IOCs) related to exploiting Windows Defender's Protected Process Light (PPL) capabilities, including suspicious process execution, service creation, and file modifications in Defender directories.",
    "rule_id": "exploit_defender_ppl_bypass_detection",
    "index": ["logs-winlogbeat.*"],
    "language": "kuery",
    "query": "(winlog.channel:\"Microsoft-Windows-Sysmon/Operational\") AND (winlog.event_id:(1 OR 11)) AND (((winlog.event_id:1 AND process.parent.executable:/\\*\\\\CreateProcessAsPPL.exe/ AND process.executable:/\\*\\\\clipup.exe/) OR (winlog.event_id:1 AND process.executable:/\\*\\\\System32\\\\clipup.exe/ AND process.command_line:/\\*-ppl*\\/ AND (process.command_line:/\\*\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*\\/ OR process.command_line:/\\*\\\\Program Files\\\\Windows Defender\\\\*\\/ OR process.command_line:/\\*\\\\Program Files (x86)\\\\Windows Defender\\\\*\\/ OR process.command_line:/\\*-ppl *PROGRA~*\\/ )) OR (winlog.event_id:1 AND process.executable:/\\*\\\\sc.exe/ AND process.command_line:/\\*create*\\/ AND process.command_line:/\\*start=auto*\\/ AND (process.command_line:/\\*binPath=*CreateProcessAsPPL.exe*\\/ OR process.command_line:/\\*binPath=*\\\\Users\\\\*\\/ OR process.command_line:/\\*binPath=*\\\\ProgramData\\\\*\\/ OR process.command_line:/\\*binPath=*\\\\Windows\\\\Temp\\\\*\\/ OR process.command_line:/\\*binPath=*\\\\Temp\\\\*\\/ OR process.command_line:/\\*binPath=.*(cmd|powershell|pwsh).exe*\\/ )) OR (winlog.event_id:11 AND (file.path:/C:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\*\\/ OR file.path:/C:\\\\Program Files\\\\Windows Defender\\\\*\\/ OR file.path:/C:\\\\Program Files (x86)\\\\Windows Defender\\\\*\\/ ) AND NOT process.executable:(\"*\\\\MsMpEng.exe\" OR \"*\\\\NisSrv.exe\" OR \"*\\\\MsMpEngCP.exe\" OR \"*\\\\MpCmdRun.exe\" OR \"*\\\\TiWorker.exe\" OR \"*\\\\TrustedInstaller.exe\" OR \"*\\\\svchost.exe\" OR \"*\\\\setup.exe\"))))",
    "interval": "5m",
    "severity": "critical",
    "type": "query",
    "version": "1"
  }
}
