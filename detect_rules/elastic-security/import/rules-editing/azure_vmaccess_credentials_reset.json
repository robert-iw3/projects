{
  "rule_id": "azure_vmaccess_credentials_reset",
  "name": "Azure VMAccess Extension Credentials Reset",
  "description": "Detects the use of the VMAccess extension to reset credentials (SSH key or password) on an Azure virtual machine. This could be indicative of a malicious actor maintaining persistence or escalating privileges on a compromised VM.",
  "severity": "critical",
  "enabled": true,
  "language": "esql",
  "query": "FROM logs-azure.activity-* | WHERE event.action == 'MICROSOFT.COMPUTE/VIRTUALMACHINES/EXTENSIONS/WRITE' AND event.outcome == 'Success' AND azure.resource_id LIKE '%/extensions/VMAccess%' AND azure.activity.request_body LIKE '%protectedSettings%' AND (azure.activity.request_body LIKE '%ssh_key%' OR azure.activity.request_body LIKE '%password%') | eval user = azure.caller.identity, src_ip = source.ip, subscription_id = azure.subscription_id, target_vm = REGEXP_EXTRACT(azure.resource_id, 'virtualMachines/([^/]+)'), target_user = JSON_EXTRACT(azure.activity.request_body, 'properties.protectedSettings.username'), action_type = CASE(azure.activity.request_body LIKE '%ssh_key%', 'SSH Key Reset/Update', azure.activity.request_body LIKE '%password%', 'Password Reset/User Create', TRUE, 'Unknown VMAccess Action') | WHERE action_type != 'Unknown VMAccess Action' AND user NOT LIKE '%admin@example.com%' AND user NOT LIKE '%automation-account-id%' | KEEP user, src_ip, subscription_id, target_vm, target_user, action_type",
  "type": "esql",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0003",
        "name": "Persistence",
        "reference": "https://attack.mitre.org/tactics/TA0003/"
      },
      "technique": [
        {
          "id": "T1098",
          "name": "Account Manipulation",
          "reference": "https://attack.mitre.org/techniques/T1098/"
        },
        {
          "id": "T1098.001",
          "name": "Additional Cloud Credentials",
          "reference": "https://attack.mitre.org/techniques/T1098/001/"
        }
      ]
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0004",
        "name": "Privilege Escalation",
        "reference": "https://attack.mitre.org/tactics/TA0004/"
      }
    }
  ],
  "interval": "10m",
  "from": "now-10m",
  "max_signals": 100,
  "risk_score": 90,
  "output_index": ".alerts-security.alerts-default",
  "meta": {},
  "version": 1,
  "references": [
    "https://docs.microsoft.com/en-us/azure/defender-for-cloud/alerts-azure-vm-extensions",
    "https://www.elastic.co/guide/en/security/current/azure-vm-credentials-reset.html"
  ],
  "tags": [
    "Azure",
    "Azure Activity Log",
    "Persistence",
    "Privilege Escalation",
    "VMAccess"
  ],
  "actions": [],
  "throttle": "no_throttle",
  "custom_query_fields": [],
  "event_group": "user, target_vm, action_type"
}
