{
  "type": "detection-engine.rule",
  "id": "koske-malware-linux-activity",
  "attributes": {
    "enabled": false,
    "author": ["RW"],
    "name": "Suspicious Linux Activity Associated with Koske Malware",
    "description": "This detection rule identifies multiple behaviors associated with the Koske malware on Linux systems. It combines several detection techniques into a single query, looking for polyglot file execution, persistence mechanism abuse, rootkit deployment, and suspicious C2 communications. An alert from this rule indicates one or more potentially malicious activities have occurred on a host and warrants investigation.",
    "rule_id": "koske_malware_linux_activity",
    "index": ["logs-endpoint.events.*"],
    "language": "esql",
    "query": "FROM logs-endpoint.events.*\nWHERE host.os.type = \"linux\" AND (\n  -- TTP 1: Process-based detection\n  (\n    process.name IN (\"grep\", \"egrep\") AND process.command_line LIKE \"*|*[sh,bash]\"\n    OR process.name = \"systemctl\" AND process.command_line LIKE \"*enable*.service\"\n    OR process.command_line LIKE \"*LD_PRELOAD=*\"\n    OR process.name IN (\"curl\", \"wget\")\n  )\n  -- TTP 2: File-based detection\n  OR (\n    event.action IN (\"file_creation\", \"file_modification\")\n    AND file.path IN (\"*/.bashrc\", \"/etc/crontab\", \"/etc/cron.d/*\", \"/etc/systemd/system/*.service\", \"/etc/ld.so.preload\")\n  )\n)\n-- Exclude benign activities\nAND NOT user.name IN (\"puppet\", \"ansible\")\nAND NOT process.parent.name IN (\"yum\", \"apt-get\")\n| EVAL detection_reason = CASE(\n    process.name IN (\"grep\", \"egrep\"), \"Polyglot Execution (grep | shell)\",\n    process.name = \"systemctl\", \"Persistence: Systemd Service Enabled\",\n    process.command_line LIKE \"*LD_PRELOAD=*\", \"Rootkit: LD_PRELOAD Env Var Used\",\n    process.name IN (\"curl\", \"wget\"), \"Suspicious C2 (curl/wget execution)\",\n    file.path = \"/etc/ld.so.preload\", \"Rootkit: ld.so.preload Modified\",\n    TRUE, \"Persistence: Common File Modified\"\n  )\n| EVAL event_detail = COALESCE(process.command_line, file.path)\n| STATS\n    triggered_reasons = ARRAY_AGG(detection_reason),\n    event_details = ARRAY_AGG(event_detail),\n    event_count = COUNT(*) BY @timestamp, host.name, user.name\n| RENAME @timestamp AS _time, host.name AS host",
    "interval": "30m",
    "severity": "high",
    "type": "esql",
    "version": "1"
  }
}
