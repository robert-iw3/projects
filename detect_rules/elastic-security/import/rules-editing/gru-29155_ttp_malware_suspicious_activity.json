{
  "rule_id": "multi_ttp_malware_suspicious_activity",
  "name": "GRU-29155 Multi-TTP Malware and Suspicious Activity Detection",
  "description": "Correlates various tactics, techniques, and procedures (TTPs) associated with malware and attacker tools. This rule covers process execution patterns (WhisperGate, Impacket, Rclone, GOST), file creation, and network/DNS activity (Unit 29155 C2s, Iodine, Ngrok).",
  "severity": "critical",
  "enabled": true,
  "language": "esql",
  "query": "FROM logs-endpoint.events.*,logs-network.* | WHERE (event.category == 'process' AND event.action == 'start' AND (process.name IN ('powershell.exe', 'pwsh.exe') AND process.command_line LIKE '% -enc UwB0AGEAcgB0AC0AUwBsAGUAZQBwACAALQBzACAAMQAwAA==%') OR (process.name IN ('powershell.exe', 'pwsh.exe') AND process.command_line LIKE '%Set-MpPreference*ExclusionPath*C:\\%') OR (process.name == 'AdvancedRun.exe' AND (process.command_line LIKE '%stop WinDefend%' OR process.command_line LIKE '%rmdir *C:\\ProgramData\\Microsoft\\Windows Defender%')) OR (process.name == 'InstallUtil.exe' AND (process.executable LIKE '%\\AppData\\Local\\Temp\\%' OR process.executable LIKE '%\\Windows\\Temp\\%')) OR (process.command_line LIKE '%secretsdump.py%' OR process.command_line LIKE '%psexec.py%') OR (process.name ILIKE 'rclone%' AND process.command_line LIKE '%mega%.nz%') OR (process.name == 'java.exe' AND (process.command_line LIKE '%-L*socks5://%' OR process.command_line LIKE '%-L*rtcp://%')) OR (process.command_line LIKE '%proxychains%') OR (process.command_line LIKE '%su-bruteforce%') OR (process.command_line LIKE '%linpeas.sh%' OR process.command_line LIKE '%linpeas.py%')) OR (event.category == 'file' AND event.action == 'creation' AND file.hash.md5 == '896e0f54fc67d72d94b40d7885f10c51') OR (event.category == 'network' AND (destination.ip IN ('5.226.139.66', '45.141.87.11', '46.101.242.222', '62.173.140.223', '79.124.8.66', '90.131.156.107', '112.51.253.153', '112.132.218.45', '154.21.20.82', '179.43.133.202', '179.43.142.42', '179.43.162.55', '179.43.175.38', '179.43.175.108', '179.43.176.60', '179.43.187.47', '179.43.189.218', '185.245.84.227', '185.245.85.251', '194.26.29.84', '194.26.29.95', '194.26.29.98', '194.26.29.251')) OR (destination.domain IN ('interlinks.top', '3proxy.ru', 'nssm.cc')) OR (destination.domain LIKE '%cdn.discordapp.com' AND url.full LIKE '%/attachments/%') OR (destination.domain LIKE '%ngrok.com')) OR (event.category == 'dns' AND dns.question.name == 'dns.test658324901domain.me')",
  "type": "esql",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0005",
        "name": "Defense Evasion",
        "reference": "https://attack.mitre.org/tactics/TA0005/"
      }
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0002",
        "name": "Execution",
        "reference": "https://attack.mitre.org/tactics/TA0002/"
      }
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0011",
        "name": "Command and Control",
        "reference": "https://attack.mitre.org/tactics/TA0011/"
      }
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0010",
        "name": "Exfiltration",
        "reference": "https://attack.mitre.org/tactics/TA0010/"
      }
    }
  ],
  "interval": "5m",
  "from": "now-5m",
  "max_signals": 100,
  "risk_score": 95,
  "output_index": ".alerts-security.alerts-default",
  "meta": {},
  "version": 1,
  "references": [
    "https://www.microsoft.com/en-us/security/blog/2022/01/15/destructive-malware-targeting-ukraine-government-agencies-detected/",
    "https://securelist.com/unit-29155-targeting-governments/106963/",
    "https://rclone.org/"
  ],
  "tags": [
    "Malware",
    "WhisperGate",
    "Impacket",
    "Rclone",
    "APT",
    "Defense Evasion",
    "C2"
  ],
  "actions": [],
  "throttle": "no_throttle",
  "custom_query_fields": [],
  "event_group": "host.name, user.name, process.name"
}
