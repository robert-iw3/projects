{
  "rule_id": "powershell_amsi_bypass_attempt",
  "name": "PowerShell AMSI Bypass Attempt",
  "description": "Detects attempts to bypass the Antimalware Scan Interface (AMSI) via PowerShell by looking for common API functions and DLLs associated with memory patching. This technique is often used by attackers to evade security products.",
  "severity": "critical",
  "enabled": true,
  "language": "esql",
  "query": "FROM * | WHERE @timestamp IS NOT NULL AND event.action == 'PowerShellScriptBlock' AND powershell.script_block.text IS NOT NULL AND powershell.script_block.text LIKE '%VirtualProtect%' AND powershell.script_block.text LIKE '%GetProcAddress%' AND powershell.script_block.text LIKE '%InteropServices%' AND powershell.script_block.text LIKE '%AmsiScanBuffer%' AND (powershell.script_block.text LIKE '%amsi.dll%' OR powershell.script_block.text LIKE '%clr.dll%') | KEEP host.name, user.name, process.parent.name, process.parent.command_line, powershell.script_block.text",
  "type": "esql",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0005",
        "name": "Defense Evasion",
        "reference": "https://attack.mitre.org/tactics/TA0005/"
      },
      "technique": [
        {
          "id": "T1562",
          "name": "Impair Defenses",
          "reference": "https://attack.mitre.org/techniques/T1562/"
        },
        {
          "id": "T1562.001",
          "name": "Disable or Modify Tools",
          "reference": "https://attack.mitre.org/techniques/T1562/001/"
        }
      ]
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0002",
        "name": "Execution",
        "reference": "https://attack.mitre.org/tactics/TA0002/"
      },
      "technique": [
        {
          "id": "T1059",
          "name": "Command and Scripting Interpreter",
          "reference": "https://attack.mitre.org/techniques/T1059/"
        },
        {
          "id": "T1059.001",
          "name": "PowerShell",
          "reference": "https://attack.mitre.org/techniques/T1059/001/"
        }
      ]
    }
  ],
  "interval": "5m",
  "from": "now-5m",
  "max_signals": 100,
  "risk_score": 90,
  "output_index": ".alerts-security.alerts-default",
  "meta": {},
  "version": 1,
  "references": [
    "https://www.elastic.co/guide/en/security/8.13/potential-antimalware-scan-interface-bypass-via-powershell.html",
    "https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/"
  ],
  "tags": [
    "Powershell",
    "AMSI Bypass",
    "Defense Evasion"
  ],
  "actions": [],
  "throttle": "no_throttle",
  "custom_query_fields": [],
  "event_group": "host.name, user.name, powershell.script_block.text"
}
