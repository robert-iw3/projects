{
  "rule_id": "suspicious_powershell_obfuscation",
  "name": "Suspicious PowerShell Obfuscation",
  "description": "Detects obfuscated PowerShell command lines, including long, encoded commands and complex string manipulation combined with Invoke-Expression. This technique is often used by adversaries to hide malicious activity and evade security controls.",
  "severity": "high",
  "enabled": true,
  "language": "esql",
  "query": "FROM * | WHERE @timestamp IS NOT NULL AND process.name IN (\"powershell.exe\", \"pwsh.exe\") AND (((process.command_line LIKE \"% -encodedcommand %\" OR process.command_line LIKE \"% -ec %\" OR process.command_line LIKE \"% -enc %\" OR process.command_line LIKE \"% -en %\" OR process.command_line LIKE \"% -e %\") AND LENGTH(process.command_line) > 200) OR ((process.command_line LIKE \"%iex%\" OR process.command_line LIKE \"%invoke-expression%\") AND (process.command_line LIKE \"%+%\" OR process.command_line LIKE \"% -join %\" OR process.command_line LIKE \"%[char]%\" OR process.command_line LIKE \"%frombase64string%\" OR LENGTH(process.command_line) > 1024)) OR (LENGTH(process.command_line) > 400 AND (process.command_line LIKE \"% -join %\" OR process.command_line LIKE \"% -replace %\" OR process.command_line LIKE \"% -split %\")))",
  "type": "esql",
  "threat": [
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0005",
        "name": "Defense Evasion",
        "reference": "https://attack.mitre.org/tactics/TA0005/"
      },
      "technique": [
        {
          "id": "T1027",
          "name": "Obfuscated Files or Information",
          "reference": "https://attack.mitre.org/techniques/T1027/"
        }
      ]
    },
    {
      "framework": "MITRE ATT&CK",
      "tactic": {
        "id": "TA0002",
        "name": "Execution",
        "reference": "https://attack.mitre.org/tactics/TA0002/"
      },
      "technique": [
        {
          "id": "T1059",
          "name": "Command and Scripting Interpreter",
          "reference": "https://attack.mitre.org/techniques/T1059/"
        },
        {
          "id": "T1059.001",
          "name": "PowerShell",
          "reference": "https://attack.mitre.org/techniques/T1059/001/"
        }
      ]
    }
  ],
  "interval": "5m",
  "from": "now-5m",
  "max_signals": 100,
  "risk_score": 70,
  "output_index": ".alerts-security.alerts-default",
  "meta": {},
  "version": 1,
  "references": [
    "https://www.elastic.co/guide/en/security/current/potential-powershell-obfuscation-via-special-character-overuse.html",
    "https://www.elastic.co/guide/en/security/current/suspicious-powershell-script.html"
  ],
  "tags": [
    "Powershell",
    "Obfuscation",
    "Defense Evasion"
  ],
  "actions": [],
  "throttle": "no_throttle",
  "custom_query_fields": [],
  "event_group": "host.name, user.name, process.name"
}
