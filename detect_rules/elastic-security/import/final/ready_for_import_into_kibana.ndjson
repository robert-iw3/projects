{"rule_id":"create_computer_account_by_non_admin","name":"New Computer Account Created by Non-Admin","description":"Detects the creation of new computer accounts (Event ID 4741) by users who are not on a designated admin user list.","severity":"medium","enabled":true,"language":"kuery","query":"event.module:\"windows\" and winlog.event_id:4741 and not winlog.event_data.SubjectUserName:/.*\\$$/","type":"query","threat":[],"timestamp_override":"@timestamp","index":["logs-endpoint.events.*","logs-windows.events.*"],"author":["RW"],"false_positives":["Known administrative tasks."],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":50,"output_index":".siem-signals-default","meta":{},"version":1,"references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4741"],"tags":["Active Directory","Account Creation"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"admin_users_exemption","_comment":"Execute ../aux_rule_files/create_admin_users_exemption_list.sh to create the list","description":"Exempts known administrative user accounts from triggering the rule.","conditions":[{"field":"winlog.event_data.SubjectUserName","operator":"included","type":"list","list_id":"admin_users"}],"enabled":true}],"custom_query_fields":[],"event_group":"winlog.event_data.SubjectUserName"}
{"rule_id":"ad_shadow_credentials_added","name":"Active Directory Shadow Credentials Added","description":"Detects modifications to the 'msDS-KeyCredentialLink' attribute on user or computer objects. This activity can indicate an attacker adding 'Shadow Credentials' to gain persistent access to the target account.","severity":"critical","enabled":true,"language":"esql","query":"from winlogbeat-* | where winlog.channel = 'Security' and winlog.event_id = '5136' and winlog.event_data.AttributeLDAPDisplayName = 'msDS-KeyCredentialLink' and winlog.event_data.ObjectClass IN ('user', 'computer') | keep host.name, winlog.event_data.SubjectUserName, winlog.event_data.ObjectName, winlog.event_data.ObjectClass, winlog.event_data.OperationType","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1098","name":"Account Manipulation","reference":"https://attack.mitre.org/techniques/T1098/"},{"id":"T1098.005","name":"Device Registration","reference":"https://attack.mitre.org/techniques/T1098/005/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1003","name":"OS Credential Dumping","reference":"https://attack.mitre.org/techniques/T1003/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab","https://www.thehacker.recipes/ad/movement/kerberos/shadow-credentials"],"tags":["Active Directory","Shadow Credentials","Persistence","Credential Access"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"winlog.event_data.SubjectUserName, winlog.event_data.ObjectName, winlog.event_data.OperationType"}
{"rule_id":"adcs_cert_template_name_flag_modified","name":"AD CS Certificate Template Modified to Allow Subject Name Supply","description":"Detects modifications to the 'msPKI-Certificate-Name-Flag' attribute of a certificate template, where it is configured to allow the enrollee to supply the subject name. This change can be exploited for privilege escalation via Active Directory Certificate Services (AD CS).","severity":"critical","enabled":true,"language":"esql","query":"from winlogbeat-* | where winlog.channel = 'Security' and winlog.event_id = '5136' and winlog.event_data.ObjectClass = 'pKICertificateTemplate' and winlog.event_data.AttributeLDAPDisplayName = 'msPKI-Certificate-Name-Flag' and winlog.event_data.Attributevalue = '1' | keep host.name, winlog.event_data.SubjectUserName, winlog.event_data.ObjectName, winlog.event_data.AttributeLDAPDisplayName, winlog.event_data.Attributevalue","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"},"technique":[{"id":"T1649","name":"Credentials in Registry","reference":"https://attack.mitre.org/techniques/T1649/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1003","name":"OS Credential Dumping","reference":"https://attack.mitre.org/techniques/T1003/"}]}],"interval":"1h","from":"now-1h","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf","https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-one/"],"tags":["Active Directory","AD CS","Privilege Escalation","ESC1"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"winlog.event_data.SubjectUserName, winlog.event_data.ObjectName"}
{"rule_id":"adcs_editflags_modification","name":"AD CS EditFlags Registry Key Modified","description":"Detects changes to the 'EditFlags' registry key in the Certificate Services configuration via Sysmon Event ID 13. This modification can indicate an attempt to abuse Active Directory Certificate Services (AD CS) misconfigurations, as seen in ESC8 attacks.","severity":"critical","enabled":true,"language":"esql","query":"from logs-endpoint.events-* | where event.module = 'sysmon' and event.code = '13' and winlog.event_data.TargetObject RLIKE '.*\\\\SYSTEM\\\\CurrentControlSet\\\\Services\\\\CertSvc\\\\Configuration\\\\.*\\\\PolicyModules\\\\CertificateAuthority_MicrosoftDefault.Policy\\\\EditFlags' | eval ca_name = REGEXP_EXTRACT(winlog.event_data.TargetObject, 'Configuration\\\\([^\\\\]+)\\\\PolicyModules') | keep host.name, user.name, process.name, ca_name, winlog.event_data.TargetObject, winlog.event_data.Details","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"},"technique":[{"id":"T1649","name":"Credentials in Registry","reference":"https://attack.mitre.org/techniques/T1649/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1546","name":"Event Triggered Execution","reference":"https://attack.mitre.org/techniques/T1546/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.rbtsec.com/blog/active-directory-certificate-attack-esc8-adcs-web-enrollment/","https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf"],"tags":["AD CS","Registry","Sysmon","Privilege Escalation","ESC8"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, process.name"}
{"rule_id":"adcs_ntlm_relay_detection","name":"NTLM Relay From AD CS Server Detected","description":"Detects successful NTLM authentication requests (Event ID 4776) originating from an AD CS server for a machine account that does not match the source workstation name. This behavior can be indicative of an NTLM relay attack.","severity":"critical","enabled":true,"language":"esql","query":"from winlogbeat-* | where winlog.channel = 'Security' and winlog.event_id = '4776' and winlog.event_data.Status = '0x0' and winlog.event_data.AccountName RLIKE '.*\\\\$$' | eval adcs_machine_account = UPPER(winlog.event_data.SourceWorkstation) + '$' | where UPPER(winlog.event_data.AccountName) != adcs_machine_account | STATS count = COUNT(*) BY host.name, winlog.event_data.AccountName, winlog.event_data.SourceWorkstation, source.ip | keep host.name, winlog.event_data.AccountName, winlog.event_data.SourceWorkstation, source.ip, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1557","name":"Adversary-in-the-Middle","reference":"https://attack.mitre.org/techniques/T1557/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1003","name":"OS Credential Dumping","reference":"https://attack.mitre.org/techniques/T1003/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.specterops.io/assets/resources/Certified_Pre-Owned.pdf"],"tags":["Active Directory","NTLM Relay","AD CS","Credential Access"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"adcs_servers_exemption","description":"Filters NTLM relay activity to only include requests originating from AD CS servers.","conditions":[{"field":"source.ip","operator":"included","type":"list","list_id":"adcs_servers"}],"enabled":true}],"custom_query_fields":[],"event_group":"winlog.event_data.AccountName, winlog.event_data.SourceWorkstation, source.ip"}
{"rule_id":"adcs_san_mismatch_detection","name":"AD CS SAN Mismatch Detection","description":"Detects Active Directory certificate enrollment attempts where the Subject Alternative Name (SAN) UPN does not match the user making the request. This can indicate a privilege escalation attempt via Active Directory Certificate Services (AD CS) abuse.","severity":"critical","enabled":true,"language":"esql","query":"from winlogbeat-* | where winlog.channel = 'Security' and winlog.event_id = '4886' and winlog.event_data.CertificateAttributes RLIKE '.*san:.*' | eval san_upn = REGEXP_EXTRACT(winlog.event_data.CertificateAttributes, 'san:.*?upn=([^&\\s]+)'), requester_principal = LOWER(REPLACE(winlog.event_data.RequesterName, '^.*\\\\', '')), requester_principal = SPLIT(requester_principal, '@')[0], san_principal = LOWER(SPLIT(san_upn, '@')[0]) | where san_upn IS NOT NULL and requester_principal != san_principal | keep host.name, winlog.event_data.RequesterName, san_upn, winlog.event_data.CertificateTemplate, requester_principal, san_principal","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"},"technique":[{"id":"T1649","name":"Credentials in Registry","reference":"https://attack.mitre.org/techniques/T1649/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1003","name":"OS Credential Dumping","reference":"https://attack.mitre.org/techniques/T1003/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.crowdstrike.com/wp-content/uploads/2023/12/investigating-active-directory-certificate-abuse.pdf","https://www.blackhillsinfosec.com/abusing-active-directory-certificate-services-part-one/"],"tags":["Active Directory","AD CS","Privilege Escalation"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"requester_principal, san_principal, host.name"}
{"rule_id":"aws_ec2_imds_credential_theft_attempt","name":"AWS EC2 Instance Metadata Credential Theft Attempt","description":"Detects Server-Side Request Forgery (SSRF) attempts against the AWS EC2 Instance Metadata Service (IMDS) by monitoring processes attempting to access IAM security credentials. This indicates a potential compromise of the host to steal IAM role credentials.","severity":"critical","enabled":true,"language":"esql","query":"from logs-endpoint.events-* | where event.category == 'process' and process.command_line LIKE '%169.254.169.254/latest/meta-data/iam/security-credentials%' and process.name != 'ecs-agent' and (container.id IS NOT NULL OR process.name != 'dockerd') | keep host.id, process.user.name, process.parent.name, process.name, process.command_line, container.id","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1557","name":"Adversary-in-the-Middle","reference":"https://attack.mitre.org/techniques/T1557/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1550","name":"Use Alternate Authentication Material","reference":"https://attack.mitre.org/techniques/T1550/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://hackingthe.cloud/aws/exploitation/ec2-metadata-ssrf/","https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html"],"tags":["AWS","EC2","IMDS","Credential Access"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.id, process.user.name, process.name, process.command_line"}
{"rule_id":"aws_multiple_ecs_instance_registrations","name":"AWS Multiple ECS Container Instance Registrations From Same Source","description":"Detects a surge in ECS container instance registration activity from a single IP address. This could indicate a misconfigured script or a malicious actor launching multiple instances for persistence or resource abuse.","severity":"medium","enabled":true,"language":"esql","query":"from logs-aws.cloudtrail-* | where event.action == 'RegisterContainerInstance' | stats count = COUNT(*), distinct_user_agents = COUNT(DISTINCT user_agent.original), user_agents = ARRAY_AGG(user_agent.original) BY DATE_TRUNC('day', @timestamp), source.ip, aws.cloudtrail.userIdentity.arn, aws.cloudtrail.awsRegion | where count > 1 | keep source.ip, aws.cloudtrail.userIdentity.arn, aws.cloudtrail.awsRegion, count, distinct_user_agents, user_agents","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1543.003","name":"Windows Service","reference":"https://attack.mitre.org/techniques/T1543/003/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/"}]}],"interval":"24h","from":"now-24h","max_signals":100,"risk_score":50,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":[],"tags":["AWS","CloudTrail","ECS"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"source.ip, aws.cloudtrail.userIdentity.arn"}
{"rule_id":"aws_policy_grants_delegated_admin_permission","name":"AWS Policy Grants organizations:RegisterDelegatedAdministrator","description":"Detects the creation or modification of IAM policies that grant the 'organizations:RegisterDelegatedAdministrator' permission. This could be an attacker attempting to establish persistence or elevate privileges within the AWS Organization by delegating administrative authority.","severity":"critical","enabled":true,"language":"esql","query":"from logs-aws.cloudtrail-* | where event.action in ('CreatePolicy', 'CreatePolicyVersion', 'PutUserPolicy', 'PutRolePolicy', 'PutGroupPolicy') and aws.cloudtrail.requestParameters.policyDocument like '%organizations:RegisterDelegatedAdministrator%' and aws.cloudtrail.requestParameters.policyDocument like '%\"Resource\":\"*\"%' and aws.cloudtrail.requestParameters.policyDocument like '%\"Effect\":\"Allow\"%' | eval target_name = COALESCE(aws.cloudtrail.requestParameters.policyName, aws.cloudtrail.requestParameters.userName, aws.cloudtrail.requestParameters.roleName, aws.cloudtrail.requestParameters.groupName) | keep event.action, aws.cloudtrail.aws_account_id, aws.cloudtrail.userIdentity.arn, source.ip, target_name","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"},"technique":[{"id":"T1078.004","name":"Valid Accounts:Cloud Accounts","reference":"https://attack.mitre.org/techniques/T1078/004/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1078.004","name":"Valid Accounts:Cloud Accounts","reference":"https://attack.mitre.org/techniques/T1078/004/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.aws.amazon.com/organizations/latest/userguide/orgs_delegate_admin.html"],"tags":["AWS","CloudTrail","IAM","Privilege Escalation","Persistence"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"aws.cloudtrail.userIdentity.arn, target_name, event.action"}
{"rule_id":"aws_suspicious_delegated_admin_activity","name":"AWS Suspicious Delegated Administrator Activity","description":"Detects the creation or enabling of delegated administrator accounts for sensitive AWS services via CloudTrail events. This can indicate an attacker attempting to establish persistence or elevate privileges by granting administrative permissions to a controlled account within the AWS Organization.","severity":"high","enabled":true,"language":"esql","query":"from logs-aws.cloudtrail-* | where event.action in ('RegisterDelegatedAdministrator', 'EnableOrganizationAdminAccount') | eval delegated_service = COALESCE(aws.cloudtrail.requestParameters.servicePrincipal, event.provider), recipient_account_id = COALESCE(aws.cloudtrail.requestParameters.accountId, aws.cloudtrail.requestParameters.adminAccountId) | where delegated_service in ('sso.amazonaws.com', 'cloudformation.amazonaws.com', 'guardduty.amazonaws.com', 'securityhub.amazonaws.com', 'iam-access-analyzer.amazonaws.com', 'config.amazonaws.com')","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/","subtechniques":[{"id":"T1078.004","name":"Valid Accounts:Cloud Accounts","reference":"https://attack.mitre.org/techniques/T1078/004/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/","subtechniques":[{"id":"T1078.004","name":"Valid Accounts:Cloud Accounts","reference":"https://attack.mitre.org/techniques/T1078/004/"}]}}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":80,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-delegated-administrator.html"],"tags":["AWS","CloudTrail","Privilege Escalation","Persistence"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"aws.cloudtrail.userIdentity.arn, recipient_account_id"}
{"rule_id":"aws_suspicious_ssh_key_injection","name":"AWS Suspicious SSH Key Injection","description":"Detects the injection of SSH public keys into EC2 instances via SendSSHPublicKey or SendSerialConsoleSSHPublicKey from unknown or non-trusted roles. This can be used by an attacker to gain backdoor access to instances.","severity":"critical","enabled":true,"language":"esql","query":"from logs-aws.cloudtrail-* | where event.action in ('SendSSHPublicKey', 'SendSerialConsoleSSHPublicKey') and error.code is null and source.ip != '10.0.0.0/8' and not (aws.cloudtrail.user_identity.arn like '%arn:aws:iam::123456789012:role/known-admin-role%') | stats count = COUNT(*), dest_instance_id = ARRAY_AGG(aws.cloudtrail.request_parameters.instanceId), dest_os_user = ARRAY_AGG(aws.cloudtrail.request_parameters.instanceOSUser) BY @timestamp, event.action, aws.cloudtrail.aws_region, source.ip, aws.cloudtrail.user_identity.arn | keep @timestamp, aws.cloudtrail.user_identity.arn, source.ip, aws.cloudtrail.aws_region, event.action, dest_instance_id, dest_os_user, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1098","name":"Account Manipulation","reference":"https://attack.mitre.org/techniques/T1098/"},{"id":"T1098.001","name":"Additional Cloud Credentials","reference":"https://attack.mitre.org/techniques/T1098/001/"}]},{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"},{"id":"T1021.004","name":"SSH","reference":"https://attack.mitre.org/techniques/T1021/004/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.aws.amazon.com/ec2-instance-connect/latest/APIReference/API_SendSSHPublicKey.html","https://stratus-red-team.cloud/attack-techniques/AWS/aws.lateral-movement.ec2-instance-connect/"],"tags":["AWS","CloudTrail","EC2","SSH","Persistence"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"known_admin_roles_exemption","description":"Exempts known administrative roles from the SSH key injection rule.","conditions":[{"field":"aws.cloudtrail.userIdentity.arn","operator":"included","type":"list","list_id":"known_admin_roles"}],"enabled":true}],"custom_query_fields":[],"event_group":"aws.cloudtrail.user_identity.arn, event.action, source.ip"}
{"rule_id":"aws_suspicious_ssm_sendcommand_activity","name":"AWS Suspicious SSM SendCommand Activity (Mass Execution)","description":"Detects the execution of SSM commands ('AWS-RunShellScript' or 'AWS-RunPowerShellScript') on a large number of instances from an unknown user or source IP. This may indicate an attacker using a compromised role for lateral movement or large-scale attack execution.","severity":"critical","enabled":true,"language":"esql","query":"from logs-aws.cloudtrail-* | where event.provider == 'ssm.amazonaws.com' and event.action == 'SendCommand' and error.code is null and aws.cloudtrail.request_parameters.documentName in ('AWS-RunShellScript', 'AWS-RunPowerShellScript') | keep aws.cloudtrail.user_identity.arn, source.ip, aws.cloudtrail.aws_region, aws.cloudtrail.request_parameters.documentName, aws.cloudtrail.request_parameters.instanceIds, aws.cloudtrail.request_parameters.parameters.commands | stats target_instance_count = COUNT(aws.cloudtrail.request_parameters.instanceIds), target_instance_ids = ARRAY_AGG(aws.cloudtrail.request_parameters.instanceIds), commands_executed = ARRAY_AGG(aws.cloudtrail.request_parameters.parameters.commands) BY @timestamp, aws.cloudtrail.user_identity.arn, source.ip, aws.cloudtrail.aws_region, aws.cloudtrail.request_parameters.documentName | where target_instance_count > 5","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"}, {"id":"T1021.006","name":"System Management","reference":"https://attack.mitre.org/techniques/T1021/006/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.aws.amazon.com/systems-manager/latest/userguide/ssm-agent-command-execution.html"],"tags":["AWS","CloudTrail","SSM","Lateral Movement","Execution"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"known_ssm_users_exemption","description":"Exempts known administrative roles and trusted IPs from SSM command detection.","conditions":[{"field":"aws.cloudtrail.userIdentity.arn","operator":"included","type":"list","list_id":"known_ssm_users"}, {"field":"source.ip","operator":"included","type":"list","list_id":"known_ssm_users"}],"enabled":true}],"custom_query_fields":[],"event_group":"aws.cloudtrail.user_identity.arn, source.ip"}
{"rule_id":"aws_suspicious_ssm_startsession_activity","name":"AWS Suspicious SSM StartSession Activity","description":"Detects the initiation of an SSM session to an EC2 instance by an unknown user or from an untrusted source IP address. This can indicate an attacker using compromised credentials for backdoor access or lateral movement.","severity":"critical","enabled":true,"language":"esql","query":"from logs-aws.cloudtrail-* | where event.provider == 'ssm.amazonaws.com' and event.action == 'StartSession' and error.code is null | keep aws.cloudtrail.user_identity.arn, source.ip, aws.cloudtrail.request_parameters.target, aws.cloudtrail.aws_region","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"}, {"id":"T1021.006","name":"System Management","reference":"https://attack.mitre.org/techniques/T1021/006/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"}}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.aws.amazon.com/systems-manager/latest/userguide/session-manager.html","https://stratus-red-team.cloud/attack-techniques/AWS/aws.execution.ssm-start-session/"],"tags":["AWS","CloudTrail","SSM","Lateral Movement","Persistence"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"known_ssm_users_exemption","description":"Exempts known administrative roles and trusted IPs from SSM session detection.","conditions":[{"field":"aws.cloudtrail.user_identity.arn","operator":"included","type":"list","list_id":"known_ssm_users"}, {"field":"source.ip","operator":"included","type":"list","list_id":"known_ssm_users"}],"enabled":true}],"custom_query_fields":[],"event_group":"aws.cloudtrail.user_identity.arn, source.ip, aws.cloudtrail.request_parameters.target"}
{"rule_id":"azure_vmaccess_credentials_reset","name":"Azure VMAccess Extension Credentials Reset","description":"Detects the use of the VMAccess extension to reset credentials (SSH key or password) on an Azure virtual machine. This could be indicative of a malicious actor maintaining persistence or escalating privileges on a compromised VM.","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-azure.activity-* | WHERE event.action == 'MICROSOFT.COMPUTE/VIRTUALMACHINES/EXTENSIONS/WRITE' AND event.outcome == 'Success' AND azure.resource_id LIKE '%/extensions/VMAccess%' AND azure.activity.request_body LIKE '%protectedSettings%' AND (azure.activity.request_body LIKE '%ssh_key%' OR azure.activity.request_body LIKE '%password%') | eval user = azure.caller.identity, src_ip = source.ip, subscription_id = azure.subscription_id, target_vm = REGEXP_EXTRACT(azure.resource_id, 'virtualMachines/([^/]+)'), target_user = JSON_EXTRACT(azure.activity.request_body, 'properties.protectedSettings.username'), action_type = CASE(azure.activity.request_body LIKE '%ssh_key%', 'SSH Key Reset/Update', azure.activity.request_body LIKE '%password%', 'Password Reset/User Create', TRUE, 'Unknown VMAccess Action') | WHERE action_type != 'Unknown VMAccess Action' AND user NOT LIKE '%admin@example.com%' AND user NOT LIKE '%automation-account-id%' | KEEP user, src_ip, subscription_id, target_vm, target_user, action_type","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1098","name":"Account Manipulation","reference":"https://attack.mitre.org/techniques/T1098/"}, {"id":"T1098.001","name":"Additional Cloud Credentials","reference":"https://attack.mitre.org/techniques/T1098/001/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"}}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.microsoft.com/en-us/azure/defender-for-cloud/alerts-azure-vm-extensions","https://www.elastic.co/guide/en/security/current/azure-vm-credentials-reset.html"],"tags":["Azure","Azure Activity Log","Persistence","Privilege Escalation","VMAccess"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"user, target_vm, action_type"}
{"rule_id":"azure_web_vuln_ioc_detection","name":"Azure, Web, and Vulnerability IOC/TTP Detection","description":"Detects suspicious activity in Azure (Entra Connect, App/SP creation), potential cloud data exfiltration, web shell execution, and known vulnerabilities (e.g., CVEs). The rule identifies tactics such as Valid Accounts and Impact, covering multiple cloud and web-based threat vectors.","severity":"medium","enabled":true,"language":"kuery","query":"(/* Anomalous Entra Connect Activity */ ((user.name:/\\*AAD_\\*\\/ OR user.name:/\\*MSOL_\\*\\/) AND event.category:\"signin\") OR (event.action:\"Reset user password\" AND event.outcome:\"success\" AND (event.initiated_by.user.userPrincipalName:/\\*AAD_\\*\\/ OR event.initiated_by.user.userPrincipalName:/\\*MSOL_\\*\\/))) OR /* Suspicious App/Service Principal creation */ (event.category:\"ApplicationManagement\" AND (event.action:\"Add service principal\" OR event.action:\"Add OAuth2 permission grant\" OR event.action:\"Add owner to service principal\" OR event.action:\"Update application - Certificates and secrets management\")) OR /* Potential Cloud Data Exfiltration */ (event.action:(\"MailItemsAccessed\" OR \"FileDownloaded\")) OR /* Web Shell execution */ (winlog.event_id:1 AND process.parent.name:(\"*\\\\w3wp.exe\" OR \"*\\\\httpd.exe\" OR \"*\\\\nginx.exe\" OR \"*\\\\tomcat*.exe\") AND process.name:(\"*\\\\cmd.exe\" OR \"*\\\\powershell.exe\" OR \"*\\\\pwsh.exe\" OR \"*\\\\sh\" OR \"*\\\\bash\")) OR /* Known Vulnerabilities */ (vulnerability.id:(\"CVE-2025-0282\" OR \"CVE-2024-3400\" OR \"CVE-2023-3519\" OR \"CVE-2021-26855\" OR \"CVE-2021-26857\" OR \"CVE-2021-26858\" OR \"CVE-2021-27065\"))","type":"query","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"},"technique":[{"id":"T1078.004","name":"Valid Accounts:Cloud Accounts","reference":"https://attack.mitre.org/techniques/T1078/004/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1078.004","name":"Valid Accounts:Cloud Accounts","reference":"https://attack.mitre.org/techniques/T1078/004/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0040","name":"Impact","reference":"https://attack.mitre.org/tactics/TA0040/"},"technique":[{"id":"T1499","name":"Endpoint Denial of Service","reference":"https://attack.mitre.org/techniques/T1499/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":70,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.microsoft.com/en-us/azure/active-directory/hybrid/concept-aad-connect-sync-account","https://attack.mitre.org/techniques/T1078/004/","https://docs.microsoft.com/en-us/office365/securityandcompliance/search-the-audit-log-in-the-compliance-center"],"tags":["Azure","Microsoft 365","Cloud Security","Web Shell","Vulnerability Scan","Data Exfiltration","Threat Detection"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"user.name, process.name, vulnerability.id"}
{"rule_id":"credential_brute_force_followed_by_success","name":"Credential Brute Force Followed by Success","description":"Detects credential brute force or credential stuffing attacks by monitoring for a high number of failed authentication attempts followed by a successful login for the same user within a 15-minute time window.","severity":"critical","enabled":true,"language":"esql","query":"from * | where event.category == 'authentication' and event.type in ('authentication_success', 'authentication_failure') and user.name IS not NULL and user.name != '-' and user.name != 'unknown' | eval action = CASE(event.outcome == 'success', 'success', event.outcome == 'failure', 'failure', NULL) | stats failure_count = SUM(CASE(action == 'failure', 1, 0)), success_count = SUM(CASE(action == 'success', 1, 0)), src = ARRAY_AGG(source.ip), app = ARRAY_AGG(process.name) by user.name | where failure_count > 10 and success_count > 0 | keep user.name, failure_count, success_count, src, app","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1110","name":"Brute Force","reference":"https://attack.mitre.org/techniques/T1110/"}]}],"interval":"15m","from":"now-15m","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://detection.fyi/elastic/detection-rules/windows/credential_access_bruteforce_multiple_logon_failure_followed_by_success/","https://www.elastic.co/blog/getting-started-elasticsearch-query-language"],"tags":["Authentication","Brute Force","Credential Stuffing"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"user.name"}
{"rule_id":"dcsync_attack_detection","name":"DCSync Attack Attempt","description":"Detects attempts to perform a DCSync attack by monitoring for Active Directory replication properties being accessed (Event ID 4662) from non-domain controller systems.","severity":"critical","enabled":true,"language":"esql","query":"from winlogbeat-* | where winlog.channel == 'Security' and winlog.event_id == '4662' and winlog.event_data.Properties RLIKE '(?i).*(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2|1131f6aa-9c07-11d1-f79f-00c04fc2dcd2|9923a32a-3607-11d2-b9be-0000f87a36b2).*' and NOT (winlog.event_data.SubjectUserName IN ('DWM-1', 'UMFD-1') OR winlog.event_data.SubjectUserName RLIKE '.*\\\\$$') | stats count() by host.name, winlog.event_data.SubjectUserName, source.ip, winlog.event_data.ObjectName | keep host.name, winlog.event_data.SubjectUserName, source.ip, winlog.event_data.ObjectName, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1003","name":"OS Credential Dumping","reference":"https://attack.mitre.org/techniques/T1003/"}, {"id":"T1003.006","name":"DCSync","reference":"https://attack.mitre.org/techniques/T1003/006/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":99,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://adsecurity.org/?p=1729"],"tags":["Active Directory","Credential Access","DCSync"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"dc_replication_exemption","description":"Exempts domain controller IP addresses from the rule.","conditions":[{"field":"source.ip","operator":"included","type":"list","list_id":"domain_controllers"}],"enabled":true}],"custom_query_fields":[],"event_group":"winlog.event_data.SubjectUserName, source.ip, winlog.event_data.ObjectName"}
{"rule_id":"dns_fast_flux_detection","name":"DNS Fast Flux Detection","description":"Detects Fast Flux DNS activity by identifying domains that resolve to a high number of unique public IP addresses within a short timeframe. This behavior can be indicative of malicious infrastructure.","severity":"high","enabled":true,"language":"esql","query":"from network_resolution | where event.dataset == 'dns' and dns.question.type in ('A', 'AAAA') | stats distinct_ip_count = COUNT_DISTINCT(dns.answers.address), resolved_ips = ARRAY_AGG(dns.answers.address) BY dns.question.name | where distinct_ip_count > 3 and dns.answers.address IS NOT NULL and NOT (dns.answers.address like '10.%' or dns.answers.address like '172.1[6-9].%' or dns.answers.address like '172.2[0-9].%' or dns.answers.address like '172.3[0-1].%' or dns.answers.address like '192.168.%' or dns.answers.address == '127.0.0.1') and NOT (dns.question.name like '%.google.com' or dns.question.name like '%.googleapis.com' or dns.question.name like '%.microsoft.com' or dns.question.name like '%.windowsupdate.com' or dns.question.name like '%.apple.com' or dns.question.name like '%.icloud.com' or dns.question.name like '%.amazonaws.com' or dns.question.name like '%.cloudfront.net' or dns.question.name like '%.akamaitechnologies.com' or dns.question.name like '%.akamai.net' or dns.question.name like '%.cloudflare.com' or dns.question.name like '%.fastly.net' or dns.question.name like '%.office365.com') | keep dns.question.name, distinct_ip_count, resolved_ips","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1568","name":"Dynamic Resolution","reference":"https://attack.mitre.org/techniques/T1568/"}, {"id":"T1568.001","name":"Fast Flux DNS","reference":"https://attack.mitre.org/techniques/T1568/001/"}]}],"interval":"1h","from":"now-1h","max_signals":100,"risk_score":85,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.cisa.gov/news-events/cybersecurity-advisories/aa25-093a","https://www.elastic.co/guide/en/security/current/fast-flux-network-activity-detected.html"],"tags":["DNS","Fast Flux","Command and Control"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"dns.question.name"}
{"rule_id":"email_data_exfiltration_suspicious_volume","name":"Suspicious Email Data Exfiltration Attempt","description":"Detects potential data exfiltration via email by monitoring outbound traffic for high volume, large attachments, emails to numerous external domains, or sensitive keywords in the subject line.","severity":"critical","enabled":true,"language":"esql","query":"from logs-email-* | where email.direction == 'outbound' and email.from.address in (SELECT email_address from internal_users where is_internal = true) and email.to.domain not in (SELECT domain from internal_domains) | eval is_personal_domain = case(email.to.domain RLIKE '(?i).*(gmail\\.com|yahoo\\.com|outlook\\.com|hotmail\\.com|aol\\.com|protonmail\\.com|icloud\\.com)', 1, 0), has_sensitive_subject = case(email.subject RLIKE '(?i).*(confidential|secret|internal use only|proprietary|private)', 1, 0) | stats email_count = COUNT(*), total_bytes_sent = SUM(email.message_size), distinct_recipient_domains = COUNT_DISTINCT(email.to.domain), recipient_domains = ARRAY_AGG(email.to.domain), personal_email_count = SUM(is_personal_domain), sensitive_subject_count = SUM(has_sensitive_subject) BY DATE_TRUNC('1 day', @timestamp) AS time_window_start, email.from.address | where (email_count > 100 and total_bytes_sent > 52428800) or personal_email_count > 20 or sensitive_subject_count > 5","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0010","name":"Exfiltration","reference":"https://attack.mitre.org/tactics/TA0010/"},"technique":[{"id":"T1048","name":"Exfiltration Over Alternative Protocol","reference":"https://attack.mitre.org/techniques/T1048/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"}}],"interval":"1d","from":"now-1d","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":[],"tags":["Email","Exfiltration","Data Loss Prevention"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"internal_users_exemption","description":"Exempts internal users based on email address.","conditions":[{"field":"email.from.address","operator":"included","type":"list","list_id":"internal_users"}],"enabled":true}, {"name":"internal_domains_exemption","description":"Exempts internal domains from the recipient domain check.","conditions":[{"field":"email.to.domain","operator":"included","type":"list","list_id":"internal_domains"}],"enabled":true}],"custom_query_fields":[],"event_group":"email.from.address, time_window_start"}
{"rule_id":"gcp_suspicious_ssh_key_injection","name":"GCP Suspicious SSH Key Injection","description":"Detects the injection of SSH public keys into GCP instance or project metadata from non-whitelisted users. This activity can indicate a backdoor being created for persistent access or a privilege escalation attempt.","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-gcp.audit-* | WHERE event.provider == 'compute.googleapis.com' AND event.action IN ('v1.compute.instances.setMetadata', 'v1.compute.projects.setCommonInstanceMetadata') AND error.code IS NULL AND gcp.audit.request.metadata.items.key == 'ssh-keys' AND gcp.audit.authentication_info.principalEmail NOT LIKE '%admin@example.com' AND gcp.audit.authentication_info.principalEmail NOT LIKE '%automation-sa@%.iam.gserviceaccount.com' | eval user = gcp.audit.authentication_info.principalEmail, src_ip = source.ip, project_id = gcp.resource.labels.project_id, api_call = event.action, target_type = CASE(event.action == 'v1.compute.projects.setCommonInstanceMetadata', 'Project', 'Instance'), target_id = COALESCE(gcp.resource.labels.instance_id, gcp.resource.labels.project_id), ssh_key_value = gcp.audit.request.metadata.items.value | KEEP user, src_ip, project_id, api_call, target_type, target_id, ssh_key_value","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1098","name":"Account Manipulation","reference":"https://attack.mitre.org/techniques/T1098/"}, {"id":"T1098.004","name":"SSH Authorized Keys","reference":"https://attack.mitre.org/techniques/T1098/004/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"}}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://cloud.google.com/compute/docs/connect/ssh-best-practices/auditing","https://cloud.google.com/blog/products/identity-security/gleaning-security-insights-from-audit-logs-with-log-analytics"],"tags":["GCP","Compute Engine","SSH Key Injection","Persistence","Privilege Escalation"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"user, project_id, target_id, api_call"}
{"rule_id":"multi_ttp_malware_suspicious_activity","name":"GRU-29155 Multi-TTP Malware and Suspicious Activity Detection","description":"Correlates various tactics, techniques, and procedures (TTPs) associated with malware and attacker tools. This rule covers process execution patterns (WhisperGate, Impacket, Rclone, GOST), file creation, and network/DNS activity (Unit 29155 C2s, Iodine, Ngrok).","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-endpoint.events.*,logs-network.* | WHERE (event.category == 'process' AND event.action == 'start' AND (process.name IN ('powershell.exe', 'pwsh.exe') AND process.command_line LIKE '% -enc UwB0AGEAcgB0AC0AUwBsAGUAZQBwACAALQBzACAAMQAwAA==%') OR (process.name IN ('powershell.exe', 'pwsh.exe') AND process.command_line LIKE '%Set-MpPreference*ExclusionPath*C:\\%') OR (process.name == 'AdvancedRun.exe' AND (process.command_line LIKE '%stop WinDefend%' OR process.command_line LIKE '%rmdir *C:\\ProgramData\\Microsoft\\Windows Defender%')) OR (process.name == 'InstallUtil.exe' AND (process.executable LIKE '%\\AppData\\Local\\Temp\\%' OR process.executable LIKE '%\\Windows\\Temp\\%')) OR (process.command_line LIKE '%secretsdump.py%' OR process.command_line LIKE '%psexec.py%') OR (process.name ILIKE 'rclone%' AND process.command_line LIKE '%mega%.nz%') OR (process.name == 'java.exe' AND (process.command_line LIKE '%-L*socks5://%' OR process.command_line LIKE '%-L*rtcp://%')) OR (process.command_line LIKE '%proxychains%') OR (process.command_line LIKE '%su-bruteforce%') OR (process.command_line LIKE '%linpeas.sh%' OR process.command_line LIKE '%linpeas.py%')) OR (event.category == 'file' AND event.action == 'creation' AND file.hash.md5 == '896e0f54fc67d72d94b40d7885f10c51') OR (event.category == 'network' AND (destination.ip IN ('5.226.139.66', '45.141.87.11', '46.101.242.222', '62.173.140.223', '79.124.8.66', '90.131.156.107', '112.51.253.153', '112.132.218.45', '154.21.20.82', '179.43.133.202', '179.43.142.42', '179.43.162.55', '179.43.175.38', '179.43.175.108', '179.43.176.60', '179.43.187.47', '179.43.189.218', '185.245.84.227', '185.245.85.251', '194.26.29.84', '194.26.29.95', '194.26.29.98', '194.26.29.251')) OR (destination.domain IN ('interlinks.top', '3proxy.ru', 'nssm.cc')) OR (destination.domain LIKE '%cdn.discordapp.com' AND url.full LIKE '%/attachments/%') OR (destination.domain LIKE '%ngrok.com')) OR (event.category == 'dns' AND dns.question.name == 'dns.test658324901domain.me')","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0010","name":"Exfiltration","reference":"https://attack.mitre.org/tactics/TA0010/"}}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.microsoft.com/en-us/security/blog/2022/01/15/destructive-malware-targeting-ukraine-government-agencies-detected/","https://securelist.com/unit-29155-targeting-governments/106963/","https://rclone.org/"],"tags":["Malware","WhisperGate","Impacket","Rclone","APT","Defense Evasion","C2"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, process.name"}
{"rule_id":"lateral_movement_suspicious_psexec_rdp_activity","name":"Lateral Movement:Suspicious PsExec or RDP Activity","description":"Detects activity indicative of lateral movement using PsExec or RDP. This rule correlates PsExec service installations (7045), PsExec-like process executions (Sysmon Event ID 1), and successful RDP logins (1149) on an endpoint.","severity":"critical","enabled":true,"language":"esql","query":"from winlogbeat-*, logs-endpoint.events-* | where (winlog.channel == 'System' and winlog.event_id == '7045' and (winlog.event_data.ServiceName == 'PSEXESVC' or winlog.event_data.ServiceFileName rlike '(?i).*PSEXESVC\\.exe$')) or (event.module == 'sysmon' and event.code == '1' and (process.executable rlike '.*PSEXESVC\\.exe$' or (process.executable rlike '.*[C|c]:\\\\[W|w][I|i][N|n][D|d][O|o][W|w][S|s]\\\\.*\\.exe$' and process.executable rlike '(?i).*[C|c]:\\\\[W|w][I|i][N|n][D|d][O|o][W|w][S|s]\\\\[a-zA-Z0-9]{8,}\\.exe$'))) or (winlog.channel == 'Microsoft-Windows-TerminalServices-LocalSessionManager/Operational' and winlog.event_id == '1149') | eval activity_type = CASE(winlog.event_id == '7045' or event.code == '7045', 'PsExec Service Installation', winlog.event_id == '1' or event.code == '1', 'PsExec-like Process Execution', winlog.event_id == '1149', 'Successful RDP Logon', 'Unknown'), user = COALESCE(winlog.event_data.AccountName, user.name), details = COALESCE(winlog.event_data.ServiceFileName, process.executable, process.command_line, CONCAT('Source IP:', source.ip), winlog.event_data.param1) | stats count = COUNT(*), activities = ARRAY_AGG(activity_type), users = ARRAY_AGG(user), activity_details = ARRAY_AGG(details) by host.name | keep host.name, activities, users, activity_details, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"}, {"id":"T1021.001","name":"Remote Desktop Protocol","reference":"https://attack.mitre.org/techniques/T1021/001/"}, {"id":"T1021.002","name":"SMB/Windows Admin Shares","reference":"https://attack.mitre.org/techniques/T1021/002/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":85,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.microsoft.com/en-us/sysinternals/downloads/psexec","https://www.elastic.co/guide/en/security/current/psexec-service-creation.html"],"tags":["PsExec","RDP","Lateral Movement","Windows"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name"}
{"rule_id":"linux_log_tampering_defense_evasion","name":"Linux Log Tampering - Defense Evasion","description":"Detects log tampering techniques on Linux systems, including timestomping with `touch`, disabling bash history, sanitizing WTMP logs, and modifying/deleting critical log files.","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-endpoint.events-* | WHERE @timestamp IS NOT NULL AND ((process.name == 'touch' AND process.command_line LIKE '%-r %') OR (process.command_line LIKE '%HISTFILE=/dev/null%') OR (process.command_line LIKE '%utmpdump%|%sed%') OR (event.category == 'file' AND event.action IN ('deleted', 'modified') AND file.path IN ('/var/log/wtmp', '/var/log/auth.log', '/var/log/btmp', '%/.bash_history'))) | EVAL threat_name = CASE(process.name == 'touch', 'Timestomping with Touch', process.command_line LIKE '%HISTFILE=/dev/null%', 'Bash History Disabling Attempt', process.command_line LIKE '%utmpdump%|%sed%', 'WTMP Log Sanitization Attempt', event.category == 'file', CONCAT('Sensitive Log File Tampering (', event.action, ')'), NULL), process_name = COALESCE(process.name, 'File System Event'), process = COALESCE(process.command_line, file.path) | STATS count = COUNT(*) BY host.name AS host, user.name AS user, threat_name, process_name, process | KEEP host, user, threat_name, process_name, process, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1070","name":"Indicator Removal on Host","reference":"https://attack.mitre.org/techniques/T1070/"}, {"id":"T1070.003","name":"Clear Command History","reference":"https://attack.mitre.org/techniques/T1070/003/"}, {"id":"T1070.002","name":"Clear OS Log","reference":"https://attack.mitre.org/techniques/T1070/002/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"}}],"interval":"15m","from":"now-15m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/linux-log-tampering-defense-evasion.html","https://attack.mitre.org/techniques/T1070/"],"tags":["Linux","Log Tampering","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host, user, threat_name, process_name"}
{"rule_id":"linux_pam_configuration_file_modification","name":"Linux PAM Configuration File Modification","description":"Detects unauthorized modifications to Linux Pluggable Authentication Module (PAM) configuration files. This can indicate an attacker attempting to establish a backdoor, bypass authentication, or persist on the system.","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-endpoint.events.* | WHERE (file.path LIKE '/etc/pam.d/*' OR file.path IN ('/lib/security/*', '/usr/lib/security/*', '/lib64/security/*')) AND event.action IN ('creation', 'modification') AND process.name NOT IN ('yum', 'apt', 'apt-get', 'dpkg', 'rpm', 'dnf', 'pacman', 'systemd', 'chkconfig', 'update-alternatives', 'authconfig') | STATS count = COUNT(*) BY event.action, host.name, file.name, file.path, process.name, user.name | KEEP event.action, host.name, file.name, file.path, process.name, user.name, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1546","name":"Event Triggered Execution","reference":"https://attack.mitre.org/techniques/T1546/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1070","name":"Indicator Removal on Host","reference":"https://attack.mitre.org/techniques/T1070/"}]}],"interval":"1h","from":"now-1h","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/linux-authentication-module-modification.html","https://attack.mitre.org/techniques/T1546/"],"tags":["Linux","PAM","Persistence","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, process.name, file.path"}
{"rule_id":"linux_process_masquerading_detection","name":"Linux Process Masquerading Detection","description":"Detects process masquerading on Linux systems, including fake kernel threads, unusual Apache httpd locations, and suspicious D-Bus process executions. This can indicate defense evasion by an attacker.","severity":"high","enabled":true,"language":"esql","query":"FROM logs-endpoint.events-* | WHERE @timestamp IS NOT NULL AND event.category == 'process' AND ((process.name LIKE '[%]' AND process.name LIKE '%]' AND process.executable != '') OR (process.name == 'httpd' AND process.command_line LIKE '%-D%' AND process.executable NOT IN ('/usr/sbin/*', '/usr/local/apache2/bin/*')) OR (process.name LIKE 'dbus-%' AND process.executable != '/usr/bin/*')) | EVAL technique = CASE(process.name LIKE '[%]' AND process.name LIKE '%]', 'Kernel Thread Masquerading', process.name == 'httpd', 'Apache httpd Masquerading', process.name LIKE 'dbus-%', 'D-Bus Process Masquerading', NULL), process_name = process.name | STATS firstTime = MIN(@timestamp), lastTime = MAX(@timestamp), count = COUNT(*) BY host.name AS host, user.name AS user, technique, process_name, process.command_line AS process, process.executable AS process_path | KEEP host, user, technique, process_name, process, process_path, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1036","name":"Masquerading","reference":"https://attack.mitre.org/techniques/T1036/"}, {"id":"T1036.004","name":"Masquerade Task or Service","reference":"https://attack.mitre.org/techniques/T1036/004/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"}}],"interval":"15m","from":"now-15m","max_signals":100,"risk_score":80,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/linux-process-masquerading.html","https://www.elastic.co/guide/en/security/current/detect-linux-kernel-rootkit.html"],"tags":["Linux","Process Masquerading","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host, user, technique, process_name"}
{"rule_id":"llmnr_nbt_ns_poisoning_detection","name":"LLMNR/NBT-NS Poisoning Detection","description":"Detects potential LLMNR or NBT-NS poisoning activity by identifying a single source IP responding to a large number of unique destination IPs on ports 137 or 5355.","severity":"high","enabled":true,"language":"esql","query":"from logs-packetbeat-* | where network.transport == 'udp' and destination.port in (137, 5355) | stats victim_count = COUNT(DISTINCT destination.ip) BY source.ip | where victim_count > 10 | keep source.ip, victim_count | sort victim_count DESC","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1557","name":"Adversary-in-the-Middle","reference":"https://attack.mitre.org/techniques/T1557/"}]}],"interval":"15m","from":"now-15m","max_signals":100,"risk_score":75,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://attack.mitre.org/techniques/T1557/001/"],"tags":["Packetbeat","LLMNR","NBT-NS","Lateral Movement"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"source.ip"}
{"rule_id":"rogue_dns_server_detection","name":"Potential Rogue DNS Server Detection","description":"Detects potential rogue DNS server activity by identifying a single destination IP receiving DNS queries (A/AAAA/ANY) from multiple unique source IPs. This rule uses an exception list to exclude authorized DNS servers.","severity":"high","enabled":true,"language":"esql","query":"from logs-packetbeat-* | where dns.question.type IN ('AAAA', 'ANY', 'A') and destination.ip != '0.0.0.0' | stats victim_count = COUNT(DISTINCT source.ip) BY destination.ip | where victim_count > 1 | keep destination.ip, victim_count | sort victim_count DESC","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1557","name":"Adversary-in-the-Middle","reference":"https://attack.mitre.org/techniques/T1557/"}]}],"interval":"15m","from":"now-15m","max_signals":100,"risk_score":80,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://attack.mitre.org/techniques/T1557/001/"],"tags":["Packetbeat","DNS","Lateral Movement"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"authorized_dns_servers_exemption","_comment":"Execute ../aux_rule_files/create_kibana_dns_exception_list.sh to create the list","description":"Exempts authorized DNS server IPs.","conditions":[{"field":"destination.ip","operator":"included","type":"list","list_id":"authorized_dns_servers"}],"enabled":true}],"custom_query_fields":[],"event_group":"destination.ip"}
{"rule_id":"network_protocol_port_mismatch_detection","name":"Network Protocol-Port Mismatch Detection","description":"Detects network traffic where the protocol does not match the port, which can indicate C2 activity, misconfiguration, or port scanning.","severity":"medium","enabled":true,"language":"esql","query":"from network_traffic | where tags IN ('network', 'communicate') and ((network.application == 'dns' and destination.port != 53) or (network.application == 'smtp' and destination.port not in (25, 465, 587)) or (destination.port in (80, 443) and network.application not in ('http', 'ssl', 'https', 'quic', 'http-proxy', 'unknown', 'bittorrent'))) and source.ip not in ('10.0.0.0/8', '127.0.0.1', '169.254.0.0/16') and destination.ip not in ('224.0.0.0/4', '255.255.255.255', '169.254.0.0/16') | eval reason = CASE(destination.port in (80, 443), 'Non-Standard Protocol on Web Port', network.application == 'dns', 'DNS on Non-Standard Port', network.application == 'smtp', 'SMTP on Non-Standard Port', true, 'Unknown Anomaly'), signature = network.application | keep @timestamp, source.ip, destination.ip, destination.port, network.transport, signature, reason","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1090","name":"Proxy","reference":"https://attack.mitre.org/techniques/T1090/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0007","name":"Discovery","reference":"https://attack.mitre.org/tactics/TA0007/"},"technique":[{"id":"T1046","name":"Network Service Scanning","reference":"https://attack.mitre.org/techniques/T1046/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":50,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":[],"tags":["Network","Protocol Mismatch","Scanning"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"source.ip, destination.ip, destination.port"}
{"rule_id":"network_icmp_tunneling_detection","name":"Potential ICMP Tunneling Detected","description":"Flags a high volume of ICMP traffic (high packet count and byte count) between two hosts. This can indicate data exfiltration or a Command and Control (C2) channel disguised as normal network traffic.","severity":"high","enabled":true,"language":"esql","query":"from network_traffic | where tags in ('network', 'communicate') and network.transport == 'icmp' and source.ip not in ('10.0.0.0/8', '127.0.0.1', '169.254.0.0/16') and destination.ip not in ('224.0.0.0/4', '255.255.255.255', '169.254.0.0/16') | stats total_bytes = SUM(network.bytes), distinct_icmp_types = COUNT_DISTINCT(network.icmp.type), pkt_count = COUNT(*) BY source.ip, destination.ip, network.transport | where pkt_count > 100 and total_bytes > 20480 | eval reason = 'Potential ICMP Tunneling', signature = 'High Volume ICMP (' + TO_STRING(total_bytes) + ' bytes, ' + TO_STRING(pkt_count) + ' packets)' | keep @timestamp, source.ip, destination.ip, network.transport, signature, reason, total_bytes, pkt_count, distinct_icmp_types","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1090","name":"Proxy","reference":"https://attack.mitre.org/techniques/T1090/"}, {"id":"T1090.003","name":"ICMP","reference":"https://attack.mitre.org/techniques/T1090/003/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0010","name":"Exfiltration","reference":"https://attack.mitre.org/tactics/TA0010/"}}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":85,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":[],"tags":["Network","ICMP Tunneling","Command and Control"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"source.ip, destination.ip"}
{"rule_id":"ntlm_reflection_attack_detection","name":"Potential NTLM Reflection Attack","description":"Detects network NTLM authentication (Event ID 4624, Logon Type 3) where the source workstation and destination hostname are identical. This behavior is indicative of an NTLM relay loop or reflection attack.","severity":"high","enabled":true,"language":"esql","query":"from winlogbeat-* | where winlog.channel == 'Security' and winlog.event_id == '4624' and winlog.event_data.LogonType == '3' and winlog.event_data.AuthenticationPackageName == 'NTLM' and source.ip != '127.0.0.1' and source.ip != '::1' | eval dest_host = LOWER(SPLIT(host.name, '.')[0]), src_workstation = LOWER(SPLIT(winlog.event_data.WorkstationName, '.')[0]) | where dest_host == src_workstation and dest_host != '' and dest_host != '-' | stats count() by dest_host, source.ip, winlog.event_data.TargetUserName, winlog.event_data.SubjectUserName","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1187","name":"NTLM Reflection","reference":"https://attack.mitre.org/techniques/T1187/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":75,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4624","https://attack.mitre.org/techniques/T1187/"],"tags":["Active Directory","NTLM","Lateral Movement"],"author":["RW"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"dest_host, source.ip, winlog.event_data.TargetUserName, winlog.event_data.SubjectUserName"}
{"rule_id":"powershell_amsi_bypass_attempt","name":"PowerShell AMSI Bypass Attempt","description":"Detects attempts to bypass the Antimalware Scan Interface (AMSI) via PowerShell by looking for common API functions and DLLs associated with memory patching. This technique is often used by attackers to evade security products.","severity":"critical","enabled":true,"language":"esql","query":"FROM * | WHERE @timestamp IS NOT NULL AND event.action == 'PowerShellScriptBlock' AND powershell.script_block.text IS NOT NULL AND powershell.script_block.text LIKE '%VirtualProtect%' AND powershell.script_block.text LIKE '%GetProcAddress%' AND powershell.script_block.text LIKE '%InteropServices%' AND powershell.script_block.text LIKE '%AmsiScanBuffer%' AND (powershell.script_block.text LIKE '%amsi.dll%' OR powershell.script_block.text LIKE '%clr.dll%') | KEEP host.name, user.name, process.parent.name, process.parent.command_line, powershell.script_block.text","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1562","name":"Impair Defenses","reference":"https://attack.mitre.org/techniques/T1562/"}, {"id":"T1562.001","name":"Disable or Modify Tools","reference":"https://attack.mitre.org/techniques/T1562/001/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/"}, {"id":"T1059.001","name":"PowerShell","reference":"https://attack.mitre.org/techniques/T1059/001/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/8.13/potential-antimalware-scan-interface-bypass-via-powershell.html","https://www.mdsec.co.uk/2018/06/exploring-powershell-amsi-and-logging-evasion/"],"tags":["Powershell","AMSI Bypass","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, powershell.script_block.text"}
{"rule_id":"powershell_amsiutils_reflection_bypass","name":"PowerShell AMSIUtils Reflection Bypass","description":"Detects attempts to bypass the Antimalware Scan Interface (AMSI) via reflection by looking for the modification of the 'amsiInitFailed' field in the 'AmsiUtils' type. This is a well-known technique to disable AMSI scanning for PowerShell scripts.","severity":"critical","enabled":true,"language":"esql","query":"FROM * | WHERE @timestamp IS NOT NULL AND event.action == 'PowerShellScriptBlock' AND powershell.script_block.text IS NOT NULL AND powershell.script_block.text LIKE '%AmsiUtils%' AND powershell.script_block.text LIKE '%amsiInitFailed%' AND (powershell.script_block.text LIKE '%GetField%' OR powershell.script_block.text LIKE '%SetValue%' OR powershell.script_block.text LIKE '%NonPublic%' OR powershell.script_block.text LIKE '%Static%') | KEEP host.name, user.name, process.parent.name, process.parent.command_line, powershell.script_block.text","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1562","name":"Impair Defenses","reference":"https://attack.mitre.org/techniques/T1562/"}, {"id":"T1562.001","name":"Disable or Modify Tools","reference":"https://attack.mitre.org/techniques/T1562/001/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/"}, {"id":"T1059.001","name":"PowerShell","reference":"https://attack.mitre.org/techniques/T1059/001/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.ghostlulz.com/blog/powershell-amsi-bypass","https://arttoolkit.github.io/wadcoms/AMSI-Bypass-amsiInitFailed/"],"tags":["Powershell","AMSI Bypass","Reflection","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, powershell.script_block.text"}
{"rule_id":"ssh_session_without_authentication_correl","name":"SSH Session Without Prior Authentication","description":"Correlates SSH sessions (process spawn) with authentication logs. Alerts when a user-shell process (e.g., bash) is started by sshd without a corresponding successful authentication event in the immediate preceding time window. This can indicate malicious backdoor activity.","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-endpoint.events.* | WHERE event.dataset == 'endpoint.events.process' AND process.parent.name == 'sshd' AND process.name IN ('bash', 'sh', 'zsh', 'csh', 'tcsh', 'ksh') AND host.name, user.name NOT IN (FROM logs-endpoint.events.* | WHERE event.dataset == 'endpoint.events.auth' AND process.name == 'sshd' AND event.action == 'success' AND @timestamp >= NOW() - INTERVAL '5 minutes' AND @timestamp <= NOW() | SELECT host.name, user.name)","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1098","name":"Account Manipulation","reference":"https://attack.mitre.org/techniques/T1098/"}, {"id":"T1098.004","name":"SSH Authorized Keys","reference":"https://attack.mitre.org/techniques/T1098/004/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"}, {"id":"T1021.004","name":"SSH","reference":"https://attack.mitre.org/techniques/T1021/004/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/ssh-brute-force-attack.html"],"tags":["SSH","Backdoor","Lateral Movement","Persistence"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name"}
{"rule_id":"static_tundra_activity_detection","name":"Static Tundra Activity Detection","description":"Detects activity associated with the Static Tundra threat group, including connections to known C2 IPs, network-based TTPs (inbound TFTP/GRE), and Cisco IOS command-line TTPs (config exfil, ACL/TACACS modification).","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-network.*,logs-cisco.* | WHERE (source.ip IN ('185.141.24.222', '185.82.202.34', '185.141.24.28', '185.82.200.181') OR destination.ip IN ('185.141.24.222', '185.82.202.34', '185.141.24.28', '185.82.200.181')) OR (network.transport == 'udp' AND destination.port == 69) OR (network.protocol == 'gre') OR (process.command_line LIKE '%tftp-server nvram:startup-config%' OR process.command_line LIKE '%redirect tftp://%' OR process.command_line LIKE '%copy running-config ftp://%' OR process.command_line LIKE '%access-list %' OR process.command_line LIKE '%tacacs-server %') | EVAL src = COALESCE(source.ip, 'N/A'), dest = COALESCE(destination.ip, host.name), command = CASE(process.command_line LIKE '%tftp-server%', 'tftp-server nvram:startup-config', process.command_line LIKE '%redirect tftp://%', process.command_line, process.command_line LIKE '%copy running-config ftp://%', process.command_line, process.command_line LIKE '%access-list %', process.command_line, process.command_line LIKE '%tacacs-server %', process.command_line, true, 'N/A'), detection_technique = CASE(source.ip IN ('185.141.24.222', '185.82.202.34', '185.141.24.28', '185.82.200.181') OR destination.ip IN ('185.141.24.222', '185.82.202.34', '185.141.24.28', '185.82.200.181'), 'Static Tundra C2 IP Detected', destination.port == 69, 'Potential Inbound TFTP for Config Exfil', network.protocol == 'gre', 'GRE Tunnel Established for Traffic Collection', process.command_line LIKE '%tftp-server%', 'Local TFTP Server Enabled for Config Exfil', process.command_line LIKE '%redirect tftp://%', 'Config Exfil via TFTP Redirect', process.command_line LIKE '%copy running-config ftp://%', 'Config Exfil via FTP', process.command_line LIKE '%access-list %', 'ACL Modification Detected', process.command_line LIKE '%tacacs-server %', 'TACACS+ Config Modification Detected', true, null) | STATS detection_techniques = CONCAT_ARRAY(detection_technique), commands = CONCAT_ARRAY(command) BY @timestamp, src, dest, user.name AS user | EVAL message = 'Potential Static Tundra activity detected. Techniques observed:' + CONCAT(detection_techniques, ', ') + '. Source:' + src + ', Destination:' + dest + ', User:' + user | keep @timestamp, src, dest, user, detection_techniques, commands, message","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1090","name":"Proxy","reference":"https://attack.mitre.org/techniques/T1090/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0010","name":"Exfiltration","reference":"https://attack.mitre.org/tactics/TA0010/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"}}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/blog/static-tundra-targets-defense-industrial-base","https://www.elastic.co/guide/en/security/current/static-tundra-activity-detection.html"],"tags":["Static Tundra","Threat Group","Cisco IOS","Command and Control","Exfiltration"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"src, dest, user"}
{"rule_id":"suspicious_amsi_dll_load","name":"Suspicious AMSI.dll Load","description":"Detects attempts to bypass the Antimalware Scan Interface (AMSI) via DLL hijacking by monitoring for suspicious processes loading 'amsi.dll' from an unusual location or an 'amsi.dll' with an invalid or missing digital signature.","severity":"critical","enabled":true,"language":"esql","query":"FROM * | WHERE @timestamp IS NOT NULL AND file.name LIKE '%\\\\amsi.dll' AND process.name IN ('powershell.exe', 'pwsh.exe', 'cscript.exe', 'wscript.exe', 'rundll32.exe', 'regsvr32.exe') AND (NOT (file.path LIKE '%C:\\\\Windows\\\\System32\\\\%' OR file.path LIKE '%C:\\\\Windows\\\\SysWOW64\\\\%') OR (file.signature.status IS NULL OR file.signature.status != 'Valid' OR file.signature.issuer NOT LIKE '%Microsoft Windows%')) | KEEP host.name, process.name, process.command_line, file.name, file.path, file.hash.sha1, file.signature.issuer, file.signature.status | eval is_signed = CASE(file.signature.status == 'Valid', true, false)","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1574","name":"Hijack Execution Flow","reference":"https://attack.mitre.org/techniques/T1574/"}, {"id":"T1574.001","name":"DLL Side-Loading","reference":"https://attack.mitre.org/techniques/T1574/001/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1543.003","name":"Windows Service","reference":"https://attack.mitre.org/techniques/T1543/003/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://detection.fyi/elastic/detection-rules/windows/defense_evasion_amsi_bypass_dllhijack/","https://www.elastic.co/docs/reference/security/prebuilt-rules/rules/windows/defense_evasion_amsi_bypass_dllhijack"],"tags":["AMSI Bypass","DLL Hijacking","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, process.name, file.path, file.name"}
{"rule_id":"suspicious_dns_activity_dga_exfiltration","name":"Suspicious DNS Activity (DGA/Exfiltration)","description":"Detects DNS activity indicative of Domain Generation Algorithms (DGA) or data exfiltration. This includes a high number of distinct, long, or numerically-rich queries, and an excessive number of TXT record queries, while filtering out known benign domains.","severity":"high","enabled":true,"language":"esql","query":"from * | where (event.dataset = 'stream.dns' OR tags = 'dns') and dns.question.name != 'localhost' | eval query_len = LENGTH(dns.question.name), numeric_chars = REGEXP_REPLACE(dns.question.name, '[^0-9]', ''), numeric_ratio = LENGTH(numeric_chars) / query_len | stats total_queries = COUNT(), distinct_query_count = COUNT_DISTINCT(dns.question.name), sample_queries = ARRAY_AGG(dns.question.name), query_types = ARRAY_AGG(dns.question.type), avg_query_len = AVG(query_len), max_numeric_ratio = MAX(numeric_ratio), total_txt_queries = COUNT(case(dns.question.type = 'TXT', 1, NULL)) BY source.ip, dns.question.registered_domain | where (distinct_query_count > 15 and avg_query_len > 20 and max_numeric_ratio > 0.2) OR (total_txt_queries > 10 and distinct_query_count > 5) | where NOT (dns.question.registered_domain like '%.amazonaws.com' OR dns.question.registered_domain like '%.google.com' OR dns.question.registered_domain like '%.microsoft.com' OR dns.question.registered_domain like '%.icloud.com' OR dns.question.registered_domain like '%.akamai.net')","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1568","name":"Domain Generation Algorithms","reference":"https://attack.mitre.org/techniques/T1568/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0010","name":"Exfiltration","reference":"https://attack.mitre.org/tactics/TA0010/"},"technique":[{"id":"T1048","name":"Exfiltration Over Alternative Protocol","reference":"https://attack.mitre.org/techniques/T1048/"}]}],"interval":"30m","from":"now-30m","max_signals":100,"risk_score":85,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/dns-tunneling.html"],"tags":["DNS","DGA","Exfiltration","Command and Control"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"source.ip, dns.question.registered_domain"}
{"rule_id":"suspicious_font_file_download_by_non_browser_process","name":"Suspicious Font File Download by Non-Browser Process","description":"Detects outbound network connections to font files (.ttf) from processes that are not standard web browsers. This could indicate Command and Control (C2) communication or data exfiltration disguised as benign traffic.","severity":"high","enabled":true,"language":"esql","query":"from logs-proxy*, logs-endpoint.events.* | where url MATCHES '(?i)/assets/fonts/[^/]+\\.ttf$' and process.name not in ('chrome.exe', 'firefox.exe', 'msedge.exe', 'iexplore.exe', 'browser.exe', 'opera.exe', 'safari.exe') | stats count = COUNT(*), urls = ARRAY_AGG(url), user_agents = ARRAY_AGG(http.user_agent) BY host.name, user.name, process.parent.name, process.name, process.executable | keep host.name, user.name, process.parent.name, process.name, process.executable, urls, user_agents, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1071","name":"Application Layer Protocol","reference":"https://attack.mitre.org/techniques/T1071/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1036","name":"Masquerading","reference":"https://attack.mitre.org/techniques/T1036/"}]}],"interval":"15m","from":"now-15m","max_signals":100,"risk_score":80,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/unusual-network-activity-suspicious-font-downloads.html","https://www.galacticadvisors.com/research/the-importance-of-font-security/"],"tags":["Font Downloads","Command and Control","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, process.name, process.executable"}
{"rule_id":"suspicious_powershell_obfuscation","name":"Suspicious PowerShell Obfuscation","description":"Detects obfuscated PowerShell command lines, including long, encoded commands and complex string manipulation combined with Invoke-Expression. This technique is often used by adversaries to hide malicious activity and evade security controls.","severity":"high","enabled":true,"language":"esql","query":"FROM * | WHERE @timestamp IS NOT NULL AND process.name IN (\"powershell.exe\", \"pwsh.exe\") AND (((process.command_line LIKE \"% -encodedcommand %\" OR process.command_line LIKE \"% -ec %\" OR process.command_line LIKE \"% -enc %\" OR process.command_line LIKE \"% -en %\" OR process.command_line LIKE \"% -e %\") AND LENGTH(process.command_line) > 200) OR ((process.command_line LIKE \"%iex%\" OR process.command_line LIKE \"%invoke-expression%\") AND (process.command_line LIKE \"%+%\" OR process.command_line LIKE \"% -join %\" OR process.command_line LIKE \"%[char]%\" OR process.command_line LIKE \"%frombase64string%\" OR LENGTH(process.command_line) > 1024)) OR (LENGTH(process.command_line) > 400 AND (process.command_line LIKE \"% -join %\" OR process.command_line LIKE \"% -replace %\" OR process.command_line LIKE \"% -split %\")))","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1027","name":"Obfuscated Files or Information","reference":"https://attack.mitre.org/techniques/T1027/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/"}, {"id":"T1059.001","name":"PowerShell","reference":"https://attack.mitre.org/techniques/T1059/001/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":70,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/potential-powershell-obfuscation-via-special-character-overuse.html","https://www.elastic.co/guide/en/security/current/suspicious-powershell-script.html"],"tags":["Powershell","Obfuscation","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, process.name"}
{"rule_id":"suspicious_process_memory_allocation","name":"Suspicious Process Memory Allocation","description":"Detects anomalous process memory allocation with execute-write permissions (`0x40`). This technique is frequently used by adversaries for process injection and defense evasion by executing malicious code from within a legitimate process.","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-endpoint.events.* | WHERE process.memory.allocation.flags LIKE '%0x40%' AND process.actor.name != process.target.name AND process.actor.name not in ('csrss.exe', 'lsass.exe', 'svchost.exe', 'YourEDRAgent.exe') AND process.target.name not in ('msedge.exe', 'chrome.exe', 'firefox.exe') | STATS count = COUNT(*) BY host.name, user.name, process.actor.name, process.actor.executable, process.actor.command_line, process.target.name, process.target.executable | KEEP host.name, user.name, process.actor.name, process.actor.executable, process.actor.command_line, process.target.name, process.target.executable, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1055","name":"Process Injection","reference":"https://attack.mitre.org/techniques/T1055/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"}}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/security-labs/upping-the-ante-detecting-in-memory-threats-with-kernel-call-stacks","https://www.elastic.co/guide/en/security/current/detect-suspicious-memory-allocation.html"],"tags":["Process Injection","Memory","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, process.actor.name, process.target.name"}
{"rule_id":"suspicious_ssl_tls_validation_bypass","name":"Suspicious SSL/TLS Validation Bypass","description":"Detects API calls that bypass SSL/TLS certificate validation, which can be used by malicious software to facilitate command and control (C2) communication or avoid detection.","severity":"high","enabled":true,"language":"esql","query":"FROM logs-endpoint.events.* | WHERE (process.api.parameters MATCHES '(?i)SECURITY_FLAG_IGNORE_CERT_CN_INVALID|SECURITY_FLAG_IGNORE_CERT_DATE_INVALID|SECURITY_FLAG_IGNORE_UNKNOWN_CA|SECURITY_FLAG_IGNORE_CERT_WRONG_USAGE' OR process.api.parameters MATCHES '(?i)0x1000|0x2000|0x100|0x200') | STATS count = COUNT(*), evidence = ARRAY_AGG(process.api.parameters) BY host.name, user.name, process.parent.name, process.name, process.executable, process.command_line | KEEP host.name, user.name, process.parent.name, process.name, process.executable, process.command_line, evidence, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1562","name":"Impair Defenses","reference":"https://attack.mitre.org/techniques/T1562/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1090","name":"Proxy","reference":"https://attack.mitre.org/techniques/T1090/"}]}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":85,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/ssl-tls-validation-bypass.html"],"tags":["SSL/TLS","Defense Evasion","Command and Control"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"trusted_ssl_processes_exemption","description":"Exempts known, legitimate processes from SSL validation bypass detection.","conditions":[{"field":"process.name","operator":"included","type":"list","list_id":"trusted_ssl_processes"}],"enabled":true}],"custom_query_fields":[],"event_group":"host.name, user.name, process.name, process.executable"}
{"rule_id":"suspicious_werfault_outbound_connection","name":"Suspicious WerFault.exe Outbound Connection","description":"Detects outbound network connections made by the Windows Error Reporting process (WerFault.exe) to non-standard or non-Microsoft domains. This can indicate a hijacked process being used for Command and Control (C2) communication or data exfiltration.","severity":"high","enabled":true,"language":"esql","query":"FROM logs-endpoint.events.* | WHERE (process.name == 'WerFault.exe' OR process.executable LIKE '%\\\\WerFault.exe') AND NOT (destination.domain LIKE '%.microsoft.com' OR destination.domain LIKE '%.windows.com' OR destination.domain LIKE '%.msftconnecttest.com' OR destination.domain LIKE '%.windowsupdate.com') | STATS count = COUNT(*), destinations = ARRAY_AGG(destination.domain) BY host.name, user.name, process.parent.name, process.name, process.executable, process.command_line | KEEP host.name, user.name, process.parent.name, process.name, process.executable, process.command_line, destinations, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1071","name":"Application Layer Protocol","reference":"https://attack.mitre.org/techniques/T1071/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1036","name":"Masquerading","reference":"https://attack.mitre.org/techniques/T1036/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":80,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/security-labs/upping-the-ante-detecting-in-memory-threats-with-kernel-call-stacks","https://www.elastic.co/guide/en/security/current/detect-uncommon-processes-with-network-connections.html"],"tags":["Windows","WerFault","Command and Control","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, process.name, process.executable"}
{"rule_id":"suspicious_werfault_process_creation_flags","name":"Suspicious WerFault.exe Process Creation with Specific Flags","description":"Detects the creation of WerFault.exe with suspicious process creation flags (e.g., CREATE_SUSPENDED). This technique is often used by attackers to stage process injection and evade endpoint security controls.","severity":"critical","enabled":true,"language":"esql","query":"from * | where ((event.module == 'wineventlog' and event.code == '4688') or (event.module == 'xmlwineventlog' and event.code == '1') or (event.module == 'crowdstrike' and event.action == 'ProcessRollup2')) and (process.name == 'WerFault.exe' or process.executable like '%\\\\WerFault.exe') and (process.creation_flags like '%0x4%' or process.flags like '%0x4%') | stats count = COUNT(*) by host.name, user.name, process.parent.name, process.name, process.executable, process.command_line, process.creation_flags, process.flags | keep host.name, user.name, process.parent.name, process.name, process.executable, process.command_line, process.creation_flags, process.flags, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1055","name":"Process Injection","reference":"https://attack.mitre.org/techniques/T1055/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"},"technique":[{"id":"T1059","name":"Command and Scripting Interpreter","reference":"https://attack.mitre.org/techniques/T1059/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/security-labs/upping-the-ante-detecting-in-memory-threats-with-kernel-call-stacks","https://github.com/elastic/detection-rules/blob/main/rules/windows/defense_evasion_masquerading_suspicious_werfault_childproc.toml"],"tags":["Windows","WerFault","Process Injection","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, process.name, process.creation_flags, process.flags"}
{"rule_id":"suspicious_wuauclt_access_lsass","name":"Suspicious Wuauclt.exe Access to LSASS.exe","description":"Detects the Windows Update client, wuauclt.exe, accessing the LSASS process with elevated permissions. This is a highly suspicious behavior that could indicate an attacker using a compromised system process to perform credential dumping.","severity":"critical","enabled":true,"language":"esql","query":"FROM * | WHERE event.action = 'access' AND process.name = 'wuauclt.exe' AND process.target.name = 'lsass.exe' AND process.target.access_mask RLIKE '(0x1010|0x1410|0x1fffff)' | STATS count = COUNT(*), process = ARRAY_AGG(process.command_line) BY host.name, user.name, process.parent.name, process.target.access_mask | keep host.name, user.name, process.parent.name, process, process.target.access_mask, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"},"technique":[{"id":"T1003","name":"OS Credential Dumping","reference":"https://attack.mitre.org/techniques/T1003/"}, {"id":"T1003.001","name":"LSASS Memory","reference":"https://attack.mitre.org/techniques/T1003/001/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1036","name":"Masquerading","reference":"https://attack.mitre.org/techniques/T1036/"}, {"id":"T1036.002","name":"Right-to-Left Override","reference":"https://attack.mitre.org/techniques/T1036/002/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://detection.fyi/elastic/detection-rules/windows/credential_access_suspicious_lsass_access_generic/","https://www.elastic.co/guide/en/security/current/lsass-memory-dump-creation.html"],"tags":["Credential Access","LSASS","Windows","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name, process.parent.name"}
{"rule_id":"sysmon_suspicious_remote_thread_injection","name":"Sysmon Suspicious Remote Thread Injection","description":"Detects suspicious remote thread creation (Sysmon Event ID 8) from living-off-the-land binaries into other processes. The presence of a NULL or UNKNOWN starting module is a strong indicator of a malicious process injection attempt.","severity":"critical","enabled":true,"language":"esql","query":"from logs-endpoint.events-* | where event.module = 'sysmon' and event.code = '8' and (winlog.event_data.StartModule IS NULL OR winlog.event_data.StartModule rlike '.*UNKNOWN.*') and ((process.executable rlike '.*\\\\(rundll32\\.exe|svchost\\.exe|regsvr32\\.exe|powershell\\.exe)$') and (winlog.event_data.TargetImage rlike '.*\\\\(explorer\\.exe|svchost\\.exe|notepad\\.exe|msiexec\\.exe|aspnet_compiler\\.exe)$')) | stats count = COUNT(*) by host.name, process.executable, winlog.event_data.TargetImage, winlog.event_data.SourceProcessGuid, winlog.event_data.TargetProcessGuid, winlog.event_data.StartAddress, winlog.event_data.StartModule, user.name | keep host.name, process.executable, winlog.event_data.TargetImage, winlog.event_data.SourceProcessGuid, winlog.event_data.TargetProcessGuid, winlog.event_data.StartAddress, winlog.event_data.StartModule, user.name, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"},"technique":[{"id":"T1055","name":"Process Injection","reference":"https://attack.mitre.org/techniques/T1055/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon","https://www.elastic.co/guide/en/security/current/process-injection-detected.html"],"tags":["Sysmon","Process Injection","Defense Evasion"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, process.executable, winlog.event_data.TargetImage"}
{"rule_id":"unauthorized_remote_access_tool_execution","name":"Unauthorized Remote Access Tool Execution","description":"Detects the execution of known remote access and remote management tools by unauthorized users or parent processes. This activity could be indicative of an attacker attempting to gain or maintain remote access to a system.","severity":"critical","enabled":true,"language":"esql","query":"from logs-endpoint.events.* | where event.category == 'process' and event.type == 'start' and (process.name in ('AnyDesk.exe', 'TeamViewer.exe', 'ngrok.exe', 'TacticalRMM.exe', 'tailscale.exe', 'tailscaled.exe', 'tsh.exe') or process.name like 'Splashtop%' or process.name like 'ScreenConnect.Client%' or process.name like 'ConnectWiseControl.Client%' or process.name like 'Pulseway%' or process.name like 'level%' or process.name like 'fleetdeck%') | stats count = COUNT(*) by host.name, user.name, process.parent.name, process.name, process.command_line | keep host.name, user.name, process.parent.name, process.name, process.command_line, count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"},"technique":[{"id":"T1563","name":"Remote Access Tool","reference":"https://attack.mitre.org/techniques/T1563/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"}]}],"interval":"5m","from":"now-5m","max_signals":100,"risk_score":90,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":[],"tags":["Remote Access","Persistence","Lateral Movement"],"actions":[],"throttle":"no_throttle","exemptions":[{"name":"authorized_remote_users_exemption","description":"Exempts authorized users from remote access tool detection.","conditions":[{"field":"user.name","operator":"included","type":"list","list_id":"authorized_remote_users"}],"enabled":true}, {"name":"authorized_remote_parents_exemption","description":"Exempts authorized parent processes from remote access tool detection.","conditions":[{"field":"process.parent.name","operator":"included","type":"list","list_id":"authorized_remote_parents"}],"enabled":true}],"custom_query_fields":[],"event_group":"host.name, process.name, user.name"}
{"rule_id":"unusual_web_user_agent_detection","name":"Unusual Web User Agent Detection","description":"Detects low-volume or non-standard user agents accessing web servers. This activity can indicate malicious scanning, web scraping, or command-and-control activity.","severity":"medium","enabled":true,"language":"esql","query":"from logs-nginx*, logs-apache*, logs-iis* | where http.request.user_agent IS NOT NULL and http.request.user_agent != '-' and NOT (http.request.user_agent rlike '.*(Mozilla/|Opera/|curl/|Wget/|Python-urllib/|Go-http-client/|Java/).*' or http.request.user_agent rlike '.*(bot|spider|crawler|scanner).*') | stats count() by http.request.user_agent, source.ip, destination.ip | stats ua_total_count = sum(count()), Source_IPs = group_concat(source.ip), Destination_IPs = group_concat(destination.ip), Connection_Count = sum(count()) by http.request.user_agent | where ua_total_count < 10 | keep http.request.user_agent, ua_total_count, Source_IPs, Destination_IPs, Connection_Count | sort ua_total_count","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"},"technique":[{"id":"T1021","name":"Remote Services","reference":"https://attack.mitre.org/techniques/T1021/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0002","name":"Execution","reference":"https://attack.mitre.org/tactics/TA0002/"}}],"interval":"1h","from":"now-1h","max_signals":100,"risk_score":50,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":[],"tags":["Web Server","User Agent","Lateral Movement"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"http.request.user_agent"}
{"rule_id":"warlock_ransomware_attack_ttp_correlation","name":"Warlock Ransomware Multi-Stage Attack TTP Correlation","description":"Detects activity indicative of a multi-stage attack by correlating various Tactics, Techniques, and Procedures (TTPs) including initial access, discovery, credential access, defense evasion, C2, lateral movement, and exfiltration. An alert is triggered when two or more distinct TTPs are observed from the same host and user.","severity":"critical","enabled":true,"language":"esql","query":"FROM logs-endpoint.events.* | WHERE (@timestamp IS NOT NULL) AND ( (event.category == 'process' AND event.action == 'start' AND process.parent.name == 'w3wp.exe' AND process.parent.command_line LIKE '%SharePoint%' AND (process.command_line LIKE '%net user guest /active:yes%' OR process.command_line LIKE '%net localgroup administrators guest /add%' OR process.command_line LIKE '%New-GPO%')) OR (event.category == 'process' AND event.action == 'start' AND (process.command_line LIKE '%nltest /domain_trusts%' OR process.command_line LIKE '%wmic product get name,identifyingnumber%' OR process.command_line LIKE '%net group \"domain admins\"%' OR process.command_line LIKE '%net group \"domain computers\"%' OR process.command_line LIKE '%net group \"domain controllers\"%' OR process.command_line LIKE '%quser%')) OR (event.category == 'process' AND event.action == 'start' AND (process.name == 'mimikatz.exe' OR process.command_line LIKE '%reg*save*hklm\\sam%' OR process.command_line LIKE '%reg*save*hklm\\security%')) OR (event.category == 'process' AND event.action == 'start' AND process.parent.name == 'vmtools.exe' AND (process.command_line LIKE '%taskkill%' OR process.command_line LIKE '%net stop%')) OR (event.category == 'file' AND event.action == 'creation' AND file.name == 'googleApiUtil64.sys') OR (event.category == 'process' AND event.action == 'start' AND process.command_line LIKE '%tunnel*run*--token%') OR (event.category == 'process' AND event.action == 'start' AND process.command_line LIKE '%copy*\\c$\\users\\public%') OR (event.category == 'registry' AND event.action == 'modification' AND ((registry.path LIKE '%\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\fDenyTSConnections' AND registry.data.strings == '0') OR (registry.path LIKE '%\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\\UserAuthentication' AND registry.data.strings == '0'))) OR (event.category == 'process' AND event.action == 'start' AND (process.parent.name IN ('rclone.exe', 'TrendSecurity.exe')) AND process.command_line LIKE '%copy*--protondrive-username*--protondrive-password%') )","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0001","name":"Initial Access","reference":"https://attack.mitre.org/tactics/TA0001/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0004","name":"Privilege Escalation","reference":"https://attack.mitre.org/tactics/TA0004/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0007","name":"Discovery","reference":"https://attack.mitre.org/tactics/TA0007/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0006","name":"Credential Access","reference":"https://attack.mitre.org/tactics/TA0006/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0005","name":"Defense Evasion","reference":"https://attack.mitre.org/tactics/TA0005/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0003","name":"Persistence","reference":"https://attack.mitre.org/tactics/TA0003/"}}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0010","name":"Exfiltration","reference":"https://attack.mitre.org/tactics/TA0010/"}}],"interval":"1h","from":"now-1h","max_signals":100,"risk_score":95,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":[],"tags":["Multi-Stage Attack","TTP Correlation","Advanced Threat"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"host.name, user.name"}
{"rule_id":"zeek_suspicious_network_traffic_correlation","name":"Zeek Suspicious Network Traffic Correlation","description":"Detects suspicious network activity, including potential domain fronting (HTTP Host != SNI) and unusual file transfers (application/octet-stream without common file extensions) by correlating Zeek HTTP and SSL logs.","severity":"high","enabled":true,"language":"esql","query":"from zeek-* | where zeek.session_id IS NOT NULL and (event.category IN ('zeek_ssl', 'zeek_http')) | stats sourcetypes = COLLECT(event.category), http_host = COLLECT(url.domain), sni = COLLECT(tls.server_name), http_method = COLLECT(http.request.method), uri = COLLECT(url.path), filenames = COLLECT(http.response.body.filenames), content_type = COLLECT(http.response.mime_type) BY zeek.session_id, source.address, destination.address, destination.port | where (('application/octet-stream' IN content_type and NOT (uri MATCHES '.*\\.(exe|zip|rar|dll|msi|iso|pkg|dmg)$' OR filenames IS NOT NULL)) OR (LENGTH(sourcetypes) > 1 and http_host IS NOT NULL and sni IS NOT NULL and http_host != sni and NOT http_host like CONCAT('%.', sni))) and NOT (sni like '*.google.com' OR sni like '*.akamaiedge.net' OR sni like '*.amazonaws.com' OR sni like '*.azureedge.net' OR sni like '*.cloudflare.net' OR sni like '*.fastly.net' OR sni like '*.cloudfront.net' OR http_host like '*.google.com' OR http_host like '*.akamaiedge.net' OR http_host like '*.amazonaws.com' OR http_host like '*.azureedge.net' OR http_host like '*.cloudflare.net' OR http_host like '*.fastly.net' OR http_host like '*.cloudfront.net') | keep @timestamp, source.address, destination.address, destination.port, http_host, sni, content_type, uri, http_method","type":"esql","threat":[{"framework":"MITRE ATT&CK","tactic":{"id":"TA0011","name":"Command and Control","reference":"https://attack.mitre.org/tactics/TA0011/"},"technique":[{"id":"T1090","name":"Proxy","reference":"https://attack.mitre.org/techniques/T1090/"}, {"id":"T1090.003","name":"Domain Fronting","reference":"https://attack.mitre.org/techniques/T1090/003/"}]}, {"framework":"MITRE ATT&CK","tactic":{"id":"TA0008","name":"Lateral Movement","reference":"https://attack.mitre.org/tactics/TA0008/"}}],"interval":"10m","from":"now-10m","max_signals":100,"risk_score":85,"output_index":".alerts-security.alerts-default","meta":{},"version":1,"references":["https://www.elastic.co/guide/en/security/current/domain-fronting-activity-detected.html"],"tags":["Zeek","Domain Fronting","Network Traffic","Command and Control"],"actions":[],"throttle":"no_throttle","custom_query_fields":[],"event_group":"zeek.session_id, source.address, destination.address"}
