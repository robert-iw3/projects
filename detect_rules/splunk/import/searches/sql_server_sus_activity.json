[
  {
    "name": "SQL Server Threat Detection",
    "search": "`wineventlog_application` (EventCode=15457 OR EventCode=17135) | rex field=EventData \"<Data>(?<field1>[^<]+)</Data>(?:<Data>(?<field2>[^<]+)</Data>)?(?:<Data>(?<field3>[^<]+)</Data>)?\" | eval rule_name = case(EventCode=15457 AND field1 IN (\"xp_cmdshell\", \"Ole Automation Procedures\") AND field2=\"1\", \"High-Risk SQL Procedure Enabled\", EventCode=15457 AND field1=\"clr enabled\" AND field2=\"1\", \"SQL CLR Enabled\", EventCode=15457 AND field1=\"clr strict security\" AND field2=\"0\", \"SQL CLR Strict Security Disabled\", EventCode=17135 AND (lower(field1) LIKE \"%xp_%\" OR lower(field1) LIKE \"%sp_%\" OR lower(field1) LIKE \"%cmdshell%\" OR lower(field1) LIKE \"%shell%\" OR lower(field1) LIKE \"%exec%\"), \"Suspicious SQL Startup Procedure\"), details = case(EventCode=15457, \"Config: \" . field1 . \", Old Value: \" . field3 . \", New Value: \" . field2, EventCode=17135, \"Procedure: \" . field1), user=\"N/A (From Event Log)\", command=details, parent_process=\"sqlservr.exe\" | where isnotnull(rule_name) | rename host as dest | table _time, dest, user, rule_name, details, command, parent_process | append [ | tstats `security_content_summariesonly` count from datamodel=Endpoint.Processes where Processes.parent_process_name=\"sqlservr.exe\" AND Processes.process_name IN (\"cmd.exe\", \"powershell.exe\") by _time, Processes.dest, Processes.user, Processes.parent_process, Processes.process_name, Processes.process | `drop_dm_object_name(Processes)` | eval rule_name=\"SQL Server Spawning Shell\", details=process_name . \" spawned by sqlservr.exe.\", command=process, parent_process=parent_process | table _time, dest, user, rule_name, details, command, parent_process ] | append [ | tstats `security_content_summariesonly` count from datamodel=Endpoint.Processes where Processes.process_name=\"sqlcmd.exe\" AND (Processes.process=\"*xp_cmdshell*\" OR Processes.process=\"*sp_oacreate*\" OR Processes.process=\"*sp_add_trusted_assembly*\" OR Processes.process=\"*sp_configure*\" OR Processes.process=\"*OPENROWSET*\" OR Processes.process=\"*-o *\" OR Processes.process=\"*--outputfile*\" OR Processes.process=\"*http*//*\" OR Processes.process=\"*-t 0*\" OR Processes.process=\"*--query_timeout=0*\") by _time, Processes.dest, Processes.user, Processes.parent_process, Processes.process | `drop_dm_object_name(Processes)` | eval rule_name=\"Suspicious sqlcmd.exe Usage\", details=\"sqlcmd.exe executed with suspicious arguments.\", command=process, parent_process=parent_process | table _time, dest, user, rule_name, details, command, parent_process ] | append [ | tstats `security_content_summariesonly` count from datamodel=Endpoint.Filesystem where Filesystem.action=created Filesystem.file_name=*.dll Filesystem.file_path=\"*\\\\Microsoft SQL Server\\\\*\\\\MSSQL\\\\Binn\\\\*\" by _time, Filesystem.dest, Filesystem.user, Filesystem.file_name, Filesystem.file_path, Filesystem.process_name | `drop_dm_object_name(Filesystem)` | eval rule_name=\"Potential SQL CLR Assembly Loaded\", details=\"DLL \" . file_name . \" created in \" . file_path, command=file_name, parent_process=process_name | table _time, dest, user, rule_name, details, command, parent_process ] | append [ search `powershell_script_block_log` EventCode=4104 ScriptBlockText=\"*Invoke-Sqlcmd*\" AND (ScriptBlockText=\"*xp_cmdshell*\" OR ScriptBlockText=\"*sp_oacreate*\" OR ScriptBlockText=\"*sp_add_trusted_assembly*\" OR ScriptBlockText=\"*sp_configure*\" OR ScriptBlockText=\"*OPENROWSET*\" OR ScriptBlockText=\"*-QueryTimeout 0*\") | rename ComputerName as dest, ScriptBlockText as command | eval rule_name=\"Suspicious Invoke-Sqlcmd Usage\", details=\"PowerShell Invoke-Sqlcmd used with suspicious arguments.\", parent_process=\"powershell.exe\" | table _time, dest, user, rule_name, details, command, parent_process ]",
    "description": "Correlates events related to SQL Server attacks, including configuration changes (e.g., enabling xp_cmdshell, CLR), suspicious process spawns (sqlservr.exe, sqlcmd.exe), CLR assembly creation, and PowerShell abuse.",
    "is_scheduled": 1,
    "disabled": 0,
    "cron_schedule": "*/30 * * * *",
    "dispatch.earliest_time": "-24h",
    "dispatch.latest_time": "now",
    "sharing": "global",
    "acl": {
      "read": ["power", "admin"],
      "write": ["admin"]
    }
  }
]
