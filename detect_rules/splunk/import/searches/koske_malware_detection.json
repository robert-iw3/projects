[
  {
    "name": "Suspicious Linux Activity Associated with Koske Malware",
    "search": "| tstats `summariesonly` count from datamodel=Endpoint.Processes where (nodename=Processes) AND (\n    (Processes.process_name=\"grep\" AND (Processes.process=\"*|*sh\" OR Processes.process=\"*|*bash\"))\n    OR (Processes.process_name=\"systemctl\" AND Processes.process=\"* enable *.service\")\n    OR (Processes.process=\"*LD_PRELOAD=*\")\n    OR (Processes.process_name IN (\"curl\", \"wget\"))\n  ) by _time, Processes.dest, Processes.user, Processes.process_name, Processes.process, Processes.parent_process\n| `drop_dm_object_name(\"Processes\")`\n| eval detection_reason = case(\n    process_name=\"grep\", \"Polyglot Execution (grep | shell)\",\n    process_name=\"systemctl\", \"Persistence: Systemd Service Enabled\",\n    match(process, \"(?i)LD_PRELOAD=\"), \"Rootkit: LD_PRELOAD Env Var Used\",\n    process_name IN (\"curl\", \"wget\"), \"Suspicious C2 (curl/wget execution)\",\n    1=1, \"Unknown Process Behavior\"\n  )\n| rename process as event_detail\n| append [\n    | tstats `summariesonly` count from datamodel=Endpoint.Filesystem where (nodename=Filesystem) AND Filesystem.action IN (\"created\", \"modified\") AND (\n        Filesystem.file_path LIKE \"%/.bashrc\"\n        OR Filesystem.file_path=\"/etc/crontab\"\n        OR Filesystem.file_path LIKE \"/etc/cron.d/%\"\n        OR Filesystem.file_path LIKE \"/etc/systemd/system/%.service\"\n        OR Filesystem.file_path=\"/etc/ld.so.preload\"\n      ) by _time, Filesystem.dest, Filesystem.user, Filesystem.file_path, Filesystem.process_name\n    | `drop_dm_object_name(\"Filesystem\")`\n    | eval detection_reason = case(\n        file_path=\"/etc/ld.so.preload\", \"Rootkit: ld.so.preload Modified\",\n        1=1, \"Persistence: Common File Modified\"\n      )\n    | rename file_path as event_detail\n]\n| stats\n    values(detection_reason) as triggered_reasons,\n    values(event_detail) as event_details,\n    count by _time, dest, user\n| rename dest as host",
    "description": "This detection rule identifies multiple behaviors associated with the Koske malware on Linux systems. It combines several detection techniques into a single query, looking for polyglot file execution, persistence mechanism abuse, rootkit deployment, and suspicious C2 communications. An alert from this rule indicates one or more potentially malicious activities have occurred on a host and warrants investigation.",
    "is_scheduled": 1,
    "disabled": 0,
    "cron_schedule": "*/30 * * * *",
    "dispatch.earliest_time": "-24h",
    "dispatch.latest_time": "now",
    "sharing": "global",
    "acl": {
      "read": ["power", "admin"],
      "write": ["admin"]
    }
  }
]
