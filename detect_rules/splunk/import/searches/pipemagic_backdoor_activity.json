[
  {
    "name": "PipeMagic Detection Search",
    "search": "(index=* sourcetype IN (stream:http, pan:traffic, suricata, zeek, *sysmon*, *windows*)) ( (sha256 IN (\"dc54117b965674bad3d7cd203ecf5e7fc822423a3f692895cf5e96e83fb88f6a\", \"4843429e2e8871847bc1e97a0f12fa1f4166baa4735dff585cb3b4736e3fe49e\", \"297ea881aa2b39461997baf75d83b390f2c36a9a0a4815c81b5cf8be42840fd1\") OR file_hash IN (\"dc54117b965674bad3d7cd203ecf5e7fc822423a3f692895cf5e96e83fb88f6a\", \"4843429e2e8871847bc1e97a0f12fa1f4166baa4735dff585cb3b4736e3fe49e\", \"297ea881aa2b39461997baf75d83b390f2c36a9a0a4815c81b5cf8be42840fd1\")) OR (EventCode=17 AND match(PipeName, \"^\\\\.\\\\pipe\\\\1\\\\.[0-9a-fA-F]{32}$\")) OR (EventCode=3 AND (DestinationHostname=\"aaaaabbbbbbb.eastus.cloudapp.azure.com\" OR DestinationIp=\"127.0.0.1\") AND DestinationPort IN (443, 8082)) OR (match(url, \".*/[a-fA-F0-9]{16}$\") AND \"*Upgrade: websocket*\" AND \"*Connection: Upgrade*\") OR (EventCode=1 AND (Image LIKE \"%\\\\certutil.exe\" OR process_name=\"certutil.exe\") AND CommandLine LIKE \"%-urlcache%\" AND CommandLine LIKE \"%-f%\" AND (CommandLine LIKE \"%.tmp%\" OR CommandLine LIKE \"%.dat%\" OR CommandLine LIKE \"%.msbuild%\")) OR (EventCode=1 AND (ParentImage LIKE \"%\\\\msbuild.exe\" OR parent_process_name=\"msbuild.exe\") AND CommandLine LIKE \"%.mshi%\") OR (EventCode=10 AND TargetImage LIKE \"%\\\\lsass.exe\" AND SourceImage LIKE \"%\\\\dllhost.exe\")) | eval timestamp=strftime(_time, \"%Y-%m-%d %H:%M:%S\") | eval detection_clause=case((sha256 IN (\"dc54117b965674bad3d7cd203ecf5e7fc822423a3f692895cf5e96e83fb88f6a\", \"4843429e2e8871847bc1e97a0f12fa1f4166baa4735dff585cb3b4736e3fe49e\", \"297ea881aa2b39461997baf75d83b390f2c36a9a0a4815c81b5cf8be42840fd1\") OR file_hash IN (\"dc54117b965674bad3d7cd203ecf5e7fc822423a3f692895cf5e96e83fb88f6a\", \"4843429e2e8871847bc1e97a0f12fa1f4166baa4735dff585cb3b4736e3fe49e\", \"297ea881aa2b39461997baf75d83b390f2c36a9a0a4815c81b5cf8be42840fd1\")), \"PipeMagic File Hash IOC\", (EventCode=17 AND match(PipeName, \"^\\\\.\\\\pipe\\\\1\\\\.[0-9a-fA-F]{32}$\")), \"PipeMagic Named Pipe\", (EventCode=3 AND (DestinationHostname=\"aaaaabbbbbbb.eastus.cloudapp.azure.com\" OR DestinationIp=\"127.0.0.1\") AND DestinationPort IN (443, 8082)), \"PipeMagic C2 Connection\", (match(url, \".*/[a-fA-F0-9]{16}$\") AND \"*Upgrade: websocket*\" AND \"*Connection: Upgrade*\"), \"PipeMagic C2 HTTP Pattern\", (EventCode=1 AND (Image LIKE \"%\\\\certutil.exe\" OR process_name=\"certutil.exe\") AND CommandLine LIKE \"%-urlcache%\"), \"PipeMagic Certutil Download\", (EventCode=1 AND (ParentImage LIKE \"%\\\\msbuild.exe\" OR parent_process_name=\"msbuild.exe\") AND CommandLine LIKE \"%.mshi%\"), \"PipeMagic MSBuild Execution\", (EventCode=10 AND TargetImage LIKE \"%\\\\lsass.exe\" AND SourceImage LIKE \"%\\\\dllhost.exe\"), \"PipeMagic LSASS Access\", 1=1, \"Unknown PipeMagic Activity\") | eval process_name=coalesce(process_name, ProcessName, process), parent_process_name=coalesce(parent_process_name, ParentProcessName, parent_process), command_line=coalesce(CommandLine, ProcessCommandLine), file_hash=coalesce(sha256, file_hash, process_hash, Hashes), dest_host=coalesce(dest_host, DestinationHostname, RemoteUrl, url), dest_ip=coalesce(dest_ip, DestinationIp, RemoteIP), dest_port=coalesce(dest_port, DestinationPort, RemotePort), pipe_name=PipeName, source_image=SourceImage, target_image=TargetImage | table timestamp, detection_clause, host, user, process_name, parent_process_name, command_line, file_hash, dest_host, dest_ip, dest_port, pipe_name, source_image, target_image",
    "description": "Detects activity associated with the PipeMagic malware, based on file hashes, named pipes, C2 communication, and execution techniques.",
    "is_scheduled": 1,
    "disabled": 0,
    "cron_schedule": "*/30 * * * *",
    "dispatch.earliest_time": "-24h",
    "dispatch.latest_time": "now",
    "sharing": "global",
    "acl": {
      "read": ["power", "admin"],
      "write": ["admin"]
    }
  }
]
