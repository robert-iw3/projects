[
  {
    "name": "Silent Harvest Correlated Attack: WMI + Large Upload",
    "search": "(sourcetype=xmlwineventlog:microsoft-windows-sysmon/operational OR sourcetype=sysmon) EventCode IN (1, 3, 13)\n| eval event_type=case(EventCode=1 AND (ParentImage LIKE \"%\\\\WmiPrvSE.exe\"), \"wmi_child_process\", EventCode=13 AND (TargetObject LIKE \"%\\\\SAM\\\\%\" OR TargetObject LIKE \"%\\\\SECURITY\\\\%\") AND User!=\"NT AUTHORITY\\\\SYSTEM\", \"sensitive_reg_access\", EventCode=3 AND Direction=\"outbound\" AND Initiated=\"true\" AND SentBytes > 500000, \"large_upload\")\n| where isnotnull(event_type)\n| transaction host ProcessGuid maxspan=30m\n| where mvfind(event_type, \"sensitive_reg_access\") > -1\n| eval has_wmi_parent = if(mvfind(event_type, \"wmi_child_process\") > -1, \"Yes\", \"No\")\n| eval has_large_upload = if(mvfind(event_type, \"large_upload\") > -1, \"Yes\", \"No\")\n| where has_wmi_parent=\"Yes\" OR has_large_upload=\"Yes\"\n| where NOT (Image LIKE \"%\\\\outlook.exe\" OR Image LIKE \"%\\\\teams.exe\" OR Image LIKE \"%\\\\onedrive.exe\" OR Image LIKE \"%\\\\msedge.exe\" OR Image LIKE \"%\\\\chrome.exe\" OR Image LIKE \"%\\\\firefox.exe\" OR Image LIKE \"%\\\\gdrive.exe\" OR Image LIKE \"%\\\\dropbox.exe\" OR Image LIKE \"%\\\\Veeam.EndPoint.Service.exe\")\n| eval start_time = strftime(startTime, \"%Y-%m-%d %H:%M:%S\")\n| eval end_time = strftime(endTime, \"%Y-%m-%d %H:%M:%S\")\n| eval risk_description = \"Correlated Attack Pattern Detected: \" . mvindex(Image,0) . \" on \" . host . \" by user \" . mvindex(User,0) . \".\"\n| eval wmi_context = if(has_wmi_parent=\"Yes\", \" | Precursor: Process spawned by WMI.\", \"\")\n| eval exfil_context = if(has_large_upload=\"Yes\", \" | Follow-on: Large outbound data transfer observed.\", \"\")\n| eval risk_description = risk_description + wmi_context + exfil_context\n| table start_time, end_time, host, User, Image, CommandLine, has_wmi_parent, has_large_upload, risk_description, eventcount, duration",
    "description": "This search correlates Sysmon events to detect a potential correlated attack pattern involving WMI process spawning, sensitive registry access (like SAM/SECURITY hive), and large outbound data transfers, while filtering out benign processes.",
    "is_scheduled": 1,
    "disabled": 0,
    "cron_schedule": "*/30 * * * *",
    "dispatch.earliest_time": "-24h",
    "dispatch.latest_time": "now",
    "sharing": "global",
    "acl": {
      "read": ["power", "admin"],
      "write": ["admin"]
    }
  }
]
