### SAP NetWeaver CVE-2025-31324 Exploitation Report
---

A critical unrestricted file upload vulnerability, CVE-2025-31324, in SAP NetWeaver Visual Composer is being actively exploited to upload web shells and execute arbitrary code on affected servers. This allows adversaries to gain initial access, establish persistence, and deploy additional malicious tools like reverse shells, KrustyLoader, Supershell, and XMRig cryptocurrency miners.


Beyond the initial exploitation of CVE-2025-31324 for web shell deployment, recent observations indicate adversaries are leveraging this vulnerability to deploy a wider range of post-exploitation tools, including KrustyLoader and Supershell malware, often leading to cryptocurrency mining operations. This highlights an evolving threat where initial access is quickly leveraged for financial gain through cryptojacking.

### Actionable Threat Data
---

Monitor for process creation from known SAP processes that involve python and attempt to establish socket connections or execute shell commands, indicative of reverse shell activity (MITRE ATT&CK T1059.006, T1021.004).

Detect `curl` or `wget` commands downloading files into the `/tmp` directory, especially if followed by execution, as this is a common method for adversaries to stage and run additional tools (MITRE ATT&CK T1105).

Look for bash commands that include Base64 encoded strings, as this is a technique used for obfuscation and evasion of command-line monitoring (MITRE ATT&CK T1027).

Identify the presence of unexpected JSP files in SAP NetWeaver web application directories, specifically within `j2ee\cluster\apps\sap.com\irj\servlet_jsp\irj\root`, `j2ee\cluster\apps\sap.com\irj\servlet_jsp\irj\work`, and `j2ee\cluster\apps\sap.com\irj\servlet_jsp\irj\work\sync`, which could indicate successful web shell uploads (MITRE ATT&CK T1505.003).

Monitor network connections from SAP NetWeaver servers to unusual or known malicious IP addresses and domains associated with C2 infrastructure or malware distribution, such as those linked to `KrustyLoader`, `Supershell`, or `XMRig` (MITRE ATT&CK T1071.001, T1573.001).

### Python Reverse Shell
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: Python Reverse Shell Spawned from SAP Process
#   description: "Detects the execution of a Python reverse shell, a behavior observed as a post-exploitation technique following the compromise of SAP NetWeaver systems via CVE-2025-31324. The detection looks for Python processes spawned from known SAP parent processes that contain command-line arguments indicative of creating a network socket and launching a shell."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1059.006
#     - T1021.004
#   false_positives:
#     - Legitimate administrative or application scripts running under an SAP service might use Python for network communications. Review the script content and the context of the parent process to validate legitimacy. The list of SAP parent processes may need to be tuned for your specific environment.
#
(index=* OR sourcetype=*) `comment("This search leverages process execution logs from any source, mapped to the CIM.")`
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes
  `comment("Filter for python processes executing a command-line script (-c) with keywords indicative of a reverse shell (socket, connect, subprocess, os.dup2).")`
  where (Processes.process_name IN ("python*", "python3*"))
  AND Processes.process="*-c*"
  AND Processes.process="*socket*"
  AND Processes.process="*connect*"
  AND (Processes.process="*subprocess*" OR Processes.process="*os.dup2*")
  `comment("The key context is that the parent process is a known SAP process. This list may need to be tuned for your environment to reduce potential false positives from legitimate admin scripts.")`
  AND Processes.parent_process_name IN ("sapstartsrv*", "jstart*", "disp+work*")
  by Processes.dest, Processes.user, Processes.parent_process_name, Processes.process_name, Processes.process
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename dest as host, user as user, parent_process_name as parent_process, process_name as process, process as process_commandline
```

### Curl/Wget to /tmp
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: Curl or Wget Downloading to Tmp From SAP Process
#   description: "Detects the use of `curl` or `wget` to download a file into the `/tmp` directory, a common staging technique for additional payloads. This behavior is particularly suspicious when initiated by a known SAP process, as observed in post-exploitation activities related to CVE-2025-31324."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1105
#   false_positives:
#     - Legitimate administrative scripts running under an SAP service might use curl or wget to download files to /tmp for temporary processing. The list of SAP parent processes may need tuning. Investigate the downloaded file and its source to determine legitimacy.
#
(index=* OR sourcetype=*) `comment("This search leverages process execution logs from any source, mapped to the CIM.")`
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes
  `comment("Filter for curl or wget processes downloading a file to the /tmp directory.")`
  where (Processes.process_name IN ("curl", "wget"))
  AND Processes.process="*/tmp/*"
  `comment("The key context is that the parent process is a known SAP process. This list may need to be tuned for your environment.")`
  AND Processes.parent_process_name IN ("sapstartsrv*", "jstart*", "disp+work*")
  by Processes.dest, Processes.user, Processes.parent_process_name, Processes.process_name, Processes.process
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename dest as host, user as user, parent_process_name as parent_process, process_name as process, process as process_commandline
```

### Base64 Encoded Commands
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: Bash Execution of Base64 Encoded Commands from SAP Process
#   description: "Detects a shell process executing a Base64 encoded command. This is a common obfuscation technique used by adversaries to hide their commands from command-line logging. This behavior is particularly suspicious when initiated by a known SAP process, as observed in post-exploitation activities related to CVE-2025-31324."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1027
#     - T1059.004
#   false_positives:
#     - Legitimate, albeit uncommon, administrative scripts may use this technique for encoding sensitive data. The key context is the parent process; if this activity is not expected from an SAP service, it warrants investigation. The list of SAP parent processes may need tuning.
#
(index=* OR sourcetype=*) `comment("This search leverages process execution logs from any source, mapped to the CIM.")`
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Processes
  `comment("Filter for shell processes executing a command containing 'base64' and a decode flag.")`
  where Processes.process_name IN ("bash", "sh", "zsh")
  AND Processes.process="*base64*"
  AND (Processes.process IN ("* -d *", "* --decode *", "*{base64,-d}*"))
  `comment("Look for the decoded output being piped to another shell for execution, a strong indicator of malicious intent.")`
  AND (Processes.process IN ("*|*bash*", "*|*sh*", "*|*zsh*"))
  `comment("The key context is that the parent process is a known SAP process. This list may need to be tuned for your environment.")`
  AND Processes.parent_process_name IN ("sapstartsrv*", "jstart*", "disp+work*")
  by Processes.dest, Processes.user, Processes.parent_process_name, Processes.process_name, Processes.process
| `drop_dm_object_name(Processes)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename dest as host, user as user, parent_process_name as parent_process, process_name as process, process as process_commandline
```

### Unexpected JSP Files
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: Unexpected JSP File Creation in SAP Directory
#   description: "Detects the creation of new JSP (JavaServer Pages) files in specific SAP NetWeaver web application directories. This activity is a strong indicator of a web shell being uploaded, a common post-exploitation technique following the compromise of vulnerabilities like CVE-2025-31324."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1505.003
#   false_positives:
#     - Legitimate application deployments or patching activities could create new JSP files. However, such activities are typically planned. Unrecognized JSP files appearing in these directories warrant immediate investigation. It may be necessary to baseline the legitimate JSP files in these directories and alert on deviations.
#
(index=* OR sourcetype=*) `comment("This search leverages file system monitoring logs, mapped to the CIM.")`
| tstats `security_content_summariesonly` count values(Filesystem.file_hash) as file_hash min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem
  `comment("Filter for JSP file creation events.")`
  where Filesystem.file_name="*.jsp"
  `comment("Focus on specific SAP web directories known to be targeted for web shell uploads, covering both Windows and Linux path styles.")`
  AND (
    Filesystem.file_path IN (
      "*\\j2ee\\cluster\\apps\\sap.com\\irj\\servlet_jsp\\irj\\root\\*",
      "*\\j2ee\\cluster\\apps\\sap.com\\irj\\servlet_jsp\\irj\\work\\*",
      "*\\j2ee\\cluster\\apps\\sap.com\\irj\\servlet_jsp\\irj\\work\\sync\\*"
    ) OR
    Filesystem.file_path IN (
      "*/j2ee/cluster/apps/sap.com/irj/servlet_jsp/irj/root/*",
      "*/j2ee/cluster/apps/sap.com/irj/servlet_jsp/irj/work/*",
      "*/j2ee/cluster/apps/sap.com/irj/servlet_jsp/irj/work/sync/*"
    )
  )
  by Filesystem.dest, Filesystem.user, Filesystem.file_path, Filesystem.file_name
| `drop_dm_object_name(Filesystem)`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename dest as host, user as user, file_path as path, file_name as file
```

### Malicious IP Connections
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: SAP Post-Exploitation C2 Communication to Known Malicious IP
#   description: "Detects network traffic from internal hosts to known malicious IP addresses associated with post-exploitation activities following the compromise of SAP NetWeaver systems via CVE-2025-31324. This could indicate command and control (C2) communication or the download of additional malware."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1071.001
#     - T1573.001
#   false_positives:
#     - This rule is based on known malicious indicators and is expected to have a low false positive rate. However, an IP address could be reallocated or used by a legitimate service in the future. If a false positive is identified, consider adding the specific source/destination pair or application to an allow list.
#
(index=* OR sourcetype=*) `comment("This search leverages network traffic logs, mapped to the CIM.")`
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Traffic
  `comment("Filter for outbound network traffic to known malicious IP addresses associated with SAP exploitation.")`
  where All_Traffic.action=allowed AND All_Traffic.dest_ip IN ("5.161.153.112", "23.95.123.5")
  `comment("Exclude traffic destined for private IP space as a best practice, although the IOCs are public.")`
  AND `cidrmatch("0.0.0.0/8,10.0.0.0/8,127.0.0.0/8,169.254.0.0/16,172.16.0.0/12,192.168.0.0/16,224.0.0.0/4", dest_ip)=false`
  by All_Traffic.src, All_Traffic.dest_ip, All_Traffic.dest_port, All_Traffic.user, All_Traffic.process_name
| `drop_dm_object_name("All_Traffic")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename src as host, dest_ip as destination_ip, dest_port as destination_port, user as user, process_name as process
```

### Malicious Domain Connections
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: SAP Post-Exploitation C2 Communication to Malicious Domain
#   description: "Detects DNS queries for known malicious domains associated with post-exploitation activities following the compromise of SAP NetWeaver systems via CVE-2025-31324. This could indicate command and control (C2) communication or attempts to download additional malware."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1071.001
#     - T1573.001
#   false_positives:
#     - This rule is based on known malicious indicators. However, some of these domains (e.g., S3, Cloudflare) are on shared infrastructure, which could lead to false positives if the specific subdomain is used by a legitimate service. Additionally, domains can be sinkholed or re-purposed. If a false positive is identified, consider adding the specific source host to an allow list if the activity is confirmed benign.
#
(index=* OR sourcetype=*) `comment("This search leverages DNS query logs, mapped to the CIM.")`
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Network_Resolution
  `comment("Filter for DNS queries to known malicious domains associated with SAP exploitation.")`
  where DNS.query IN (
    "brandnav-cms-storage.s3.amazonaws.com",
    "abode-dashboard-media.s3.ap-south-1.amazonaws.com",
    "overseas-recognized-athens-oakland.trycloudflare.com",
    "ocr-freespace.oss-cn-beijing.aliyuncs.com",
    "devocional.click",
    "update.zoho-software.com"
  )
  by DNS.src, DNS.user, DNS.query, DNS.answer
| `drop_dm_object_name("DNS")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename src as host, user as user, query as domain_queried, answer as resolved_ip
```

### Malicious URL Downloads
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: SAP Post-Exploitation Malicious URL Download
#   description: "Detects network traffic to known malicious URLs associated with post-exploitation activities following the compromise of SAP NetWeaver systems via CVE-2025-31324. This activity indicates the staging of additional tools and malware, such as KrustyLoader, Supershell, or XMRig miners."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1105
#   false_positives:
#     - This rule is based on known malicious indicators and is expected to have a low false positive rate. However, a URL path on a legitimate domain (e.g., temp.sh) could be reused. If a false positive is identified, consider adding the specific source host to an allow list if the activity is confirmed benign.
#
(index=* OR sourcetype=*) `comment("This search leverages web proxy logs, mapped to the CIM.")`
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Web
  `comment("Filter for web requests to known malicious URLs associated with SAP exploitation.")`
  where Web.url IN (
    "*ocr-freespace.oss-cn-beijing.aliyuncs.com/2025/config.sh*",
    "*abode-dashboard-media.s3.ap-south-1.amazonaws.com/BCYVrrHX*",
    "*brandnav-cms-storage.s3.amazonaws.com:80/ZGHU5tVaLk*",
    "*overseas-recognized-athens-oakland.trycloudflare.com/v2.js*",
    "*23.95.123.5:666/xmrigCCall/8bq.sh*",
    "*devocional.click/download/forwardsap.jsp*",
    "*temp.sh/vvgtW/webhelper*",
    "*update.zoho-software.com:443/webhelper*"
  )
  by Web.src, Web.user, Web.url, Web.dest
| `drop_dm_object_name("Web")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename src as host, user as user, url as url_requested, dest as destination
```

### Malicious Filenames
---
```sql
#
# metadata:
#   date: 2025-07-24
#   name: SAP Post-Exploitation Malicious File Creation
#   description: "Detects the creation of files with names known to be associated with post-exploitation activities following the compromise of SAP NetWeaver systems via CVE-2025-31324. These files include web shells, downloaders, and other malicious scripts."
#   references:
#     - https://redcanary.com/blog/threat-intelligence/cve-2025-31324/
#   mitre_attack:
#     - T1505.003
#     - T1105
#   false_positives:
#     - "Some filenames like '1.sh', '0', or '1' are generic and could be created by legitimate scripts or user activity, especially in the /tmp directory. If false positives occur, consider adding more context, such as the parent process name (e.g., known SAP processes like 'jstart', 'sapstartsrv') or excluding known benign scripts."
#
(index=* OR sourcetype=*) `comment("This search leverages file system monitoring logs, mapped to the CIM.")`
| tstats `security_content_summariesonly` count min(_time) as firstTime max(_time) as lastTime from datamodel=Endpoint.Filesystem
  `comment("Filter for file creation events matching known malicious filenames.")`
  where (
    Filesystem.file_name IN (
      "config.sh", ".webhelper.jsp", ".h.jsp", "usage.jsp", "usage1.jsp",
      "helper.jsp", "404_error.jsp", "webhelp.jsp", "forwardsap.jsp", "1.sh"
    )
    `comment("For generic filenames, require them to be in the /tmp directory to reduce false positives.")`
    OR (
      (Filesystem.file_path="*/tmp" OR Filesystem.file_path="*\\tmp")
      AND Filesystem.file_name IN ("0", "1", "8bq.sh")
    )
  )
  by Filesystem.dest, Filesystem.user, Filesystem.file_path, Filesystem.file_name, Filesystem.process_name
| `drop_dm_object_name("Filesystem")`
| `security_content_ctime(firstTime)`
| `security_content_ctime(lastTime)`
| rename dest as host, user as user, file_path as path, file_name as file, process_name as process
```
