### Koske Malware: AI-Assisted Polyglot Threat
---

The Koske malware is a sophisticated Linux-based threat that leverages AI-generated code and polyglot image files to conduct stealthy cryptocurrency mining operations. It evades detection by hiding malicious payloads within seemingly benign images and executing code directly in memory, making it a significant challenge for traditional security measures.

Recent intelligence highlights Koske's advanced adaptive capabilities, including its use of AI to dynamically adjust its behavior, such as self-correcting C2 communication issues by altering proxy settings and DNS configurations. This AI-driven adaptability and the use of polyglot files for stealthy payload delivery represent a notable evolution in Linux malware, making it more resilient and harder to attribute.

### Actionable Threat Data
---

Monitor for the execution of grep piped to bash (e.g., grep -a -A9999 "# PAYLOAD" polyglot.jpg | bash), as this is a core technique used by Koske to execute embedded payloads from polyglot files.

Detect unusual modifications to system persistence mechanisms, such as .bashrc, crontab entries, or the creation of new systemd services, which Koske abuses to maintain access.

Look for the creation or modification of /etc/ld.so.preload or the use of the LD_PRELOAD environment variable, as Koske deploys rootkits using this technique to hide its presence.

Identify suspicious network connections initiated by curl or wget to unusual or newly observed IP addresses or domains, especially when originating from temporary directories or unexpected processes, indicating C2 communication or payload download.

Monitor for sudden and sustained spikes in CPU or GPU utilization on Linux systems, which could indicate the presence of unauthorized cryptocurrency mining activity.

### Combined Analysis Search
---
```sql
-- Name: Suspicious Linux Activity Associated with Koske Malware
-- Author: RW
-- Date: 2025-08-24
-- Description: This detection rule identifies multiple behaviors associated with the Koske malware on Linux systems. It combines several detection techniques into a single query, looking for polyglot file execution, persistence mechanism abuse, rootkit deployment, and suspicious C2 communications. An alert from this rule indicates one or more potentially malicious activities have occurred on a host and warrants investigation.
-- Data Source Requirements: This query requires Linux process execution and file modification events, mapped to the Splunk Common Information Model (CIM) Endpoint data model. Ensure that data from sources like auditd, Sysmon for Linux, or other EDRs is available and CIM-compliant.

-- TTP 1: Polyglot Execution, Persistence, and Rootkit behavior identified through process execution events.
| tstats `summariesonly` count from datamodel=Endpoint.Processes where (nodename=Processes) AND (
    -- Looks for grep piping its output to a shell, a technique to execute embedded payloads.
    (Processes.process_name="grep" AND (Processes.process="*|*sh" OR Processes.process="*|*bash"))
    -- Looks for systemctl enabling a new service for persistence.
    OR (Processes.process_name="systemctl" AND Processes.process="* enable *.service")
    -- Looks for the LD_PRELOAD environment variable being used to load a malicious library.
    OR (Processes.process="*LD_PRELOAD=*")
    -- Looks for execution of curl or wget, which could be used for C2 or to download additional payloads.
    OR (Processes.process_name IN ("curl", "wget"))
  ) by _time, Processes.dest, Processes.user, Processes.process_name, Processes.process, Processes.parent_process
| `drop_dm_object_name("Processes")`
| eval detection_reason = case(
    process_name="grep", "Polyglot Execution (grep | shell)",
    process_name="systemctl", "Persistence: Systemd Service Enabled",
    match(process, "(?i)LD_PRELOAD="), "Rootkit: LD_PRELOAD Env Var Used",
    process_name IN ("curl", "wget"), "Suspicious C2 (curl/wget execution)",
    1=1, "Unknown Process Behavior"
  )
| rename process as event_detail

| append [
    -- TTP 2: Persistence and Rootkit behavior identified through file system modifications.
    | tstats `summariesonly` count from datamodel=Endpoint.Filesystem where (nodename=Filesystem) AND Filesystem.action IN ("created", "modified") AND (
        -- Detects modification of common persistence files.
        Filesystem.file_path LIKE "%/.bashrc"
        OR Filesystem.file_path="/etc/crontab"
        OR Filesystem.file_path LIKE "/etc/cron.d/%"
        OR Filesystem.file_path LIKE "/etc/systemd/system/%.service"
        -- Detects modification of the ld.so.preload file, a common rootkit technique.
        OR Filesystem.file_path="/etc/ld.so.preload"
      ) by _time, Filesystem.dest, Filesystem.user, Filesystem.file_path, Filesystem.process_name
    | `drop_dm_object_name("Filesystem")`
    | eval detection_reason = case(
        file_path="/etc/ld.so.preload", "Rootkit: ld.so.preload Modified",
        1=1, "Persistence: Common File Modified"
      )
    | rename file_path as event_detail
]

-- FP Tuning: This is a broad search and may require tuning. Filter out known benign activities, such as those from configuration management tools (Puppet, Ansible), legitimate software updaters, or administrator scripts.
-- Example: | where NOT (user IN (\"puppet\", \"ansible\") OR parent_process IN (\"yum\", \"apt-get\"))

-- Aggregate all findings by host and user for a consolidated alert. Note: High CPU/GPU usage from cryptomining is best detected with a separate, threshold-based rule that monitors performance metrics.
| stats
    values(detection_reason) as triggered_reasons,
    values(event_detail) as event_details,
    count by _time, dest, user
| rename dest as host
```