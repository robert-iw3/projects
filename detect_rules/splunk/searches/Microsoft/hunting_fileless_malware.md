### Hunting Fileless Malware in the Windows Registry
---

This report details techniques used by fileless malware to leverage the Windows Registry for payload staging and persistence, emphasizing the use of Living Off the Land Binaries (LOLBins). It outlines various detection strategies, including statistical analysis and behavioral correlation, to identify anomalous registry activities indicative of fileless threats.

Recent intelligence highlights the continued evolution of fileless malware, with new JavaScript-based Remote Access Trojans (RATs) like DarkWatchman utilizing the Windows Registry for nearly all temporary and permanent storage operations, including storing lightweight keyloggers, to evade detection. This represents a significant advancement in fileless techniques, as it minimizes disk artifacts even further than previously observed.

### Actionable Threat Data
---

Monitor for registry value data written by LOLBins (powershell.exe, reg.exe, wscript.exe, cscript.exe, mshta.exe, rundll32.exe) that exhibit unusually long lengths, potentially indicating encoded or obfuscated payloads. (T1027.011)

Detect registry write operations by common LOLBins to HKEY_CURRENT_USER keys that contain long hexadecimal strings, which may signify staged shellcode or other malicious data. (T1027.011)

Identify suspicious registry writes by LOLBins to HKEY_CURRENT_USER where the RegistryValueData is a large, contiguous string without spaces, suggesting encoded blobs or configuration data. (T1027.011)

Look for instances where LOLBins capable of direct registry modification are spawned by indirect parent processes such as WmiPrvSE.exe, svchost.exe, schtasks.exe, taskhostw.exe, services.exe, or dllhost.exe, as this can indicate fileless persistence or staged payload delivery. (T1546, T1047)

Implement detection for bursts of registry write activity from LOLBins within short timeframes (e.g., 1-minute windows) to identify rapid modification of multiple registry keys, which can be indicative of scripting activity or multi-key payload delivery. (T1027.011)

### LOLBins Write Long Registry Values
---
```sql
--
-- LOLBins Writing Unusually Long Registry Values
--
-- Description: Detects when a common LOLBin (Living Off the Land Binary) writes a value to the HKEY_CURRENT_USER (HKCU) registry hive that is statistically longer than its typical behavior. Adversaries may store encoded payloads (Base64, hex) or configuration data in the registry to support fileless execution. This rule establishes a 30-day baseline of registry write lengths for each LOLBin and flags new writes that exceed a threshold of 2 standard deviations above the average length.
--
-- Author: Rob Weber
-- Date: 2025-07-27
--
-- MITRE ATT&CK: T1027.011 (Obfuscated Files or Information: Encrypted/Encoded File)
--
-- False Positives:
--   - Legitimate software installers or updaters may write large configuration blobs to the registry.
--   - Some applications may store user-specific data or tokens that are unusually long.
--   - It is recommended to tune the `stdev_threshold` or add specific process_name and registry_path exclusions to the `lolbins_writing_unusually_long_registry_values_filter` macro based on environment-specific activity.
--
-- Data Source:
--   - This query is written for the Splunk Common Information Model (CIM) and is compatible with any EDR or Sysmon data mapped to the 'Registry' data model.
--
`comment("The main search retrieves recent (last hour) registry write events by known LOLBins to HKCU.")`
| tstats summariesonly=true allow_old_summaries=true values(All_Registry.registry_path) as registry_path, values(All_Registry.registry_value_name) as registry_value_name, values(All_Registry.registry_value_data) as registry_value_data from datamodel=Registry where All_Registry.action="set" AND (All_Registry.process_name IN ("powershell.exe", "pwsh.exe", "powershell_ise.exe", "reg.exe", "wscript.exe", "cscript.exe", "mshta.exe", "rundll32.exe")) AND (match(All_Registry.registry_path, "(?i)HKEY_CURRENT_USER|HKCU")) earliest=-1h@h by _time, All_Registry.dest, All_Registry.user, All_Registry.process_name
| rename "All_Registry.*" as *
| eval data_len = len(registry_value_data)
| where data_len > 50 `comment("Filter out very small, common registry writes to improve performance.")`

`comment("The subsearch calculates the historical average and standard deviation of registry write lengths for each LOLBin over the last 30 days.")`
| join type=left process_name [
    | tstats summariesonly=true allow_old_summaries=true count from datamodel=Registry where All_Registry.action="set" AND (All_Registry.process_name IN ("powershell.exe", "pwsh.exe", "powershell_ise.exe", "reg.exe", "wscript.exe", "cscript.exe", "mshta.exe", "rundll32.exe")) AND (match(All_Registry.registry_path, "(?i)HKEY_CURRENT_USER|HKCU")) earliest=-30d@d latest=-1h@h by All_Registry.process_name, All_Registry.registry_value_data
    | rename "All_Registry.*" as *
    | eval data_len = len(registry_value_data)
    | where data_len > 0
    | stats avg(data_len) as avg_len, stdev(data_len) as stdev_len, count by process_name
    | where count > 10 `comment("Ensure baseline is built on a meaningful number of events.")`
]
| where isnotnull(avg_len)

`comment("Compare the length of recent writes to the historical baseline and flag outliers.")`
| eval stdev_threshold = 2.0 `comment("Medium sensitivity threshold. Increase to 3 for High, decrease to 1 for Low.")`
| eval threshold_value = avg_len + (stdev_threshold * stdev_len)
| where data_len > threshold_value
| eval deviation_level=printf("%.1f", (data_len - avg_len)/stdev_len)
| table _time, dest, user, process_name, registry_path, registry_value_name, data_len, avg_len, stdev_len, deviation_level, registry_value_data
| `lolbins_writing_unusually_long_registry_values_filter`
```

### LOLBins Write Hex Registry Values
---
```sql
--
-- LOLBins Writing Hexadecimal Data to Registry
--
-- Description: Detects when a common LOLBin (Living Off the Land Binary) writes a long hexadecimal string to the HKEY_CURRENT_USER (HKCU) registry hive. Adversaries may stage shellcode or other encoded payloads as hex strings in the registry to support fileless execution.
--
-- Author: Rob Weber
-- Date: 2025-07-27
--
-- MITRE ATT&CK: T1027.011 (Obfuscated Files or Information: Encrypted/Encoded File)
--
-- False Positives:
--   - Legitimate applications may store configuration data, tokens, or unique identifiers as hexadecimal strings.
--   - It is recommended to tune the length threshold in the `where match(...)` command (e.g., `{30,}`) or add exclusions to the filter macro based on common activity in your environment.
--
-- Data Source:
--   - This query is written for the Splunk Common Information Model (CIM) and is compatible with any EDR or Sysmon data mapped to the 'Registry' data model.
--
`comment("Search for registry set events from known LOLBins targeting the HKCU hive.")`
| tstats summariesonly=true allow_old_summaries=true values(All_Registry.registry_path) as registry_path, values(All_Registry.registry_value_name) as registry_value_name, values(All_Registry.registry_value_data) as registry_value_data from datamodel=Registry
  where All_Registry.action="set"
  AND (All_Registry.process_name IN ("powershell.exe", "pwsh.exe", "powershell_ise.exe", "reg.exe", "wscript.exe", "cscript.exe", "mshta.exe", "rundll32.exe"))
  AND (match(All_Registry.registry_path, "(?i)HKEY_CURRENT_USER|HKCU"))
  earliest=-24h@h
  by _time, All_Registry.dest, All_Registry.user, All_Registry.process_name
| rename "All_Registry.*" as *

`comment("Filter for events where the registry value contains a long hexadecimal string (e.g., 30+ characters).")`
| where isnotnull(registry_value_data) AND match(registry_value_data, "(?i)\b(0x)?[a-f0-9]{30,}\b")

`comment("Format the results for analysis.")`
| eval data_len = len(registry_value_data)
| table _time, dest, user, process_name, registry_path, registry_value_name, data_len, registry_value_data
| `lolbins_writing_hex_registry_values_filter`
```

### LOLBins Write Blob Registry Values
---
```sql
--
-- LOLBins Writing Blob Data to Registry
--
-- Description: Detects when a common LOLBin (Living Off the Land Binary) writes a large, contiguous string without spaces to the HKEY_CURRENT_USER (HKCU) registry hive. This pattern is often indicative of encoded payloads (e.g., Base64), shellcode, or configuration data staged by fileless malware to evade detection.
--
-- Author: Rob Weber
-- Date: 2025-07-27
--
-- MITRE ATT&CK: T1027.011 (Obfuscated Files or Information: Encrypted/Encoded File)
--
-- False Positives:
--   - Legitimate software installers or applications may write large configuration blobs or license keys to the registry.
--   - It is recommended to tune the length threshold in the `where data_len > 100` command or add process and path exclusions to the filter macro based on common activity in your environment.
--
-- Data Source:
--   - This query is written for the Splunk Common Information Model (CIM) and is compatible with any EDR or Sysmon data mapped to the 'Registry' data model.
--
`comment("Search for registry set events from known LOLBins targeting the HKCU hive.")`
| tstats summariesonly=true allow_old_summaries=true values(All_Registry.registry_path) as registry_path, values(All_Registry.registry_value_name) as registry_value_name, values(All_Registry.registry_value_data) as registry_value_data from datamodel=Registry
  where All_Registry.action="set"
  AND (All_Registry.process_name IN ("powershell.exe", "pwsh.exe", "powershell_ise.exe", "reg.exe", "wscript.exe", "cscript.exe", "mshta.exe", "rundll32.exe"))
  AND (match(All_Registry.registry_path, "(?i)HKEY_CURRENT_USER|HKCU"))
  earliest=-24h@h
  by _time, All_Registry.dest, All_Registry.user, All_Registry.process_name
| rename "All_Registry.*" as *

`comment("Filter for events where the registry value is a large, space-less string (blob).")`
| eval data_len = len(registry_value_data)
| where data_len > 100 AND NOT match(registry_value_data, " ")

`comment("Format the results for analysis.")`
| table _time, dest, user, process_name, registry_path, registry_value_name, data_len, registry_value_data
| `lolbins_writing_blob_registry_values_filter`
```

### Indirect Registry Modification by LOLBins
---
```sql
--
-- Indirect Registry Modification by LOLBins
--
-- Description: Detects when a LOLBin (Living Off the Land Binary) modifies a registry key when spawned by a parent process associated with indirect execution. Parent processes such as WmiPrvSE.exe, svchost.exe, and schtasks.exe are often used by adversaries to establish persistence or execute payloads non-interactively, making their child processes' registry modifications highly suspicious. This activity is a common pattern for fileless persistence and staged payload delivery.
--
-- Author: Rob Weber
-- Date: 2025-07-27
--
-- MITRE ATT&CK:
--   - T1047: Windows Management Instrumentation
--   - T1053.005: Scheduled Task/Job: Scheduled Task
--   - T1543.003: Create or Modify System Process: Windows Service
--   - T1546: Compromise Client Software Binary
--
--
-- False Positives:
--   - Legitimate system administration scripts or software deployment tools (e.g., SCCM) may use WMI or scheduled tasks to configure applications, which can result in registry modifications by LOLBins.
--   - It is recommended to baseline normal administrative activity and add exclusions for known parent-child process relationships or specific registry paths to the filter macro.
--
-- Data Source:
--   - This query is written for the Splunk Common Information Model (CIM) and is compatible with any EDR or Sysmon data mapped to the 'Endpoint' data model.
--
`comment("Search for registry modification events, including parent process information.")`
| tstats summariesonly=true allow_old_summaries=true values(All_Registry.process) as process, values(All_Registry.registry_path) as registry_path, values(All_Registry.registry_value_name) as registry_value_name, values(All_Registry.registry_value_data) as registry_value_data from datamodel=Endpoint.Registry where All_Registry.action="set" by _time, All_Registry.dest, All_Registry.user, All_Registry.parent_process_name, All_Registry.process_name
| rename "All_Registry.*" as *

`comment("Filter for LOLBins spawned by parent processes associated with indirect execution (WMI, Services, Tasks).")`
| where parent_process_name IN ("WmiPrvSE.exe", "svchost.exe", "schtasks.exe", "taskhostw.exe", "services.exe", "dllhost.exe")
  AND process_name IN ("powershell.exe", "pwsh.exe", "powershell_ise.exe", "reg.exe", "wscript.exe", "cscript.exe", "mshta.exe", "rundll32.exe")

`comment("Focus on user-land registry keys, a common target for non-elevated persistence.")`
| where match(registry_path, "(?i)HKEY_CURRENT_USER|HKCU")

`comment("Format the results for analysis.")`
| table _time, dest, user, parent_process_name, process_name, process, registry_path, registry_value_name, registry_value_data
| `indirect_registry_modification_by_lolbins_filter`
```

### LOLBins Registry Write Bursts
---
```sql
--
-- LOLBins Registry Write Bursts
--
-- Description: Detects when a LOLBin (Living Off the Land Binary) rapidly modifies multiple registry keys under HKEY_CURRENT_USER (HKCU) within a short time frame (e.g., 1 minute). This "burst" activity is often indicative of automated scripting used for fileless persistence, configuration staging, or multi-key payload delivery, which are common tactics in fileless attacks.
--
-- Author: Rob Weber
-- Date: 2025-07-27
--
-- MITRE ATT&CK: T1027.011 (Obfuscated Files or Information: Encrypted/Encoded File)
--
-- False Positives:
--   - Legitimate software installers, updaters, or configuration scripts can perform burst writes to the registry.
--   - It is recommended to tune the `write_count` threshold and add exclusions for known benign processes or registry path patterns to the filter macro.
--
-- Data Source:
--   - This query is written for the Splunk Common Information Model (CIM) and is compatible with any EDR or Sysmon data mapped to the 'Registry' data model.
--
`comment("Use tstats to efficiently pre-aggregate registry write events in 1-minute buckets.")`
| tstats summariesonly=true allow_old_summaries=true count from datamodel=Registry
  where All_Registry.action="set"
  AND (All_Registry.process_name IN ("powershell.exe", "pwsh.exe", "powershell_ise.exe", "reg.exe", "wscript.exe", "cscript.exe", "mshta.exe", "rundll32.exe"))
  AND (match(All_Registry.registry_path, "(?i)HKEY_CURRENT_USER|HKCU"))
  by _time span=1m, All_Registry.dest, All_Registry.process_name, All_Registry.registry_path, All_Registry.registry_value_name
| rename "All_Registry.*" as *

`comment("Group the events by the 1-minute bucket, host, and process to count the writes and collect details.")`
| stats count as write_count, dc(registry_path) as distinct_paths, values(registry_path) as modified_paths, values(registry_value_name) as modified_value_names by _time, dest, process_name

`comment("Filter for bursts exceeding a defined threshold. Tune as needed for your environment.")`
| where write_count > 5

`comment("Format the results for analysis.")`
| rename _time as burst_time
| table burst_time, dest, process_name, write_count, distinct_paths, modified_paths, modified_value_names
| `lolbins_registry_write_bursts_filter`
```