### Common Industrial Protocol (CIP) Exploits and Detections
---

This report summarizes the Common Industrial Protocol (CIP) and associated vulnerabilities, focusing on how these can be exploited in Industrial Control Systems (ICS) environments. It highlights the importance of understanding CIP's role in ICS and the potential for significant impacts from successful exploits, including risks to human safety, the environment, and physical infrastructure.

Recent intelligence indicates a continued rise in cyberattacks targeting ICS, with a significant increase in adversarial reconnaissance against industrial protocols like Modbus/TCP. Furthermore, new Critical Infrastructure Protection (CIP) standards are being introduced in 2024 and 2025, emphasizing enhanced visibility and real-time contextual awareness for proactive defense against evolving threats.

### Actionable Threat Data
---

Monitor for anomalous CIP traffic patterns: Implement anomaly detection techniques to identify deviations from normal CIP communication behavior, such as unusual service requests, unexpected class/instance/attribute access, or abnormal data sizes. This can help detect fuzzing attempts or other malicious interactions with CIP devices.

Detect malformed CIP packets: Look for CIP packets that do not conform to the protocol specification, especially those with unusual lengths, invalid object paths, or unexpected data in fields. Such malformed packets can indicate attempts to trigger denial-of-service conditions or memory corruption vulnerabilities.

Identify unauthorized CIP service requests: Establish a baseline of expected CIP service requests for each device and alert on any requests that fall outside this baseline. This includes monitoring for "Get All Attributes" (0x01) or "Get Attribute List" (0x03) services from unexpected sources, which could indicate reconnaissance or fuzzing activities.

Monitor for CIP communication with internet-facing ICS devices: Actively monitor and alert on any CIP communication originating from or destined for internet-facing ICS devices, as this significantly increases the attack surface and is a common vector for exploitation.

Track changes to CIP device configurations: Implement monitoring for unauthorized changes to CIP device configurations, including firmware updates or modifications to operational parameters, which could indicate a compromise.

### Search
---
```sql
-- Name: CIP Class Fuzzing Attempt
-- Author: RW
-- Date: 2025-08-17
-- Description: Detects a potential Common Industrial Protocol (CIP) class fuzzing attempt. This technique, as described in the provided intelligence, involves sending 'Get Attribute List' (0x03) requests to the static class instance (0x00) for a wide range of class IDs to discover supported classes on a target device. This is a form of anomalous traffic indicative of reconnaissance.
-- References:
-- - https://github.com/ICSVillage
-- False Positive Sensitivity: Medium
-- Tags: ICS, CIP, EtherNet/IP, Reconnaissance, Fuzzing, Anomalous Traffic

-- Data Source: Logs from OT security tools (e.g., Zeek, Nozomi) with parsed CIP fields.
-- Query Strategy: Search for cip_service:0x03 and cip_instance:0x00, aggregate by source IP and time window, and alert on high distinct class counts.
-- False Positive Tuning: Exclude known engineering IPs using tags or filters.

logs(
  source:network
  network.protocol:(CIP OR EtherNet/IP)
  cip_service:(3 OR 0x03)
  cip_instance:(0 OR 0x00)
  @host:(ics* OR plc* OR controllogix*)
)
| group by network.src_ip, @timestamp within 15m
| select
    min(@timestamp) as StartTime,
    max(@timestamp) as EndTime,
    network.src_ip as SourceIp,
    count_distinct(cip_class) as FuzzedClassCount,
    count_distinct(network.dest_ip) as TargetedDeviceCount,
    values(cip_class) as SampleFuzzedClasses,
    values(network.dest_ip) as SampleTargetedDevices
| where FuzzedClassCount > 20
| display StartTime, EndTime, SourceIp, FuzzedClassCount, TargetedDeviceCount, SampleFuzzedClasses, SampleTargetedDevices
```
---
```sql
-- Name: Malformed CIP Packet Detection
-- Author: RW
-- Date: 2025-08-17
-- Description: Detects malformed Common Industrial Protocol (CIP) packets based on alerts from an OT security monitoring tool. These can indicate attempts to trigger denial-of-service, cause memory corruption, or exploit vulnerabilities in the target device's protocol stack.
-- False Positive Sensitivity: Medium
-- Tags: ICS, CIP, EtherNet/IP, Denial of Service, Exploitation

-- Data Source: Logs from OT security tools (e.g., Dragos, Claroty) with alert names indicating malformed packets.
-- Query Strategy: Search for alerts with keywords like “malformed” or specific CIP violations, aggregate by source and destination IPs.
-- False Positive Tuning: Filter for ICS devices and exclude known non-standard CIP implementations.

logs(
  source:ot_security
  (alert.name:(*malformed* OR *violation* OR *illegal*) AND network.protocol:(CIP OR EtherNet/IP))
  OR alert.name:("Invalid CIP Packet Length" OR "Invalid CIP Service" OR "CIP Protocol Anomaly" OR "Disallowed Function in CIP")
  @host:(ics* OR plc* OR controllogix*)
)
| group by network.src_ip, network.dest_ip, alert.dest_device_name
| select
    min(@timestamp) as FirstSeen,
    max(@timestamp) as LastSeen,
    network.src_ip as SourceIp,
    network.dest_ip as DestinationIp,
    alert.dest_device_name as DestinationDevice,
    count as AlertCount,
    values(alert.name) as DistinctAlertNames
| display FirstSeen, LastSeen, SourceIp, DestinationIp, DestinationDevice, AlertCount, DistinctAlertNames
```
---
```sql
-- Name: Unauthorized CIP Service Requests
-- Author: RW
-- Date: 2025-08-17
-- Description: Detects reconnaissance and fuzzing activity targeting Industrial Control Systems (ICS). The rule identifies Common Industrial Protocol (CIP) "Get All Attributes" (0x01) and "Get Attribute List" (0x03) service requests originating from sources not on an allowlist of known management or engineering hosts.
-- References:
-- - https://github.com/ICSVillage
-- False Positive Sensitivity: Medium
-- Tags: ICS, CIP, EtherNet/IP, Reconnaissance, TTPs

-- Data Source: CIP/EtherNet/IP traffic logs from OT monitoring tools.
-- Query Strategy: Filter for cip_service:(0x01 OR 0x03), exclude authorized management IPs, and summarize by source IP.
-- False Positive Tuning: Use a tag-based allowlist for engineering workstations.

logs(
  source:network
  network.protocol:(CIP OR EtherNet/IP)
  cip_service:(1 OR 0x01 OR 3 OR 0x03)
  @host:(ics* OR plc* OR controllogix*)
  -network.src_ip:(@known_management_hosts)
)
| group by network.src_ip
| select
    min(@timestamp) as StartTime,
    max(@timestamp) as EndTime,
    network.src_ip as SourceIp,
    count as RequestCount,
    values(network.dest_ip) as TargetedDevices,
    values(cip_service) as ServicesUsed
| display StartTime, EndTime, SourceIp, RequestCount, TargetedDevices, ServicesUsed
```
---
```sql
-- Name: CIP Communication with Internet-Facing Device
-- Author: RW
-- Date: 2025-08-17
-- Description: Detects Common Industrial Protocol (CIP) traffic between an internal, private IP address (assumed ICS device) and a public, internet-routable IP address. Exposing ICS devices and protocols directly to the internet is a significant security risk and a common vector for exploitation.
-- False Positive Sensitivity: Medium
-- Tags: ICS, CIP, EtherNet/IP, TTPs, Initial Access, Internet-Exposed

-- Data Source: Datadog Network Performance Monitoring (NPM) or network logs.
-- Query Strategy: Filter for CIP traffic (port 44818), identify private vs. public IPs, and exclude authorized public IPs.
-- False Positive Tuning: Use a tag-based allowlist for authorized vendor IPs.

logs(
  source:network
  network.protocol:(CIP OR EtherNet/IP)
  (network.dest_port:44818 OR network.src_port:44818)
  @host:(ics* OR plc* OR controllogix*)
)
| eval
    src_is_private = case(
      network.src_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) => 1,
      true => 0
    ),
    dest_is_private = case(
      network.dest_ip:(10.0.0.0/8 OR 172.16.0.0/12 OR 192.168.0.0/16) => 1,
      true => 0
    )
| where src_is_private != dest_is_private
| eval
    IcsDeviceIp = case(src_is_private = 1 => network.src_ip, true => network.dest_ip),
    PublicIp = case(src_is_private = 0 => network.src_ip, true => network.dest_ip),
    ConnectionDirection = case(network.dest_port = 44818 => "Inbound to ICS", true => "Outbound from ICS")
| where -PublicIp:(@authorized_public_ips)
| group by IcsDeviceIp, PublicIp, ConnectionDirection
| select
    min(@timestamp) as StartTime,
    max(@timestamp) as EndTime,
    IcsDeviceIp,
    PublicIp,
    ConnectionDirection,
    count as EventCount,
    values(network.src_device_name) as ReportedDeviceName
| display StartTime, EndTime, IcsDeviceIp, PublicIp, ConnectionDirection, EventCount, ReportedDeviceName
```
---
```sql
-- Name: Unauthorized CIP Device Configuration Change
-- Author: RW
-- Date: 2025-08-17
-- Description: Detects alerts related to Common Industrial Protocol (CIP) device configuration changes originating from a source IP not on the authorized list. Such changes can include firmware updates, PLC program downloads, or operational mode changes (e.g., RUN to STOP), and may indicate a compromise or unauthorized activity within the ICS environment.
-- False Positive Sensitivity: Medium
-- Tags: ICS, CIP, EtherNet/IP, Persistence, Impact, TTPs

-- Data Source: OT security tool alerts (e.g., Defender for IoT, Dragos).
-- Query Strategy: Filter for configuration change alerts, exclude authorized sources, and summarize by source IP and protocol.
-- False Positive Tuning: Maintain an allowlist for engineering workstations.

logs(
  source:ot_security
  alert.name:("Configuration Change" OR "Firmware Update" OR "Program Download" OR "PLC Mode Change" OR "PLC Stop Command Detected" OR "Unauthorized PLC Programming")
  @host:(ics* OR plc* OR controllogix*)
  -network.src_ip:(@authorized_change_sources)
)
| group by network.src_ip, network.protocol
| select
    min(@timestamp) as StartTime,
    max(@timestamp) as EndTime,
    network.src_ip as SourceIp,
    values(alert.dest_device) as TargetedDevices,
    network.protocol as Protocol,
    count as AlertCount,
    values(alert.name) as DistinctAlerts
| display StartTime, EndTime, SourceIp, TargetedDevices, Protocol, AlertCount, DistinctAlerts
```