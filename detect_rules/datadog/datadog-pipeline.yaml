name: Datadog Rule Import Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * *' # Daily at midnight UTC

jobs:
  test-and-import:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml==6.0.2 datadog-api-client==2.25.0 urllib3==2.2.3 jsonschema==4.23.0 coverage==7.6.1

      - name: Run Unit Tests with Coverage
        run: |
          coverage run --source=. --omit="*/test_*.py" test_datadog_rule_conversion.py
          coverage json -o coverage.json
          coverage report
        continue-on-error: false
        env:
          PYTHONPATH: .

      - name: Summarize Test Results
        if: always()
        run: |
          echo "## Test Metrics Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f test_metrics.json ]; then
            cat test_metrics.json >> $GITHUB_STEP_SUMMARY
          else
            echo "No test metrics generated" >> $GITHUB_STEP_SUMMARY
          fi
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          if [ -f coverage.json ]; then
            jq . coverage.json >> $GITHUB_STEP_SUMMARY
          else
            echo "No coverage report generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run Conversion and Import (Dry-Run)
        env:
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          DD_APP_KEY: ${{ secrets.DD_APP_KEY }}
          DD_DRY_RUN: true
        run: |
          python datadog_rule_converter.py

      - name: Run Conversion and Import
        env:
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          DD_APP_KEY: ${{ secrets.DD_APP_KEY }}
          DD_DRY_RUN: false
        run: |
          python datadog_rule_converter.py

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: conversion-results
          path: |
            signal_correlation_rules/*.json
            conversion_summary.json
            import_summary.json
            test_metrics.json
            conversion_metrics.json
            coverage.json

      # Optional: Push metrics to Prometheus
      # - name: Push Test Metrics to Prometheus
      #   if: always()
      #   env:
      #     PROMETHEUS_GATEWAY: ${{ secrets.PROMETHEUS_GATEWAY }}
      #   run: |
      #     if [ -f test_metrics.json ]; then
      #       total_files=$(jq '.total_files' test_metrics.json)
      #       files_passed=$(jq '.files_passed' test_metrics.json)
      #       files_failed=$(jq '.files_failed' test_metrics.json)
      #       total_rules=$(jq '.total_rules' test_metrics.json)
      #       rules_passed=$(jq '.rules_passed' test_metrics.json)
      #       rules_failed=$(jq '.rules_failed' test_metrics.json)
      #       test_duration=$(jq '.test_duration_seconds' test_metrics.json)
      #       coverage_percentage=$(jq '.coverage_percentage' test_metrics.json)
      #       curl -X POST --data-binary \
      #         "test_files_total $total_files\n\
      #         test_files_passed $files_passed\n\
      #         test_files_failed $files_failed\n\
      #         test_rules_total $total_rules\n\
      #         test_rules_passed $rules_passed\n\
      #         test_rules_failed $rules_failed\n\
      #         test_duration_seconds $test_duration\n\
      #         test_coverage_percentage $coverage_percentage" \
      #         $PROMETHEUS_GATEWAY
      #     fi

      - name: Notify Slack on Success
        if: success()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          curl -X POST -H 'Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}' \
            -H 'Content-type: application/json' \
            --data '{"channel":"security-alerts","text":"Datadog Rule Import Pipeline completed successfully. Check GitHub Actions for conversion_summary.json, import_summary.json, test_metrics.json, conversion_metrics.json, and coverage.json."}' \
            https://slack.com/api/chat.postMessage

      - name: Notify Slack on Failure
        if: failure()
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
        run: |
          curl -X POST -H 'Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}' \
            -H 'Content-type: application/json' \
            --data '{"channel":"security-alerts","text":"Datadog Rule Import Pipeline failed. Check GitHub Actions for details, test_metrics.json, and coverage.json."}' \
            https://slack.com/api/chat.postMessage