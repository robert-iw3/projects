{
  "data": {
    "type": "signal_correlation",
    "attributes": {
      "name": "Koske Malware Detection",
      "enabled": true,
      "cases": [
        {
          "name": "Polyglot Execution (grep | shell)",
          "status": "high",
          "query": "source:linux (@process.name:(grep OR egrep) @process.command:(\"*|*sh\" OR \"*|*bash\")) | aggregate count by @host.name, @usr.name, @process.name, @process.command"
        },
        {
          "name": "Persistence: Systemd Service Enabled",
          "status": "high",
          "query": "source:linux @process.name:systemctl @process.command:\"*enable*.service\" | aggregate count by @host.name, @usr.name, @process.name, @process.command"
        },
        {
          "name": "Rootkit: LD_PRELOAD Env Var Used",
          "status": "high",
          "query": "source:linux @process.command:\"*LD_PRELOAD=*\" | aggregate count by @host.name, @usr.name, @process.name, @process.command"
        },
        {
          "name": "Suspicious C2 (curl/wget execution)",
          "status": "high",
          "query": "source:linux @process.name:(curl OR wget) | aggregate count by @host.name, @usr.name, @process.name, @process.command"
        },
        {
          "name": "Rootkit: ld.so.preload Modified",
          "status": "high",
          "query": "source:linux @file.action:(created OR modified) @file.path:\"/etc/ld.so.preload\" | aggregate count by @host.name, @usr.name, @file.path"
        },
        {
          "name": "Persistence: Common File Modified",
          "status": "high",
          "query": "source:linux @file.action:(created OR modified) @file.path:(\"*/.bashrc\" OR \"/etc/crontab\" OR \"/etc/cron.d/*\" OR \"/etc/systemd/system/*.service\") | aggregate count by @host.name, @usr.name, @file.path"
        }
      ],
      "group_by_fields": ["@host.name", "@usr.name"],
      "distinct_fields": ["case_id"],
      "correlation": {
        "expression": "distinct_count >= 1",
        "timeframe": "30m"
      },
      "message": "Koske Malware Activity Detected: {distinct_count} distinct TTP(s) on host {@host.name} by user {@usr.name}. Techniques: {case_names}. Details: {@process.command OR @file.path}. Timeframe: {first_activity} to {last_activity}",
      "severity": "high",
      "tags": [
        "security:attack",
        "tactic:TA0003",
        "tactic:TA0005",
        "tactic:TA0011",
        "technique:T1059.004",
        "technique:T1546.004",
        "technique:T1543.002",
        "technique:T1053.003",
        "technique:T1071",
        "technique:T1007",
        "malware:koske"
      ],
      "filters": [
        {
          "query": "-@usr.name:(puppet OR ansible) -@process.parent.name:(yum OR apt-get)"
        }
      ],
      "options": {
        "evaluation_window": "30m"
      }
    }
  }
}