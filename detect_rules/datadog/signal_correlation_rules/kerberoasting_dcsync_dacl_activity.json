{
  "name": "Kerberoasting, AS-REP Roasting, DCSync, and AD DACL Modifications",
  "queries": [
    {
      "name": "potential_kerberoasting_rc4",
      "query": "@winlog.event_id:4769 AND @winlog.event_data.Status:0x0 AND @winlog.event_data.TicketEncryptionType:0x17 -@winlog.event_data.ServiceName:*$*",
      "data_source": "logs",
      "aggregation": "event_count"
    },
    {
      "name": "potential_as_rep_roasting",
      "query": "@winlog.event_id:4768 AND @winlog.event_data.Status:0x0 AND @winlog.event_data.ServiceName:krbtgt AND @winlog.event_data.PreAuthType:0 -@winlog.event_data.TargetUserName:*$*",
      "data_source": "logs",
      "aggregation": "event_count"
    },
    {
      "name": "potential_dcsync_attack",
      "query": "@winlog.event_id:4662 AND @winlog.event_data.ObjectServer:DS AND @winlog.event_data.ObjectType:{19195a5b-6da0-11d0-afd3-00c04fd930c9} AND (@winlog.event_data.Properties:*1131f6aa-9c07-11d1-f79f-00c04fc2dcd2* OR @winlog.event_data.Properties:*1131f6ad-9c07-11d1-f79f-00c04fc2dcd2*) -@winlog.event_data.SubjectUserName:*$*",
      "data_source": "logs",
      "aggregation": "event_count"
    },
    {
      "name": "adminsdholder_dacl_modification",
      "query": "@winlog.event_id:5136 AND @winlog.event_data.LDAPDisplayName:nTSecurityDescriptor AND @winlog.event_data.ObjectDN:*CN=AdminSDHolder,CN=System,* AND @winlog.event_data.SubjectUserSid:!S-1-5-18",
      "data_source": "logs",
      "aggregation": "event_count"
    },
    {
      "name": "malicious_ad_dacl_modification",
      "query": "@winlog.event_id:5136 AND @winlog.event_data.LDAPDisplayName:nTSecurityDescriptor AND (@winlog.event_data.Value:*(A;;GA;;* OR @winlog.event_data.Value:*(A;;WD;;* OR @winlog.event_data.Value:*(A;;WO;;*) AND @winlog.event_data.SubjectUserSid:!S-1-5-18",
      "data_source": "logs",
      "aggregation": "event_count"
    }
  ],
  "cases": [
    {
      "name": "Kerberoasting, AS-REP Roasting, DCSync, and AD DACL Modifications",
      "status": "high",
      "condition": "event_count_0 >= 1 OR event_count_1 >= 1 OR event_count_2 >= 1 OR event_count_3 >= 1 OR event_count_4 >= 1"
    }
  ],
  "options": {
    "evaluation_window": 3600,
    "keep_alive": 3600,
    "max_signal_duration": 3600,
    "correlation_based_signal": {
      "correlation_inputs": [
        {
          "rule_id": "ad_kerberos_attacks_correlation"
        }
      ],
      "correlated_by_fields": [
        "@host",
        "@usr"
      ],
      "distinct_fields": [
        "case_id"
      ]
    }
  },
  "message": "AD Attacks: {{distinct_count}} type(s) on host {{host}} by user {{usr}}: {{case_names}}",
  "type": "correlation_based_signal",
  "tags": [],
  "is_enabled": true
}
