{
  "name": "PPL Abuse and Defender Tampering Techniques",
  "queries": [
    {
      "name": "ppl_loader_launching_clipup",
      "query": "@winlog.event_id:1 AND @process.parent.executable:*\\\\CreateProcessAsPPL.exe AND @process.executable:*\\\\clipup.exe",
      "data_source": "logs",
      "aggregation": "event_count"
    },
    {
      "name": "anomalous_clipup_execution_for_file_write",
      "query": "@winlog.event_id:1 AND @process.executable:*\\\\System32\\\\clipup.exe AND @process.cmdline:\"*-ppl*\" AND (@process.cmdline:\"*\\\\ProgramData\\\\Microsoft\\\\Windows\\\\ Defender\\\\*\" OR @process.cmdline:\"*\\\\Program Files\\\\Windows\\\\ Defender\\\\*\" OR @process.cmdline:\"*\\\\Program Files (x86)\\\\Windows\\\\ Defender\\\\*\" OR @process.cmdline:\"*-ppl *PROGRA~*\")",
      "data_source": "logs",
      "aggregation": "event_count"
    },
    {
      "name": "suspicious_auto_start_service_creation",
      "query": "@winlog.event_id:1 AND @process.executable:*\\\\sc.exe AND @process.cmdline:*create* AND @process.cmdline:\"*start=auto*\" AND (@process.cmdline:*binPath=*CreateProcessAsPPL.exe* OR @process.cmdline:*binPath=*\\\\Users\\\\* OR @process.cmdline:*binPath=*\\\\ProgramData\\\\* OR @process.cmdline:*binPath=*\\\\Windows\\\\Temp\\\\* OR @process.cmdline:*binPath=*\\\\Temp\\\\* OR @process.cmdline:binPath=.*(cmd|powershell|pwsh).exe)",
      "data_source": "logs",
      "aggregation": "event_count"
    },
    {
      "name": "unauthorized_defender_directory_file_modification",
      "query": "@winlog.event_id:11 AND (@file.path:C:\\\\ProgramData\\\\Microsoft\\\\Windows\\\\ Defender\\\\* OR @file.path:C:\\\\Program Files\\\\Windows\\\\ Defender\\\\* OR @file.path:C:\\\\Program Files (x86)\\\\Windows\\\\ Defender\\\\*) -@process.executable:(\"\\\\MsMpEng.exe\" OR \"\\\\NisSrv.exe\" OR \"\\\\MsMpEngCP.exe\" OR \"\\\\MpCmdRun.exe\" OR \"\\\\TiWorker.exe\" OR \"\\\\TrustedInstaller.exe\" OR \"\\\\svchost.exe\" OR \"\\\\setup.exe\")",
      "data_source": "logs",
      "aggregation": "event_count"
    }
  ],
  "cases": [
    {
      "name": "PPL Abuse and Defender Tampering Techniques",
      "status": "high",
      "condition": "event_count_0 >= 1 OR event_count_1 >= 1 OR event_count_2 >= 1 OR event_count_3 >= 1"
    }
  ],
  "options": {
    "evaluation_window": 3600,
    "keep_alive": 3600,
    "max_signal_duration": 3600,
    "correlation_based_signal": {
      "correlation_inputs": [
        {
          "rule_id": "ppl_abuse_correlation"
        }
      ],
      "correlated_by_fields": [
        "@host",
        "@usr"
      ],
      "distinct_fields": [
        "case_id"
      ]
    }
  },
  "message": "PPL Abuse: {{distinct_count}} technique(s) on host {{host}} by user {{usr}}: {{case_names}}",
  "type": "correlation_based_signal",
  "tags": [],
  "is_enabled": true
}
