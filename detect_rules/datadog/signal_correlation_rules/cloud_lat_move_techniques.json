{
  "data": {
    "type": "signal_correlation",
    "attributes": {
      "name": "Cloud-Based SSH and Command Execution TTPs",
      "enabled": true,
      "cases": [
        {
          "name": "AWS EC2 SSH Key Injection via Instance Connect",
          "status": "high",
          "query": "source:cloudtrail @eventName:(SendSSHPublicKey OR SendSerialConsoleSSHPublicKey) @errorCode:NULL -@userIdentity.arn:*known-admin-role* -@sourceIPAddress:10.0.0.0/8"
        },
        {
          "name": "GCP Metadata SSH Key Modification",
          "status": "high",
          "query": "source:gcp_audit @protoPayload.serviceName:compute.googleapis.com @protoPayload.methodName:(v1.compute.instances.setMetadata OR v1.compute.projects.setCommonInstanceMetadata) @protoPayload.status:NULL @protoPayload.request.metadata.items.key:ssh-keys -@protoPayload.authenticationInfo.principalEmail:(admin@example.com OR automation-sa@*.iam.gserviceaccount.com)"
        },
        {
          "name": "Azure VMAccess Extension Abuse",
          "status": "high",
          "query": "source:azure_activity @operationName.value:MICROSOFT.COMPUTE/VIRTUALMACHINES/EXTENSIONS/WRITE @resultType:Success @resourceId:*extensions/VMAccess* @properties.requestbody:*protectedSettings* (@properties.requestbody:*ssh_key* OR @properties.requestbody:*password*) -@caller:(admin@example.com OR automation-account-id)"
        },
        {
          "name": "AWS SSM Session Initiation",
          "status": "medium",
          "query": "source:cloudtrail @eventSource:ssm.amazonaws.com @eventName:StartSession @errorCode:NULL -@userIdentity.arn:*known-admin-role* -@sourceIPAddress:1.2.3.4"
        },
        {
          "name": "AWS SSM Command Execution",
          "status": "high",
          "query": "source:cloudtrail @eventSource:ssm.amazonaws.com @eventName:SendCommand @errorCode:NULL @requestParameters.documentName:(AWS-RunShellScript OR AWS-RunPowerShellScript) -@userIdentity.arn:*known-admin-role* -@sourceIPAddress:1.2.3.4 | groupby @userIdentity.arn, @sourceIPAddress, @awsRegion count as target_instance_count | filter target_instance_count > 5"
        }
      ],
      "group_by_fields": ["@userIdentity.arn", "@protoPayload.authenticationInfo.principalEmail", "@caller", "@sourceIPAddress"],
      "distinct_fields": ["case_id"],
      "correlation": {
        "expression": "distinct_count >= 2",
        "timeframe": "1h"
      },
      "message": "Cloud-Based SSH and Command Execution TTPs: {distinct_count} distinct techniques detected for user {@userIdentity.arn OR @protoPayload.authenticationInfo.principalEmail OR @caller} from source IP {@sourceIPAddress}. Techniques: {case_names}. Details: {@eventName OR @protoPayload.methodName OR @operationName.value OR @requestParameters.documentName OR @properties.requestbody}. Timeframe: {first_activity} to {last_activity}",
      "severity": "high",
      "tags": [
        "security:attack",
        "tactic:TA0001",
        "tactic:TA0003",
        "tactic:TA0008",
        "technique:T1136",
        "technique:T1021.004",
        "technique:T1059"
      ],
      "options": {
        "evaluation_window": "1h"
      }
    }
  }
}