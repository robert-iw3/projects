## MonitorC2Activities_AdvancedBeaconing.ps1

### Overview
---

This tool monitors Windows systems for potential C2 activities using Sysmon events. It detects anomalies like beaconing, high-entropy domains/IPs, unusual ports, and process behaviors, mapping them to MITRE ATT&CK. Enhanced with advanced beaconing (jitter, autocorrelation, periodogram) and optional Python ML clustering for intervals. Outputs logs to CSV/JSON/YAML.

### Requirements
---

- Windows OS with administrative privileges.
- Sysmon installed and configured (use companion script).
- PowerShell 5.1+.
- For ML beaconing: Python 3.x with scikit-learn, numpy, joblib (install via `pip install -r requirements.txt`).

### Installation
---

1. Run `InstallSysmonForC2Detection.ps1` as admin to install/configure Sysmon (logs ProcessCreate ID 1, NetworkConnect ID 3, etc.).
2. For ML: Place `BeaconML.py` and `requirements.txt` in the script directory; install deps with `pip install -r requirements.txt`.

### Usage
---

Run `MonitorC2Activities_AdvancedBeaconing.ps1` as admin. It polls Sysmon logs indefinitely.

### Command-Line Parameters
---

Override defaults/config (e.g., `.\MonitorC2Activities_AdvancedBeaconing.ps1 -OutputPath "C:\Logs\output.json" -Format JSON`):
- `-OutputPath`: Output file path (default: C:\Temp\C2Monitoring.csv).
- `-Format`: CSV, JSON, or YAML (default: CSV).
- `-IntervalSeconds`: Polling interval (default: 10).
- `-BeaconWindowMinutes`: Beaconing detection window (default: 60).
- `-MinConnectionsForBeacon`: Min connections for beaconing (default: 3).
- `-MaxIntervalVarianceSeconds`: Max std dev for beaconing (default: 10).
- `-MaxHistoryKeys`: Max tracked endpoints (default: 1000).
- `-VolumeThreshold`: High-volume anomaly threshold (default: 50).
- `-DomainEntropyThreshold`: Domain entropy threshold (default: 3.5).
- `-DomainLengthThreshold`: Domain length threshold (default: 30).
- `-NumericRatioThreshold`: Numeric ratio threshold (default: 0.4).
- `-VowelRatioThreshold`: Vowel ratio threshold (default: 0.2).
- `-IPEntropyThreshold`: IP entropy threshold (default: 3.0).
- `-SpecificTLDs`: Array of TLDs to flag (e.g., @('.ru', '.cn')).
- `-SpecificRMMTools`: Array of RMM tools to flag (e.g., @('AnyDesk.exe')).
- `-SpecificLOLBins`: Array of LOLBins to flag (e.g., @('rundll32.exe')).
- `-SpecificCloudDomains`: Array of cloud domains to flag (e.g., @('amazonaws.com')).

### Customization
---

- Edit `config.ini` in the script directory for defaults (no need for every run).
  Example:
  ```
  [Anomaly]
  DomainEntropyThreshold=3.8

  [Specifics]
  TLDs=.ru,.cn
  ```

### Output
---

- Logs outbound network/DNS events and flagged anomalies.
- Fields: EventType, Timestamp, SuspiciousFlags, ATTCKMappings, and more (e.g., FullMessage, CommandLine, DestinationIp).
- Appends to file; console shows append confirmations.

### ML Beaconing (Optional)
---

- If Python is installed, enables advanced detection via `BeaconML.py`.
- **What BeaconML.py Does**: Reads connection intervals from a temporary JSON file generated by the PowerShell script. Uses K-Means clustering (from scikit-learn) to group intervals; flags beaconing if a cluster has low variance (indicating regular patterns). Supports parallel processing (joblib) for efficiency on larger datasets. Returns detection result to PowerShell for inclusion in logs.

### Troubleshooting
---

- Verify Sysmon: `Get-Service Sysmon*` (should be "Running").
- Test events: Generate network traffic (e.g., ping google.com) for ID 3/22.
- For YAML: Install `powershell-yaml` module.
- Stop: Ctrl+C.